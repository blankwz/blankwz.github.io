<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>试玩IPv6与DDNS | Gxkon's Blog</title><meta name="description" content="试玩IPv6与DDNS一、基本1. 目的我的目的很简单，能在外面访问家里的设备即可。比如，NAS。 下面的其他方案也可以，但是还是放弃了  现在的固定IPv4太难申请  拉独立光纤太贵，  做内网穿透也需要一个公网固定IP，买服务器也不划算  花生壳有限制   2. 条件要想玩IPv6，需要以下条件：  运营商开放了IPv6：现在基本都有 光猫支持IPv6：新光猫也基本有 路由支持IPv6：买高端"><meta name="keywords" content="IPV6,DDNS"><meta name="author" content="Gkon"><meta name="copyright" content="Gkon"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="试玩IPv6与DDNS"><meta name="twitter:description" content="试玩IPv6与DDNS一、基本1. 目的我的目的很简单，能在外面访问家里的设备即可。比如，NAS。 下面的其他方案也可以，但是还是放弃了  现在的固定IPv4太难申请  拉独立光纤太贵，  做内网穿透也需要一个公网固定IP，买服务器也不划算  花生壳有限制   2. 条件要想玩IPv6，需要以下条件：  运营商开放了IPv6：现在基本都有 光猫支持IPv6：新光猫也基本有 路由支持IPv6：买高端"><meta name="twitter:image" content="http://gxkon.top/Pic/post.jpg"><meta property="og:type" content="article"><meta property="og:title" content="试玩IPv6与DDNS"><meta property="og:url" content="http://gxkon.top/posts/ebbbbbf7/"><meta property="og:site_name" content="Gxkon's Blog"><meta property="og:description" content="试玩IPv6与DDNS一、基本1. 目的我的目的很简单，能在外面访问家里的设备即可。比如，NAS。 下面的其他方案也可以，但是还是放弃了  现在的固定IPv4太难申请  拉独立光纤太贵，  做内网穿透也需要一个公网固定IP，买服务器也不划算  花生壳有限制   2. 条件要想玩IPv6，需要以下条件：  运营商开放了IPv6：现在基本都有 光猫支持IPv6：新光猫也基本有 路由支持IPv6：买高端"><meta property="og:image" content="http://gxkon.top/Pic/post.jpg"><meta property="article:published_time" content="2020-12-03T12:20:55.000Z"><meta property="article:modified_time" content="2021-01-23T12:12:21.650Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://gxkon.top/posts/ebbbbbf7/"><link rel="prev" title="Python文本处理之xml文件操作" href="http://gxkon.top/posts/ec4e7dd/"><link rel="next" title="Python文本处理之configparser配置文件" href="http://gxkon.top/posts/7a50e393/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: {"text":"本人,超帅,打钱","fontSize":"15px"},
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/Pic/avatar.png" onerror="onerror=null;src='/Pic/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">156</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">83</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">54</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 娱乐</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#试玩IPv6与DDNS"><span class="toc-text">试玩IPv6与DDNS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、基本"><span class="toc-text">一、基本</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-目的"><span class="toc-text">1. 目的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-条件"><span class="toc-text">2. 条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-光猫设置"><span class="toc-text">3. 光猫设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-流程"><span class="toc-text">4. 流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、OpenWrt的IPV6设置"><span class="toc-text">二、OpenWrt的IPV6设置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-添加接口"><span class="toc-text">1. 添加接口</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#"><span class="toc-text"></span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-WAN设置"><span class="toc-text">2.WAN设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-LAN设置"><span class="toc-text">3.LAN设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-DHCP设置"><span class="toc-text">4.DHCP设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-防火墙设置"><span class="toc-text">5.防火墙设置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1）"><span class="toc-text">1）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2）"><span class="toc-text">2）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-负载均衡"><span class="toc-text">6.负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-完成"><span class="toc-text">7.完成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-测试"><span class="toc-text">8.测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#浏览器中测试"><span class="toc-text">浏览器中测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试网站测试"><span class="toc-text">测试网站测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、DDNS"><span class="toc-text">三、DDNS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-讲解"><span class="toc-text">1. 讲解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#代码原理"><span class="toc-text">代码原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DDNS的大前提"><span class="toc-text">DDNS的大前提</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-哪些需要做DDNS"><span class="toc-text">2. 哪些需要做DDNS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Cloudflare-API获取"><span class="toc-text">3.Cloudflare API获取</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#API操作说明-Linux通用"><span class="toc-text">API操作说明 - Linux通用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-群晖配置原生-DDNS"><span class="toc-text">4. 群晖配置原生 DDNS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-开启并登陆群晖NAS终端"><span class="toc-text">1. 开启并登陆群晖NAS终端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-下载-Cloudflare-DDNS-脚本"><span class="toc-text">2. 下载 Cloudflare DDNS 脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#参考备用"><span class="toc-text">参考备用</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-新增原生-DDNS-列表"><span class="toc-text">3. 新增原生 DDNS 列表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-群晖中配置"><span class="toc-text">4. 群晖中配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-OpenWrt配置DDNS"><span class="toc-text">5. OpenWrt配置DDNS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-阿里云获取Key"><span class="toc-text">1. 阿里云获取Key</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-添加ddns"><span class="toc-text">2. 添加ddns</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-基本设置"><span class="toc-text">2. 基本设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-高级设置"><span class="toc-text">3. 高级设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-启动"><span class="toc-text">4. 启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-查看方法"><span class="toc-text">5.查看方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-阿里云DDNS-脚本方法"><span class="toc-text">5. 阿里云DDNS - 脚本方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IPV4"><span class="toc-text">IPV4</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#更智能的脚本"><span class="toc-text">更智能的脚本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#方法二脚本"><span class="toc-text">方法二脚本</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IPV6"><span class="toc-text">IPV6</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#实操，可用"><span class="toc-text">实操，可用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#其他IPV6脚本备份"><span class="toc-text">其他IPV6脚本备份</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-Windows方法-Aliyun-Python"><span class="toc-text">6. Windows方法 - Aliyun+Python</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Python代码备份"><span class="toc-text">Python代码备份</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-Linux系统通用"><span class="toc-text">7.Linux系统通用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-更多脚本"><span class="toc-text">8.更多脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、定时计划"><span class="toc-text">四、定时计划</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#群晖定时计划"><span class="toc-text">群晖定时计划</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows定时计划"><span class="toc-text">Windows定时计划</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、失效问题解决"><span class="toc-text">五、失效问题解决</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#最简单的方法："><span class="toc-text">最简单的方法：</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/Pic/post.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Gxkon's Blog</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 娱乐</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">试玩IPv6与DDNS</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-12-03 20:20:55"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-12-03</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2021-01-23 20:12:21"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2021-01-23</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/posts/ebbbbbf7/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="试玩IPv6与DDNS"><a href="#试玩IPv6与DDNS" class="headerlink" title="试玩IPv6与DDNS"></a>试玩IPv6与DDNS</h1><h2 id="一、基本"><a href="#一、基本" class="headerlink" title="一、基本"></a>一、基本</h2><h3 id="1-目的"><a href="#1-目的" class="headerlink" title="1. 目的"></a>1. 目的</h3><p>我的目的很简单，能在外面访问家里的设备即可。比如，NAS。</p>
<p>下面的其他方案也可以，但是还是放弃了</p>
<ul>
<li><p>现在的固定IPv4太难申请</p>
</li>
<li><p>拉独立光纤太贵，</p>
</li>
<li><p>做内网穿透也需要一个公网固定IP，买服务器也不划算</p>
</li>
<li><p>花生壳有限制</p>
</li>
</ul>
<h3 id="2-条件"><a href="#2-条件" class="headerlink" title="2. 条件"></a>2. 条件</h3><p><strong>要想玩IPv6，需要以下条件：</strong></p>
<ol>
<li><strong>运营商开放了IPv6</strong>：现在基本都有</li>
<li><strong>光猫支持IPv6</strong>：新光猫也基本有</li>
<li><strong>路由支持IPv6</strong>：买高端点的路由即可，买个软路由也都行。</li>
<li><strong>终端支持IPv6</strong>：比如软路由、NAS等设备</li>
</ol>
<p><strong>最后有</strong></p>
<h3 id="3-光猫设置"><a href="#3-光猫设置" class="headerlink" title="3. 光猫设置"></a>3. 光猫设置</h3><p><strong>目的</strong>：设置桥接模式，让路由来拨号。</p>
<p><strong>方法</strong>：每个运营商方法不同，这里不细讲，</p>
<h3 id="4-流程"><a href="#4-流程" class="headerlink" title="4. 流程"></a>4. 流程</h3><ol>
<li>光猫设置桥接，让路由拨号</li>
<li>主路由设置IPv6，能获取IPv6，也能分配IPv6</li>
<li>这样，家里所有设备都能有个独立的公网IPv6</li>
<li>虽然有了公网IPv6，但不是固定的，还需要做 DDNS，动态域名解析</li>
<li>完工，通过域名访问家里的设备</li>
</ol>
<h2 id="二、OpenWrt的IPV6设置"><a href="#二、OpenWrt的IPV6设置" class="headerlink" title="二、OpenWrt的IPV6设置"></a>二、OpenWrt的IPV6设置</h2><h3 id="1-添加接口"><a href="#1-添加接口" class="headerlink" title="1. 添加接口"></a>1. 添加接口</h3><h6 id=""><a href="#" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/11/28/35image-20201128112048176.png" alt="image-20201128112048176"></h6><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/11/28/94image-20201128112134495.png" alt="image-20201128112134495"></p>
<h3 id="2-WAN设置"><a href="#2-WAN设置" class="headerlink" title="2.WAN设置"></a>2.WAN设置</h3><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/11/28/68image-20201128112227639.png" alt="image-20201128112227639"></p>
<h3 id="3-LAN设置"><a href="#3-LAN设置" class="headerlink" title="3.LAN设置"></a>3.LAN设置</h3><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/11/28/56image-20201128112337094.png" alt="image-20201128112337094"></p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/11/28/5image-20201128112414246.png" alt="image-20201128112414246"></p>
<h3 id="4-DHCP设置"><a href="#4-DHCP设置" class="headerlink" title="4.DHCP设置"></a>4.DHCP设置</h3><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/11/28/96image-20201128210217589.png" alt="image-20201128210217589"></p>
<h3 id="5-防火墙设置"><a href="#5-防火墙设置" class="headerlink" title="5.防火墙设置"></a>5.防火墙设置</h3><h4 id="1）"><a href="#1）" class="headerlink" title="1）"></a>1）</h4><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/11/28/40image-20201128112708831.png" alt="image-20201128112708831"></p>
<h4 id="2）"><a href="#2）" class="headerlink" title="2）"></a>2）</h4><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/11/28/83image-20201128112741848.png" alt="image-20201128112741848"></p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/11/28/93image-20201128112803670.png" alt="image-20201128112803670"></p>
<h3 id="6-负载均衡"><a href="#6-负载均衡" class="headerlink" title="6.负载均衡"></a>6.负载均衡</h3><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/11/28/32image-20201128112932027.png" alt="image-20201128112932027"></p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/11/28/93image-20201128112949578.png" alt="image-20201128112949578"></p>
<h3 id="7-完成"><a href="#7-完成" class="headerlink" title="7.完成"></a>7.完成</h3><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/11/28/42image-20201128113720609.png" alt="image-20201128113720609"></p>
<h3 id="8-测试"><a href="#8-测试" class="headerlink" title="8.测试"></a>8.测试</h3><h4 id="浏览器中测试"><a href="#浏览器中测试" class="headerlink" title="浏览器中测试"></a>浏览器中测试</h4><p>在Chrome浏览器地址栏中输入： <code>[你的IPV6地址]</code> （中括号加IPV6地址，没有后面的/64）</p>
<p>例如：在外网访问你的OpenWrt，输入<code>[240e:370:2722:4711:fcdc:8b5:a443:e487]</code></p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/11/28/83image-20201128113913303.png" alt="image-20201128113913303"></p>
<h4 id="测试网站测试"><a href="#测试网站测试" class="headerlink" title="测试网站测试"></a>测试网站测试</h4><p><a href="http://www.test-ipv6.com/" target="_blank" rel="noopener">IPV6测试</a></p>
<h2 id="三、DDNS"><a href="#三、DDNS" class="headerlink" title="三、DDNS"></a>三、DDNS</h2><h3 id="1-讲解"><a href="#1-讲解" class="headerlink" title="1. 讲解"></a>1. 讲解</h3><p>首先讲下DNS，<strong>DNS是域名解析</strong></p>
<p>通俗来讲，就是把你的<code>公网固定</code>IP和你的域名绑定，能让你通过好记的域名来访问你的网站，而不是复杂难记的全是数字的IP地址访问。</p>
<p>而DDNS呢，是<strong>动态域名解析</strong>。</p>
<p>因为运营商虽然分配给你了公网IP，但是这个公网IP随时可能会变，因为不是固定的，绑定域名也没用，怎么办，这就用到动态域名解析。具体原理不讲，就是DDNS能通过某些方法，知道你的动态IP变了，变了就自动更新域名和IP绑定。</p>
<h4 id="代码原理"><a href="#代码原理" class="headerlink" title="代码原理"></a>代码原理</h4><p>下面所有代码的原理，都是通过命令，</p>
<ol>
<li>获取本机的IPv6地址（LINUX、Windows、群晖都差不多）</li>
<li>然后通过各平台的API（比如CloudFlare或者阿里云）发送IPv6地址给他们</li>
<li>然后改代码做个定时计划。</li>
<li>完成</li>
</ol>
<h4 id="DDNS的大前提"><a href="#DDNS的大前提" class="headerlink" title="DDNS的大前提"></a><strong>DDNS的大前提</strong></h4><p>大前提就是：你必须有公网IP！！</p>
<ul>
<li>IPv6一般都是公网IP，不过它是动态的</li>
<li>IPv4就不一定了，一般都是内网IP，需要向运营商申请才有公网固定IPv4！！</li>
</ul>
<blockquote>
<p>注意，如果你不做DDNS，你测试的时候，直接用域名绑定你的IPv6，也可以成功访问，但是过几天可能就没有用了。</p>
<p>因为IPv6是动态的，会随时变的，所以，这里需要用到DDNS！</p>
</blockquote>
<h3 id="2-哪些需要做DDNS"><a href="#2-哪些需要做DDNS" class="headerlink" title="2. 哪些需要做DDNS"></a>2. 哪些需要做DDNS</h3><p>你需要访问的设备，都要做DDNS</p>
<ul>
<li>IPv6是每个设备都有个独立公网IP地址</li>
<li>本来在OpenWrt - 防火墙 - 端口转发中设置即可。<ul>
<li>但是不知道为什么没有效果…</li>
<li>而且用端口号，也不方法，干脆全做了</li>
</ul>
</li>
<li>我这里就做两个<ul>
<li>软路由</li>
<li>NAS(群晖)</li>
</ul>
</li>
</ul>
<h3 id="3-Cloudflare-API获取"><a href="#3-Cloudflare-API获取" class="headerlink" title="3.Cloudflare API获取"></a>3.Cloudflare API获取</h3><ol>
<li>获取 区域 ID<ol>
<li>登陆 Cloudflare </li>
<li>点击域名,</li>
<li>在概述页面 - 往下拖 - 右侧获取<code>区域 ID</code>.</li>
</ol>
</li>
<li>获取API<ol>
<li>再点击 <code>获取您的 API 令牌</code></li>
<li>点击 <code>API 令牌</code></li>
<li><code>创建令牌 - 创建自定义令牌</code><ol>
<li>名称随便写</li>
<li>权限中分别写上： 区域、DNS、编辑</li>
<li>其他默认</li>
<li>确定</li>
</ol>
</li>
<li>复制<code>生成的API令牌</code></li>
</ol>
</li>
</ol>
<h4 id="API操作说明-Linux通用"><a href="#API操作说明-Linux通用" class="headerlink" title="API操作说明 - Linux通用"></a>API操作说明 - Linux通用</h4><blockquote>
<p>这个看不懂没关系，直接跳过，看下面的群晖方法即可，这里只是备注下</p>
</blockquote>
<p>参考：<a href="https://zhuanlan.zhihu.com/p/69379645" target="_blank" rel="noopener">基于 Cloudflare DNS API 部署 IPv6 DDNS</a></p>
<p>官方API<a href="https://api.cloudflare.com/#dns-records-for-a-zone-create-dns-record" target="_blank" rel="noopener">文档</a></p>
<ol>
<li>先以<code>POST</code>方式增加某条记录，并获取记录的ID（可以自己网页上新建，也可以API方式新建）</li>
<li>再以<code>PUT</code> 方式，更新IP给CloudFlare</li>
<li>设定定时执行</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">1.增加记录，会返回一个 结果，把结果中的AAAA的id获取出来</span><br><span class="line">curl -X POST <span class="string">"https://api.cloudflare.com/client/v4/zones/&lt;你的 Zone ID&gt;/dns_records"</span> \</span><br><span class="line">     -H <span class="string">"X-Auth-Email: &lt;Cloudflare 账号的邮箱地址&gt;"</span> \</span><br><span class="line">     -H <span class="string">"X-Auth-Key: &lt;刚才获取的 API Key&gt;"</span> \</span><br><span class="line">     -H <span class="string">"Content-Type: application/json"</span> \</span><br><span class="line">     --data <span class="string">'&#123;"type":"AAAA","name":"&lt;希望的完整域名&gt;","content":"&lt;你的IPv6地址&gt;","ttl":120,"priority":10,"proxied":false&#125;'</span></span><br><span class="line"><span class="comment"># 返回结果，获取该ID "id":"094e80a6608d0fb53096ac21b441da66"</span></span><br><span class="line">&#123;<span class="string">"result"</span>:&#123;<span class="string">"id"</span>:<span class="string">"094e80a6608d0fb53096ac21b441da66"</span>,<span class="string">"zone_id"</span>:<span class="string">"..."</span>,<span class="string">"zone_name"</span>:<span class="string">"..."</span>,<span class="string">"name"</span>:<span class="string">"..."</span>,<span class="string">"type"</span>:<span class="string">"AAAA"</span>,<span class="string">"content"</span>:<span class="string">"..."</span>,<span class="string">"proxiable"</span>:<span class="literal">true</span>,<span class="string">"proxied"</span>:<span class="literal">false</span>,<span class="string">"ttl"</span>:120,<span class="string">"locked"</span>:<span class="literal">false</span>,<span class="string">"meta"</span>:&#123;<span class="string">"auto_added"</span>:<span class="literal">false</span>,<span class="string">"managed_by_apps"</span>:<span class="literal">false</span>,<span class="string">"managed_by_argo_tunnel"</span>:<span class="literal">false</span>,<span class="string">"source"</span>:<span class="string">"primary"</span>&#125;,<span class="string">"created_on"</span>:<span class="string">"2020-11-29T05:12:35.370867Z"</span>,<span class="string">"modified_on"</span>:<span class="string">"2020-11-29T05:12:35.370867Z"</span>&#125;,<span class="string">"success"</span>:<span class="literal">true</span>,<span class="string">"errors"</span>:[],<span class="string">"messages"</span>:[]&#125;</span><br><span class="line"></span><br><span class="line">2.创建DDNS脚本</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/ipv6-ddns.sh </span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">sleep 10</span><br><span class="line">IP6=$(ip addr show|grep -v deprecated|grep -A1 <span class="string">'inet6 [^f:]'</span>|sed -nr <span class="string">':a;N;s#^ +inet6 ([a-f0-9:]+)/.+? scope global .*? valid_lft ([0-9]+sec) .*#\2 \1#p;ta'</span>|grep <span class="string">'ff:fe'</span>|sort -nr|head -n1|cut -d<span class="string">' '</span> -f2)</span><br><span class="line">curl -X PUT <span class="string">"https://api.cloudflare.com/client/v4/zones/&lt;刚才获取的 Zone ID&gt;/dns_records/&lt;刚才获取的 AAAA 记录 ID&gt;"</span> -H <span class="string">"X-Auth-Email: &lt;Cloudflare 账号的邮箱地址&gt;"</span> -H <span class="string">"X-Auth-Key: &lt;刚才获取的 API Key&gt;"</span> -H <span class="string">"Content-Type: application/json"</span> --data <span class="string">'&#123;"type":"AAAA","name":"&lt;DDNS 域名&gt;","content":"'</span><span class="string">"\$&#123;IP6&#125;"</span><span class="string">'","ttl":120,"proxied":false&#125;'</span></span><br><span class="line">EOF</span><br><span class="line">chmod +x /etc/ipv6-ddns.sh  <span class="comment"># 给它权限</span></span><br><span class="line"></span><br><span class="line">3.执行脚本</span><br><span class="line">/etc/ipv6-ddns.sh | python -m json.tool</span><br><span class="line"></span><br><span class="line">4.定时执行</span><br><span class="line">crontab -e</span><br><span class="line">在命令行窗口中按下 O（大写），复制粘贴下面代码， </span><br><span class="line">* * * * * /etc/ipv6-ddns.sh &gt; /dev/null 2&gt;&amp;1    <span class="comment"># 设定每分钟执行一次 DDNS 脚本</span></span><br><span class="line">按ESC，输入:wq 保存</span><br></pre></td></tr></table></figure>

<p><strong>若是之前增加过记录，只想获取刚刚增加的记录的ID</strong>，用<code>GET</code>方法，如下：</p>
<p>官方<a href="https://api.cloudflare.com/#dns-records-for-a-zone-list-dns-records" target="_blank" rel="noopener">文档</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取type为AAAA的记录信息</span></span><br><span class="line">curl -s -X GET <span class="string">"https://api.cloudflare.com/client/v4/zones/&lt;刚才获取的 Zone ID&gt;/dns_records?type=AAAA&amp;name=&lt;DDNS 域名&gt;&amp;content=127.0.0.1&amp;page=1&amp;per_page=100&amp;order=type&amp;direction=desc&amp;match=any"</span> \</span><br><span class="line">    -H <span class="string">"X-Auth-Email: &lt;Cloudflare 账号的邮箱地址&gt;"</span> \</span><br><span class="line">    -H <span class="string">"X-Auth-Key: &lt;刚才获取的 API Key&gt;"</span> \</span><br><span class="line">    -H <span class="string">"Content-Type: application/json"</span> \</span><br><span class="line">    | python -m json.tool</span><br></pre></td></tr></table></figure>





<h3 id="4-群晖配置原生-DDNS"><a href="#4-群晖配置原生-DDNS" class="headerlink" title="4. 群晖配置原生 DDNS"></a>4. 群晖配置原生 DDNS</h3><p>参考<a href="https://www.ioiox.com/archives/105.html" target="_blank" rel="noopener">Stille大神</a></p>
<p>群晖原生 DDNS 并不支持 Cloudflare ,通过 <a href="https://github.com/joshuaavalon/SynologyCloudflareDDNS" target="_blank" rel="noopener">joshuaavalon/SynologyCloudflareDDNS</a> 项目提供的脚本和方案,可以将 Cloudflare 添加到原生 DDNS 列表中.</p>
<h4 id="1-开启并登陆群晖NAS终端"><a href="#1-开启并登陆群晖NAS终端" class="headerlink" title="1. 开启并登陆群晖NAS终端"></a>1. 开启并登陆群晖NAS终端</h4><ol>
<li><strong>控制面板 - 终端机和 SNMP - 勾选启用 SSH 功能</strong> </li>
<li>用SSH登陆群晖后台<ol>
<li>地址：群晖IP （不需要5000端口号）</li>
<li>账号密码就是你的管理员账号密码</li>
</ol>
</li>
<li>登陆后，获取管理员权限<ul>
<li><code>sudo -i</code>，输入密码</li>
</ul>
</li>
</ol>
<h4 id="2-下载-Cloudflare-DDNS-脚本"><a href="#2-下载-Cloudflare-DDNS-脚本" class="headerlink" title="2. 下载 Cloudflare DDNS 脚本"></a>2. 下载 Cloudflare DDNS 脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -e;</span><br><span class="line"></span><br><span class="line">ipv4Regex=<span class="string">"((25[0-5]|(2[0-4]|1&#123;0,1&#125;[0-9])&#123;0,1&#125;[0-9])\.)&#123;3,3&#125;(25[0-5]|(2[0-4]|1&#123;0,1&#125;[0-9])&#123;0,1&#125;[0-9])"</span></span><br><span class="line"></span><br><span class="line">proxy=<span class="string">"false"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DSM Config，从群晖中获取变量</span></span><br><span class="line">user=<span class="string">"<span class="variable">$1</span>"</span>  <span class="comment"># 含有邮箱和地区ID，以 “/” 分割</span></span><br><span class="line">username=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$user</span>"</span> | cut -d <span class="string">'/'</span> -f 1) <span class="comment"># 第一个是地区ID</span></span><br><span class="line">email=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$user</span>"</span> | cut -d <span class="string">'/'</span> -f 2) <span class="comment"># 第二个是邮箱</span></span><br><span class="line">password=<span class="string">"<span class="variable">$2</span>"</span>  <span class="comment"># API key</span></span><br><span class="line">hostname=<span class="string">"<span class="variable">$3</span>"</span> <span class="comment"># 域名</span></span><br><span class="line">ipAddr=<span class="string">"<span class="variable">$4</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否是IPV4类型，修改记录A或者AAAA</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$ipAddr</span> =~ <span class="variable">$ipv4Regex</span> ]]; <span class="keyword">then</span></span><br><span class="line">    recordType=<span class="string">"A"</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    recordType=<span class="string">"AAAA"</span>;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">listDnsApi=<span class="string">"https://api.cloudflare.com/client/v4/zones/<span class="variable">$&#123;username&#125;</span>/dns_records?type=<span class="variable">$&#123;recordType&#125;</span>&amp;name=<span class="variable">$&#123;hostname&#125;</span>&amp;content=127.0.0.1&amp;page=1&amp;per_page=100&amp;order=type&amp;dircetion=desc&amp;match=any"</span></span><br><span class="line">createDnsApi=<span class="string">"https://api.cloudflare.com/client/v4/zones/<span class="variable">$&#123;username&#125;</span>/dns_records"</span></span><br><span class="line"></span><br><span class="line">res=$(curl -s -X GET <span class="string">"<span class="variable">$listDnsApi</span>"</span> -H <span class="string">"X-Auth-Email: <span class="variable">$email</span>"</span> -H <span class="string">"X-Auth-Key:  <span class="variable">$password</span>"</span> -H <span class="string">"Content-Type:application/json"</span>)</span><br><span class="line">resSuccess=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$res</span>"</span> | jq -r <span class="string">".success"</span>)</span><br><span class="line"><span class="comment"># jq命令为json化结果</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$resSuccess</span> != <span class="string">"true"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"badauth"</span>;</span><br><span class="line">    <span class="built_in">exit</span> 1;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">recordId=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$res</span>"</span> | jq -r <span class="string">".result[0].id"</span>)</span><br><span class="line">recordIp=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$res</span>"</span> | jq -r <span class="string">".result[0].content"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$recordIp</span> = <span class="string">"<span class="variable">$ipAddr</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"nochg"</span>;  <span class="comment"># 无变化</span></span><br><span class="line">    <span class="built_in">exit</span> 0;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$recordId</span> = <span class="string">"null"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># Record not exists</span></span><br><span class="line">    res=$(curl -s -X POST <span class="string">"<span class="variable">$createDnsApi</span>"</span> -H <span class="string">"X-Auth-Email: <span class="variable">$email</span>"</span> -H <span class="string">"X-Auth-Key:  <span class="variable">$password</span>"</span> -H <span class="string">"Content-Type:application/json"</span> --data <span class="string">"&#123;\"type\":\"<span class="variable">$recordType</span>\",\"name\":\"<span class="variable">$hostname</span>\",\"content\":\"<span class="variable">$ipAddr</span>\",\"ttl\":120,\"proxied\":<span class="variable">$proxy</span>&#125;"</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment"># Record exists</span></span><br><span class="line">    updateDnsApi=<span class="string">"https://api.cloudflare.com/client/v4/zones/<span class="variable">$&#123;username&#125;</span>/dns_records/<span class="variable">$&#123;recordId&#125;</span>"</span>;</span><br><span class="line">    res=$(curl -s -X PUT <span class="string">"<span class="variable">$updateDnsApi</span>"</span> -H <span class="string">"X-Auth-Email: <span class="variable">$email</span>"</span> -H <span class="string">"X-Auth-Key:  <span class="variable">$password</span>"</span> -H <span class="string">"Content-Type:application/json"</span> --data <span class="string">"&#123;\"type\":\"<span class="variable">$recordType</span>\",\"name\":\"<span class="variable">$hostname</span>\",\"content\":\"<span class="variable">$ipAddr</span>\",\"ttl\":120,\"proxied\":<span class="variable">$proxy</span>&#125;"</span>)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> resSuccess</span><br><span class="line">resSuccess=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$res</span>"</span> | jq -r <span class="string">".success"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$resSuccess</span> = <span class="string">"true"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"good"</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"badauth"</span>;</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>







<h5 id="参考备用"><a href="#参考备用" class="headerlink" title="参考备用"></a>参考备用</h5><p><code>无效了，不支持匿名 Bearer</code></p>
<p>下载 Cloudflare 的 DDNS 脚本文件,官方推荐存放于<code>/sbin/cloudflareddns.sh</code>并赋予执行权限.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">因 GitHub DNS 被污染,无法下载,同时提供本站国内镜像地址</span><br><span class="line">wget https://files.ioiox.com/GitHub/joshuaavalon/SynologyCloudflareDDNS/master/cloudflareddns.sh -O /sbin/cloudflareddns.sh</span><br><span class="line"><span class="comment"># 下载脚本</span></span><br><span class="line">chmod +x /sbin/cloudflareddns.sh</span><br><span class="line"><span class="comment"># 赋予执行权限</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -e;</span><br><span class="line"></span><br><span class="line">ipv4Regex=<span class="string">"((25[0-5]|(2[0-4]|1&#123;0,1&#125;[0-9])&#123;0,1&#125;[0-9])\.)&#123;3,3&#125;(25[0-5]|(2[0-4]|1&#123;0,1&#125;[0-9])&#123;0,1&#125;[0-9])"</span></span><br><span class="line"></span><br><span class="line">proxy=<span class="string">"true"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DSM Config，从群晖中获取变量</span></span><br><span class="line">username=<span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line">password=<span class="string">"<span class="variable">$2</span>"</span></span><br><span class="line">hostname=<span class="string">"<span class="variable">$3</span>"</span></span><br><span class="line">ipAddr=<span class="string">"<span class="variable">$4</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否是IPV4类型，修改记录A或者AAAA</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$ipAddr</span> =~ <span class="variable">$ipv4Regex</span> ]]; <span class="keyword">then</span></span><br><span class="line">    recordType=<span class="string">"A"</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    recordType=<span class="string">"AAAA"</span>;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">listDnsApi=<span class="string">"https://api.cloudflare.com/client/v4/zones/<span class="variable">$&#123;username&#125;</span>/dns_records?type=<span class="variable">$&#123;recordType&#125;</span>&amp;name=<span class="variable">$&#123;hostname&#125;</span>"</span></span><br><span class="line">createDnsApi=<span class="string">"https://api.cloudflare.com/client/v4/zones/<span class="variable">$&#123;username&#125;</span>/dns_records"</span></span><br><span class="line"></span><br><span class="line">res=$(curl -s -X GET <span class="string">"<span class="variable">$listDnsApi</span>"</span> -H <span class="string">"Authorization: Bearer <span class="variable">$password</span>"</span> -H <span class="string">"Content-Type:application/json"</span>)</span><br><span class="line">resSuccess=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$res</span>"</span> | jq -r <span class="string">".success"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$resSuccess</span> != <span class="string">"true"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"badauth"</span>;</span><br><span class="line">    <span class="built_in">exit</span> 1;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">recordId=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$res</span>"</span> | jq -r <span class="string">".result[0].id"</span>)</span><br><span class="line">recordIp=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$res</span>"</span> | jq -r <span class="string">".result[0].content"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$recordIp</span> = <span class="string">"<span class="variable">$ipAddr</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"nochg"</span>;</span><br><span class="line">    <span class="built_in">exit</span> 0;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$recordId</span> = <span class="string">"null"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># Record not exists</span></span><br><span class="line">    res=$(curl -s -X POST <span class="string">"<span class="variable">$createDnsApi</span>"</span> -H <span class="string">"Authorization: Bearer <span class="variable">$password</span>"</span> -H <span class="string">"Content-Type:application/json"</span> --data <span class="string">"&#123;\"type\":\"<span class="variable">$recordType</span>\",\"name\":\"<span class="variable">$hostname</span>\",\"content\":\"<span class="variable">$ipAddr</span>\",\"proxied\":<span class="variable">$proxy</span>&#125;"</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment"># Record exists</span></span><br><span class="line">    updateDnsApi=<span class="string">"https://api.cloudflare.com/client/v4/zones/<span class="variable">$&#123;username&#125;</span>/dns_records/<span class="variable">$&#123;recordId&#125;</span>"</span>;</span><br><span class="line">    res=$(curl -s -X PUT <span class="string">"<span class="variable">$updateDnsApi</span>"</span> -H <span class="string">"Authorization: Bearer <span class="variable">$password</span>"</span> -H <span class="string">"Content-Type:application/json"</span> --data <span class="string">"&#123;\"type\":\"<span class="variable">$recordType</span>\",\"name\":\"<span class="variable">$hostname</span>\",\"content\":\"<span class="variable">$ipAddr</span>\",\"proxied\":<span class="variable">$proxy</span>&#125;"</span>)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> resSuccess</span><br><span class="line">resSuccess=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$res</span>"</span> | jq -r <span class="string">".success"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$resSuccess</span> = <span class="string">"true"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"good"</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"badauth"</span>;</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h4 id="3-新增原生-DDNS-列表"><a href="#3-新增原生-DDNS-列表" class="headerlink" title="3. 新增原生 DDNS 列表"></a>3. 新增原生 DDNS 列表</h4><p>把脚本放到群晖DDNS列表的配置文件中</p>
<p><strong>复制粘贴以下命令并执行</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc.defaults/ddns_provider.conf &lt;&lt; EOF</span><br><span class="line">[Cloudflare]</span><br><span class="line">        modulepath=/sbin/cloudflareddns.sh</span><br><span class="line">        queryurl=https://www.cloudflare.com</span><br><span class="line">        website=https://www.cloudflare.com</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="4-群晖中配置"><a href="#4-群晖中配置" class="headerlink" title="4. 群晖中配置"></a>4. 群晖中配置</h4><p><strong>登陆群晖 DSM - 控制面板 - 外部访问 - DDNS - 新增</strong></p>
<ul>
<li><strong>服务供应商</strong> - 选择 Cloudflare</li>
<li><strong>主机名称</strong> - 填写 DDNS 域名</li>
<li><strong>用户名</strong> - 填写区域 ID</li>
<li><strong>密码</strong> - 填写上文生成的 API 令牌</li>
</ul>
<p><code>因为我们没有公网IPv4地址，需要把IPv4地址删掉</code></p>
<ol>
<li>点击，设置 <code>外部IP</code></li>
<li>把 IPv4地址，改为：<code>0.0.0.0</code></li>
</ol>
<blockquote>
<p>如果IPv6是灰色的，且是0.0.0.0.0……，</p>
<p>需要在OpenWrt中 <code>网络 - DHCP/DNS- 高级设置</code> - 去掉勾 <code>禁止解析IPv6 DNS记录</code></p>
</blockquote>
<h3 id="5-OpenWrt配置DDNS"><a href="#5-OpenWrt配置DDNS" class="headerlink" title="5. OpenWrt配置DDNS"></a>5. OpenWrt配置DDNS</h3><p>我们使用 <code>动态DNS+阿里云解析</code></p>
<h4 id="1-阿里云获取Key"><a href="#1-阿里云获取Key" class="headerlink" title="1. 阿里云获取Key"></a>1. 阿里云获取Key</h4><ol>
<li>鼠标放在右上角 <code>头像</code>上，点击 <code>AccessKey 管理</code></li>
<li><code>创建 AccessKey</code></li>
<li>记录保存下 <code>ID和Secret</code></li>
</ol>
<h4 id="2-添加ddns"><a href="#2-添加ddns" class="headerlink" title="2. 添加ddns"></a>2. 添加ddns</h4><ol>
<li><code>OpenWrt - 服务 - 动态DNS</code></li>
<li>在输入框中输入：<code>DDNS</code>，点击添加</li>
</ol>
<h4 id="2-基本设置"><a href="#2-基本设置" class="headerlink" title="2. 基本设置"></a>2. 基本设置</h4><ol>
<li>DDNS服务提供商，选择 ：<code>aliyun.com</code>，点击 <code>更改提供者</code></li>
<li>勾选 <code>启动</code></li>
<li>主机名：比如  <code>abc.com</code>  (输入你买的域名)</li>
<li>IP地址版本：<code>IPv6</code></li>
<li>域名： <code>ow.abc.com</code>（输入二级域名）</li>
<li>用户名和密码：刚刚记录的阿里云key  <code>ID和Secret</code></li>
</ol>
<h4 id="3-高级设置"><a href="#3-高级设置" class="headerlink" title="3. 高级设置"></a>3. 高级设置</h4><ol>
<li>切换到高级设置</li>
<li>IP地址来源[IPv6]：<code>接口</code></li>
<li>接口：<code>pppoe-wan</code></li>
<li>保存并应用</li>
</ol>
<h4 id="4-启动"><a href="#4-启动" class="headerlink" title="4. 启动"></a>4. 启动</h4><p>最后，记得在外面点击启用！！</p>
<ul>
<li>出现PID，说话启动成功。</li>
</ul>
<h4 id="5-查看方法"><a href="#5-查看方法" class="headerlink" title="5.查看方法"></a>5.查看方法</h4><ol>
<li>点击 - 修改</li>
<li>日志查看器 - 点击下按钮， <code>读取日志文件</code></li>
<li>拖到最下方</li>
<li>查看日志，是否成功！</li>
</ol>
<blockquote>
<p>记得！需要在OpenWrt中 <code>网络 - DHCP/DNS- 高级设置</code> -  <code>禁止解析IPv6 DNS记录</code> 去掉勾！！！！</p>
</blockquote>
<h3 id="5-阿里云DDNS-脚本方法"><a href="#5-阿里云DDNS-脚本方法" class="headerlink" title="5. 阿里云DDNS - 脚本方法"></a>5. 阿里云DDNS - 脚本方法</h3><h4 id="IPV4"><a href="#IPV4" class="headerlink" title="IPV4"></a>IPV4</h4><h5 id="更智能的脚本"><a href="#更智能的脚本" class="headerlink" title="更智能的脚本"></a>更智能的脚本</h5><p><a href="https://github.com/risfeng/aliyun-ddns-shell" target="_blank" rel="noopener">Github</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">1.下载</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/risfeng/aliyun-ddns-shell.git</span><br><span class="line">2.进入目录</span><br><span class="line"><span class="built_in">cd</span> ./aliyun-ddns-shell</span><br><span class="line">3.给权限</span><br><span class="line">chmod +x ./src/aliyun/aliyun-ddns.sh</span><br><span class="line">4.运行脚本</span><br><span class="line">sh ./src/aliyun/aliyun-ddns.sh</span><br><span class="line"></span><br><span class="line">5.配置===========================================</span><br><span class="line">请输入你的选择（输入数字）:1</span><br><span class="line"></span><br><span class="line">[Info]    2020-12-04 17:30:27 [var_check_online_url]请输入外网检测Ping地址:</span><br><span class="line">(默认:www.baidu.com,如有疑问请输入“-h”查看帮助):-h</span><br><span class="line">[Info]    2020-12-04 17:30:27 [var_check_online_url]外网检测Ping地址-说明</span><br><span class="line">            此参数为检测当前脚本运行环境与外网是否畅通ping使用的地址</span><br><span class="line">            如不了解，请使用默认值：www.baidu.com</span><br><span class="line">[Info]    2020-12-04 17:30:27 [var_check_online_url]请输入外网检测Ping地址:</span><br><span class="line">(默认:www.baidu.com):www.baidu.com</span><br><span class="line"></span><br><span class="line">[Info]    2020-12-04 17:30:27 [var_check_online_retry_times]请输入外网检测失败后重试次数:</span><br><span class="line">(默认:3,如有疑问请输入“-h”查看帮助):3</span><br><span class="line"></span><br><span class="line">[Info]    2020-12-04 17:30:27 [var_first_level_domain]请输入一级域名(示例 demo.com)(*)</span><br><span class="line">(此项为必填,如有疑问请输入“-h”查看帮助):123.vip</span><br><span class="line"></span><br><span class="line">[Info]    2020-12-04 17:30:27 [var_second_level_domain]请输入二级域名(示例 <span class="built_in">test</span>)(*)</span><br><span class="line">(此项为必填,如有疑问请输入“-h”查看帮助):cq</span><br><span class="line"></span><br><span class="line">[Info]    2020-12-04 17:30:27 [var_domain_record_type]请输入解析类型(示例 A)(*)</span><br><span class="line">(此项为必填,如有疑问请输入“-h”查看帮助):A</span><br><span class="line"></span><br><span class="line">[Info]    2020-12-04 17:30:27 [var_domian_ttl]请输入域名解析记录生效时间(TTL Time-To-Live)秒:</span><br><span class="line">(默认600,如有疑问请输入“-h”查看帮助):600</span><br><span class="line"></span><br><span class="line">[Info]    2020-12-04 17:30:27 [var_access_key_id]请输入阿里云AccessKeyId(*)</span><br><span class="line">(此项为必填,如有疑问请输入“-h”查看帮助):LTAI4GC123HqKXDQSmZYn9</span><br><span class="line"></span><br><span class="line">[Info]    2020-12-04 17:30:27 [var_access_key_secret]请输入阿里云AccessKeySecret(*)</span><br><span class="line">(此项为必填,如有疑问请输入“-h”查看帮助):qRC05ETc123syL4SglkC4AgSZTyA</span><br><span class="line"></span><br><span class="line">[Info]    2020-12-04 17:30:27 [var_local_wan_ip]请输入获取本机外网IP使用的命令(默认：只支持ipv4)</span><br><span class="line">(如有疑问请输入“-h”查看帮助):curl ip.sb</span><br><span class="line"></span><br><span class="line">[Info]    2020-12-04 17:30:27 [var_domian_server_ip]请输入获取域名当前解析记录的IP使用的命令(建议默认)</span><br><span class="line">(如有疑问请输入“-h”查看帮助):</span><br><span class="line">[Info]    2020-12-04 17:30:27 输入为空值,已设置执行命令为:“nslookup“</span><br><span class="line"></span><br><span class="line">[Info]    2020-12-04 17:30:27 [var_enable_message_push]请输入是否启用消息通知(钉钉机器人)推送(请输入<span class="literal">true</span>或<span class="literal">false</span>):</span><br><span class="line">(默认<span class="literal">false</span>,如有疑问请输入“-h”查看帮助):</span><br><span class="line">[Info]    2020-12-04 17:30:27 输入为空值,已设置为:<span class="literal">false</span></span><br><span class="line">[Info]    2020-12-04 17:30:27 正在保存配置文件......</span><br><span class="line">[Success] 2020-12-04 17:30:27 配置文件保存成功.</span><br><span class="line"></span><br><span class="line">6.配置定时任务计划   （注意下面的sh的路径，每个人不一样，自己更改路径）</span><br><span class="line">crontab -e</span><br><span class="line">i  <span class="comment"># 编辑</span></span><br><span class="line">*/20 * * * * /root/alidns/aliyun-ddns-shell/src/aliyun/aliyun-ddns.sh -run &gt;&gt; /root/alidns/aliyun-ddns-shell/src/aliyun/crontab-log.log</span><br><span class="line">按esc</span><br><span class="line">：wq  <span class="comment"># 保存</span></span><br><span class="line"></span><br><span class="line">7.如果显示 /var/spool/cron/<span class="comment">#tmp.localhost.XXXXKltUQl: 权限不够</span></span><br><span class="line">则</span><br><span class="line">lsattr /var/spool/cron/  <span class="comment"># 查看是否有特殊的属性</span></span><br><span class="line">chattr -ai /var/spool/cron <span class="comment">#  去掉特殊的属性</span></span><br><span class="line">crontab -e <span class="comment">#  再次编辑定时任务，按上面方法操作，保存后，应该就成功了</span></span><br><span class="line"></span><br><span class="line">8.重新加载配置：</span><br><span class="line">service crond reload</span><br></pre></td></tr></table></figure>

<h5 id="方法二脚本"><a href="#方法二脚本" class="headerlink" title="方法二脚本"></a>方法二脚本</h5><p>详细方法看<a href="#实操，可用">IPV6</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 脚本备用</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ApiId=<span class="string">"LTAI4GC231SHqKXDQSmZYn9"</span></span><br><span class="line">ApiKey=<span class="string">"qRC05ETcV123syL4SglkC4AgSZTyA"</span></span><br><span class="line">Domain=<span class="string">"zkzk.vip"</span></span><br><span class="line">SubDomain=<span class="string">"c"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Nonce=$(date -u <span class="string">"+%N"</span>)	</span><br><span class="line">Timestamp=$(date -u <span class="string">"+%Y-%m-%dT%H%%3A%M%%3A%SZ"</span>)	</span><br><span class="line">Nonce=<span class="variable">$Timestamp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">urlencode</span></span>() &#123;</span><br><span class="line">	<span class="built_in">local</span> raw=<span class="string">"<span class="variable">$1</span>"</span>;</span><br><span class="line">	<span class="built_in">local</span> len=<span class="string">"<span class="variable">$&#123;#raw&#125;</span>"</span></span><br><span class="line">	<span class="built_in">local</span> encoded=<span class="string">""</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> `seq 1 <span class="variable">$len</span>`; <span class="keyword">do</span></span><br><span class="line">		<span class="built_in">local</span> j=$((i+1))</span><br><span class="line">		<span class="built_in">local</span> c=$(<span class="built_in">echo</span> <span class="variable">$raw</span> | cut -c<span class="variable">$i</span>-<span class="variable">$i</span>)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="variable">$c</span> <span class="keyword">in</span> [a-zA-Z0-9.~_-]) ;;</span><br><span class="line">			*)</span><br><span class="line">			c=$(<span class="built_in">printf</span> <span class="string">'%%%02X'</span> <span class="string">"'<span class="variable">$c</span>"</span>) ;;</span><br><span class="line">		<span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">		encoded=<span class="string">"<span class="variable">$encoded</span><span class="variable">$c</span>"</span></span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">echo</span> <span class="variable">$encoded</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># $1 = query string</span></span><br><span class="line"><span class="function"><span class="title">getSignature</span></span>() &#123;</span><br><span class="line">	<span class="built_in">local</span> encodedQuery=$(urlencode <span class="variable">$1</span>)</span><br><span class="line">	<span class="built_in">local</span> message=<span class="string">"GET&amp;%2F&amp;<span class="variable">$encodedQuery</span>"</span></span><br><span class="line">	<span class="built_in">local</span> sig=$(<span class="built_in">echo</span> -n <span class="string">"<span class="variable">$message</span>"</span> | openssl dgst -sha1 -hmac <span class="string">"<span class="variable">$ApiKey</span>&amp;"</span> -binary | openssl base64)</span><br><span class="line">	<span class="built_in">echo</span> $(urlencode <span class="variable">$sig</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">sendRequest</span></span>() &#123;</span><br><span class="line">	<span class="built_in">local</span> sig=$(getSignature <span class="variable">$1</span>)</span><br><span class="line">	<span class="built_in">local</span> result=$(wget -qO- --no-check-certificate --content-on-error <span class="string">"https://alidns.aliyuncs.com?<span class="variable">$1</span>&amp;Signature=<span class="variable">$sig</span>"</span>)</span><br><span class="line">	<span class="built_in">echo</span> <span class="variable">$result</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">getRecordId</span></span>() &#123;</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"获取 <span class="variable">$SubDomain</span>.<span class="variable">$Domain</span> 的 IP..."</span> &gt;&amp;2</span><br><span class="line">	<span class="built_in">local</span> queryString=<span class="string">"AccessKeyId=<span class="variable">$ApiId</span>&amp;Action=DescribeSubDomainRecords&amp;Format=JSON&amp;SignatureMethod=HMAC-SHA1&amp;SignatureNonce=<span class="variable">$Nonce</span>&amp;SignatureVersion=1.0&amp;SubDomain=<span class="variable">$SubDomain</span>.<span class="variable">$Domain</span>&amp;Timestamp=<span class="variable">$Timestamp</span>&amp;Type=A&amp;Version=2015-01-09"</span></span><br><span class="line">	<span class="built_in">local</span> result=$(sendRequest <span class="string">"<span class="variable">$queryString</span>"</span>)</span><br><span class="line">	<span class="built_in">local</span> code=$(<span class="built_in">echo</span> <span class="variable">$result</span> | sed <span class="string">'s/.*,"Code":"\([A-z]*\)",.*/\1/'</span>)</span><br><span class="line">	<span class="built_in">local</span> recordId=$(<span class="built_in">echo</span> <span class="variable">$result</span> | sed <span class="string">'s/.*,"RecordId":"\([0-9]*\)",.*/\1/'</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> [ <span class="string">"<span class="variable">$code</span>"</span> = <span class="string">"<span class="variable">$result</span>"</span> ] &amp;&amp; [ ! <span class="string">"<span class="variable">$recordId</span>"</span> = <span class="string">"<span class="variable">$result</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">local</span> ip=$(<span class="built_in">echo</span> <span class="variable">$result</span> | sed <span class="string">'s/.*,"Value":"\([0-9\.]*\)",.*/\1/'</span>)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> [ <span class="string">"<span class="variable">$ip</span>"</span> == <span class="string">"<span class="variable">$NewIP</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">			<span class="built_in">echo</span> <span class="string">"IP 无变化, 退出脚本..."</span> &gt;&amp;2</span><br><span class="line">			<span class="built_in">echo</span> <span class="string">"quit"</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="built_in">echo</span> <span class="variable">$recordId</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"null"</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># $1 = record ID, $2 = new IP</span></span><br><span class="line"><span class="function"><span class="title">updateRecord</span></span>() &#123;</span><br><span class="line">	<span class="built_in">local</span> queryString=<span class="string">"AccessKeyId=<span class="variable">$ApiId</span>&amp;Action=UpdateDomainRecord&amp;DomainName=<span class="variable">$Domain</span>&amp;Format=JSON&amp;RR=<span class="variable">$SubDomain</span>&amp;RecordId=<span class="variable">$1</span>&amp;SignatureMethod=HMAC-SHA1&amp;SignatureNonce=<span class="variable">$Nonce</span>&amp;SignatureVersion=1.0&amp;Timestamp=<span class="variable">$Timestamp</span>&amp;Type=A&amp;Value=<span class="variable">$2</span>&amp;Version=2015-01-09"</span></span><br><span class="line">	<span class="built_in">local</span> result=$(sendRequest <span class="variable">$queryString</span>)</span><br><span class="line">	<span class="built_in">local</span> code=$(<span class="built_in">echo</span> <span class="variable">$result</span> | sed <span class="string">'s/.*,"Code":"\([A-z]*\)",.*/\1/'</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> [ <span class="string">"<span class="variable">$code</span>"</span> = <span class="string">"<span class="variable">$result</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"<span class="variable">$SubDomain</span>.<span class="variable">$Domain</span> 已指向 <span class="variable">$NewIP</span>."</span> &gt;&amp;2</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"更新失败."</span> &gt;&amp;2</span><br><span class="line">		<span class="built_in">echo</span> <span class="variable">$result</span> &gt;&amp;2</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># $1 = new IP</span></span><br><span class="line"><span class="function"><span class="title">addRecord</span></span>() &#123;</span><br><span class="line">	<span class="built_in">local</span> queryString=<span class="string">"AccessKeyId=<span class="variable">$ApiId</span>&amp;Action=AddDomainRecord&amp;DomainName=<span class="variable">$Domain</span>&amp;Format=JSON&amp;RR=<span class="variable">$SubDomain</span>&amp;SignatureMethod=HMAC-SHA1&amp;SignatureNonce=<span class="variable">$Nonce</span>&amp;SignatureVersion=1.0&amp;Timestamp=<span class="variable">$Timestamp</span>&amp;Type=A&amp;Value=<span class="variable">$1</span>&amp;Version=2015-01-09"</span></span><br><span class="line">	<span class="built_in">local</span> result=$(sendRequest <span class="variable">$queryString</span>)</span><br><span class="line">	<span class="built_in">local</span> code=$(<span class="built_in">echo</span> <span class="variable">$result</span> | sed <span class="string">'s/.*,"Code":"\([A-z]*\)",.*/\1/'</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> [ <span class="string">"<span class="variable">$code</span>"</span> = <span class="string">"<span class="variable">$result</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"<span class="variable">$SubDomain</span>.<span class="variable">$Domain</span> 已指向 <span class="variable">$NewIP</span>."</span> &gt;&amp;2</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"添加失败."</span> &gt;&amp;2</span><br><span class="line">		<span class="built_in">echo</span> <span class="variable">$result</span> &gt;&amp;2</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get new IP address</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"获取当前 IP..."</span></span><br><span class="line">NewIP=$(curl ip.sb)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"当前 IP 为 <span class="variable">$NewIP</span>."</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Get record ID of sub domain</span></span><br><span class="line">recordId=$(getRecordId)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! <span class="string">"<span class="variable">$recordId</span>"</span> = <span class="string">"quit"</span> ]; <span class="keyword">then</span></span><br><span class="line">	<span class="keyword">if</span> [ <span class="string">"<span class="variable">$recordId</span>"</span> = <span class="string">"null"</span> ]; <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"域名记录不存在, 添加 <span class="variable">$SubDomain</span>.<span class="variable">$Domain</span> 至 <span class="variable">$NewIP</span>..."</span></span><br><span class="line">		addRecord <span class="variable">$NewIP</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"域名记录已存在, 更新 <span class="variable">$SubDomain</span>.<span class="variable">$Domain</span> 至 <span class="variable">$NewIP</span>..."</span></span><br><span class="line">		updateRecord <span class="variable">$recordId</span> <span class="variable">$NewIP</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>





<h4 id="IPV6"><a href="#IPV6" class="headerlink" title="IPV6"></a>IPV6</h4><p>阿里云+ 群晖+ddns +ipv6</p>
<p><strong>脚本参考：</strong><a href="https://raw.githubusercontent.com/AirInSpace/ribsnetwork/master/ddns/aliyun_ipv6.sh" target="_blank" rel="noopener">这里</a></p>
<p>但是获取的IPv6好像不行，我换了一个IPv6的获取方式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NewIP=$(ip addr show|grep -v deprecated|grep -A1 <span class="string">'inet6 [^f:]'</span>|sed -nr <span class="string">':a;N;s#^ +inet6 ([a-f0-9:]+)/.+? scope global .*? valid_lft ([0-9]+sec) .*#\2 \1#p;ta'</span>|grep <span class="string">'ff:fe'</span>|sort -nr|head -n1|cut -d<span class="string">' '</span> -f2)</span><br></pre></td></tr></table></figure>

<h5 id="实操，可用"><a href="#实操，可用" class="headerlink" title="实操，可用"></a>实操，可用</h5><ol>
<li><p>下载脚本，下面是脚本备份</p>
</li>
<li><p>把sh脚本通过 <code>File Station</code>上传到 群晖文件夹，看下属性（脚本的完整地址）</p>
</li>
<li><p>如果是自己拷贝到txt文件中，再上传，可能会出现错误</p>
<ul>
<li>运行脚本文件报错<code>.sh: line 1: $&#39;\r&#39;: command not found</code></li>
<li>解决办法：需要使用命令  <code>sed -i &#39;s/\r$//&#39; filename</code><ul>
<li><code>sed -i &#39;s/\r$//&#39; alidnsipv6.sh</code></li>
</ul>
</li>
</ul>
</li>
<li><p>群晖中添加计划 - 自定义脚本</p>
<ol>
<li><p>时间，随意，30分钟-1小时执行一次都可以</p>
</li>
<li><p><code>注意脚本的命令填写</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sh 脚本文件地址 &#123;AccessKeyId&#125; &#123;AccessKeySecret&#125; 顶级域名 子域名</span><br><span class="line"><span class="comment">#要注意空格，每个子域名一行，</span></span><br><span class="line"><span class="comment">#比如</span></span><br><span class="line">sh /volume1/homes/admin/alidns/alidnsipv6.sh LTAI4G4323412s7dC7uwzr g8FvrQJdR234·121237NB zk1.vip qh</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>添加完成后，执行一次，看看效果</p>
</li>
</ol>
<blockquote>
<p>小技巧，执行时，看不到反馈，可以在任务计划中，设置，保存输出结果</p>
<p>执行后，可以到结果那里看看，有什么提示。</p>
<p>完整方法：可以参考 <a href="https://post.smzdm.com/p/646325/" target="_blank" rel="noopener">这里</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 脚本备用  IPv6</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$1</span> ]; <span class="keyword">then</span></span><br><span class="line">	ApiId=<span class="variable">$1</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$2</span> ]; <span class="keyword">then</span></span><br><span class="line">	ApiKey=<span class="variable">$2</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$3</span> ]; <span class="keyword">then</span></span><br><span class="line">	Domain=<span class="variable">$3</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$ApiId</span>"</span> -o -z <span class="string">"<span class="variable">$ApiKey</span>"</span> -o -z <span class="string">"<span class="variable">$Domain</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"参数缺失"</span></span><br><span class="line">	<span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$4</span> ]; <span class="keyword">then</span></span><br><span class="line">	SubDomain=<span class="variable">$4</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$SubDomain</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">	SubDomain=<span class="string">"%40"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">Timestamp=$(date -u <span class="string">"+%Y-%m-%dT%H%%3A%M%%3A%SZ"</span>)	<span class="comment"># SB 阿里云, 什么鬼时间格式</span></span><br><span class="line"><span class="comment">#Nonce=$Timestamp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">urlencode</span></span>() &#123;</span><br><span class="line">	<span class="built_in">local</span> raw=<span class="string">"<span class="variable">$1</span>"</span>;</span><br><span class="line">	<span class="built_in">local</span> len=<span class="string">"<span class="variable">$&#123;#raw&#125;</span>"</span></span><br><span class="line">	<span class="built_in">local</span> encoded=<span class="string">""</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> `seq 1 <span class="variable">$len</span>`; <span class="keyword">do</span></span><br><span class="line">		<span class="built_in">local</span> j=$((i+1))</span><br><span class="line">		<span class="built_in">local</span> c=$(<span class="built_in">echo</span> <span class="variable">$raw</span> | cut -c<span class="variable">$i</span>-<span class="variable">$i</span>)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="variable">$c</span> <span class="keyword">in</span> [a-zA-Z0-9.~_-]) ;;</span><br><span class="line">			*)</span><br><span class="line">			c=$(<span class="built_in">printf</span> <span class="string">'%%%02X'</span> <span class="string">"'<span class="variable">$c</span>"</span>) ;;</span><br><span class="line">		<span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">		encoded=<span class="string">"<span class="variable">$encoded</span><span class="variable">$c</span>"</span></span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">echo</span> <span class="variable">$encoded</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># $1 = query string</span></span><br><span class="line"><span class="function"><span class="title">getSignature</span></span>() &#123;</span><br><span class="line">	<span class="built_in">local</span> encodedQuery=$(urlencode <span class="variable">$1</span>)</span><br><span class="line">	<span class="built_in">local</span> message=<span class="string">"GET&amp;%2F&amp;<span class="variable">$encodedQuery</span>"</span></span><br><span class="line">	<span class="built_in">local</span> sig=$(<span class="built_in">echo</span> -n <span class="string">"<span class="variable">$message</span>"</span> | openssl dgst -sha1 -hmac <span class="string">"<span class="variable">$ApiKey</span>&amp;"</span> -binary | openssl base64)</span><br><span class="line">	<span class="built_in">echo</span> $(urlencode <span class="variable">$sig</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">sendRequest</span></span>() &#123;</span><br><span class="line">	<span class="built_in">local</span> sig=$(getSignature <span class="variable">$1</span>)</span><br><span class="line">	<span class="built_in">local</span> result=$(wget -qO- --no-check-certificate --content-on-error <span class="string">"https://alidns.aliyuncs.com?<span class="variable">$1</span>&amp;Signature=<span class="variable">$sig</span>"</span>)</span><br><span class="line">	<span class="built_in">echo</span> <span class="variable">$result</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">getRecordId</span></span>() &#123;</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"获取 <span class="variable">$SubDomain</span>.<span class="variable">$Domain</span> 的 IP..."</span> &gt;&amp;2</span><br><span class="line">	Nonce=$(date -u <span class="string">"+%N"</span>)</span><br><span class="line">	<span class="built_in">local</span> queryString=<span class="string">"AccessKeyId=<span class="variable">$ApiId</span>&amp;Action=DescribeSubDomainRecords&amp;Format=JSON&amp;SignatureMethod=HMAC-SHA1&amp;SignatureNonce=<span class="variable">$Nonce</span>&amp;SignatureVersion=1.0&amp;SubDomain=<span class="variable">$SubDomain</span>.<span class="variable">$Domain</span>&amp;Timestamp=<span class="variable">$Timestamp</span>&amp;Type=AAAA&amp;Version=2015-01-09"</span></span><br><span class="line">	<span class="built_in">local</span> result=$(sendRequest <span class="string">"<span class="variable">$queryString</span>"</span>)</span><br><span class="line">	<span class="built_in">local</span> code=$(<span class="built_in">echo</span> <span class="variable">$result</span> | sed <span class="string">'s/.*,"Code":"\([A-z]*\)",.*/\1/'</span>)</span><br><span class="line">	<span class="built_in">local</span> recordId=$(<span class="built_in">echo</span> <span class="variable">$result</span> | sed <span class="string">'s/.*,"RecordId":"\([0-9]*\)",.*/\1/'</span>)</span><br><span class="line">	<span class="keyword">if</span> [ <span class="string">"<span class="variable">$code</span>"</span> = <span class="string">"<span class="variable">$result</span>"</span> ] &amp;&amp; [ ! <span class="string">"<span class="variable">$recordId</span>"</span> = <span class="string">"<span class="variable">$result</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">local</span> ip=$(<span class="built_in">echo</span> <span class="variable">$result</span> | sed <span class="string">'s/.*,"Value":"\([a-f0-9:]*\)",.*/\1/'</span>)</span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"当前DNS的IP为<span class="variable">$ip</span>"</span> &gt;&amp;2</span><br><span class="line">		<span class="keyword">if</span> [ <span class="string">"<span class="variable">$ip</span>"</span> == <span class="string">"<span class="variable">$NewIP</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">			<span class="built_in">echo</span> <span class="string">"IP 无变化, 退出脚本..."</span> &gt;&amp;2</span><br><span class="line">			<span class="built_in">echo</span> <span class="string">"quit"</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="built_in">echo</span> <span class="string">"recordId:<span class="variable">$recordId</span>"</span> &gt;&amp;2</span><br><span class="line">			<span class="built_in">echo</span> <span class="variable">$recordId</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"null"</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># $1 = record ID, $2 = new IP</span></span><br><span class="line"><span class="function"><span class="title">updateRecord</span></span>() &#123;</span><br><span class="line">	Nonce=$(date -u <span class="string">"+%N"</span>)</span><br><span class="line">	<span class="built_in">local</span> ipv6addr=$(<span class="built_in">echo</span> <span class="variable">$2</span>| sed <span class="string">'s/:/%3A/g'</span>)</span><br><span class="line">	<span class="built_in">local</span> queryString=<span class="string">"AccessKeyId=<span class="variable">$ApiId</span>&amp;Action=UpdateDomainRecord&amp;Format=JSON&amp;RR=<span class="variable">$SubDomain</span>&amp;RecordId=<span class="variable">$1</span>&amp;SignatureMethod=HMAC-SHA1&amp;SignatureNonce=<span class="variable">$Nonce</span>&amp;SignatureVersion=1.0&amp;Timestamp=<span class="variable">$Timestamp</span>&amp;Type=AAAA&amp;Value=<span class="variable">$ipv6addr</span>&amp;Version=2015-01-09"</span></span><br><span class="line">	<span class="built_in">local</span> result=$(sendRequest <span class="variable">$queryString</span>)</span><br><span class="line">	<span class="built_in">local</span> code=$(<span class="built_in">echo</span> <span class="variable">$result</span> | sed <span class="string">'s/.*,"Code":"\([A-z]*\)",.*/\1/'</span>)</span><br><span class="line">	<span class="keyword">if</span> [ <span class="string">"<span class="variable">$code</span>"</span> = <span class="string">"<span class="variable">$result</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"<span class="variable">$SubDomain</span>.<span class="variable">$Domain</span> 已指向 <span class="variable">$NewIP</span>."</span> &gt;&amp;2</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"更新失败."</span> &gt;&amp;2</span><br><span class="line">		<span class="built_in">echo</span> <span class="variable">$result</span> &gt;&amp;2</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># $1 = new IP</span></span><br><span class="line"><span class="function"><span class="title">addRecord</span></span>() &#123;</span><br><span class="line">	Nonce=$(date -u <span class="string">"+%N"</span>)</span><br><span class="line">	<span class="built_in">local</span> ipv6addr=$(<span class="built_in">echo</span> <span class="variable">$1</span>| sed <span class="string">'s/:/%3A/g'</span>)</span><br><span class="line">	<span class="built_in">local</span> queryString=<span class="string">"AccessKeyId=<span class="variable">$ApiId</span>&amp;Action=AddDomainRecord&amp;DomainName=<span class="variable">$Domain</span>&amp;Format=JSON&amp;RR=<span class="variable">$SubDomain</span>&amp;SignatureMethod=HMAC-SHA1&amp;SignatureNonce=<span class="variable">$Nonce</span>&amp;SignatureVersion=1.0&amp;Timestamp=<span class="variable">$Timestamp</span>&amp;Type=AAAA&amp;Value=<span class="variable">$ipv6addr</span>&amp;Version=2015-01-09"</span></span><br><span class="line">	<span class="built_in">local</span> result=$(sendRequest <span class="variable">$queryString</span>)</span><br><span class="line">	<span class="built_in">local</span> code=$(<span class="built_in">echo</span> <span class="variable">$result</span> | sed <span class="string">'s/.*,"Code":"\([A-z]*\)",.*/\1/'</span>)</span><br><span class="line">	<span class="keyword">if</span> [ <span class="string">"<span class="variable">$code</span>"</span> = <span class="string">"<span class="variable">$result</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"<span class="variable">$SubDomain</span>.<span class="variable">$Domain</span> 已指向 <span class="variable">$NewIP</span>."</span> &gt;&amp;2</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"添加失败."</span> &gt;&amp;2</span><br><span class="line">		<span class="built_in">echo</span> <span class="variable">$result</span> &gt;&amp;2</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get new IP address</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"获取当前 IP..."</span></span><br><span class="line">NewIP=$(ip addr show|grep -v deprecated|grep -A1 <span class="string">'inet6 [^f:]'</span>|sed -nr <span class="string">':a;N;s#^ +inet6 ([a-f0-9:]+)/.+? scope global .*? valid_lft ([0-9]+sec) .*#\2 \1#p;ta'</span>|grep <span class="string">'ff:fe'</span>|sort -nr|head -n1|cut -d<span class="string">' '</span> -f2)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"当前 IP 为 <span class="variable">$NewIP</span>."</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Get record ID of sub domain</span></span><br><span class="line">recordId=$(getRecordId)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! <span class="string">"<span class="variable">$recordId</span>"</span> = <span class="string">"quit"</span> ]; <span class="keyword">then</span></span><br><span class="line">	<span class="keyword">if</span> [ <span class="string">"<span class="variable">$recordId</span>"</span> = <span class="string">"null"</span> ]; <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"域名记录不存在, 添加 <span class="variable">$SubDomain</span>.<span class="variable">$Domain</span> 至 <span class="variable">$NewIP</span>..."</span></span><br><span class="line">		addRecord <span class="variable">$NewIP</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"域名记录已存在, 更新 <span class="variable">$SubDomain</span>.<span class="variable">$Domain</span> 至 <span class="variable">$NewIP</span>..."</span></span><br><span class="line">		updateRecord <span class="variable">$recordId</span> <span class="variable">$NewIP</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>





<h5 id="其他IPV6脚本备份"><a href="#其他IPV6脚本备份" class="headerlink" title="其他IPV6脚本备份"></a>其他IPV6脚本备份</h5><p>参考：<a href="https://blog.zeruns.tech/archives/263.html" target="_blank" rel="noopener">Zeruns’s Blog</a></p>
<p>文章中还有IPv4，这里就不写了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">aliddnsipv6_ak=<span class="string">"AccessKeyId"</span><span class="comment">#引号里改成刚刚申请的AccessKeyId</span></span><br><span class="line">aliddnsipv6_sk=<span class="string">"Access Key Secret"</span><span class="comment">#引号里改成刚刚申请的Access Key Secret</span></span><br><span class="line">aliddnsipv6_name1=<span class="string">'subDomainName'</span><span class="comment">#引号里改成自定义一个名字，需要符合域名规范</span></span><br><span class="line">aliddnsipv6_domain=<span class="string">'domainName'</span> <span class="comment">#引号里改成自己注册的域名</span></span><br><span class="line">aliddnsipv6_ttl=<span class="string">"600"</span></span><br><span class="line"><span class="comment">#举例，你在万网注册了一个域名叫zeruns.tech，那么aliddnsipv6_domain后面就填zeruns.tech,然后再自己想一个名字，比如blog，然后填到aliddnsipv6_name1后面，那么一会你访问群晖的地址就是http://blog.zeruns.tech:5000</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$aliddnsipv6_name1</span>"</span> = <span class="string">"@"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  aliddnsipv6_name=<span class="variable">$aliddnsipv6_domain</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  aliddnsipv6_name=<span class="variable">$aliddnsipv6_name1</span>.<span class="variable">$aliddnsipv6_domain</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">now=`date`</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">die</span></span> () &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ipv6s=`ip addr show ovs_eth0 | grep <span class="string">"inet6.*global"</span> | awk <span class="string">'&#123;print $2&#125;'</span> | awk -F<span class="string">"/"</span> <span class="string">'&#123;print $1&#125;'</span>` || die <span class="string">"<span class="variable">$ipv6</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ipv6 <span class="keyword">in</span> <span class="variable">$ipv6s</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="comment">#ipv6 = $ipv6</span></span><br><span class="line">  <span class="built_in">break</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$ipv6</span></span><br><span class="line"></span><br><span class="line">current_ipv6=`nslookup -query=AAAA <span class="variable">$aliddnsipv6_name</span> 2&gt;&amp;1`</span><br><span class="line"><span class="comment">#echo $current_ipv6</span></span><br><span class="line"></span><br><span class="line">current_ipv6=`<span class="built_in">echo</span> <span class="string">"<span class="variable">$current_ipv6</span>"</span> | grep <span class="string">'Address: '</span> | tail -n1 | awk <span class="string">'&#123;print $NF&#125;'</span>`</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$current_ipv6</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"$?"</span> -eq <span class="string">"0"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    current_ipv6=`<span class="built_in">echo</span> <span class="string">"<span class="variable">$current_ipv6</span>"</span> | grep <span class="string">'Address: '</span> | tail -n1 | awk <span class="string">'&#123;print $NF&#125;'</span>`</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$current_ipv6</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$ipv6</span>"</span> = <span class="string">"<span class="variable">$current_ipv6</span>"</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"skipping"</span></span><br><span class="line">    <span class="keyword">fi</span> </span><br><span class="line"><span class="comment"># fix when A record removed by manual dns is always update error</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">unset</span> aliddnsipv6_record_id</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">timestamp=`date -u <span class="string">"+%Y-%m-%dT%H%%3A%M%%3A%SZ"</span>`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">urlencode</span></span>() &#123;</span><br><span class="line">    <span class="comment"># urlencode &lt;string&gt;</span></span><br><span class="line">    out=<span class="string">""</span></span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">read</span> -n1 c</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">case</span> <span class="variable">$c</span> <span class="keyword">in</span></span><br><span class="line">            [a-zA-Z0-9._-]) out=<span class="string">"<span class="variable">$out</span><span class="variable">$c</span>"</span> ;;</span><br><span class="line">            *) out=<span class="string">"<span class="variable">$out</span>`printf '%%%02X' "</span><span class="string">'$c"`" ;;</span></span><br><span class="line"><span class="string">        esac</span></span><br><span class="line"><span class="string">    done</span></span><br><span class="line"><span class="string">    echo -n $out</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">enc() &#123;</span></span><br><span class="line"><span class="string">    echo -n "$1" | urlencode</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">send_request() &#123;</span></span><br><span class="line"><span class="string">    local args="AccessKeyId=$aliddnsipv6_ak&amp;Action=$1&amp;Format=json&amp;$2&amp;Version=2015-01-09"</span></span><br><span class="line"><span class="string">    local hash=$(echo -n "GET&amp;%2F&amp;$(enc "$args")" | openssl dgst -sha1 -hmac "$aliddnsipv6_sk&amp;" -binary | openssl base64)</span></span><br><span class="line"><span class="string">    curl -s "http://alidns.aliyuncs.com/?$args&amp;Signature=$(enc "$hash")"</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">get_recordid() &#123;</span></span><br><span class="line"><span class="string">    grep -Eo '</span><span class="string">"RecordId"</span>:<span class="string">"[0-9]+"</span><span class="string">' | cut -d'</span>:<span class="string">' -f2 | tr -d '</span><span class="string">"'</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">query_recordid() &#123;</span></span><br><span class="line"><span class="string">    send_request "</span>DescribeSubDomainRecords<span class="string">" "</span>SignatureMethod=HMAC-SHA1&amp;SignatureNonce=<span class="variable">$timestamp</span>&amp;SignatureVersion=1.0&amp;SubDomain=<span class="variable">$aliddnsipv6_name</span>&amp;Timestamp=<span class="variable">$timestamp</span>&amp;Type=AAAA<span class="string">"</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">update_record() &#123;</span></span><br><span class="line"><span class="string">    send_request "</span>UpdateDomainRecord<span class="string">" "</span>RR=<span class="variable">$aliddnsipv6_name1</span>&amp;RecordId=<span class="variable">$1</span>&amp;SignatureMethod=HMAC-SHA1&amp;SignatureNonce=<span class="variable">$timestamp</span>&amp;SignatureVersion=1.0&amp;TTL=<span class="variable">$aliddnsipv6_ttl</span>&amp;Timestamp=<span class="variable">$timestamp</span>&amp;Type=AAAA&amp;Value=$(enc <span class="variable">$ipv6</span>)<span class="string">"</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">add_record() &#123;</span></span><br><span class="line"><span class="string">    send_request "</span>AddDomainRecord&amp;DomainName=<span class="variable">$aliddnsipv6_domain</span><span class="string">" "</span>RR=<span class="variable">$aliddnsipv6_name1</span>&amp;SignatureMethod=HMAC-SHA1&amp;SignatureNonce=<span class="variable">$timestamp</span>&amp;SignatureVersion=1.0&amp;TTL=<span class="variable">$aliddnsipv6_ttl</span>&amp;Timestamp=<span class="variable">$timestamp</span>&amp;Type=AAAA&amp;Value=$(enc <span class="variable">$ipv6</span>)<span class="string">"</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#add support */%2A and @/%40 record</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#https://blog.zeruns.tech</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if [ "</span><span class="variable">$aliddnsipv6_record_id</span><span class="string">" = "</span><span class="string">" ]</span></span><br><span class="line"><span class="string">then</span></span><br><span class="line"><span class="string">    aliddnsipv6_record_id=`query_recordid | get_recordid`</span></span><br><span class="line"><span class="string">    #echo '-----------------' <span class="variable">$aliddnsipv6_record_id</span></span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">if [ "</span><span class="variable">$aliddnsipv6_record_id</span><span class="string">" = "</span><span class="string">" ]</span></span><br><span class="line"><span class="string">then</span></span><br><span class="line"><span class="string">    aliddnsipv6_record_id=`add_record | get_recordid`</span></span><br><span class="line"><span class="string">    echo "</span>added record <span class="variable">$aliddnsipv6_record_id</span><span class="string">"</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">    update_record <span class="variable">$aliddnsipv6_record_id</span></span></span><br><span class="line"><span class="string">    echo "</span>updated record <span class="variable">$aliddnsipv6_record_id</span><span class="string">"</span></span><br><span class="line"><span class="string">fi</span></span><br></pre></td></tr></table></figure>

<h3 id="6-Windows方法-Aliyun-Python"><a href="#6-Windows方法-Aliyun-Python" class="headerlink" title="6. Windows方法 - Aliyun+Python"></a>6. Windows方法 - <code>Aliyun+Python</code></h3><p>参考：<a href="https://blog.zeruns.tech/archives/507.html" target="_blank" rel="noopener">Python实现阿里云域名DDNS支持ipv4和ipv6</a></p>
<ol>
<li>阿里云获取accessKeyId和accessSecret</li>
<li>编辑修改Python代码</li>
<li>运行该代码</li>
<li>定时计划该代码（定时计划看<a href="#Windows定时计划">下面</a>）</li>
</ol>
<h4 id="Python代码备份"><a href="#Python代码备份" class="headerlink" title="Python代码备份"></a>Python代码备份</h4><p><a href="https://github.com/zeruns/-Python-aliddns_ipv4-ipv6" target="_blank" rel="noopener">github</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>安装Python</span><br><span class="line"><span class="number">2.</span>安装Python 的库</span><br><span class="line">pip install aliyun-python-sdk-core-v3</span><br><span class="line">pip install aliyun-python-sdk-domain</span><br><span class="line">pip install aliyun-python-sdk-alidns</span><br><span class="line">pip install requests</span><br><span class="line"><span class="number">3.</span>代码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> aliyunsdkcore.client <span class="keyword">import</span> AcsClient</span><br><span class="line"><span class="keyword">from</span> aliyunsdkcore.acs_exception.exceptions <span class="keyword">import</span> ClientException</span><br><span class="line"><span class="keyword">from</span> aliyunsdkcore.acs_exception.exceptions <span class="keyword">import</span> ServerException</span><br><span class="line"><span class="keyword">from</span> aliyunsdkalidns.request.v20150109.DescribeSubDomainRecordsRequest <span class="keyword">import</span> DescribeSubDomainRecordsRequest</span><br><span class="line"><span class="keyword">from</span> aliyunsdkalidns.request.v20150109.DescribeDomainRecordsRequest <span class="keyword">import</span> DescribeDomainRecordsRequest</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">ipv4_flag = <span class="number">1</span>  <span class="comment"># 是否开启ipv4 ddns解析,1为开启，0为关闭</span></span><br><span class="line">ipv6_flag = <span class="number">0</span>  <span class="comment"># 是否开启ipv6 ddns解析,1为开启，0为关闭</span></span><br><span class="line">accessKeyId = <span class="string">"LTAI4GJzU123ZANeDigao"</span>  <span class="comment"># 将accessKeyId改成自己的accessKeyId</span></span><br><span class="line">accessSecret = <span class="string">"YGkjDSqU123L1XIydETlmZ"</span>  <span class="comment"># 将accessSecret改成自己的accessSecret</span></span><br><span class="line">domain = <span class="string">"123.vip"</span>  <span class="comment"># 你的主域名</span></span><br><span class="line">name_ipv4 = <span class="string">"cq"</span>  <span class="comment"># 要进行ipv4 ddns解析的子域名</span></span><br><span class="line">name_ipv6 = <span class="string">"ipv6.test"</span>  <span class="comment"># 要进行ipv6 ddns解析的子域名</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">client = AcsClient(accessKeyId, accessSecret, <span class="string">'cn-hangzhou'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(RecordId, RR, Type, Value)</span>:</span>  <span class="comment"># 修改域名解析记录</span></span><br><span class="line">    <span class="keyword">from</span> aliyunsdkalidns.request.v20150109.UpdateDomainRecordRequest <span class="keyword">import</span> UpdateDomainRecordRequest</span><br><span class="line">    request = UpdateDomainRecordRequest()</span><br><span class="line">    request.set_accept_format(<span class="string">'json'</span>)</span><br><span class="line">    request.set_RecordId(RecordId)</span><br><span class="line">    request.set_RR(RR)</span><br><span class="line">    request.set_Type(Type)</span><br><span class="line">    request.set_Value(Value)</span><br><span class="line">    response = client.do_action_with_exception(request)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(DomainName, RR, Type, Value)</span>:</span>  <span class="comment"># 添加新的域名解析记录</span></span><br><span class="line">    <span class="keyword">from</span> aliyunsdkalidns.request.v20150109.AddDomainRecordRequest <span class="keyword">import</span> AddDomainRecordRequest</span><br><span class="line">    request = AddDomainRecordRequest()</span><br><span class="line">    request.set_accept_format(<span class="string">'json'</span>)</span><br><span class="line">    request.set_DomainName(DomainName)</span><br><span class="line">    request.set_RR(RR)  <span class="comment"># https://blog.zeruns.tech</span></span><br><span class="line">    request.set_Type(Type)</span><br><span class="line">    request.set_Value(Value)</span><br><span class="line">    response = client.do_action_with_exception(request)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ipv4_flag == <span class="number">1</span>:</span><br><span class="line">    request = DescribeSubDomainRecordsRequest()</span><br><span class="line">    request.set_accept_format(<span class="string">'json'</span>)</span><br><span class="line">    request.set_DomainName(domain)</span><br><span class="line">    request.set_SubDomain(name_ipv4 + <span class="string">'.'</span> + domain)</span><br><span class="line">    response = client.do_action_with_exception(request)  <span class="comment"># 获取域名解析记录列表</span></span><br><span class="line">    domain_list = json.loads(response)  <span class="comment"># 将返回的JSON数据转化为Python能识别的</span></span><br><span class="line"></span><br><span class="line">    ip = urlopen(<span class="string">'https://api-ipv4.ip.sb/ip'</span>).read()  <span class="comment"># 使用IP.SB的接口获取ipv4地址</span></span><br><span class="line">    ipv4 = str(ip, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">    print(<span class="string">"获取到IPv4地址：%s"</span> % ipv4)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> domain_list[<span class="string">'TotalCount'</span>] == <span class="number">0</span>:</span><br><span class="line">        add(domain, name_ipv4, <span class="string">"A"</span>, ipv4)</span><br><span class="line">        print(<span class="string">"新建域名解析成功"</span>)</span><br><span class="line">    <span class="keyword">elif</span> domain_list[<span class="string">'TotalCount'</span>] == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> domain_list[<span class="string">'DomainRecords'</span>][<span class="string">'Record'</span>][<span class="number">0</span>][<span class="string">'Value'</span>].strip() != ipv4.strip():</span><br><span class="line">            update(domain_list[<span class="string">'DomainRecords'</span>][<span class="string">'Record'</span>][<span class="number">0</span>][<span class="string">'RecordId'</span>], name_ipv4, <span class="string">"A"</span>, ipv4)</span><br><span class="line">            print(<span class="string">"修改域名解析成功"</span>)</span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># https://blog.zeruns.tech</span></span><br><span class="line">            print(<span class="string">"IPv4地址没变"</span>)</span><br><span class="line">    <span class="keyword">elif</span> domain_list[<span class="string">'TotalCount'</span>] &gt; <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">from</span> aliyunsdkalidns.request.v20150109.DeleteSubDomainRecordsRequest <span class="keyword">import</span> DeleteSubDomainRecordsRequest</span><br><span class="line">        request = DeleteSubDomainRecordsRequest()</span><br><span class="line">        request.set_accept_format(<span class="string">'json'</span>)</span><br><span class="line">        request.set_DomainName(domain)  <span class="comment"># https://blog.zeruns.tech</span></span><br><span class="line">        request.set_RR(name_ipv4)</span><br><span class="line">        response = client.do_action_with_exception(request)</span><br><span class="line">        add(domain, name_ipv4, <span class="string">"A"</span>, ipv4)</span><br><span class="line">        print(<span class="string">"修改域名解析成功"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ipv6_flag == <span class="number">1</span>:</span><br><span class="line">    request = DescribeSubDomainRecordsRequest()</span><br><span class="line">    request.set_accept_format(<span class="string">'json'</span>)</span><br><span class="line">    request.set_DomainName(domain)</span><br><span class="line">    request.set_SubDomain(name_ipv6 + <span class="string">'.'</span> + domain)</span><br><span class="line">    response = client.do_action_with_exception(request)  <span class="comment"># 获取域名解析记录列表</span></span><br><span class="line">    domain_list = json.loads(response)  <span class="comment"># 将返回的JSON数据转化为Python能识别的</span></span><br><span class="line"></span><br><span class="line">    ip = urlopen(<span class="string">'https://api-ipv6.ip.sb/ip'</span>).read()  <span class="comment"># 使用IP.SB的接口获取ipv6地址</span></span><br><span class="line">    ipv6 = str(ip, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">    print(<span class="string">"获取到IPv6地址：%s"</span> % ipv6)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> domain_list[<span class="string">'TotalCount'</span>] == <span class="number">0</span>:</span><br><span class="line">        add(domain, name_ipv6, <span class="string">"AAAA"</span>, ipv6)</span><br><span class="line">        print(<span class="string">"新建域名解析成功"</span>)</span><br><span class="line">    <span class="keyword">elif</span> domain_list[<span class="string">'TotalCount'</span>] == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> domain_list[<span class="string">'DomainRecords'</span>][<span class="string">'Record'</span>][<span class="number">0</span>][<span class="string">'Value'</span>].strip() != ipv6.strip():</span><br><span class="line">            update(domain_list[<span class="string">'DomainRecords'</span>][<span class="string">'Record'</span>][<span class="number">0</span>][<span class="string">'RecordId'</span>], name_ipv6, <span class="string">"AAAA"</span>, ipv6)</span><br><span class="line">            print(<span class="string">"修改域名解析成功"</span>)</span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># https://blog.zeruns.tech</span></span><br><span class="line">            print(<span class="string">"IPv6地址没变"</span>)</span><br><span class="line">    <span class="keyword">elif</span> domain_list[<span class="string">'TotalCount'</span>] &gt; <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">from</span> aliyunsdkalidns.request.v20150109.DeleteSubDomainRecordsRequest <span class="keyword">import</span> DeleteSubDomainRecordsRequest</span><br><span class="line">        request = DeleteSubDomainRecordsRequest()</span><br><span class="line">        request.set_accept_format(<span class="string">'json'</span>)</span><br><span class="line">        request.set_DomainName(domain)</span><br><span class="line">        request.set_RR(name_ipv6)  <span class="comment"># https://blog.zeruns.tech</span></span><br><span class="line">        response = client.do_action_with_exception(request)</span><br><span class="line">        add(domain, name_ipv6, <span class="string">"AAAA"</span>, ipv6)</span><br><span class="line">        print(<span class="string">"修改域名解析成功"</span>)</span><br></pre></td></tr></table></figure>



<h3 id="7-Linux系统通用"><a href="#7-Linux系统通用" class="headerlink" title="7.Linux系统通用"></a>7.Linux系统通用</h3><p>群晖和Linux系统都能用</p>
<ol>
<li><p>域名用CloudFlare的DNS，</p>
</li>
<li><p>CloudFlare加入你的域名，并申请API的Key</p>
</li>
<li><p>先添加个DNS记录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.点击域名控制面板的「DNS」选项卡</span><br><span class="line">2.添加记录</span><br><span class="line">    1、记录类型选择「AAAA」，也就是 IPv6 地址记录。</span><br><span class="line">    2、Name 一栏填写子域名。例如 DDNS 域名是 ipv6-ddns.example.com 的话这里就填写 ipv6-ddns。</span><br><span class="line">    3、IPv6 address 一栏填写 ::1 即可。</span><br><span class="line">    4、TTL 选择 「2 minutes」。</span><br><span class="line">    5、由于这里不使用 CDN 功能，所以需要点击一下橙色的云图标让其变为灰色。</span><br><span class="line">    6、点击「Add Record」即可添加记录。</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看刚刚添加的AAAA记录,找到刚刚 的Content的记录的ID，记录下来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SSH 中输入下面内容</span></span><br><span class="line">curl -s -X GET <span class="string">"https://api.cloudflare.com/client/v4/zones/&lt;刚才获取的 Zone ID&gt;/dns_records?type=AAAA&amp;name=&lt;DDNS 域名&gt;&amp;content=127.0.0.1&amp;page=1&amp;per_page=100&amp;order=type&amp;direction=desc&amp;match=any"</span> \</span><br><span class="line">    -H <span class="string">"X-Auth-Email: &lt;Cloudflare 账号的邮箱地址&gt;"</span> \</span><br><span class="line">    -H <span class="string">"X-Auth-Key: &lt;刚才获取的 API Key&gt;"</span> \</span><br><span class="line">    -H <span class="string">"Content-Type: application/json"</span> \</span><br><span class="line">    | python -m json.tool</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建DDNS脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建DDNS脚本</span></span><br><span class="line"><span class="comment"># SSH 中输入下面内容</span></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/ipv6-ddns.sh </span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">sleep 10</span><br><span class="line">IP6=$(ip addr show|grep -v deprecated|grep -A1 <span class="string">'inet6 [^f:]'</span>|sed -nr <span class="string">':a;N;s#^ +inet6 ([a-f0-9:]+)/.+? scope global .*? valid_lft ([0-9]+sec) .*#\2 \1#p;ta'</span>|grep <span class="string">'ff:fe'</span>|sort -nr|head -n1|cut -d<span class="string">' '</span> -f2)</span><br><span class="line">curl -X PUT <span class="string">"https://api.cloudflare.com/client/v4/zones/&lt;刚才获取的 Zone ID&gt;/dns_records/&lt;刚才获取的 AAAA 记录 ID&gt;"</span> -H <span class="string">"X-Auth-Email: &lt;Cloudflare 账号的邮箱地址&gt;"</span> -H <span class="string">"X-Auth-Key: &lt;刚才获取的 API Key&gt;"</span> -H <span class="string">"Content-Type: application/json"</span> --data <span class="string">'&#123;"type":"AAAA","name":"&lt;DDNS 域名&gt;","content":"'</span><span class="string">"\$&#123;IP6&#125;"</span><span class="string">'","ttl":120,"proxied":false&#125;'</span></span><br><span class="line">EOF</span><br><span class="line">chmod +x /etc/ipv6-ddns.sh  <span class="comment"># 给它权限</span></span><br><span class="line"></span><br><span class="line">3.执行脚本，看看效果</span><br><span class="line">/etc/ipv6-ddns.sh | python -m json.tool</span><br></pre></td></tr></table></figure>
</li>
<li><p>成功后，添加计划任务（方法看<a href="#四、定时计划">下面</a>）</p>
<ul>
<li>如果是群晖，可以保存脚本，然后让群晖来计划执行</li>
</ul>
</li>
</ol>
<h3 id="8-更多脚本"><a href="#8-更多脚本" class="headerlink" title="8.更多脚本"></a>8.更多脚本</h3><p>看<a href="https://github.com/cuteribs/ribsnetwork/tree/master/ddns" target="_blank" rel="noopener">这</a></p>
<p><a href="https://github.com/cuteribs/ribsnetwork" target="_blank" rel="noopener">主Github</a>，有其他各种sh脚本，可以学习下 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dnspod (添加 / 更新) 推荐</span><br><span class="line">sh dnspod.sh &#123;ApiID&#125;,&#123;ApiKey&#125; example.com www</span><br><span class="line"></span><br><span class="line">qcloud (添加 / 更新)  腾讯云</span><br><span class="line">sh qcloud.sh &#123;SecretId&#125; &#123;SecretKey&#125; example.com www</span><br><span class="line"></span><br><span class="line">aliyun (添加 / 更新)  阿里云</span><br><span class="line">sh aliyun.sh &#123;AccessKeyId&#125; &#123;AccessKeySecret&#125; example.com www</span><br><span class="line"></span><br><span class="line">cloudxns (只能更新)</span><br><span class="line">sh cloudxns.sh &#123;ApiKey&#125; &#123;SecretKey&#125; example.com www</span><br></pre></td></tr></table></figure>



<h2 id="四、定时计划"><a href="#四、定时计划" class="headerlink" title="四、定时计划"></a>四、定时计划</h2><h3 id="群晖定时计划"><a href="#群晖定时计划" class="headerlink" title="群晖定时计划"></a>群晖定时计划</h3><p>若用群晖的原生DDNS功能，这里就不需要定时了，</p>
<p>主要用于自己写的脚本，定时执行</p>
<ol>
<li>写好脚本，通过群晖的File Station 放到任意目录，</li>
<li>查看脚本属性记录下路径位置</li>
<li>群晖控制面板 - 新建任务计划</li>
<li>新增 - 用户定义的脚本<ol>
<li>计划：<ol>
<li>每天执行</li>
<li>首次运行时间：<code>00：00</code></li>
<li>运行频率：10分钟</li>
<li>最后运行时间：<code>23：50</code></li>
</ol>
</li>
<li>任务设置，用于定义的脚本，输入刚刚记录文件的位置即可</li>
</ol>
</li>
</ol>
<h3 id="Windows定时计划"><a href="#Windows定时计划" class="headerlink" title="Windows定时计划"></a>Windows定时计划</h3><ol>
<li>右键开始菜单 - 计算机管理</li>
<li>选择 - 任务计划程序 - 最右侧 - 创建任务<ol>
<li>常规：命名</li>
<li>触发器：新建<ol>
<li>时间：每天</li>
<li>重复任务间隔：1小时</li>
<li>持续时间：无限制</li>
</ol>
</li>
<li>操作：新建<ol>
<li>程序或脚本：选择Python的安装目录（Python.exe文件所在）</li>
<li>添加参数：<code>.Py脚本</code>所在</li>
<li>起始于：Python的安装目录 （最右面有 <code>\</code> 符号）</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="五、失效问题解决"><a href="#五、失效问题解决" class="headerlink" title="五、失效问题解决"></a>五、失效问题解决</h2><p>有时，服务器出问题，一些DDNS没有成功，人又不在现场，如何解决。</p>
<p>只要想办法获取到服务器的外网IP就可以了</p>
<h3 id="最简单的方法："><a href="#最简单的方法：" class="headerlink" title="最简单的方法："></a>最简单的方法：</h3><p><strong>条件</strong>：</p>
<ol>
<li>你不在现场，其他人在现场</li>
<li>你已经做好了端口转发，有外网IP即可远程设置</li>
</ol>
<p><strong>解决：</strong></p>
<p>让在现场的人，访问 <code>查询外网IP的网站</code>，比如  <a href="http://www.ip138.com，把看到的IP地址发给你即可" target="_blank" rel="noopener">www.ip138.com，把看到的IP地址发给你即可</a></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Gkon</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://gxkon.top/posts/ebbbbbf7/">http://gxkon.top/posts/ebbbbbf7/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://gxkon.top" target="_blank">Gxkon's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/IPV6/">IPV6</a><a class="post-meta__tags" href="/tags/DDNS/">DDNS</a></div><div class="post_share"><div class="social-share" data-image="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/10/7/68coffee-5567269_1280.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/posts/ec4e7dd/"><img class="prev_cover" data-src="/Pic/post.jpg" onerror="onerror=null;src='/Pic/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Python文本处理之xml文件操作</div></div></a></div><div class="next-post pull_right"><a href="/posts/7a50e393/"><img class="next_cover" data-src="/Pic/post.jpg" onerror="onerror=null;src='/Pic/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Python文本处理之configparser配置文件</div></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '1ce3148e3133bf004c96',
  clientSecret: '2a1e5c0f4d38387460b916843bfe5cac67ef2d07',
  repo: 'blankwz.github.io',
  owner: 'blankwz',
  admin: ['blankwz'],
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  perPage: 10,
  distractionFreeMode: false,
  pagerDirection: 'last',
  createIssueManually: false,
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  try {
    document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
  } catch (e) {
    return false
  }
}</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Gkon</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">簡</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script src="/js/third-party/ClickShowText.js"></script></body></html>
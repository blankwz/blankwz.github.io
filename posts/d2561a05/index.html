<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Python高级之调用DLL(ctypes) | Gxkon's Blog</title><meta name="description" content="Python高级之调用DLL(ctypes) 在python中某些时候需要C做效率上的补充，在实际应用中，需要做部分数据的交互 使用python中的ctypes模块可以很方便调用windows的dll（也包括linux下的so文件） 静态链接库是一个lib文件，动态链接库是一个dll文件 Python 的 ctypes 要使用 C 函数  需要先将 C 编译成动态链接库的形式， 即 Windows"><meta name="keywords" content="Python"><meta name="author" content="Gkon"><meta name="copyright" content="Gkon"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Python高级之调用DLL(ctypes)"><meta name="twitter:description" content="Python高级之调用DLL(ctypes) 在python中某些时候需要C做效率上的补充，在实际应用中，需要做部分数据的交互 使用python中的ctypes模块可以很方便调用windows的dll（也包括linux下的so文件） 静态链接库是一个lib文件，动态链接库是一个dll文件 Python 的 ctypes 要使用 C 函数  需要先将 C 编译成动态链接库的形式， 即 Windows"><meta name="twitter:image" content="http://gxkon.top/Pic/post.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Python高级之调用DLL(ctypes)"><meta property="og:url" content="http://gxkon.top/posts/d2561a05/"><meta property="og:site_name" content="Gxkon's Blog"><meta property="og:description" content="Python高级之调用DLL(ctypes) 在python中某些时候需要C做效率上的补充，在实际应用中，需要做部分数据的交互 使用python中的ctypes模块可以很方便调用windows的dll（也包括linux下的so文件） 静态链接库是一个lib文件，动态链接库是一个dll文件 Python 的 ctypes 要使用 C 函数  需要先将 C 编译成动态链接库的形式， 即 Windows"><meta property="og:image" content="http://gxkon.top/Pic/post.jpg"><meta property="article:published_time" content="2021-02-01T10:07:07.000Z"><meta property="article:modified_time" content="2021-02-13T12:49:38.796Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://gxkon.top/posts/d2561a05/"><link rel="prev" title="玩转AutoHotkey" href="http://gxkon.top/posts/25ba6bc9/"><link rel="next" title="正则表达式" href="http://gxkon.top/posts/2f57a694/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: {"text":"本人,超帅,打钱","fontSize":"15px"},
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/Pic/avatar.png" onerror="onerror=null;src='/Pic/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">156</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">83</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">54</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 娱乐</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Python高级之调用DLL-ctypes"><span class="toc-text">Python高级之调用DLL(ctypes)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、开始"><span class="toc-text">一、开始</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-引入ctypes库"><span class="toc-text">1 引入ctypes库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-加载DLL"><span class="toc-text">2 加载DLL</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#stdcall调用约定："><span class="toc-text">stdcall调用约定：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cdesl调用约定："><span class="toc-text">cdesl调用约定：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#注意"><span class="toc-text">注意</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-调用dll"><span class="toc-text">3 调用dll</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#简单"><span class="toc-text">简单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#传入参数为指针时"><span class="toc-text">传入参数为指针时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#函数pointer"><span class="toc-text">函数pointer</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-如果DLL中的函数返回一个指针"><span class="toc-text">4 如果DLL中的函数返回一个指针</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-处理C中的结构体类型"><span class="toc-text">5 处理C中的结构体类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#C里面dll的定义如下："><span class="toc-text">C里面dll的定义如下：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Python的定义："><span class="toc-text">Python的定义：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#如果结构体里面有指针"><span class="toc-text">如果结构体里面有指针</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-结构体"><span class="toc-text">6 结构体</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、例子"><span class="toc-text">二、例子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#例1"><span class="toc-text">例1</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#C-代码如下："><span class="toc-text">C++代码如下：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Python代码如下："><span class="toc-text">Python代码如下：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#例2："><span class="toc-text">例2：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#例3"><span class="toc-text">例3</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#C-C-的DLL文件"><span class="toc-text">C&#x2F;C++的DLL文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#python调用编写好的DLL文件"><span class="toc-text">python调用编写好的DLL文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#例：调用kernel32-dll链接库文件复制"><span class="toc-text">例：调用kernel32.dll链接库文件复制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#例：简单"><span class="toc-text">例：简单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#例：音量控制"><span class="toc-text">例：音量控制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、问题"><span class="toc-text">三、问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#function-‘test’-not-found"><span class="toc-text">function ‘test’ not found!</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Procedure-called-with-not-enough-arguments-bytes-missing-or-wrong-calling-convention"><span class="toc-text">Procedure called with not enough arguments (** bytes missing) or wrong calling convention</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#access-violation-reading-…"><span class="toc-text">access violation reading …</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、Python-ctypes-数据类型表"><span class="toc-text">四、Python ctypes 数据类型表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、工具"><span class="toc-text">五、工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#查看DLL内置函数接口-VS2019"><span class="toc-text">查看DLL内置函数接口  - VS2019</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DLL文件查看-Dependency-Walker"><span class="toc-text">DLL文件查看 - Dependency Walker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#生成DLL-MinGW-w64"><span class="toc-text">生成DLL - MinGW-w64</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/Pic/post.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Gxkon's Blog</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 娱乐</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Python高级之调用DLL(ctypes)</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2021-02-01 18:07:07"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2021-02-01</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2021-02-13 20:49:38"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2021-02-13</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Python/">Python</a><i class="fa fa-angle-right post-meta__separator" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Python/%E9%AB%98%E7%BA%A7/">高级</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/posts/d2561a05/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="Python高级之调用DLL-ctypes"><a href="#Python高级之调用DLL-ctypes" class="headerlink" title="Python高级之调用DLL(ctypes)"></a>Python高级之调用DLL(ctypes)</h1><blockquote>
<p>在python中某些时候需要C做效率上的补充，在实际应用中，需要做部分数据的交互</p>
<p>使用python中的ctypes模块可以很方便调用windows的dll（也包括linux下的so文件）</p>
<p><strong>静态链接库是一个lib文件，动态链接库是一个dll文件</strong></p>
<p>Python 的 ctypes 要使用 C 函数</p>
<ul>
<li>需要先将 C 编译成动态链接库的形式，<ul>
<li>即 Windows 下的 .dll 文件，</li>
<li>或者 Linux 下的 .so 文件</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="一、开始"><a href="#一、开始" class="headerlink" title="一、开始"></a>一、开始</h2><h3 id="1-引入ctypes库"><a href="#1-引入ctypes库" class="headerlink" title="1 引入ctypes库"></a>1 引入ctypes库</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure>

<h3 id="2-加载DLL"><a href="#2-加载DLL" class="headerlink" title="2 加载DLL"></a>2 加载DLL</h3><p>加载的时候要根据你将要调用的函数是符合什么调用约定的</p>
<h4 id="stdcall调用约定："><a href="#stdcall调用约定：" class="headerlink" title="stdcall调用约定："></a><strong>stdcall调用约定</strong>：</h4><p><strong>windll</strong>用于加载遵循stdcall调用约定的动态链接库</p>
<ul>
<li><p>Objdll = <code>ctypes.windll.LoadLibrary(&quot;dllpath&quot;)</code></p>
</li>
<li><p>Objdll = <code>ctypes.WinDLL(&quot;dllpath&quot;)</code>    <strong>WinDLL类对象</strong></p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">stdcall很多时候被称为pascal调用约定，因为pascal是早期很常见的一种教学用计算机程序设计语言，其语法严谨，使用的函数调用约定就是stdcall。</span><br><span class="line">在Microsoft C++系列的C/C++编译器中，常常用PASCAL宏来声明这个调用约定，类似的宏还有WINAPI和CALLBACK。</span><br><span class="line">stdcall调用约定声明的语法为(以前文的那个函数为例）：int __stdcall <span class="keyword">function</span>(int a,int b)</span><br><span class="line"></span><br><span class="line">stdcall的调用约定意味着：</span><br><span class="line">1）参数从右向左压入堆栈，</span><br><span class="line">2）函数自身修改堆栈 </span><br><span class="line">3)函数名自动加前导的下划线，后面紧跟一个@符号，其后紧跟着参数的尺寸。</span><br><span class="line">注意不同编译器会插入自己的汇编代码以提供编译的通用性，但是大体代码如此。</span><br></pre></td></tr></table></figure>



<h4 id="cdesl调用约定："><a href="#cdesl调用约定：" class="headerlink" title="cdesl调用约定："></a><strong>cdesl调用约定</strong>：</h4><p><strong>cdll</strong>用于加载遵守cdecl标准函数调用约定的连接库</p>
<ul>
<li>Objdll = <code>ctypes.cdll.LoadLibrary(&quot;dllpath&quot;)</code></li>
<li>Objdll = <code>ctypes.CDLL(&quot;dllpath&quot;)</code>    <strong>CDLL类的对象</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cdecl调用约定又称为C调用约定，是C语言缺省的调用约定，它的定义语法是：</span><br><span class="line"></span><br><span class="line">int <span class="keyword">function</span> (int a ,int b) //不加修饰就是C调用约定，</span><br><span class="line">int __cdecl <span class="keyword">function</span>(int a,int b)//明确指出C调用约定。</span><br><span class="line"></span><br><span class="line">cdecl调用约定的参数压栈顺序是和stdcall是一样的，参数首先由右向左压入堆栈。所不同的是，函数本身不清理堆栈，调用者负责清理堆栈</span><br></pre></td></tr></table></figure>







<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><p> 想要正确调用dll文件，你要找到正确的调用约定，必须查看C头文件或要调用的函数的文档。</p>
<ul>
<li>整数、字节对象和（unicode）字符串是<strong>唯一可以在这些函数调用中直接用作参数的本地Python对象</strong>。<ul>
<li>它们都不作为C语言NULL指针传递，字节对象和字符串作为指针传递给包含它们的数据的内存块（char<em>或wchar_t</em>）。</li>
</ul>
</li>
<li>Python整数作为平台默认的C int类型传递，它们的值被屏蔽以适合于C类型。</li>
<li>在继续使用其他参数类型调用函数之前，我们必须了解更多关于ctypes数据类型的信息。<ul>
<li>具体看下面的数据类型表</li>
</ul>
</li>
</ul>
<h3 id="3-调用dll"><a href="#3-调用dll" class="headerlink" title="3 调用dll"></a>3 <strong>调用dll</strong></h3><h4 id="简单"><a href="#简单" class="headerlink" title="简单"></a>简单</h4><p>加载dll的时候会返回一个DLL对象，利用该对象就可以调用dll中的方法</p>
<ul>
<li>例如：假设名字叫<strong>Objdll</strong>，如果dll中有个方法名字叫<strong>Add</strong>，<ul>
<li>调用：<code>nRet = Objdll.Add(12, 15)</code> </li>
</ul>
</li>
</ul>
<h4 id="传入参数为指针时"><a href="#传入参数为指针时" class="headerlink" title="传入参数为指针时"></a>传入参数为指针时</h4><p>现在假设函数需要你传入一个int类型的指针（int*），可以通过库中的byref关键字来实现，假设现在调用的函数的第三个参数是个int类型的指针。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">intPara = c_int(<span class="number">9</span>)</span><br><span class="line">dll.sub(<span class="number">23</span>, <span class="number">102</span>, byref(intPara))</span><br><span class="line"><span class="keyword">print</span> intPara.value</span><br></pre></td></tr></table></figure>

<p>如果是要传入一个char缓冲区指针，和缓冲区长度，方法至少有四种：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法1</span></span><br><span class="line">szPara = create_string_buffer(<span class="string">'/0'</span>*<span class="number">100</span>)</span><br><span class="line">dll.PrintInfo(byref(szPara), <span class="number">100</span>);</span><br><span class="line"><span class="keyword">print</span> szPara.value</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 方法2</span></span><br><span class="line">sBuf = <span class="string">'aaaaaaaaaabbbbbbbbbbbbbb'</span></span><br><span class="line">pStr = c_char_p( )</span><br><span class="line">pStr.value = sBuf</span><br><span class="line"><span class="comment">#pVoid = ctypes.cast( pStr, ctypes.c_void_p ).value</span></span><br><span class="line">dll.PrintInfo(pStr, len(pStr.value))</span><br><span class="line"><span class="keyword">print</span> pStr.value</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 方法3</span></span><br><span class="line">strMa = <span class="string">"/0"</span>*<span class="number">20</span></span><br><span class="line">FunPrint  = dll.PrintInfo</span><br><span class="line">FunPrint.argtypes = [c_char_p, c_int]</span><br><span class="line"><span class="comment">#FunPrint.restypes = c_void_p</span></span><br><span class="line">nRst = FunPrint(strMa, len(strMa))</span><br><span class="line"><span class="keyword">print</span> strMa,len(strMa)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 方法4</span></span><br><span class="line">pStr2 = c_char_p(<span class="string">"/0"</span>)</span><br><span class="line"><span class="keyword">print</span> pStr2.value</span><br><span class="line"><span class="comment">#pVoid = ctypes.cast( pStr, ctypes.c_void_p ).value</span></span><br><span class="line">dll.PrintInfo(pStr2, len(pStr.value))</span><br><span class="line"><span class="keyword">print</span> pStr2.value</span><br></pre></td></tr></table></figure>

<h4 id="函数pointer"><a href="#函数pointer" class="headerlink" title="函数pointer"></a>函数pointer</h4><p>在python中除了通过byref传入指针地址外，还有一个函数pointer。原文链接：<a href="http://www.pythontip.com/blog/post/9835/" target="_blank" rel="noopener">http://www.pythontip.com/blog/post/9835/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">byref(n)返回的相当于C的指针右值&amp;n，本身没有被分配空间：</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; from ctypes import *</span><br><span class="line">&gt;&gt;&gt; n = c_int(0)</span><br><span class="line">&gt;&gt;&gt; p = byref(n)</span><br><span class="line">&gt;&gt;&gt; pp = byref(p)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;pyshell#4&gt;"</span>, line 1, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    pp = byref(p)</span><br><span class="line">TypeError: byref() argument must be a ctypes instance, not <span class="string">'CArgObject'</span></span><br><span class="line"></span><br><span class="line">pointer返回的相当于指针左值T* p=&amp;n，可以改变，可以取地址:</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; from ctypes import *</span><br><span class="line">&gt;&gt;&gt; n = c_int(0)</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; q = pointer(n)</span><br><span class="line">&gt;&gt;&gt; q.contents = c_int(1)</span><br><span class="line">&gt;&gt;&gt; qq = byref(q)</span><br><span class="line">&gt;&gt;&gt; dir(qq)</span><br><span class="line">[<span class="string">'__class__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__dir__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__eq__'</span>, <span class="string">'__format__'</span>, <span class="string">'__ge__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__gt__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__le__'</span>, <span class="string">'__lt__'</span>, <span class="string">'__ne__'</span>, <span class="string">'__new__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>, <span class="string">'_obj'</span>]</span><br><span class="line">&gt;&gt;&gt; <span class="built_in">type</span>(qq)</span><br><span class="line">&lt;class <span class="string">'CArgObject'</span>&gt;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; qq</span><br><span class="line">&lt;cparam <span class="string">'P'</span> (010AD238)&gt;</span><br><span class="line">&gt;&gt;&gt; q</span><br><span class="line">&lt;__main__.LP_c_long object at 0x010AD210&gt;</span><br><span class="line">&gt;&gt;&gt; q.contens</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; q.contents</span><br><span class="line">c_long(1)</span><br><span class="line"></span><br><span class="line">对于T**参数，通常你得构造一个pointer，然后byref传进去</span><br><span class="line"></span><br><span class="line">PS: addressof返回一个Python整数，不能直接传给C那边</span><br></pre></td></tr></table></figure>



<h3 id="4-如果DLL中的函数返回一个指针"><a href="#4-如果DLL中的函数返回一个指针" class="headerlink" title="4 如果DLL中的函数返回一个指针"></a>4 如果<strong>DLL中的函数返回一个指针</strong></h3><p>其实返回的都是地址，把他们转换相应的python类型，再通过value属性访问。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pchar = dll.getbuffer()</span><br><span class="line">szbuffer = c_char_p(pchar)</span><br><span class="line"><span class="keyword">print</span> szbuffer.value</span><br></pre></td></tr></table></figure>

<h3 id="5-处理C中的结构体类型"><a href="#5-处理C中的结构体类型" class="headerlink" title="5 处理C中的结构体类型"></a>5 <strong>处理C中的结构体类型</strong></h3><p>在python里面申明一个类似c的结构体，要用到类，并且这个类必须继承自Structure。</p>
<h4 id="C里面dll的定义如下："><a href="#C里面dll的定义如下：" class="headerlink" title="C里面dll的定义如下："></a>C里面dll的定义如下：</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SimpleStruct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span>    nNo;</span><br><span class="line">    <span class="keyword">float</span>  fVirus;</span><br><span class="line">    <span class="keyword">char</span>   szBuffer[<span class="number">512</span>];</span><br><span class="line">&#125; SimpleStruct, *PSimpleStruct;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">const</span> SimpleStruct*  PCSimpleStruct;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span><span class="keyword">int</span>  __declspec(dllexport) PrintStruct(PSimpleStruct simp);</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">PrintStruct</span><span class="params">(PSimpleStruct simp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">"nMaxNum=%f, szContent=%s"</span>, simp-&gt;fVirus, simp-&gt;szBuffer);</span><br><span class="line"><span class="keyword">return</span> simp-&gt;nNo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="Python的定义："><a href="#Python的定义：" class="headerlink" title="Python的定义："></a>Python的定义：</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpStruct</span><span class="params">(Structure)</span>:</span></span><br><span class="line">    _fields_ = [ (<span class="string">"nNo"</span>, c_int),</span><br><span class="line">              (<span class="string">"fVirus"</span>, c_float),</span><br><span class="line">              (<span class="string">"szBuffer"</span>, c_char * <span class="number">512</span>)]</span><br><span class="line"> </span><br><span class="line">dll = CDLL(<span class="string">"AddDll.dll"</span>)</span><br><span class="line">simple = SimpStruct();</span><br><span class="line">simple.nNo = <span class="number">16</span></span><br><span class="line">simple.fVirus = <span class="number">3.1415926</span></span><br><span class="line">simple.szBuffer = <span class="string">"magicTong/0"</span></span><br><span class="line"><span class="keyword">print</span> dll.PrintStruct(byref(simple))</span><br></pre></td></tr></table></figure>

<h4 id="如果结构体里面有指针"><a href="#如果结构体里面有指针" class="headerlink" title="如果结构体里面有指针"></a>如果结构体里面有指针</h4><p>如果结构体里面有指针，甚至是指向结构体的指针，处理起来会复杂很多，不过Python里面也有相应的处理方法</p>
<p>C代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">char</span> words[<span class="number">10</span>];</span><br><span class="line">&#125;keywords;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">keywords *kws;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> len;</span><br><span class="line">&#125;outStruct;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span><span class="keyword">int</span> __declspec(dllexport) test(outStruct *o);</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">test</span><span class="params">(outStruct *o)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">4</span>;</span><br><span class="line">o-&gt;kws = (keywords *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">char</span>) * <span class="number">10</span> * i);</span><br><span class="line"><span class="built_in">strcpy</span>(o-&gt;kws[<span class="number">0</span>].words, <span class="string">"The First Data"</span>);</span><br><span class="line"><span class="built_in">strcpy</span>(o-&gt;kws[<span class="number">1</span>].words, <span class="string">"The Second Data"</span>);</span><br><span class="line">o-&gt;len = i;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Python代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">keywords</span><span class="params">(Structure)</span>:</span></span><br><span class="line">        _fields_ = [(<span class="string">'words'</span>, c_char *<span class="number">10</span>),]</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">outStruct</span><span class="params">(Structure)</span>:</span></span><br><span class="line">        _fields_ = [(<span class="string">'kws'</span>, POINTER(keywords)),</span><br><span class="line"> </span><br><span class="line">                    (<span class="string">'len'</span>, c_int),]</span><br><span class="line"> </span><br><span class="line">o = outStruct()</span><br><span class="line">dll.test(byref(o))</span><br><span class="line"> </span><br><span class="line"><span class="keyword">print</span> o.kws[<span class="number">0</span>].words;</span><br><span class="line"><span class="keyword">print</span> o.kws[<span class="number">1</span>].words;</span><br><span class="line"><span class="keyword">print</span> o.len</span><br></pre></td></tr></table></figure>

<h3 id="6-结构体"><a href="#6-结构体" class="headerlink" title="6 结构体"></a>6 结构体</h3><p>在系统Windows上有不少的API函数，这些函数大部分都有结构体，并且还要用上指针，这个就比较头痛了。</p>
<p>拿个栗子出来先…<br>使用<strong>user32.dll</strong>中<strong>GetCursorPos</strong>()获取鼠标位置的坐标。</p>
<p><strong>GetCursorPos</strong>()的定义，形参中使用结构体指针<strong>LPPOINT</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">WINUSERAPI</span><br><span class="line">BOOL</span><br><span class="line">WINAPI</span><br><span class="line">GetCursorPos(</span><br><span class="line">    _Out_ LPPOINT lpPoint);</span><br><span class="line"><span class="number">12345</span></span><br></pre></td></tr></table></figure>

<p>系统中的结构体指针<strong>LPPOINT</strong>，如下所示</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagPOINT</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    LONG  x;</span><br><span class="line">    LONG  y;</span><br><span class="line">&#125; POINT, *PPOINT, NEAR *NPPOINT, FAR *LPPOINT;</span><br><span class="line"><span class="number">12345</span></span><br></pre></td></tr></table></figure>

<p>上结构体改成Python中代码如下，要指定相同的类型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># POINT结构体定义</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">POINT</span><span class="params">(Structure)</span>:</span></span><br><span class="line">    _fields_ = [(<span class="string">'x'</span>, c_long), (<span class="string">'y'</span>, c_long)]</span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>

<p>下面是获取鼠标坐标的Python代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># POINT结构体定义</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">POINT</span><span class="params">(Structure)</span>:</span></span><br><span class="line">    _fields_ = [(<span class="string">'x'</span>, c_long), (<span class="string">'y'</span>, c_long)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    q = POINT(<span class="number">0</span>, <span class="number">0</span>) <span class="comment"># 初始化x,y为0</span></span><br><span class="line">    mouse = WinDLL(<span class="string">"C:/Windows/System32/user32.dll"</span>) <span class="comment">#调用dll</span></span><br><span class="line">    print(mouse) <span class="comment"># 看一下dll状况</span></span><br><span class="line">    mouse.GetCursorPos(pointer(q))  <span class="comment"># 传递指针结构体形参，获取鼠标坐标位置</span></span><br><span class="line">    print(q.x) <span class="comment"># 输出鼠标的X坐标</span></span><br><span class="line">    print(q.y) <span class="comment"># 输出鼠标的y坐标</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br><span class="line"><span class="number">12345678910111213141516171819</span></span><br></pre></td></tr></table></figure>

<p>上面中的pointer(q)，可以使用byref(q)替代运行效果更快。<br>官网ctypes上参考：<a href="https://docs.python.org/3/library/ctypes.html" target="_blank" rel="noopener">https://docs.python.org/3/library/ctypes.html</a></p>
<h2 id="二、例子"><a href="#二、例子" class="headerlink" title="二、例子"></a>二、例子</h2><h3 id="例1"><a href="#例1" class="headerlink" title="例1"></a>例1</h3><p>这个例子比较简单，就是用C++调用win32 API来产生GUID，然后python通过调用C++写的dll来获得这个GUID。</p>
<h4 id="C-代码如下："><a href="#C-代码如下：" class="headerlink" title="C++代码如下："></a>C++代码如下：</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span>__declspec(dllexport) <span class="function"><span class="keyword">char</span>* <span class="title">newGUID</span><span class="params">()</span></span>; </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">newGUID</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">char</span> buf[<span class="number">64</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">     statc GUID guid;</span><br><span class="line">     <span class="keyword">if</span> (S_OK == ::CoCreateGuid(&amp;guid)) </span><br><span class="line">     &#123;</span><br><span class="line">       _snprintf(buf, <span class="keyword">sizeof</span>(buf),</span><br><span class="line"> </span><br><span class="line"><span class="string">"%08X-%04X-%04X-%02X%02X-%02X%02X%02X%02X%02X%02X"</span>, </span><br><span class="line"> </span><br><span class="line">guid.Data1,</span><br><span class="line">guid.Data2,</span><br><span class="line">guid.Data3,</span><br><span class="line">guid.Data4[<span class="number">0</span>], guid.Data4[<span class="number">1</span>],</span><br><span class="line">guid.Data4[<span class="number">2</span>], guid.Data4[<span class="number">3</span>],</span><br><span class="line">guid.Data4[<span class="number">4</span>], guid.Data4[<span class="number">5</span>],</span><br><span class="line">guid.Data4[<span class="number">6</span>], guid.Data4[<span class="number">7</span>]</span><br><span class="line">); </span><br><span class="line"> </span><br><span class="line">       ::MessageBox(<span class="literal">NULL</span>, buf, <span class="string">"GUID"</span>, MB_OK); </span><br><span class="line">      &#125;</span><br><span class="line">     <span class="keyword">return</span> (<span class="keyword">char</span>*)buf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Python代码如下："><a href="#Python代码如下：" class="headerlink" title="Python代码如下："></a>Python代码如下：</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">CreateGUID</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    创建一个全局唯一标识符</span></span><br><span class="line"><span class="string">    类似：E06093E2-699A-4BF2-A325-4F1EADB50E18</span></span><br><span class="line"><span class="string">    NewVersion</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># dll path</span></span><br><span class="line">        strDllPath = sys.path[<span class="number">0</span>] + str(os.sep) + <span class="string">"createguid.dll"</span></span><br><span class="line">        dll = CDLL(strDllPath)</span><br><span class="line">        b = dll.newGUID()</span><br><span class="line">        a = c_char_p(b)</span><br><span class="line">    <span class="keyword">except</span> Exception, error:</span><br><span class="line">        <span class="keyword">print</span> error</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">    <span class="keyword">return</span> a.value</span><br></pre></td></tr></table></figure>

<h3 id="例2："><a href="#例2：" class="headerlink" title="例2："></a><strong>例2：</strong></h3><p>这个例子是调用kernel32.dll中的createprocessA函数来启动一个记事本进程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  -*- coding:utf-8 -*- </span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> * </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 定义_PROCESS_INFORMATION结构体</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_PROCESS_INFORMATION</span><span class="params">(Structure)</span>:</span></span><br><span class="line">    _fields_ = [(<span class="string">'hProcess'</span>, c_void_p),</span><br><span class="line">                (<span class="string">'hThread'</span>, c_void_p),</span><br><span class="line">                (<span class="string">'dwProcessId'</span>, c_ulong),</span><br><span class="line">                (<span class="string">'dwThreadId'</span>, c_ulong)]</span><br><span class="line"><span class="comment"># 定义_STARTUPINFO结构体</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_STARTUPINFO</span><span class="params">(Structure)</span>:</span></span><br><span class="line">    _fields_ = [(<span class="string">'cb'</span>,c_ulong),</span><br><span class="line">                (<span class="string">'lpReserved'</span>, c_char_p),</span><br><span class="line">                (<span class="string">'lpDesktop'</span>, c_char_p),</span><br><span class="line">                (<span class="string">'lpTitle'</span>, c_char_p),</span><br><span class="line">                (<span class="string">'dwX'</span>, c_ulong),</span><br><span class="line">                (<span class="string">'dwY'</span>, c_ulong),</span><br><span class="line">                (<span class="string">'dwXSize'</span>, c_ulong),</span><br><span class="line">                (<span class="string">'dwYSize'</span>, c_ulong),</span><br><span class="line">                (<span class="string">'dwXCountChars'</span>, c_ulong),</span><br><span class="line">                (<span class="string">'dwYCountChars'</span>, c_ulong),</span><br><span class="line">                (<span class="string">'dwFillAttribute'</span>, c_ulong),</span><br><span class="line">                (<span class="string">'dwFlags'</span>, c_ulong),</span><br><span class="line">                (<span class="string">'wShowWindow'</span>, c_ushort),</span><br><span class="line">                (<span class="string">'cbReserved2'</span>, c_ushort),</span><br><span class="line">                (<span class="string">'lpReserved2'</span>, c_char_p),</span><br><span class="line">                (<span class="string">'hStdInput'</span>, c_ulong),</span><br><span class="line">                (<span class="string">'hStdOutput'</span>, c_ulong),</span><br><span class="line">                (<span class="string">'hStdError'</span>, c_ulong)]</span><br><span class="line">NORMAL_PRIORITY_CLASS = <span class="number">0x00000020</span> <span class="comment">#定义NORMAL_PRIORITY_CLASS</span></span><br><span class="line">kernel32 = windll.LoadLibrary(<span class="string">"kernel32.dll"</span>)  <span class="comment">#加载kernel32.dll</span></span><br><span class="line">CreateProcess = kernel32.CreateProcessA   <span class="comment">#获得CreateProcess函数地址</span></span><br><span class="line">ReadProcessMemory = kernel32.ReadProcessMemory <span class="comment">#获得ReadProcessMemory函数地址</span></span><br><span class="line">WriteProcessMemory = kernel32.WriteProcessMemory <span class="comment">#获得WriteProcessMemory函数地址</span></span><br><span class="line">TerminateProcess = kernel32.TerminateProcess</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 声明结构体</span></span><br><span class="line">ProcessInfo = _PROCESS_INFORMATION()</span><br><span class="line">StartupInfo = _STARTUPINFO()</span><br><span class="line">fileName = <span class="string">'c:/windows/notepad.exe'</span>       <span class="comment"># 要进行修改的文件</span></span><br><span class="line">address = <span class="number">0x0040103c</span>        <span class="comment"># 要修改的内存地址</span></span><br><span class="line">strbuf = c_char_p(<span class="string">"_"</span>)        <span class="comment"># 缓冲区地址</span></span><br><span class="line">bytesRead = c_ulong(<span class="number">0</span>)       <span class="comment"># 读入的字节数</span></span><br><span class="line">bufferSize =  len(strbuf.value)     <span class="comment"># 缓冲区大小</span></span><br><span class="line"><span class="comment"># 创建进程 </span></span><br><span class="line">CreateProcess(fileName, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, NORMAL_PRIORITY_CLASS,<span class="number">0</span>, <span class="number">0</span>, byref(StartupInfo), byref(ProcessInfo))</span><br></pre></td></tr></table></figure>

<h3 id="例3"><a href="#例3" class="headerlink" title="例3"></a>例3</h3><h4 id="C-C-的DLL文件"><a href="#C-C-的DLL文件" class="headerlink" title="C/C++的DLL文件"></a>C/C++的DLL文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include "stdafx.h"</span></span><br><span class="line"><span class="comment">#include &lt;windows.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line">typedef struct _SimpleStruct</span><br><span class="line">&#123;</span><br><span class="line">	int    nNo;</span><br><span class="line">	float  fVirus;</span><br><span class="line">	char   szBuffer[<span class="number">2</span>];</span><br><span class="line">&#125; SimpleStruct, *PSimpleStruct;</span><br><span class="line">typedef const SimpleStruct*  PCSimpleStruct;</span><br><span class="line"> </span><br><span class="line">extern <span class="string">"C"</span> int  __declspec(dllexport) PrintStruct(PSimpleStruct simp);</span><br><span class="line">int PrintStruct(PSimpleStruct simp)</span><br><span class="line">&#123;</span><br><span class="line">	printf("nMaxNum=%f,szContent=%s", simp-&gt;fVirus, simp-&gt;szBuffer);</span><br><span class="line">	return simp-&gt;nNo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="python调用编写好的DLL文件"><a href="#python调用编写好的DLL文件" class="headerlink" title="python调用编写好的DLL文件"></a>python调用编写好的DLL文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># author:SingWeek</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpStruct</span><span class="params">(Structure)</span>:</span></span><br><span class="line">    _fields_ = [(<span class="string">"nNo"</span>, c_int),</span><br><span class="line">                (<span class="string">"fVirus"</span>, c_float),</span><br><span class="line">                (<span class="string">"szBuffer"</span>, c_wchar)]<span class="comment">#“”中的命名可以自己指定 </span></span><br><span class="line">dll = CDLL(<span class="string">"Dll1.dll"</span>)</span><br><span class="line"><span class="comment"># print(dll.PrintStruct)</span></span><br><span class="line">simple = SimpStruct()</span><br><span class="line">simple.nNo = <span class="number">16</span></span><br><span class="line">simple.fVirus = <span class="number">3.1415926</span></span><br><span class="line">simple.szBuffer = <span class="string">"x"</span></span><br><span class="line">out=dll.PrintStruct(byref(simple))</span><br><span class="line">print(out)</span><br></pre></td></tr></table></figure>



<h3 id="例：调用kernel32-dll链接库文件复制"><a href="#例：调用kernel32-dll链接库文件复制" class="headerlink" title="例：调用kernel32.dll链接库文件复制"></a>例：调用kernel32.dll链接库文件复制</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    targetstr = <span class="string">"E:/VS/ddl1/"</span>  <span class="comment"># 目标文件夹路径</span></span><br><span class="line">    dststr = <span class="string">"E:/VS/"</span>  <span class="comment"># 复制文件夹路径</span></span><br><span class="line"></span><br><span class="line">    targefile = <span class="string">"pch.h"</span>  <span class="comment"># 目标文件夹名字</span></span><br><span class="line">    targetstr = targetstr + targefile</span><br><span class="line"></span><br><span class="line">    fname = <span class="string">"1.h"</span>  <span class="comment"># 复制后文件名字</span></span><br><span class="line">    dststr = dststr + fname</span><br><span class="line"></span><br><span class="line">    ddl1 = WinDLL(<span class="string">"C:/Windows/System32/kernel32.dll"</span>) <span class="comment"># 调用静态连接文件中API函数CopyFileA（）</span></span><br><span class="line">    <span class="keyword">if</span> ddl1.CopyFileA(c_char_p(bytes(targetstr, <span class="string">'utf-8'</span>)), c_char_p(bytes(dststr, <span class="string">'utf-8'</span>)), c_bool(bool(<span class="number">0</span>))) != <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">"OK!"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"Not success!"</span>)</span><br><span class="line"></span><br><span class="line">Declare Function CopyFile Lib <span class="string">"kernel32"</span> Alias <span class="string">"CopyFileA"</span> (ByVal lpExistingFileName As String, ByVal lpNewFileName As String, ByVal bFailIfExists As Long) As Long </span><br><span class="line">说明 </span><br><span class="line">	复制文件。与vb的filecopy命令相似 </span><br><span class="line">返回值 </span><br><span class="line">	Long，非零表示成功，零表示失败。会设置GetLastError </span><br><span class="line">参数表 </span><br><span class="line">	参数 类型及说明 </span><br><span class="line">	lpExistingFileName String，源文件名 </span><br><span class="line">	lpNewFileName String，目标文件名 </span><br><span class="line">	bFailIfExists Long，如果设为TRUE（非零），那么一旦目标文件已经存在，则函数调用会失败。否则目标文件被改写</span><br></pre></td></tr></table></figure>

<h3 id="例：简单"><a href="#例：简单" class="headerlink" title="例：简单"></a>例：简单</h3><p>Windows 系统下的 C 标准库动态链接文件为 <code>msvcrt.dll</code></p>
<ul>
<li>一般在目录 C:\Windows\System32 和 C:\Windows\SysWOW64 下分别对应 32-bit 和 64-bit</li>
<li>使用时不用刻意区分，Python 会选择合适的</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> platform</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *  <span class="comment">#导入模块</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> platform.system() == <span class="string">'Windows'</span>:</span><br><span class="line">    libc = cdll.LoadLibrary(<span class="string">'msvcrt.dll'</span>)  <span class="comment">#载入动态链接库</span></span><br><span class="line">    <span class="comment">#Windows 系统下的 C 标准库动态链接文件为 msvcrt.dll</span></span><br><span class="line"><span class="keyword">elif</span> platform.system() ==<span class="string">'Linux'</span>:</span><br><span class="line">    libc = cdll.LoadLibrary(<span class="string">'libc.so.6'</span>)</span><br><span class="line">    <span class="comment">#Linux 系统下的 C 标准库动态链接文件为 libc.so.6</span></span><br></pre></td></tr></table></figure>

<p>另外导入dll文件，还有其它方式如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> platform</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> platform.system() == <span class="string">'Windows'</span>:</span><br><span class="line">    libc = cdll.LoadLibrary(<span class="string">'msvcrt.dll'</span>)</span><br><span class="line">    <span class="comment">#libc = windll.LoadLibrary('msvcrt.dll')  # Windows only</span></span><br><span class="line">    <span class="comment">#libc = oledll.LoadLibrary('msvcrt.dll')  # Windows only</span></span><br><span class="line">    <span class="comment">#libc = pydll.LoadLibrary('msvcrt.dll')</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">#libc = CDLL('msvcrt.dll')</span></span><br><span class="line">    <span class="comment">#libc = WinDLL('msvcrt.dll')  # Windows only</span></span><br><span class="line">    <span class="comment">#libc = OleDLL('msvcrt.dll')  # Windows only</span></span><br><span class="line">    <span class="comment">#libc = PyDLL('msvcrt.dll')</span></span><br><span class="line"><span class="keyword">elif</span> platform.system() ==<span class="string">'Linux'</span>:</span><br><span class="line">    libc = cdll.LoadLibrary(<span class="string">'libc.so.6'</span>)</span><br><span class="line">    <span class="comment">#libc = pydll.LoadLibrary('libc.so.6')</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#libc = CDLL('libc.so.6')</span></span><br><span class="line">    <span class="comment">#libc = PyDLL('libc.so.6')</span></span><br><span class="line">    </span><br><span class="line">libc.printf(<span class="string">'Hello ctypes!\n'</span>)</span><br></pre></td></tr></table></figure>





<h3 id="例：音量控制"><a href="#例：音量控制" class="headerlink" title="例：音量控制"></a>例：音量控制</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QApplication, QWidget</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> Qt</span><br><span class="line"><span class="keyword">import</span> platform</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *  <span class="comment">#引入ctypes库</span></span><br><span class="line"><span class="keyword">import</span> ctypes,sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Win</span><span class="params">(QWidget)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(Win, self).__init__()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> platform.system() == <span class="string">'Windows'</span>:</span><br><span class="line">            libc = cdll.LoadLibrary(<span class="string">'msvcrt.dll'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            exec(<span class="number">0</span>)</span><br><span class="line">        self.user32 = ctypes.windll.user32  <span class="comment"># 加载user32.dll并返回对象</span></span><br><span class="line">        self.mute()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mute</span><span class="params">(self)</span>:</span></span><br><span class="line">        APPCOMMAND_VOLUME_UP=<span class="number">0xa0000</span></span><br><span class="line">        APPCOMMAND_VOLUME_DOWN=<span class="number">0x090000</span></span><br><span class="line">        APPCOMMAND_VOLUME_MUTE=<span class="number">0x080000</span></span><br><span class="line">        hwnd = self.user32.GetForegroundWindow()  <span class="comment"># 获取最前窗口句柄</span></span><br><span class="line">        <span class="comment">#self.user32.PostMessageA(hwnd,0x319,0,APPCOMMAND_VOLUME_UP)  #增加系统音量2%</span></span><br><span class="line">        <span class="comment">#self.user32.PostMessageA(hwnd, 0x319, 0, APPCOMMAND_VOLUME_DOWN)  #减小系统音量2%</span></span><br><span class="line">        self.user32.PostMessageA(hwnd, <span class="number">0x319</span>, <span class="number">0</span>, APPCOMMAND_VOLUME_MUTE)  <span class="comment">#系统静音</span></span><br><span class="line">        <span class="comment">#第一次静音  第二次还原</span></span><br><span class="line">        <span class="comment">#参数4说明：https://technet.microsoft.com/zh-tw/sysinternals/ms646247(v=vs.71)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    demo = Win()</span><br><span class="line">    demo.show()</span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure>





<h2 id="三、问题"><a href="#三、问题" class="headerlink" title="三、问题"></a>三、问题</h2><h3 id="function-‘test’-not-found"><a href="#function-‘test’-not-found" class="headerlink" title="function ‘test’ not found!"></a>function ‘test’ not found!</h3><p>function ‘test’ not found!，是因为<strong>dll文件中没有对应函数</strong>，The specified module could not be found或者function ‘***’ not found</p>
<h3 id="Procedure-called-with-not-enough-arguments-bytes-missing-or-wrong-calling-convention"><a href="#Procedure-called-with-not-enough-arguments-bytes-missing-or-wrong-calling-convention" class="headerlink" title="Procedure called with not enough arguments (** bytes missing) or wrong calling convention"></a>Procedure called with not enough arguments (** bytes missing) or wrong calling convention</h3><p>在调用DLL文件中的对应函数的时候，参数传递出错，可能是参数少了，也可能是参数类型不对等引起的，此时需要核对DLL文件中的参数结构形式</p>
<h3 id="access-violation-reading-…"><a href="#access-violation-reading-…" class="headerlink" title="access violation reading …"></a>access violation reading …</h3><p>首先有这个函数会出现一串地址<code>print(cdll.kernel32.GetModuleHandleA)</code>，</p>
<p>如果向dll调用的函数中传入的参数发生错误，会出现此问题。</p>
<h2 id="四、Python-ctypes-数据类型表"><a href="#四、Python-ctypes-数据类型表" class="headerlink" title="四、Python ctypes 数据类型表"></a>四、Python ctypes 数据类型表</h2><p>ctypes 作为 Python 和 C 联系的桥梁，它定义了专有的数据类型来衔接这两种编程语言</p>
<p>注：Python 中的类型，除了 None，int， long， Byte String，Unicode String 作为 C 函数的参数默认提供转换外，其它类型都必须显式提供转换。</p>
<ul>
<li><p>None：对应 C 中的 NULL</p>
</li>
<li><p>int, long： 对应 C 中的 int，具体实现时会根据机器字长自动适配。</p>
</li>
<li><p>Byte String：对应 C 中的一个字符串指针 char * ，指向一块内存区域。</p>
</li>
<li><p>Unicode String ：对应 C 中一个宽字符串指针 wchar_t *，指向一块内存区域</p>
</li>
</ul>
<p><strong>对应的指针类型</strong>是<code>在后面加上&quot;_p”， 如int * 是 c_int_p</code></p>
<ul>
<li>在python中要实现c语言中的结构，需要用到类</li>
</ul>
<table>
<thead>
<tr>
<th><strong>ctypes 数据类型</strong></th>
<th><strong>C 数据类型</strong></th>
<th><strong>Python 数据类型</strong></th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://docs.python.org/3.6/library/ctypes.html?highlight=ctypes#ctypes.c_bool" target="_blank" rel="noopener">c_bool</a></td>
<td>_Bool</td>
<td>bool (1)</td>
</tr>
<tr>
<td><a href="https://docs.python.org/3.6/library/ctypes.html?highlight=ctypes#ctypes.c_char" target="_blank" rel="noopener">c_char</a></td>
<td>char</td>
<td>1-character bytes object</td>
</tr>
<tr>
<td><a href="https://docs.python.org/3.6/library/ctypes.html?highlight=ctypes#ctypes.c_wchar" target="_blank" rel="noopener">c_wchar</a></td>
<td>wchar_t</td>
<td>1-character string</td>
</tr>
<tr>
<td><a href="https://docs.python.org/3.6/library/ctypes.html?highlight=ctypes#ctypes.c_byte" target="_blank" rel="noopener">c_byte</a></td>
<td>char</td>
<td>int</td>
</tr>
<tr>
<td><a href="https://docs.python.org/3.6/library/ctypes.html?highlight=ctypes#ctypes.c_ubyte" target="_blank" rel="noopener">c_ubyte</a></td>
<td>unsigned char</td>
<td>int</td>
</tr>
<tr>
<td><a href="https://docs.python.org/3.6/library/ctypes.html?highlight=ctypes#ctypes.c_short" target="_blank" rel="noopener">c_short</a></td>
<td>short</td>
<td>int</td>
</tr>
<tr>
<td><a href="https://docs.python.org/3.6/library/ctypes.html?highlight=ctypes#ctypes.c_ushort" target="_blank" rel="noopener">c_ushort</a></td>
<td>unsigned short</td>
<td>int</td>
</tr>
<tr>
<td><a href="https://docs.python.org/3.6/library/ctypes.html?highlight=ctypes#ctypes.c_int" target="_blank" rel="noopener">c_int</a></td>
<td>int</td>
<td>int</td>
</tr>
<tr>
<td><a href="https://docs.python.org/3.6/library/ctypes.html?highlight=ctypes#ctypes.c_uint" target="_blank" rel="noopener">c_uint</a></td>
<td>unsigned int</td>
<td>int</td>
</tr>
<tr>
<td><a href="https://docs.python.org/3.6/library/ctypes.html?highlight=ctypes#ctypes.c_long" target="_blank" rel="noopener">c_long</a></td>
<td>long</td>
<td>int</td>
</tr>
<tr>
<td><a href="https://docs.python.org/3.6/library/ctypes.html?highlight=ctypes#ctypes.c_ulong" target="_blank" rel="noopener">c_ulong</a></td>
<td>unsigned long</td>
<td>int</td>
</tr>
<tr>
<td><a href="https://docs.python.org/3.6/library/ctypes.html?highlight=ctypes#ctypes.c_longlong" target="_blank" rel="noopener">c_longlong</a></td>
<td>__int64 or long long</td>
<td>int</td>
</tr>
<tr>
<td><a href="https://docs.python.org/3.6/library/ctypes.html?highlight=ctypes#ctypes.c_ulonglong" target="_blank" rel="noopener">c_ulonglong</a></td>
<td>unsigned __int64 or unsigned long long</td>
<td>int</td>
</tr>
<tr>
<td><a href="https://docs.python.org/3.6/library/ctypes.html?highlight=ctypes#ctypes.c_size_t" target="_blank" rel="noopener">c_size_t</a></td>
<td>size_t</td>
<td>int</td>
</tr>
<tr>
<td><a href="https://docs.python.org/3.6/library/ctypes.html?highlight=ctypes#ctypes.c_ssize_t" target="_blank" rel="noopener">c_ssize_t</a></td>
<td>ssize_t or Py_ssize_t</td>
<td>int</td>
</tr>
<tr>
<td><a href="https://docs.python.org/3.6/library/ctypes.html?highlight=ctypes#ctypes.c_float" target="_blank" rel="noopener">c_float</a></td>
<td>float</td>
<td>float</td>
</tr>
<tr>
<td><a href="https://docs.python.org/3.6/library/ctypes.html?highlight=ctypes#ctypes.c_double" target="_blank" rel="noopener">c_double</a></td>
<td>double</td>
<td>float</td>
</tr>
<tr>
<td><a href="https://docs.python.org/3.6/library/ctypes.html?highlight=ctypes#ctypes.c_longdouble" target="_blank" rel="noopener">c_longdouble</a></td>
<td>long double</td>
<td>float</td>
</tr>
<tr>
<td><a href="https://docs.python.org/3.6/library/ctypes.html?highlight=ctypes#ctypes.c_char_p" target="_blank" rel="noopener">c_char_p</a></td>
<td>char * (NUL terminated)</td>
<td>bytes object or None</td>
</tr>
<tr>
<td><a href="https://docs.python.org/3.6/library/ctypes.html?highlight=ctypes#ctypes.c_wchar_p" target="_blank" rel="noopener">c_wchar_p</a></td>
<td>wchar_t * (NUL terminated)</td>
<td>string or None</td>
</tr>
<tr>
<td><a href="https://docs.python.org/3.6/library/ctypes.html?highlight=ctypes#ctypes.c_void_p" target="_blank" rel="noopener">c_void_p</a></td>
<td>void *</td>
<td>int or None</td>
</tr>
</tbody></table>
<h2 id="五、工具"><a href="#五、工具" class="headerlink" title="五、工具"></a>五、工具</h2><h3 id="查看DLL内置函数接口-VS2019"><a href="#查看DLL内置函数接口-VS2019" class="headerlink" title="查看DLL内置函数接口  - VS2019"></a><strong>查看DLL内置函数接口</strong>  - VS2019</h3><p>启动VS2019自带命令控制台工具，使用命令：<code>dumpbin -exports ddl1.dll</code></p>
<ul>
<li>可观看到函数名字，但参数有多少个就不知道了</li>
<li>或者查看到函数名字后，自己上百度看看这个函数的功能使用</li>
</ul>
<h3 id="DLL文件查看-Dependency-Walker"><a href="#DLL文件查看-Dependency-Walker" class="headerlink" title="DLL文件查看 - Dependency Walker"></a><strong>DLL文件查看</strong> - <strong>Dependency Walker</strong></h3><p>可以在这个链接中<a href="http://www.dependencywalker.com/" target="_blank" rel="noopener">下载dll查看器</a>。</p>
<p>可以查看Dll中的相关函数等，方便对对应dll的功能函数进行编写。</p>
<p>下载后点击运行，直接将DLL文件放进来或者打开后就可以查看。</p>
<h3 id="生成DLL-MinGW-w64"><a href="#生成DLL-MinGW-w64" class="headerlink" title="生成DLL - MinGW-w64"></a>生成DLL - MinGW-w64</h3><p><a href="https://www.cnblogs.com/ggg-327931457/p/9694516.html" target="_blank" rel="noopener">MinGW-w64安装教程——著名C/C++编译器GCC的Windows版本</a></p>
<p>MinGW 的全称是：<strong>Minimalist GNU on Windows</strong> 。</p>
<p>它实际上是将经典的开源 C语言 编译器 GCC 移植到了 Windows 平台下，并且包含了 Win32API ，</p>
<p>因此可以将源代码编译为可在 Windows 中运行的可执行程序。</p>
<p>而且还可以使用一些 Windows 不具备的，Linux平台下的开发工具。</p>
<p><strong>一句话来概括：MinGW 就是 GCC 的 Windows 版本 。</strong></p>
<blockquote>
<p>参考：<a href="https://blog.csdn.net/magictong/article/details/3075478" target="_blank" rel="noopener">https://blog.csdn.net/magictong/article/details/3075478</a></p>
<p><a href="https://blog.csdn.net/zx520113/article/details/85060765" target="_blank" rel="noopener">https://blog.csdn.net/zx520113/article/details/85060765</a></p>
</blockquote>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Gkon</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://gxkon.top/posts/d2561a05/">http://gxkon.top/posts/d2561a05/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://gxkon.top" target="_blank">Gxkon's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Python/">Python</a></div><div class="post_share"><div class="social-share" data-image="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/10/7/68coffee-5567269_1280.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/posts/25ba6bc9/"><img class="prev_cover" data-src="/Pic/post.jpg" onerror="onerror=null;src='/Pic/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">玩转AutoHotkey</div></div></a></div><div class="next-post pull_right"><a href="/posts/2f57a694/"><img class="next_cover" data-src="/Pic/post.jpg" onerror="onerror=null;src='/Pic/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">正则表达式</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/posts/ffb5fdc7/" title="Python GUI编程(Tkinter)"><img class="relatedPosts_cover" data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/09/night-4011992_1280.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-09-24</div><div class="relatedPosts_title">Python GUI编程(Tkinter)</div></div></a></div><div class="relatedPosts_item"><a href="/posts/1ed47f5b/" title="Python基础之列表"><img class="relatedPosts_cover" data-src="https://tvax3.sinaimg.cn/large/4a9e9735gy1gdait9noiwj24802diqp3.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-28</div><div class="relatedPosts_title">Python基础之列表</div></div></a></div><div class="relatedPosts_item"><a href="/posts/f1154067/" title="Python基础之库、Pip、Pypi"><img class="relatedPosts_cover" data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/09/norway-4970081_1280.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-28</div><div class="relatedPosts_title">Python基础之库、Pip、Pypi</div></div></a></div><div class="relatedPosts_item"><a href="/posts/49a688a0/" title="Python基础之字符串"><img class="relatedPosts_cover" data-src="https://tvax3.sinaimg.cn/large/4a9e9735gy1gdaiuzfg25j24002o0b29.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-28</div><div class="relatedPosts_title">Python基础之字符串</div></div></a></div><div class="relatedPosts_item"><a href="/posts/bbbc4a2f/" title="Python基础之安装与部署"><img class="relatedPosts_cover" data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/09/geyser-4766105_1280.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-27</div><div class="relatedPosts_title">Python基础之安装与部署</div></div></a></div><div class="relatedPosts_item"><a href="/posts/dcbec147/" title="Python中级之Pyinstaller打包成exe"><img class="relatedPosts_cover" data-src="/Pic/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-11-07</div><div class="relatedPosts_title">Python中级之Pyinstaller打包成exe</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '1ce3148e3133bf004c96',
  clientSecret: '2a1e5c0f4d38387460b916843bfe5cac67ef2d07',
  repo: 'blankwz.github.io',
  owner: 'blankwz',
  admin: ['blankwz'],
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  perPage: 10,
  distractionFreeMode: false,
  pagerDirection: 'last',
  createIssueManually: false,
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  try {
    document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
  } catch (e) {
    return false
  }
}</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Gkon</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">簡</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script src="/js/third-party/ClickShowText.js"></script></body></html>
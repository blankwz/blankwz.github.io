<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Python中级之装饰器 | Gxkon's Blog</title><meta name="description" content="Python中级之装饰器一、基础装饰器放在一个函数开始定义的地方，它就像一顶帽子一样戴在这个函数的头上。和这个函数绑定在一起。  在我们调用这个函数的时候，这个函数做为参数传入它头顶上这顶帽子，这顶帽子我们称之为 装饰器 它可以让其他函数在不需要做任何代码变动的前提下增加额外功能，装饰器的返回值也是一个函数对象 概括的讲，装饰器的作用就是为已经存在的对象添加额外的功能。  使我们的代码  更加优雅"><meta name="author" content="Gkon"><meta name="copyright" content="Gkon"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Python中级之装饰器"><meta name="twitter:description" content="Python中级之装饰器一、基础装饰器放在一个函数开始定义的地方，它就像一顶帽子一样戴在这个函数的头上。和这个函数绑定在一起。  在我们调用这个函数的时候，这个函数做为参数传入它头顶上这顶帽子，这顶帽子我们称之为 装饰器 它可以让其他函数在不需要做任何代码变动的前提下增加额外功能，装饰器的返回值也是一个函数对象 概括的讲，装饰器的作用就是为已经存在的对象添加额外的功能。  使我们的代码  更加优雅"><meta name="twitter:image" content="http://gxkon.top/Pic/post.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Python中级之装饰器"><meta property="og:url" content="http://gxkon.top/posts/1360a20a/"><meta property="og:site_name" content="Gxkon's Blog"><meta property="og:description" content="Python中级之装饰器一、基础装饰器放在一个函数开始定义的地方，它就像一顶帽子一样戴在这个函数的头上。和这个函数绑定在一起。  在我们调用这个函数的时候，这个函数做为参数传入它头顶上这顶帽子，这顶帽子我们称之为 装饰器 它可以让其他函数在不需要做任何代码变动的前提下增加额外功能，装饰器的返回值也是一个函数对象 概括的讲，装饰器的作用就是为已经存在的对象添加额外的功能。  使我们的代码  更加优雅"><meta property="og:image" content="http://gxkon.top/Pic/post.jpg"><meta property="article:published_time" content="2020-11-18T10:12:11.000Z"><meta property="article:modified_time" content="2021-01-23T12:12:21.430Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://gxkon.top/posts/1360a20a/"><link rel="prev" title="Python中级之闭包" href="http://gxkon.top/posts/93e8dc2c/"><link rel="next" title="Python高级之Debug神器PySnooper" href="http://gxkon.top/posts/80805759/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: {"text":"本人,超帅,打钱","fontSize":"15px"},
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/Pic/avatar.png" onerror="onerror=null;src='/Pic/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">156</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">83</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">54</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 娱乐</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Python中级之装饰器"><span class="toc-text">Python中级之装饰器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、基础"><span class="toc-text">一、基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#为什么要用"><span class="toc-text">为什么要用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用方法"><span class="toc-text">使用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#叠加时顺序"><span class="toc-text">叠加时顺序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#闭包内执行顺序"><span class="toc-text">闭包内执行顺序</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#问题"><span class="toc-text">问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#要求"><span class="toc-text">要求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#需要了解的知识"><span class="toc-text">需要了解的知识</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#call"><span class="toc-text">__call__</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#闭包"><span class="toc-text">闭包</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、入门"><span class="toc-text">二、入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#入门：日志打印器"><span class="toc-text">入门：日志打印器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#入门：时间计时器"><span class="toc-text">入门：时间计时器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、进阶：带参数的函数装饰器"><span class="toc-text">三、进阶：带参数的函数装饰器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#实例1"><span class="toc-text">实例1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实例2"><span class="toc-text">实例2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、高阶：不带参数的类装饰器"><span class="toc-text">四、高阶：不带参数的类装饰器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#实例1-1"><span class="toc-text">实例1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实例2-1"><span class="toc-text">实例2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、高阶：带参数的类装饰器"><span class="toc-text">五、高阶：带参数的类装饰器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#实例1-2"><span class="toc-text">实例1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实例2-2"><span class="toc-text">实例2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六、-使用偏函数与类实现装饰器"><span class="toc-text">六、 使用偏函数与类实现装饰器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#七、能装饰类的装饰器"><span class="toc-text">七、能装饰类的装饰器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#八、wraps-装饰器"><span class="toc-text">八、wraps 装饰器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#实例1-3"><span class="toc-text">实例1</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#问题-1"><span class="toc-text">问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#解决"><span class="toc-text">解决</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实例2-3"><span class="toc-text">实例2</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#遇到问题"><span class="toc-text">遇到问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#解决-1"><span class="toc-text">解决</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#原理"><span class="toc-text">原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#不使用-wraps情况下改下"><span class="toc-text">不使用 wraps情况下改下</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#九、内置装饰器：property"><span class="toc-text">九、内置装饰器：property</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#实例1-4"><span class="toc-text">实例1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实例2-4"><span class="toc-text">实例2</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#为什么"><span class="toc-text">为什么</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#所以"><span class="toc-text">所以</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十、内置装饰器-classmethod和staticmethod"><span class="toc-text">十、内置装饰器 classmethod和staticmethod</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#这样会报错"><span class="toc-text">这样会报错</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决-2"><span class="toc-text">解决</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十一、装饰器加强包"><span class="toc-text">十一、装饰器加强包</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#decorator-py"><span class="toc-text">decorator.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wrapt"><span class="toc-text">wrapt</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#无参"><span class="toc-text">无参</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#有参数"><span class="toc-text">有参数</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/Pic/post.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Gxkon's Blog</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 娱乐</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Python中级之装饰器</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-11-18 18:12:11"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-11-18</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2021-01-23 20:12:21"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2021-01-23</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Python/">Python</a><i class="fa fa-angle-right post-meta__separator" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Python/%E4%B8%AD%E7%BA%A7/">中级</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/posts/1360a20a/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="Python中级之装饰器"><a href="#Python中级之装饰器" class="headerlink" title="Python中级之装饰器"></a>Python中级之装饰器</h1><h2 id="一、基础"><a href="#一、基础" class="headerlink" title="一、基础"></a>一、基础</h2><p>装饰器放在一个函数开始定义的地方，它就像一顶帽子一样戴在这个函数的头上。和这个函数绑定在一起。</p>
<ul>
<li>在我们调用这个函数的时候，这个函数做为参数传入它头顶上这顶帽子，这顶帽子我们称之为 <code>装饰器</code></li>
<li>它可以让其他函数在不需要做任何代码变动的前提下增加额外功能，装饰器的返回值也是一个函数对象</li>
<li>概括的讲，<code>装饰器的作用</code>就是为已经存在的对象添加额外的功能。</li>
</ul>
<p><strong>使我们的代码</strong></p>
<ul>
<li>更加优雅，代码结构更加清晰</li>
<li>将实现特定的功能代码封装成装饰器，提高代码复用率，增强代码可读性</li>
</ul>
<h3 id="为什么要用"><a href="#为什么要用" class="headerlink" title="为什么要用"></a>为什么要用</h3><p>使用场景：插入日志、性能测试、事务处理、缓存、权限校验等场景</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 假设一个新的需求，希望可以记录下函数的执行日志，于是在代码中添加日志代码</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'i am foo'</span>)</span><br><span class="line">    logging.info(<span class="string">"foo is running"</span>)</span><br><span class="line">    </span><br><span class="line"><span class="number">2.</span> bar()、bar2()也有类似的需求，怎么做？</span><br><span class="line">再写一个logging在bar函数里？</span><br><span class="line">这样就造成大量雷同的代码，</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>为了减少重复写代码，我们可以这样做，重新定义一个函数</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">use_logging</span><span class="params">(func)</span>:</span></span><br><span class="line">    logging.warn(<span class="string">"%s is running"</span> % func.__name__)</span><br><span class="line">    func()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'i am bar'</span>)</span><br><span class="line"></span><br><span class="line">use_logging(bar)</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>这样的话，我们每次都要将一个函数作为参数传递给use_logging函数。</span><br><span class="line">而且这种方式已经破坏了原有的代码逻辑结构，之前执行业务逻辑时，执行运行bar()，但是现在不得不改成use_logging(bar)</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>那么有没有更好的方式的呢？当然有，答案就是装饰器。</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">use_logging</span><span class="params">(func)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        logging.warn(<span class="string">"%s is running"</span> % func.__name__)</span><br><span class="line">        <span class="keyword">return</span> func(*args)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@use_logging</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"i am foo"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@use_logging</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"i am bar"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用 bar = use_logging(bar) 也可以</span></span><br></pre></td></tr></table></figure>



<h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><ul>
<li>先定义一个装饰器（帽子）</li>
<li>再定义你的业务函数或者类（人）</li>
<li>最后把这装饰器（帽子）扣在这个函数（人）头上</li>
</ul>
<h4 id="叠加时顺序"><a href="#叠加时顺序" class="headerlink" title="叠加时顺序"></a>叠加时顺序</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@a</span></span><br><span class="line"><span class="meta">@b</span></span><br><span class="line"><span class="meta">@c</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span> <span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">等效于</span><br><span class="line">f = a(b(c(f)))</span><br></pre></td></tr></table></figure>

<h4 id="闭包内执行顺序"><a href="#闭包内执行顺序" class="headerlink" title="闭包内执行顺序"></a>闭包内执行顺序</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">html_tags</span><span class="params">(tag_name)</span>:</span></span><br><span class="line">   <span class="keyword">print</span> (<span class="string">'1.begin outer function.'</span>)</span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">wrapper_</span><span class="params">(func)</span>:</span></span><br><span class="line">       <span class="keyword">print</span> (<span class="string">"3.begin of inner wrapper function."</span>)</span><br><span class="line">       <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">           content = func(*args, **kwargs)            </span><br><span class="line">           <span class="keyword">print</span> (<span class="string">"4.&lt;&#123;tag&#125;&gt;&#123;content&#125;&lt;/&#123;tag&#125;&gt;"</span>.format(tag=tag_name, content=content))             </span><br><span class="line">           <span class="keyword">print</span> (<span class="string">'5.end of inner wrapper function.'</span>)</span><br><span class="line">       <span class="keyword">return</span> wrapper    </span><br><span class="line">   <span class="keyword">print</span> (<span class="string">'2.end of outer function'</span>)</span><br><span class="line">   <span class="keyword">return</span> wrapper_</span><br><span class="line">   </span><br><span class="line"><span class="meta">@html_tags('b')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name=<span class="string">'Toby'</span>)</span>:</span></span><br><span class="line">   <span class="keyword">return</span>( <span class="string">'Hello &#123;&#125;!'</span>.format(name))</span><br><span class="line"></span><br><span class="line">hello()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果</span></span><br><span class="line"><span class="number">1.</span>begin outer function.</span><br><span class="line"><span class="number">2.</span>end of outer function</span><br><span class="line"><span class="number">3.</span>begin of inner wrapper function.</span><br><span class="line">4.&lt;b&gt;Hello Toby!&lt;/b&gt;</span><br><span class="line"><span class="number">5.</span>end of inner wrapper function.</span><br></pre></td></tr></table></figure>

<h5 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">如果上面连续调用两次 hello</span><br><span class="line">hello()</span><br><span class="line">hello()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果将是</span></span><br><span class="line"><span class="number">1.</span>begin outer function.</span><br><span class="line"><span class="number">2.</span>end of outer function</span><br><span class="line"><span class="number">3.</span>begin of inner wrapper function.</span><br><span class="line">4.&lt;b&gt;Hello Toby!&lt;/b&gt;</span><br><span class="line"><span class="number">5.</span>end of inner wrapper function.</span><br><span class="line">4.&lt;b&gt;Hello Toby!&lt;/b&gt;</span><br><span class="line"><span class="number">5.</span>end of inner wrapper function.</span><br></pre></td></tr></table></figure>





<h3 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h3><p>Python 对某个对象是否能通过装饰器（ <code>@decorator</code>）形式使用只有一个要求：</p>
<ul>
<li><strong>decorator 必须是一个“可被调用（callable）的对象</strong>。<ul>
<li>绝大多数装饰器都是基于函数和闭包实现的</li>
<li>对于这个 callable 对象，最直接的是函数</li>
<li>除函数之外，类也可以是 callable 对象，只要实现了<code>__call__</code> 函数</li>
<li>偏函数其实也是 callable 对象</li>
</ul>
</li>
</ul>
<h3 id="需要了解的知识"><a href="#需要了解的知识" class="headerlink" title="需要了解的知识"></a>需要了解的知识</h3><h4 id="call"><a href="#call" class="headerlink" title="__call__"></a><code>__call__</code></h4><p><code>__call__</code>在 Python 中被称为内置方法，有时候也被称为魔法方法</p>
<p>只要某个对象重载了 <code>__call__ ()</code> 方法，那么这个对象就是 callable 。</p>
<p>所以，类如果要被当作装饰器，就需要有<code>__call__</code> 函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span><span class="params">()</span>:</span></span><br><span class="line">  	 <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self)</span>:</span></span><br><span class="line">       	<span class="keyword">print</span> <span class="string">'call me!'</span></span><br><span class="line">        </span><br><span class="line">t = Test()</span><br><span class="line">t()  <span class="comment"># call me</span></span><br><span class="line"><span class="comment"># 有了__call__，类才能被直接调用</span></span><br></pre></td></tr></table></figure>



<h4 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h4><h2 id="二、入门"><a href="#二、入门" class="headerlink" title="二、入门"></a>二、入门</h2><h3 id="入门：日志打印器"><a href="#入门：日志打印器" class="headerlink" title="入门：日志打印器"></a>入门：日志打印器</h3><p>实现的功能：</p>
<ul>
<li>在函数执行前，先打印一行日志告知一下主人，我要执行函数了。</li>
<li>在函数执行完，也不能拍拍屁股就走人了，咱可是有礼貌的代码，再打印一行日志告知下主人，我执行完啦。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这是装饰器函数，参数 func 是被装饰的函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logger</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kw)</span>:</span></span><br><span class="line">        print(<span class="string">'主人，我准备开始执行：&#123;&#125; 函数了:'</span>.format(func.__name__))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 真正执行的是这行。</span></span><br><span class="line">        func(*args, **kw)</span><br><span class="line"></span><br><span class="line">        print(<span class="string">'主人，我执行完啦。'</span>)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="comment"># 业务函数 ， 计算两个数之和。写好后，直接给它带上帽子。</span></span><br><span class="line"><span class="meta">@logger</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    print(<span class="string">'&#123;&#125; + &#123;&#125; = &#123;&#125;'</span>.format(x, y, x+y))</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 再执行一下 add 函数。</span></span><br><span class="line">add(<span class="number">200</span>, <span class="number">50</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#结果</span></span><br><span class="line">主人，我准备开始执行：add 函数了:</span><br><span class="line"><span class="number">200</span> + <span class="number">50</span> = <span class="number">250</span></span><br><span class="line">主人，我执行完啦。</span><br></pre></td></tr></table></figure>

<h3 id="入门：时间计时器"><a href="#入门：时间计时器" class="headerlink" title="入门：时间计时器"></a>入门：时间计时器</h3><p><strong>计算一个函数的执行时长</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这是装饰函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">timer</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kw)</span>:</span></span><br><span class="line">        t1=time.time()</span><br><span class="line">        <span class="comment"># 这是函数真正执行的地方</span></span><br><span class="line">        func(*args, **kw)</span><br><span class="line">        t2=time.time()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 计算下时长</span></span><br><span class="line">        cost_time = t2-t1 </span><br><span class="line">        print(<span class="string">"花费时间：&#123;&#125;秒"</span>.format(cost_time))</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 业务</span></span><br><span class="line"><span class="meta">@timer</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">want_sleep</span><span class="params">(sleep_time)</span>:</span></span><br><span class="line">    time.sleep(sleep_time)</span><br><span class="line"></span><br><span class="line"><span class="comment">#执行</span></span><br><span class="line">want_sleep(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果</span></span><br><span class="line">花费时间：<span class="number">10.0073800086975098</span>秒</span><br></pre></td></tr></table></figure>

<h2 id="三、进阶：带参数的函数装饰器"><a href="#三、进阶：带参数的函数装饰器" class="headerlink" title="三、进阶：带参数的函数装饰器"></a>三、进阶：带参数的函数装饰器</h2><p>装饰器的用法还远不止如此，深究下去，还大有文章。</p>
<p>上面的例子都是<code>不带参数</code>的装饰器，如何传参呢</p>
<h3 id="实例1"><a href="#实例1" class="headerlink" title="实例1"></a>实例1</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 装饰器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(contry)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(func)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">deco</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">            <span class="keyword">if</span> contry == <span class="string">"china"</span>:</span><br><span class="line">                print(<span class="string">"你好!"</span>)</span><br><span class="line">            <span class="keyword">elif</span> contry == <span class="string">"america"</span>:</span><br><span class="line">                print(<span class="string">'hello.'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 真正执行函数的地方</span></span><br><span class="line">            func(*args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> deco</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="comment"># 小明，中国人</span></span><br><span class="line"><span class="meta">@say_hello("china")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xiaoming</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># jack，美国人</span></span><br><span class="line"><span class="meta">@say_hello("america")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">jack</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行</span></span><br><span class="line">xiaoming()</span><br><span class="line">print(<span class="string">"------------"</span>)</span><br><span class="line">jack()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果</span></span><br><span class="line">你好!</span><br><span class="line">------------</span><br><span class="line">hello.</span><br></pre></td></tr></table></figure>

<h3 id="实例2"><a href="#实例2" class="headerlink" title="实例2"></a>实例2</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">use_logging</span><span class="params">(level)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(func)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">            <span class="keyword">if</span> level == <span class="string">"warn"</span>:</span><br><span class="line">                logging.warn(<span class="string">"%s is running"</span> % func.__name__)</span><br><span class="line">            <span class="keyword">return</span> func(*args)</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> decorator</span><br><span class="line"></span><br><span class="line"><span class="meta">@use_logging(level="warn")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(name=<span class="string">'foo'</span>)</span>:</span></span><br><span class="line">    print(<span class="string">"i am %s"</span> % name)</span><br><span class="line"></span><br><span class="line">foo()</span><br><span class="line"></span><br><span class="line">上面的use_logging是允许带参数的装饰器。它实际上是对原有装饰器的一个函数封装，并返回一个装饰器。</span><br><span class="line">我们可以将它理解为一个含有参数的闭包</span><br></pre></td></tr></table></figure>







<h2 id="四、高阶：不带参数的类装饰器"><a href="#四、高阶：不带参数的类装饰器" class="headerlink" title="四、高阶：不带参数的类装饰器"></a>四、高阶：不带参数的类装饰器</h2><p> <code>基于类</code>实现的装饰器</p>
<ul>
<li>相比函数装饰器，类装饰器具有灵活度大、高内聚、封装性等优点</li>
</ul>
<p><strong>基于类装饰器的实现</strong></p>
<ul>
<li><p>必须实现 <code>__call__</code> 和 <code>__init__</code>两个内置函数。</p>
</li>
<li><p><code>__init__</code> ：接收被装饰函数 </p>
</li>
<li><p><code>__call__</code> ：实现装饰逻辑。</p>
</li>
</ul>
<h3 id="实例1-1"><a href="#实例1-1" class="headerlink" title="实例1"></a>实例1</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">logger</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func)</span>:</span></span><br><span class="line">        self.func = func</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">"[INFO]: the function &#123;func&#125;() is running..."</span>\</span><br><span class="line">            .format(func=self.func.__name__))</span><br><span class="line">        <span class="keyword">return</span> self.func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say</span><span class="params">(something)</span>:</span></span><br><span class="line">    print(<span class="string">"say &#123;&#125;!"</span>.format(something))</span><br><span class="line"></span><br><span class="line">say(<span class="string">"hello"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果</span></span><br><span class="line">[INFO]: the function say() <span class="keyword">is</span> running...</span><br><span class="line">say hello!</span><br></pre></td></tr></table></figure>

<h3 id="实例2-1"><a href="#实例2-1" class="headerlink" title="实例2"></a>实例2</h3><p>让类的构造函数 <code>__init__ ()</code> 接受一个函数，然后重载 <code>__call__ ()</code> 并返回一个函数，也可以达到装饰器函数的效果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func)</span>:</span></span><br><span class="line">    self._func = func</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> (<span class="string">'class decorator runing'</span>)</span><br><span class="line">        self._func()</span><br><span class="line">        <span class="keyword">print</span> (<span class="string">'class decorator ending'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@Foo</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">print</span> (<span class="string">'bar'</span>)</span><br><span class="line"></span><br><span class="line">bar()</span><br></pre></td></tr></table></figure>







<h2 id="五、高阶：带参数的类装饰器"><a href="#五、高阶：带参数的类装饰器" class="headerlink" title="五、高阶：带参数的类装饰器"></a>五、高阶：带参数的类装饰器</h2><p>上面只能打印<code>INFO</code>级别的日志，正常情况下，我们还需要打印<code>DEBUG</code> <code>WARNING</code>等级别的日志。</p>
<p> 这就需要给类装饰器传入参数，给这个函数指定级别了</p>
<ul>
<li><code>__init__</code> ：不再接收被装饰函数，而是接收传入参数。</li>
<li><code>__call__</code> ：接收被装饰函数，实现装饰逻辑。</li>
</ul>
<h3 id="实例1-2"><a href="#实例1-2" class="headerlink" title="实例1"></a>实例1</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">logger</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, level=<span class="string">'INFO'</span>)</span>:</span></span><br><span class="line">        self.level = level</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, func)</span>:</span> <span class="comment"># 接受函数</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">            print(<span class="string">"[&#123;level&#125;]: the function &#123;func&#125;() is running..."</span>\</span><br><span class="line">                .format(level=self.level, func=func.__name__))</span><br><span class="line">            func(*args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> wrapper  <span class="comment">#返回函数</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger(level='WARNING')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say</span><span class="params">(something)</span>:</span></span><br><span class="line">    print(<span class="string">"say &#123;&#125;!"</span>.format(something))</span><br><span class="line"></span><br><span class="line">say(<span class="string">"hello"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果</span></span><br><span class="line">[WARNING]: the function say() <span class="keyword">is</span> running...</span><br><span class="line">say hello!</span><br></pre></td></tr></table></figure>

<h3 id="实例2-2"><a href="#实例2-2" class="headerlink" title="实例2"></a>实例2</h3><p>在构造函数里接受的就不是一个函数，而是传入的参数。</p>
<p>通过类把这些参数保存起来。</p>
<p>然后在重载 <code>__call__</code> 方法</p>
<ul>
<li><code>__call__</code> 方法需要接受一个函数并返回一个函数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">logging</span><span class="params">(object)</span>:</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, level=<span class="string">'INFO'</span>)</span>:</span></span><br><span class="line">       self.level = level    </span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, func)</span>:</span>  <span class="comment"># 接受函数</span></span><br><span class="line">       <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">           <span class="keyword">print</span> <span class="string">"[&#123;level&#125;]: enter function &#123;func&#125;()"</span>.format(</span><br><span class="line">               level=self.level,</span><br><span class="line">               func=func.__name__)</span><br><span class="line">           func(*args, **kwargs)        </span><br><span class="line">           <span class="keyword">return</span> wrapper  <span class="comment"># 返回函数</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@logging(level='INFO')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say</span><span class="params">(something)</span>:</span></span><br><span class="line">   <span class="keyword">print</span> <span class="string">"say &#123;&#125;!"</span>.format(something)</span><br></pre></td></tr></table></figure>







<h2 id="六、-使用偏函数与类实现装饰器"><a href="#六、-使用偏函数与类实现装饰器" class="headerlink" title="六、 使用偏函数与类实现装饰器"></a>六、 使用偏函数与类实现装饰器</h2><p>如何使用 类和偏函数结合实现一个与众不同的装饰器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DelayFunc 是一个实现了 __call__ 的类，delay 返回一个偏函数，在这里 delay 就可以做为一个装饰器</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DelayFunc</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,  duration, func)</span>:</span></span><br><span class="line">        self.duration = duration</span><br><span class="line">        self.func = func</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">f'Wait for <span class="subst">&#123;self.duration&#125;</span> seconds...'</span>)</span><br><span class="line">        time.sleep(self.duration)</span><br><span class="line">        <span class="keyword">return</span> self.func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eager_call</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">'Call without delay'</span>)</span><br><span class="line">        <span class="keyword">return</span> self.func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delay</span><span class="params">(duration)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    装饰器：推迟某个函数的执行。</span></span><br><span class="line"><span class="string">    同时提供 .eager_call 方法立即执行</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 此处为了避免定义额外函数，</span></span><br><span class="line">    <span class="comment"># 直接使用 functools.partial 帮助构造 DelayFunc 实例</span></span><br><span class="line">    <span class="keyword">return</span> functools.partial(DelayFunc, duration)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 业务</span></span><br><span class="line"><span class="meta">@delay(duration=2)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> a+b</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行</span></span><br><span class="line">add()    <span class="comment"># 可见 add 变成了 Delay 的实例</span></span><br><span class="line">&lt;__main__.DelayFunc object at <span class="number">0x107bd0be0</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行</span></span><br><span class="line">add(<span class="number">3</span>,<span class="number">5</span>)  <span class="comment"># 直接调用实例，进入 __call__</span></span><br><span class="line">Wait <span class="keyword">for</span> <span class="number">2</span> seconds...</span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="comment"># 执行</span></span><br><span class="line">add.func <span class="comment"># 实现实例方法</span></span><br><span class="line">&lt;function add at <span class="number">0x107bef1e0</span>&gt;</span><br></pre></td></tr></table></figure>

<h2 id="七、能装饰类的装饰器"><a href="#七、能装饰类的装饰器" class="headerlink" title="七、能装饰类的装饰器"></a>七、能装饰类的装饰器</h2><p>装饰器用在类上，并不是很常见，但只要熟悉装饰器的实现过程，就不难以实现对类的装饰</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下面的例子，装饰器就只是实现对类实例的生成的控制而已。</span></span><br><span class="line">instances = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">singleton</span><span class="params">(cls)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_instance</span><span class="params">(*args, **kw)</span>:</span></span><br><span class="line">        cls_name = cls.__name__</span><br><span class="line">        print(<span class="string">'===== 1 ===='</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> cls_name <span class="keyword">in</span> instances:</span><br><span class="line">            print(<span class="string">'===== 2 ===='</span>)</span><br><span class="line">            instance = cls(*args, **kw)</span><br><span class="line">            instances[cls_name] = instance</span><br><span class="line">        <span class="keyword">return</span> instances[cls_name]</span><br><span class="line">    <span class="keyword">return</span> get_instance</span><br><span class="line"></span><br><span class="line"><span class="meta">@singleton</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>:</span></span><br><span class="line">    _instance = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        print(<span class="string">'===== 3 ===='</span>)</span><br><span class="line">        self.name = name</span><br></pre></td></tr></table></figure>



<h2 id="八、wraps-装饰器"><a href="#八、wraps-装饰器" class="headerlink" title="八、wraps 装饰器"></a>八、wraps 装饰器</h2><p>使用装饰器极大地复用了代码，</p>
<ul>
<li>但是他有一个<code>缺点就是原函数的元信息不见了</code>，比如函数的docstring、<strong>name</strong>、参数列表</li>
</ul>
<p>在 <code>functools</code> 标准库中有提供一个 wraps 装饰器，它的作用就是</p>
<ul>
<li>将 <strong>被修饰的函数(wrapped)</strong> 的一些属性值赋值给 <strong>修饰器函数(wrapper)</strong> ，最终让属性的显示更符合我们的直觉。</li>
</ul>
<h3 id="实例1-3"><a href="#实例1-3" class="headerlink" title="实例1"></a>实例1</h3><h4 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a>问题</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#装饰器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logged</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">with_logging</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> func.__name__ + <span class="string">" was called"</span></span><br><span class="line">        <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> with_logging</span><br><span class="line"><span class="comment">#函数</span></span><br><span class="line"><span class="meta">@logged</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(x)</span>:</span></span><br><span class="line">   <span class="string">"""does some math"""</span></span><br><span class="line">   <span class="keyword">return</span> x + x * x</span><br><span class="line"></span><br><span class="line"><span class="comment"># 该函数完成等价于：</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="string">"""does some math"""</span></span><br><span class="line">    <span class="keyword">return</span> x + x * x</span><br><span class="line">f = logged(f)</span><br></pre></td></tr></table></figure>

<p>不难发现，<code>函数f被with_logging取代</code>了，当然它的<code>docstring，__name__就是变成了with_logging函数的信息</code>了。</p>
<p>这个问题就比较严重了！</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print(f.__name__  )   <span class="comment"># prints 'with_logging'</span></span><br><span class="line">print(f.__doc__)     <span class="comment"># prints None</span></span><br></pre></td></tr></table></figure>

<h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>好在我们有<code>functools.wraps</code>，wraps本身也是一个装饰器，</p>
<ul>
<li>它能把原函数的元信息拷贝到装饰器函数中，这使得装饰器函数也有和原函数一样的元信息了</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logged</span><span class="params">(func)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">with_logging</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> func.__name__ + <span class="string">" was called"</span></span><br><span class="line">        <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> with_logging</span><br><span class="line"></span><br><span class="line"><span class="meta">@logged</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="string">"""does some math"""</span></span><br><span class="line">    <span class="keyword">return</span> x + x * x</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> f.__name__  <span class="comment"># prints 'f'</span></span><br><span class="line"><span class="keyword">print</span> f.__doc__   <span class="comment"># prints 'does some math'</span></span><br></pre></td></tr></table></figure>









<h3 id="实例2-3"><a href="#实例2-3" class="headerlink" title="实例2"></a>实例2</h3><h4 id="遇到问题"><a href="#遇到问题" class="headerlink" title="遇到问题"></a>遇到问题</h4><p>这里，想它返回   <code>wrapped  (func)</code>，但是结果却是  <code>inner_function</code></p>
<p>因为上边执行<code>func</code> 和下边 <code>decorator(func)</code> 是等价的，</p>
<p>所以上面 <code>func.__name__</code> 是等价于下面<code>decorator(func).__name__</code> 的，那当然名字是 <code>inner_function</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner_function</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> inner_function</span><br><span class="line"></span><br><span class="line"><span class="meta">@wrapper</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrapped</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">print(wrapped.__name__)</span><br><span class="line"><span class="comment">#inner_function</span></span><br></pre></td></tr></table></figure>

<h4 id="解决-1"><a href="#解决-1" class="headerlink" title="解决"></a>解决</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(func)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner_function</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> inner_function</span><br><span class="line"></span><br><span class="line"><span class="meta">@wrapper</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrapped</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">print(wrapped.__name__)</span><br><span class="line"><span class="comment"># wrapped</span></span><br></pre></td></tr></table></figure>

<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>准确点说，wraps 其实是一个偏函数对象（partial），源码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wraps</span><span class="params">(wrapped,</span></span></span><br><span class="line"><span class="function"><span class="params">          assigned = WRAPPER_ASSIGNMENTS,</span></span></span><br><span class="line"><span class="function"><span class="params">          updated = WRAPPER_UPDATES)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> partial(update_wrapper, wrapped=wrapped,</span><br><span class="line">                   assigned=assigned, updated=updated)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以看到wraps其实就是调用了一个函数update_wrapper</span></span><br></pre></td></tr></table></figure>

<h4 id="不使用-wraps情况下改下"><a href="#不使用-wraps情况下改下" class="headerlink" title="不使用 wraps情况下改下"></a>不使用 wraps情况下改下</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> update_wrapper</span><br><span class="line"></span><br><span class="line">WRAPPER_ASSIGNMENTS = (<span class="string">'__module__'</span>, <span class="string">'__name__'</span>, <span class="string">'__qualname__'</span>, <span class="string">'__doc__'</span>,</span><br><span class="line">                       <span class="string">'__annotations__'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner_function</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    update_wrapper(inner_function, func, assigned=WRAPPER_ASSIGNMENTS)</span><br><span class="line">    <span class="keyword">return</span> inner_function</span><br><span class="line"></span><br><span class="line"><span class="meta">@wrapper</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrapped</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">print(wrapped.__name__)</span><br></pre></td></tr></table></figure>

<h2 id="九、内置装饰器：property"><a href="#九、内置装饰器：property" class="headerlink" title="九、内置装饰器：property"></a>九、内置装饰器：property</h2><p>以上都是自定义的装饰器。</p>
<p>其实Python语言本身也有一些装饰器</p>
<p><code>property</code>：它通常存在于类中，</p>
<ul>
<li>可以将一个函数定义成一个属性，</li>
<li>属性的值就是该函数return的内容</li>
<li><strong>同时</strong>，会将这个函数变成另外一个装饰器</li>
</ul>
<p><strong>它有三个装饰器</strong>：</p>
<ul>
<li><code>getter</code> ， <code>setter</code>  , <code>deleter</code></li>
<li><code>getter</code> 装饰器和不带 <code>getter</code> 的属性装饰器效果是一样的</li>
<li><code>setter</code> 和 <code>deleter</code> 是 <code>property ()</code> 的第二和第三个参数</li>
</ul>
<p>经过 <code>@ property</code> 装饰过的函数返回的不再是一个函数，而是一个 <code>property</code> 对象。</p>
<h3 id="实例1-4"><a href="#实例1-4" class="headerlink" title="实例1"></a>实例1</h3><h3 id="实例2-4"><a href="#实例2-4" class="headerlink" title="实例2"></a>实例2</h3><h4 id="为什么"><a href="#为什么" class="headerlink" title="为什么"></a>为什么</h4><p><strong>这样直接把属性暴露出去，虽然写起来很简单，但是并不能对属性的值做合法性限制</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age=None)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例化</span></span><br><span class="line">xiaoming = Student(<span class="string">"小明"</span>)</span><br><span class="line"><span class="comment"># 添加属性</span></span><br><span class="line">xiaoming.age=<span class="number">25</span></span><br><span class="line"><span class="comment"># 查询属性</span></span><br><span class="line">xiaoming.age</span><br><span class="line"><span class="comment"># 删除属性</span></span><br><span class="line"><span class="keyword">del</span> xiaoming.age</span><br></pre></td></tr></table></figure>

<p><strong>下面这样写，又不符合思维习惯</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.name = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_age</span><span class="params">(self, age)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(age, int):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'输入不合法：年龄必须为数值!'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="number">0</span> &lt; age &lt; <span class="number">100</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'输入不合法：年龄范围必须0-100'</span>)</span><br><span class="line">        self._age=age</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_age</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._age</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">del_age</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._age = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xiaoming = Student(<span class="string">"小明"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加属性</span></span><br><span class="line">xiaoming.set_age(<span class="number">25</span>)</span><br><span class="line"><span class="comment"># 查询属性</span></span><br><span class="line">xiaoming.get_age()</span><br><span class="line"><span class="comment"># 删除属性</span></span><br><span class="line">xiaoming.del_age()</span><br></pre></td></tr></table></figure>

<h4 id="所以"><a href="#所以" class="headerlink" title="所以"></a>所以</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.name = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">age</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._age</span><br><span class="line"></span><br><span class="line"><span class="meta">    @age.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">age</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, int):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'输入不合法：年龄必须为数值!'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="number">0</span> &lt; value &lt; <span class="number">100</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'输入不合法：年龄范围必须0-100'</span>)</span><br><span class="line">        self._age=value</span><br><span class="line"></span><br><span class="line"><span class="meta">    @age.deleter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">age</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">del</span> self._age</span><br><span class="line"></span><br><span class="line">xiaoming = Student(<span class="string">"小明"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置属性</span></span><br><span class="line">xiaoming.age = <span class="number">25</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询属性</span></span><br><span class="line">xiaoming.age</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除属性</span></span><br><span class="line"><span class="keyword">del</span> xiaoming.age</span><br></pre></td></tr></table></figure>

<ul>
<li><code>@age.setter</code> 使得我们可以使用<code>XiaoMing.age = 25</code>这样的方式直接赋值。</li>
<li><code>@age.deleter</code> 使得我们可以使用<code>del XiaoMing.age</code>这样的方式来删除属性。</li>
</ul>
<h2 id="十、内置装饰器-classmethod和staticmethod"><a href="#十、内置装饰器-classmethod和staticmethod" class="headerlink" title="十、内置装饰器 classmethod和staticmethod"></a>十、内置装饰器 <strong>classmethod</strong>和staticmethod</h2><p> <code>@ staticmethod</code> 返回的是一个 <code>staticmethod</code> 类对象，</p>
<p>而 <code>@ classmethod</code> 返回的是一个 <code>classmethod</code> 类对象</p>
<p>他们都是调用的是各自的 <code>__init__ ()</code> 构造函数。</p>
<ul>
<li><strong>如果需要他们和其他装饰器叠加使用，则需要把他们放在最上面</strong>！！！！</li>
<li>因为他们<code>返回不是一个 callable 对象</code></li>
</ul>
<h3 id="这样会报错"><a href="#这样会报错" class="headerlink" title="这样会报错"></a>这样会报错</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, model)</span>:</span></span><br><span class="line">       self.model = model    </span><br><span class="line">   </span><br><span class="line"><span class="meta">   @logging  # 装饰实例方法，OK</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">       <span class="keyword">print</span> <span class="string">"&#123;&#125; is running!"</span>.format(self.model)    </span><br><span class="line">   </span><br><span class="line"><span class="meta">   @logging  # 装饰静态方法，Failed</span></span><br><span class="line"><span class="meta">   @staticmethod</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">check_model_for</span><span class="params">(obj)</span>:</span></span><br><span class="line">       <span class="keyword">if</span> isinstance(obj, Car):            </span><br><span class="line">           <span class="keyword">print</span> <span class="string">"The model of your car is &#123;&#125;"</span>.format(obj.model)        </span><br><span class="line">       <span class="keyword">else</span>:            </span><br><span class="line">           <span class="keyword">print</span> <span class="string">"&#123;&#125; is not a car!"</span>.format(obj)</span><br></pre></td></tr></table></figure>

<h3 id="解决-2"><a href="#解决-2" class="headerlink" title="解决"></a>解决</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span><span class="params">(object)</span>:</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, model)</span>:</span></span><br><span class="line">       self.model = model    </span><br><span class="line">   </span><br><span class="line"><span class="meta">   @staticmethod</span></span><br><span class="line"><span class="meta">   @logging  </span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">check_model_for</span><span class="params">(obj)</span>:</span></span><br><span class="line">       <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>



<h2 id="十一、装饰器加强包"><a href="#十一、装饰器加强包" class="headerlink" title="十一、装饰器加强包"></a>十一、装饰器加强包</h2><h3 id="decorator-py"><a href="#decorator-py" class="headerlink" title="decorator.py"></a><strong>decorator.py</strong></h3><p>decorator.py是一个非常简单的装饰器加强包。</p>
<p>你可以很直观的先定义包装函数 <code>wrapper ()</code> ，再使用 <code>decorate ( func , wrapper )</code> 方法就可以完成一个装饰器。</p>
<ul>
<li><code>decorator.py</code> 实现的装饰器能完整保留原函数的 <code>name</code> ， <code>doc</code> 和 <code>args</code> ，<ul>
<li>唯一有问题的就是 <code>inspect.getsource ( func )</code> 返回的还是装饰器的源代码，</li>
<li>你需要改成 <code>inspect.getsource ( func.__wrapped__ )</code> 。</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> decorator <span class="keyword">import</span> decorate</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(func, *args, **kwargs)</span>:</span></span><br><span class="line">   <span class="string">"""print log before a function."""</span></span><br><span class="line">   <span class="keyword">print</span> (<span class="string">"[DEBUG] &#123;&#125;: enter &#123;&#125;()"</span>.format(datetime.datetime.now(), func.__name__) )  </span><br><span class="line">   <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">   </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logging</span><span class="params">(func)</span>:</span></span><br><span class="line">   <span class="keyword">return</span> decorate(func, wrapper)  <span class="comment"># 用wrapper装饰func</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logging</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">abc</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'哈哈'</span>)</span><br><span class="line"></span><br><span class="line">abc()</span><br></pre></td></tr></table></figure>

<p>也可以使用它自带的 <code>@ decorator</code> 装饰器来完成你的装饰器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> decorator <span class="keyword">import</span> decorator</span><br><span class="line"><span class="meta">@decorator</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logging</span><span class="params">(func, *args, **kwargs)</span>:</span></span><br><span class="line">   <span class="keyword">print</span> (<span class="string">"[DEBUG] &#123;&#125;: enter &#123;&#125;()"</span>.format(datetime.datetime.now(), func.__name__))   </span><br><span class="line">   <span class="keyword">return</span> func(*args, **kwargs)</span><br></pre></td></tr></table></figure>

<h3 id="wrapt"><a href="#wrapt" class="headerlink" title="wrapt"></a><strong>wrapt</strong></h3><p>wrapt是一个功能非常完善的包，用于实现各种你想到或者你没想到的装饰器。</p>
<ul>
<li><p>只需要定义一个装饰器函数，</p>
</li>
<li><p>但是函数签名是固定的必须是 <code>( wrapped , instance, args, kwargs )</code> ，</p>
<ul>
<li>注意第二个参数 <code>instance</code> 是必须的，就算你不用它。</li>
<li>当装饰器装饰在不同位置时它将得到不同的值，比如装饰在类实例方法时你可以拿到这个类实例。</li>
<li>根据 <code>instance</code> 的值你能够更加灵活的调整你的装饰器。</li>
<li>另外， <code>args</code> 和 <code>kwargs</code> 也是固定的，注意前面<strong>没有星号</strong>。在装饰器内部调用原函数时才带星号。</li>
</ul>
</li>
<li><p>使用 wrapt 实现的装饰器你不需要担心之前 inspect 中遇到的所有问题，因为它都帮你处理了，甚至 <code>inspect.getsource ( func )</code> 也准确无误</p>
</li>
</ul>
<h4 id="无参"><a href="#无参" class="headerlink" title="无参"></a>无参</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> wrapt<span class="comment"># without argument in decorator</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@wrapt.decorator</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logging</span><span class="params">(wrapped, instance, args, kwargs)</span>:</span>  <span class="comment"># instance is must</span></span><br><span class="line">   <span class="keyword">print</span> (<span class="string">"[DEBUG]: enter &#123;&#125;()"</span>.format(wrapped.__name__)  )  </span><br><span class="line">   <span class="keyword">return</span> wrapped(*args, **kwargs)</span><br><span class="line">   </span><br><span class="line"><span class="meta">@logging</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say</span><span class="params">(something)</span>:</span> <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">say(<span class="string">'哈哈'</span>)</span><br></pre></td></tr></table></figure>

<h4 id="有参数"><a href="#有参数" class="headerlink" title="有参数"></a>有参数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> wrapt<span class="comment"># without argument in decorator</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logging</span><span class="params">(level)</span>:</span></span><br><span class="line"><span class="meta">   @wrapt.decorator</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(wrapped, instance, args, kwargs)</span>:</span></span><br><span class="line">       <span class="keyword">print</span> (<span class="string">"[&#123;&#125;]: enter &#123;&#125;()"</span>.format(level, wrapped.__name__) )       </span><br><span class="line">       <span class="keyword">return</span> wrapped(*args, **kwargs)    </span><br><span class="line">   <span class="keyword">return</span> wrapper</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line"><span class="meta">@logging(level="INFO")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 再执行一下 add 函数。</span></span><br><span class="line">add()</span><br></pre></td></tr></table></figure>







<blockquote>
<p>参考：<a href="https://zhuanlan.zhihu.com/p/269012332" target="_blank" rel="noopener">王炳明</a></p>
<p><a href="https://www.zhihu.com/question/26930016/answer/99243411" target="_blank" rel="noopener">刘志军</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/53837833" target="_blank" rel="noopener">Wayne</a></p>
</blockquote>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Gkon</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://gxkon.top/posts/1360a20a/">http://gxkon.top/posts/1360a20a/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://gxkon.top" target="_blank">Gxkon's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/10/7/68coffee-5567269_1280.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/posts/93e8dc2c/"><img class="prev_cover" data-src="/Pic/post.jpg" onerror="onerror=null;src='/Pic/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Python中级之闭包</div></div></a></div><div class="next-post pull_right"><a href="/posts/80805759/"><img class="next_cover" data-src="/Pic/post.jpg" onerror="onerror=null;src='/Pic/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Python高级之Debug神器PySnooper</div></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '1ce3148e3133bf004c96',
  clientSecret: '2a1e5c0f4d38387460b916843bfe5cac67ef2d07',
  repo: 'blankwz.github.io',
  owner: 'blankwz',
  admin: ['blankwz'],
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  perPage: 10,
  distractionFreeMode: false,
  pagerDirection: 'last',
  createIssueManually: false,
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  try {
    document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
  } catch (e) {
    return false
  }
}</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Gkon</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">簡</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script src="/js/third-party/ClickShowText.js"></script></body></html>
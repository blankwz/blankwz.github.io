<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Python之FTP | Gxkon's Blog</title><meta name="description" content="Python之FTP一、模块python自带简单ftp服务  python2：python -m SimpleHTTPServer port python3：python -m http.server port 这个服务有几个问题，仅提供了下载功能无法上传，最重要的是没有权限控制功能  1 ftplib模块 - 客户端python已经默认安装了ftplib模块，用其中的FTP类可以实现FTP文件的"><meta name="keywords" content="Python"><meta name="author" content="Gkon"><meta name="copyright" content="Gkon"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Python之FTP"><meta name="twitter:description" content="Python之FTP一、模块python自带简单ftp服务  python2：python -m SimpleHTTPServer port python3：python -m http.server port 这个服务有几个问题，仅提供了下载功能无法上传，最重要的是没有权限控制功能  1 ftplib模块 - 客户端python已经默认安装了ftplib模块，用其中的FTP类可以实现FTP文件的"><meta name="twitter:image" content="http://gxkon.top/Pic/post.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Python之FTP"><meta property="og:url" content="http://gxkon.top/posts/636b49f9/"><meta property="og:site_name" content="Gxkon's Blog"><meta property="og:description" content="Python之FTP一、模块python自带简单ftp服务  python2：python -m SimpleHTTPServer port python3：python -m http.server port 这个服务有几个问题，仅提供了下载功能无法上传，最重要的是没有权限控制功能  1 ftplib模块 - 客户端python已经默认安装了ftplib模块，用其中的FTP类可以实现FTP文件的"><meta property="og:image" content="http://gxkon.top/Pic/post.jpg"><meta property="article:published_time" content="2021-02-07T13:40:07.000Z"><meta property="article:modified_time" content="2021-02-13T12:49:38.783Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://gxkon.top/posts/636b49f9/"><link rel="prev" title="Git基础教程" href="http://gxkon.top/posts/c4eece1e/"><link rel="next" title="WordPress淘客商城" href="http://gxkon.top/posts/ea7246b/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: {"text":"本人,超帅,打钱","fontSize":"15px"},
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/Pic/avatar.png" onerror="onerror=null;src='/Pic/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">156</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">83</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">54</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 娱乐</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Python之FTP"><span class="toc-text">Python之FTP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、模块"><span class="toc-text">一、模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-ftplib模块-客户端"><span class="toc-text">1 ftplib模块 - 客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#FTP对象常用方法"><span class="toc-text">FTP对象常用方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#简单客户端"><span class="toc-text">简单客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#例1-客户端"><span class="toc-text">例1 客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#例2-客户端"><span class="toc-text">例2 客户端</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-pyftpdlib模块-服务端"><span class="toc-text">2 pyftpdlib模块 - 服务端</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#服务端-方法一"><span class="toc-text">服务端 方法一</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#服务端-方法二"><span class="toc-text">服务端 方法二</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#winddows系统中可能会有乱码"><span class="toc-text">winddows系统中可能会有乱码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-pexpect模块"><span class="toc-text">3 pexpect模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、案例"><span class="toc-text">二、案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1：ftp客服端实现自动更新文件"><span class="toc-text">1：ftp客服端实现自动更新文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-结构"><span class="toc-text">1 结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#本地模拟ftp服务端"><span class="toc-text">本地模拟ftp服务端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#configuration-txt"><span class="toc-text">configuration.txt</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#administrator-py"><span class="toc-text">administrator.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ftpclient-py"><span class="toc-text">ftpclient.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-使用介绍"><span class="toc-text">2 使用介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-填坑"><span class="toc-text">3 填坑</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、python实现的ftp自动上传下载程序（支持目录递归操作）"><span class="toc-text">2、python实现的ftp自动上传下载程序（支持目录递归操作）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、每天从FTP服务器上下载文件"><span class="toc-text">3、每天从FTP服务器上下载文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#脚本"><span class="toc-text">脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#计划"><span class="toc-text">计划</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/Pic/post.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Gxkon's Blog</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 娱乐</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Python之FTP</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2021-02-07 21:40:07"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2021-02-07</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2021-02-13 20:49:38"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2021-02-13</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Python/">Python</a><i class="fa fa-angle-right post-meta__separator" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Python/%E4%B8%AD%E7%BA%A7/">中级</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/posts/636b49f9/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="Python之FTP"><a href="#Python之FTP" class="headerlink" title="Python之FTP"></a>Python之FTP</h1><h2 id="一、模块"><a href="#一、模块" class="headerlink" title="一、模块"></a>一、模块</h2><p>python自带简单ftp服务</p>
<ul>
<li>python2：<code>python -m SimpleHTTPServer port</code></li>
<li>python3：<code>python -m http.server port</code></li>
<li>这个服务有几个问题，仅提供了下载功能无法上传，最重要的是没有权限控制功能</li>
</ul>
<h3 id="1-ftplib模块-客户端"><a href="#1-ftplib模块-客户端" class="headerlink" title="1 ftplib模块 - 客户端"></a>1 ftplib模块 - 客户端</h3><p>python已经默认安装了ftplib模块，用其中的FTP类可以实现FTP文件的上传下载</p>
<h4 id="FTP对象常用方法"><a href="#FTP对象常用方法" class="headerlink" title="FTP对象常用方法"></a>FTP对象常用方法</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Python FTP 操作</span><br><span class="line">from ftplib import FTP      <span class="comment"># 加载ftp模块</span></span><br><span class="line">ftp = FTP()                 <span class="comment"># 获取FTP对象</span></span><br><span class="line">ftp.set_debuglevel(2)       <span class="comment"># 打开调试级别2，显示详细信息</span></span><br><span class="line">ftp.connect(<span class="string">'IP'</span>, PORT) <span class="comment"># 连接ftp，server和端口</span></span><br><span class="line">ftp.login(<span class="string">'user'</span>, <span class="string">'password'</span>)  <span class="comment"># 登录用户</span></span><br><span class="line"><span class="built_in">print</span>(ftp.getwelcome())     <span class="comment"># 打印欢迎信息</span></span><br><span class="line">ftp.cmd(<span class="string">'xxx/xxx'</span>)          <span class="comment"># 进入远程目录</span></span><br><span class="line">bufsize = 1024              <span class="comment"># 设置缓存区大小</span></span><br><span class="line">filename=<span class="string">'filename.txt'</span>     <span class="comment"># 需要下载的文件</span></span><br><span class="line">file_handle=open(filename, <span class="string">'wb'</span>).write   <span class="comment"># 以写的模式在本地打开文件</span></span><br><span class="line">file.retrbinaly(<span class="string">'RETR filename.txt'</span>, file_handle,bufsize)  <span class="comment"># 接收服务器上文件并写入本地文件</span></span><br><span class="line">ftp.set_debuglevel(0)       <span class="comment"># 关闭调试模式</span></span><br><span class="line">ftp.quit                    <span class="comment"># 退出ftp</span></span><br><span class="line">ftp相关的命令操作</span><br><span class="line"></span><br><span class="line">ftp.pwd()                   <span class="comment"># 返回当前所在位置</span></span><br><span class="line"></span><br><span class="line">ftp.cwd(path)                   <span class="comment"># 设置FTP当前操作的路径，同linux中的cd</span></span><br><span class="line">ftp.dir()                         <span class="comment">#    显示目录下所有信息</span></span><br><span class="line">ftp.nlst()                      <span class="comment">#      获取目录下的文件，显示的是文件名列表</span></span><br><span class="line">ftp.mkd(directory)           <span class="comment">#  新建远程目录</span></span><br><span class="line">ftp.rmd(directory)          <span class="comment">#    删除远程目录</span></span><br><span class="line">ftp.rename(old, new)       <span class="comment">#  将远程文件old重命名为new</span></span><br><span class="line">ftp.delete(file_name)      <span class="comment">#    删除远程文件</span></span><br><span class="line">ftp.storbinary(cmd, fp, bufsize)         <span class="comment">#    上传目标文件，cmd是一个存储命令，可以为"STOR filename.txt"， fp为类文件对象（有read方法），bufsize设置缓冲大小</span></span><br><span class="line">ftp.retrbinary(cmd, callback, bufsize)             <span class="comment"># 下载FTP文件，cmd是一个获取命令，可以为"RETR filename.txt"， callback是一个回调函数，用于读取获取到的数据块</span></span><br></pre></td></tr></table></figure>

<h4 id="简单客户端"><a href="#简单客户端" class="headerlink" title="简单客户端"></a>简单客户端</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*- encoding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> ftplib <span class="keyword">import</span> FTP</span><br><span class="line"><span class="comment">#登陆FTP</span></span><br><span class="line">ftp = FTP(host=<span class="string">'localhost'</span>,user=<span class="string">'user'</span>,passwd=<span class="string">'12345'</span>)</span><br><span class="line"><span class="comment">#设置编码方式，由于在windows系统，设置编码为gbk</span></span><br><span class="line">ftp.encoding = <span class="string">'gbk'</span></span><br><span class="line"><span class="comment">#切换目录</span></span><br><span class="line">ftp.cwd(<span class="string">'test'</span>)</span><br><span class="line"><span class="comment">#列出文件夹的内容</span></span><br><span class="line">ftp.retrlines(<span class="string">'LIST'</span>) <span class="comment"># ftp.dir()</span></span><br><span class="line"><span class="comment">#下载文件_vimrc</span></span><br><span class="line">ftp.retrbinary(<span class="string">'RETR _vimrc'</span>, open(<span class="string">'_vimrc'</span>, <span class="string">'wb'</span>).write)</span><br><span class="line"><span class="comment">#上传文件 _vimrc服务器端文件名为_vimrc3</span></span><br><span class="line">ftp.storbinary(<span class="string">'STOR _vimrc3'</span>, open(<span class="string">'_vimrc'</span>, <span class="string">'rb'</span>))</span><br><span class="line"><span class="comment">#查看目录下的文件详情</span></span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> ftp.mlsd(path=<span class="string">'/test'</span>):</span><br><span class="line">    print(f)</span><br></pre></td></tr></table></figure>



<h4 id="例1-客户端"><a href="#例1-客户端" class="headerlink" title="例1 客户端"></a>例1 客户端</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> ftplib <span class="keyword">import</span> FTP</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FTPClient</span><span class="params">(FTP)</span>:</span></span><br><span class="line">    <span class="string">""" FTP 客户端 """</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ftplogin</span><span class="params">(self, host, port, username, password)</span>:</span></span><br><span class="line">        <span class="string">""" 登录 """</span></span><br><span class="line">        self.connect(host, port)</span><br><span class="line">        self.login(username, password)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">downloadfile</span><span class="params">(self, remotepath, localpath=None)</span>:</span></span><br><span class="line">        <span class="string">""" 下载文件 """</span></span><br><span class="line">        bufsize = <span class="number">1024</span></span><br><span class="line">        <span class="keyword">if</span> localpath <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            localpath = os.path.basename(remotepath)</span><br><span class="line">        fp = open(localpath, <span class="string">'wb'</span>)</span><br><span class="line">        self.retrbinary(<span class="string">'RETR '</span> + remotepath, fp.write, bufsize)</span><br><span class="line">        self.set_debuglevel(<span class="number">0</span>)</span><br><span class="line">        fp.close()</span><br><span class="line">        print(<span class="string">f'文件 <span class="subst">&#123;remotepath&#125;</span> 下载成功！'</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">uploadfile</span><span class="params">(self, localpath, remotepath=None)</span>:</span></span><br><span class="line">        <span class="string">""" 上传文件 """</span></span><br><span class="line">        bufsize = <span class="number">1024</span></span><br><span class="line">        <span class="keyword">if</span> remotepath <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            remotepath = os.path.basename(localpath)</span><br><span class="line">        fp = open(localpath, <span class="string">'rb'</span>)</span><br><span class="line">        self.storbinary(<span class="string">'STOR '</span> + remotepath, fp, bufsize)</span><br><span class="line">        self.set_debuglevel(<span class="number">0</span>)</span><br><span class="line">        fp.close()</span><br><span class="line">        print(<span class="string">f'文件 <span class="subst">&#123;localpath&#125;</span> 上传成功！'</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">uploadfolder</span><span class="params">(self, localpath)</span>:</span></span><br><span class="line">        <span class="string">""" 上传文件夹 """</span></span><br><span class="line">        bufsize = <span class="number">1024</span></span><br><span class="line">        _fold = os.path.basename(localpath)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.mkd(_fold)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'exists'</span> <span class="keyword">in</span> str(exc):</span><br><span class="line">                cz = input(<span class="string">f'目录 <span class="subst">&#123;_fold&#125;</span> 已经存在，是否覆盖其所有文件(Y/N)：'</span>)</span><br><span class="line">                <span class="keyword">if</span> cz != <span class="string">'Y'</span>:</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">        self.cwd(_fold)</span><br><span class="line">        next_fold = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> os.listdir(localpath):</span><br><span class="line">            _f = os.path.join(localpath,i)</span><br><span class="line">            <span class="keyword">if</span> os.path.isfile(_f):</span><br><span class="line">                fp = open(_f, <span class="string">'rb'</span>)</span><br><span class="line">                self.storbinary(<span class="string">'STOR '</span> + i, fp, bufsize)</span><br><span class="line">                self.set_debuglevel(<span class="number">0</span>)</span><br><span class="line">                fp.close()</span><br><span class="line">            <span class="keyword">elif</span> os.path.isdir(_f):</span><br><span class="line">                next_fold.append((_fold,_f))</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> j,i <span class="keyword">in</span> next_fold:</span><br><span class="line">            v = self.pwd().split(<span class="string">'/'</span>)</span><br><span class="line">            <span class="keyword">if</span> j != v[<span class="number">-1</span>]:</span><br><span class="line">                self.cwd(<span class="string">'../'</span>)</span><br><span class="line">            self.uploadfolder(i)</span><br><span class="line"> </span><br><span class="line">        print(<span class="string">f'文件夹 <span class="subst">&#123;localpath&#125;</span> 上传成功！'</span>)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    host = <span class="string">'192.168.2.204'</span>  <span class="comment"># IP</span></span><br><span class="line">    port = <span class="number">2121</span>             <span class="comment"># 端口</span></span><br><span class="line">    user = <span class="string">'user'</span>           <span class="comment"># 用户名</span></span><br><span class="line">    password = <span class="string">'123456'</span>     <span class="comment"># 密码</span></span><br><span class="line">    ftp = FTPClient()</span><br><span class="line">    ftp.ftplogin(host, port, user, password)  <span class="comment"># 登录</span></span><br><span class="line">    <span class="comment"># ftp.downloadfile('c.txt')  # 下载文件</span></span><br><span class="line">    ftp.uploadfolder(<span class="string">r'D:\ass'</span>)  <span class="comment"># 上传文件夹 ass</span></span><br><span class="line">    ftp.quit()</span><br></pre></td></tr></table></figure>



<h4 id="例2-客户端"><a href="#例2-客户端" class="headerlink" title="例2 客户端"></a>例2 客户端</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># !/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># name : Alenx</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> ftplib <span class="keyword">import</span> FTP</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ftpconnect</span><span class="params">()</span>:</span></span><br><span class="line">    ftp_server = <span class="string">'10.40.0.11'</span></span><br><span class="line">    username = <span class="string">'ftpadmin'</span></span><br><span class="line">    password = <span class="string">'ftpadmin'</span></span><br><span class="line">    ftp = FTP()</span><br><span class="line">    ftp.set_debuglevel(<span class="number">2</span>)</span><br><span class="line">    ftp.connect(ftp_server, <span class="number">21</span>)</span><br><span class="line">    ftp.login(username, password)</span><br><span class="line">    <span class="keyword">return</span> ftp</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">downloadfile</span><span class="params">()</span>:</span></span><br><span class="line">    remotepath = <span class="string">"/home/pub/dog.jpg"</span></span><br><span class="line">    ftp = ftpconnect()</span><br><span class="line">    print(ftp.getwelcome())</span><br><span class="line">    bufsize = <span class="number">1024</span></span><br><span class="line">    localpath = <span class="string">'f:\\test\\dog.jpg'</span></span><br><span class="line">    fp = open(localpath, <span class="string">'wb'</span>)</span><br><span class="line">    ftp.retrbinary(<span class="string">'RETR '</span> + remotepath, fp.write, bufsize)</span><br><span class="line">    ftp.set_debuglevel(<span class="number">0</span>)</span><br><span class="line">    fp.close()</span><br><span class="line">    ftp.quit()</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">uploadfile</span><span class="params">()</span>:</span></span><br><span class="line">    remotepath = <span class="string">"/opt/ftpadmin/redis.sh"</span></span><br><span class="line">    ftp = ftpconnect()</span><br><span class="line">    bufsize = <span class="number">1024</span></span><br><span class="line">    localpath = <span class="string">'/Users/admin/redis.sh'</span></span><br><span class="line">    fp = open(localpath, <span class="string">'rb'</span>)</span><br><span class="line">    ftp.storbinary(<span class="string">'STOR '</span> + remotepath, fp, bufsize)</span><br><span class="line">    ftp.set_debuglevel(<span class="number">0</span>)</span><br><span class="line">    fp.close()</span><br><span class="line">    ftp.quit()</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getList</span><span class="params">()</span>:</span></span><br><span class="line">    ftp = ftpconnect()</span><br><span class="line">    print(<span class="string">'*'</span> * <span class="number">40</span>)</span><br><span class="line">    ftp.dir()</span><br><span class="line">    ftp.dir(<span class="string">'/aaa/'</span>)</span><br><span class="line">    print(<span class="string">'+'</span> * <span class="number">40</span>)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># uploadfile()</span></span><br><span class="line">    getList()</span><br></pre></td></tr></table></figure>



<h3 id="2-pyftpdlib模块-服务端"><a href="#2-pyftpdlib模块-服务端" class="headerlink" title="2 pyftpdlib模块 - 服务端"></a>2 pyftpdlib模块 - 服务端</h3><p>安装：<code>pip install pyftpdlib</code></p>
<p><strong>更快的操作</strong><br>如果我们只想在当前目录建立一个ftp服务器供别人下载文件，那么在当前路径直接执行：<code>python -m pyftplib -p 21</code></p>
<h4 id="服务端-方法一"><a href="#服务端-方法一" class="headerlink" title="服务端 方法一"></a>服务端 方法一</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyftpdlib.authorizers <span class="keyword">import</span> DummyAuthorizer</span><br><span class="line"><span class="keyword">from</span> pyftpdlib.handlers <span class="keyword">import</span> FTPHandler</span><br><span class="line"><span class="keyword">from</span> pyftpdlib.servers <span class="keyword">import</span> FTPServer</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ftp_server</span><span class="params">(host, port, user, password, path=<span class="string">r'D:\ftp'</span>)</span>:</span></span><br><span class="line">    <span class="string">""" FTP 服务端 """</span></span><br><span class="line">    <span class="comment"># 实例化虚拟用户，这是FTP验证首要条件</span></span><br><span class="line">    authorizer = DummyAuthorizer()</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 添加用户权限和路径，括号内的参数是(用户名， 密码， 用户目录， 权限)</span></span><br><span class="line">    authorizer.add_user(user, password, path, perm=<span class="string">'elradfmw'</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 添加匿名用户 只需要路径</span></span><br><span class="line">    authorizer.add_anonymous(path)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 初始化ftp句柄</span></span><br><span class="line">    handler = FTPHandler</span><br><span class="line">    handler.authorizer = authorizer</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 添加被动端口范围</span></span><br><span class="line">    handler.passive_ports = range(<span class="number">2000</span>, <span class="number">2333</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 监听ip 和 端口</span></span><br><span class="line">    server = FTPServer((host, port), handler)  <span class="comment"># ('192.168.2.204', 2121)</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 开始服务</span></span><br><span class="line">    server.serve_forever()</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    host = <span class="string">'192.168.2.204'</span>  <span class="comment"># IP</span></span><br><span class="line">    port = <span class="number">2121</span>  <span class="comment"># 端口</span></span><br><span class="line">    user = <span class="string">'user'</span>  <span class="comment"># 用户名</span></span><br><span class="line">    password = <span class="string">'123456'</span>  <span class="comment"># 密码</span></span><br><span class="line">    path = <span class="string">r'D:\ftp'</span>  <span class="comment"># 用户目录</span></span><br><span class="line">    ftp_server(host, port, user, password, path)</span><br></pre></td></tr></table></figure>

<h4 id="服务端-方法二"><a href="#服务端-方法二" class="headerlink" title="服务端 方法二"></a>服务端 方法二</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyftpdlib.authorizers <span class="keyword">import</span> DummyAuthorizer</span><br><span class="line"><span class="keyword">from</span> pyftpdlib.handlers <span class="keyword">import</span> FTPHandler,ThrottledDTPHandler</span><br><span class="line"><span class="keyword">from</span> pyftpdlib.servers <span class="keyword">import</span> FTPServer</span><br><span class="line"><span class="keyword">from</span> pyftpdlib.log <span class="keyword">import</span> LogFormatter</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#记录日志，默认情况下日志仅输出到屏幕（终端）</span></span><br><span class="line">logger = logging.getLogger()</span><br><span class="line">logger.setLevel(logging.INFO)</span><br><span class="line">ch = logging.StreamHandler()</span><br><span class="line">fh = logging.FileHandler(filename=<span class="string">'myftpserver.log'</span>)</span><br><span class="line">ch.setFormatter(LogFormatter())</span><br><span class="line">fh.setFormatter(LogFormatter())</span><br><span class="line">logger.addHandler(ch) <span class="comment">#将日志输出至屏幕</span></span><br><span class="line">logger.addHandler(fh) <span class="comment">#将日志输出至文件</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例化虚拟用户，这是FTP验证首要条件</span></span><br><span class="line">authorizer = DummyAuthorizer()</span><br><span class="line"><span class="comment"># 添加用户权限和路径，括号内的参数是(用户名， 密码， 用户目录， 权限),可以为不同的用户添加不同的目录和权限</span></span><br><span class="line">authorizer.add_user(<span class="string">"user"</span>, <span class="string">"12345"</span>, <span class="string">"d:/"</span>, perm=<span class="string">"elradfmw"</span>)</span><br><span class="line"><span class="comment"># 添加匿名用户 只需要路径</span></span><br><span class="line">authorizer.add_anonymous(<span class="string">"d:/"</span>)</span><br><span class="line">你好</span><br><span class="line"><span class="comment"># 初始化ftp句柄</span></span><br><span class="line">handler = FTPHandler</span><br><span class="line">handler.authorizer = authorizer</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加被动端口范围</span></span><br><span class="line">handler.passive_ports = range(<span class="number">2000</span>, <span class="number">2333</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载上传速度设置</span></span><br><span class="line">dtp_handler = ThrottledDTPHandler</span><br><span class="line">dtp_handler.read_limit = <span class="number">300</span> * <span class="number">1024</span> <span class="comment">#300kb/s</span></span><br><span class="line">dtp_handler.write_limit = <span class="number">300</span> * <span class="number">1024</span> <span class="comment">#300kb/s</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 监听ip 和 端口,linux里需要root用户才能使用21端口</span></span><br><span class="line">server = FTPServer((<span class="string">"0.0.0.0"</span>, <span class="number">21</span>), handler)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最大连接数</span></span><br><span class="line">server.max_cons = <span class="number">150</span></span><br><span class="line">server.max_cons_per_ip = <span class="number">15</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始服务，自带日志打印信息</span></span><br><span class="line">server.serve_forever()</span><br></pre></td></tr></table></figure>



<h4 id="winddows系统中可能会有乱码"><a href="#winddows系统中可能会有乱码" class="headerlink" title="winddows系统中可能会有乱码"></a>winddows系统中可能会有乱码</h4><p>在winddows系统中可能会有乱码，原因是pyftpdlib内部使用utf8，而windows使用gbk</p>
<p>解决方法如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1.修改pyftpdlib包中的filesystems.py，找到</span><br><span class="line">yield line.encode(<span class="string">'utf8'</span>, self.cmd_channel.unicode_errors)</span><br><span class="line"></span><br><span class="line">共有两处，将此处的utf8改为gbk</span><br><span class="line"></span><br><span class="line">2.修改pyftpdlib包中的handlers.py，找到FTPHandler的decode方法</span><br><span class="line"></span><br><span class="line"><span class="built_in">return</span> bytes.decode(<span class="string">'utf8'</span>, self.unicode_errors)</span><br><span class="line"></span><br><span class="line">将此处的utf8改为gbk即可解决乱码问题。</span><br></pre></td></tr></table></figure>





<h3 id="3-pexpect模块"><a href="#3-pexpect模块" class="headerlink" title="3 pexpect模块"></a>3 pexpect模块</h3><p>请先阅读《<a href="http://blog.csdn.net/l1028386804/article/details/79017760" target="_blank" rel="noopener">Python之——系统批量运维管理器pexpect</a>》</p>
<p>我们常用FTP协议实现自动化，集中式的文件备份，要求做到账号登录、文件上传与下载、退出等自动化操作。那么，我们就一起来实现一个自动化FTP操作的小程序，具体代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">Created on 2018年1月9日</span></span><br><span class="line"><span class="string">@author: liuyazhuang</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="comment">#使用unicode编码</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> unicode_literals</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> pexpect</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> com.lyz.chapter5.sshdemo <span class="keyword">import</span> child</span><br><span class="line"> </span><br><span class="line"><span class="comment">#运行ftp命令</span></span><br><span class="line">child = pexpect.spawn(<span class="string">'ftp ftp.openbsd.org'</span>)</span><br><span class="line"><span class="comment">#(?i)标识后面的自妇产正则匹配忽略大小写</span></span><br><span class="line">child.expect(<span class="string">'(?i)name .*: '</span>)</span><br><span class="line"><span class="comment">#输入ftp账号信息</span></span><br><span class="line">child.sendline(<span class="string">'账号'</span>)</span><br><span class="line"><span class="comment">#匹配密码输入提示</span></span><br><span class="line">child.expect(<span class="string">'(?i)password'</span>)</span><br><span class="line"><span class="comment">#输入ftp密码</span></span><br><span class="line">child.sendline(<span class="string">'密码'</span>)</span><br><span class="line">child.expect(<span class="string">'ftp&gt; '</span>)</span><br><span class="line"><span class="comment">#启用二进制传输模式</span></span><br><span class="line">child.sendline(<span class="string">'bin'</span>)</span><br><span class="line">child.expect(<span class="string">'ftp&gt; '</span>)</span><br><span class="line"><span class="comment">#下载robots.txt</span></span><br><span class="line">child.sendline(<span class="string">'get robot.txt'</span>)</span><br><span class="line">child.expect(<span class="string">'ftp&gt; '</span>)</span><br><span class="line"><span class="comment">#输出匹配的ftp &gt; 之前的输入与输出</span></span><br><span class="line">sys.stdout.write(child.before)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"Escape character is '^]'. \n"</span></span><br><span class="line">sys.stdout.write(child.after)</span><br><span class="line">sys.stdout.flush()</span><br><span class="line"><span class="comment">#调用interact让出控制权，用户可以继续当前的会话手工控制子程序，默认输入“^]”字符跳出</span></span><br><span class="line">child.interact()</span><br><span class="line">child.sendline(<span class="string">'byte'</span>)</span><br><span class="line">child.close()</span><br></pre></td></tr></table></figure>



<h2 id="二、案例"><a href="#二、案例" class="headerlink" title="二、案例"></a>二、案例</h2><h3 id="1：ftp客服端实现自动更新文件"><a href="#1：ftp客服端实现自动更新文件" class="headerlink" title="1：ftp客服端实现自动更新文件"></a>1：ftp客服端实现自动更新文件</h3><p><a href="https://blog.csdn.net/tqlisno1/article/details/108989880" target="_blank" rel="noopener">参考地址</a></p>
<h4 id="1-结构"><a href="#1-结构" class="headerlink" title="1 结构"></a><strong>1 结构</strong></h4><ul>
<li><p>administrator.py（以管理员身份执行某端代码封装,它是为了我后续自动启动电脑里某个文件的程序时候以管理员去运行，没有这块需求可以去掉，）</p>
</li>
<li><p>ftpclient.py</p>
</li>
<li><p>configuration.txt （配置文件)</p>
</li>
</ul>
<h4 id="本地模拟ftp服务端"><a href="#本地模拟ftp服务端" class="headerlink" title="本地模拟ftp服务端"></a>本地模拟ftp服务端</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pyftpdlib.authorizers <span class="keyword">import</span> DummyAuthorizer</span><br><span class="line"><span class="keyword">from</span> pyftpdlib.handlers  <span class="keyword">import</span> FTPHandler</span><br><span class="line"><span class="keyword">from</span> pyftpdlib.servers <span class="keyword">import</span> FTPServer</span><br><span class="line"><span class="comment"># 实例化DummyAuthorizer来创建ftp用户</span></span><br><span class="line">authorizer = DummyAuthorizer()</span><br><span class="line"><span class="comment"># 参数：用户名，密码，目录，权限</span></span><br><span class="line">authorizer.add_user(<span class="string">'admin'</span>, <span class="string">'12345'</span>, <span class="string">r'E:\project_code\ftp\ftpmyserver\File'</span>, perm=<span class="string">'elradfmwMT'</span>)</span><br><span class="line"><span class="comment"># E:\project_code\ftp\ftpmyserver\File</span></span><br><span class="line"><span class="comment"># 匿名登录</span></span><br><span class="line"><span class="comment"># authorizer.add_anonymous('/home/nobody')</span></span><br><span class="line">handler = FTPHandler</span><br><span class="line">handler.authorizer = authorizer</span><br><span class="line"></span><br><span class="line"><span class="comment"># #添加被动端口范围</span></span><br><span class="line"><span class="comment"># handler.passive_ports = range(21212, 21213)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数：IP，端口，handler</span></span><br><span class="line">server = FTPServer((<span class="string">'0.0.0.0'</span>, <span class="number">21</span>), handler)           <span class="comment">#设置为0.0.0.0为本机的IP地址</span></span><br><span class="line">server.serve_forever()</span><br></pre></td></tr></table></figure>

<h4 id="configuration-txt"><a href="#configuration-txt" class="headerlink" title="configuration.txt"></a>configuration.txt</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HOST = 127.0.0.1     <span class="comment">#远程ftp服务器的ip地址</span></span><br><span class="line">FTPDir = /      <span class="comment">#需要下载的ftp服务端目录路径</span></span><br><span class="line">LocalDir = E:\project_code\ftp\ftpclient\down   <span class="comment"># 本地存贮路径</span></span><br><span class="line">flag = True  <span class="comment">#是否需要打开更新后自动启动程序功能</span></span><br><span class="line">dir = E:\project_code\companyId\dist\start_service.bat       <span class="comment">#需要自启动的文件路径</span></span><br></pre></td></tr></table></figure>

<h4 id="administrator-py"><a href="#administrator-py" class="headerlink" title="administrator.py"></a>administrator.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf8</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Created on</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@author: tql</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Function:以管理员身份执行代码块</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> sys.version_info[<span class="number">0</span>] == <span class="number">3</span>:</span><br><span class="line">    <span class="keyword">import</span> winreg <span class="keyword">as</span> winreg</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">import</span> _winreg <span class="keyword">as</span> winreg</span><br><span class="line"></span><br><span class="line">CMD = <span class="string">r"C:\Windows\System32\cmd.exe"</span></span><br><span class="line">FOD_HELPER = <span class="string">r'C:\Windows\System32\fodhelper.exe'</span></span><br><span class="line">PYTHON_CMD = <span class="string">"python"</span></span><br><span class="line">REG_PATH = <span class="string">'Software\Classes\ms-settings\shell\open\command'</span></span><br><span class="line">DELEGATE_EXEC_REG_KEY = <span class="string">'DelegateExecute'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_admin</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Checks if the script is running with administrative privileges.</span></span><br><span class="line"><span class="string">    Returns True if is running as admin, False otherwise.</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> ctypes.windll.shell32.IsUserAnAdmin()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_reg_key</span><span class="params">(key, value)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Creates a reg key</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        winreg.CreateKey(winreg.HKEY_CURRENT_USER, REG_PATH)</span><br><span class="line">        registry_key = winreg.OpenKey(winreg.HKEY_CURRENT_USER, REG_PATH, <span class="number">0</span>, winreg.KEY_WRITE)</span><br><span class="line">        winreg.SetValueEx(registry_key, key, <span class="number">0</span>, winreg.REG_SZ, value)</span><br><span class="line">        winreg.CloseKey(registry_key)</span><br><span class="line">    <span class="keyword">except</span> WindowsError:</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bypass_uac</span><span class="params">(cmd)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Tries to bypass the UAC</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        create_reg_key(DELEGATE_EXEC_REG_KEY, <span class="string">''</span>)</span><br><span class="line">        create_reg_key(<span class="literal">None</span>, cmd)</span><br><span class="line">    <span class="keyword">except</span> WindowsError:</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> is_admin():</span><br><span class="line">        print(<span class="string">'[!] The script is NOT running with administrative privileges'</span>)</span><br><span class="line">        print(<span class="string">'[+] Trying to bypass the UAC'</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            current_dir = __file__</span><br><span class="line">            cmd = <span class="string">'&#123;&#125; /k &#123;&#125; &#123;&#125;'</span>.format(CMD, PYTHON_CMD, current_dir)</span><br><span class="line">            bypass_uac(cmd)</span><br><span class="line">            os.system(FOD_HELPER)</span><br><span class="line">            sys.exit(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">except</span> WindowsError:</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 这里添加我们需要管理员权限的代码</span></span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">"C:\Windows\System32\configuration.txt"</span>, <span class="string">"r"</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:  <span class="comment"># 设置文件对象</span></span><br><span class="line">            conf = f.readlines()</span><br><span class="line">        <span class="keyword">return</span> conf</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_file</span><span class="params">(dir)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> is_admin():</span><br><span class="line">        print(<span class="string">'[!] The script is NOT running with administrative privileges'</span>)</span><br><span class="line">        print(<span class="string">'[+] Trying to bypass the UAC'</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            current_dir = __file__</span><br><span class="line">            cmd = <span class="string">'&#123;&#125; /k &#123;&#125; &#123;&#125;'</span>.format(CMD, PYTHON_CMD, current_dir)</span><br><span class="line">            bypass_uac(cmd)</span><br><span class="line">            os.system(FOD_HELPER)</span><br><span class="line">            sys.exit(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">except</span> WindowsError:</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 这里添加我们需要管理员权限的代码</span></span><br><span class="line">        os.startfile(dir)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    execute()</span><br></pre></td></tr></table></figure>

<h4 id="ftpclient-py"><a href="#ftpclient-py" class="headerlink" title="ftpclient.py"></a>ftpclient.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Created on</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@author: tql</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Function:定时更新ftp服务器中指定目录中的所有文件</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ftplib</span><br><span class="line"><span class="keyword">import</span> os, sys</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> apscheduler.schedulers.background <span class="keyword">import</span> BlockingScheduler</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getmyPath</span><span class="params">()</span>:</span></span><br><span class="line">    sap = <span class="string">'/'</span></span><br><span class="line">    <span class="keyword">if</span> sys.argv[<span class="number">0</span>].find(sap) == <span class="number">-1</span>:</span><br><span class="line">        sap = <span class="string">'\\'</span></span><br><span class="line">    indx = sys.argv[<span class="number">0</span>].rfind(sap)</span><br><span class="line">    path = sys.argv[<span class="number">0</span>][:indx] + sap</span><br><span class="line">    <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">config_valid = &#123;&#125;</span><br><span class="line">lujing = getmyPath()</span><br><span class="line"><span class="keyword">with</span> open(lujing + <span class="string">"configuration.txt"</span>, <span class="string">"r"</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:  <span class="comment"># 设置文件对象</span></span><br><span class="line">    conf = f.readlines()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> key,line <span class="keyword">in</span> enumerate(conf):</span><br><span class="line">    content = line.split(<span class="string">'#'</span>, <span class="number">1</span>)</span><br><span class="line">    content[<span class="number">0</span>] = re.sub(<span class="string">'\n$'</span>, <span class="string">""</span>, content[<span class="number">0</span>])         <span class="comment"># 去掉文本里的 #</span></span><br><span class="line">    content[<span class="number">0</span>] = re.sub(<span class="string">'\s+'</span>, <span class="string">''</span>, content[<span class="number">0</span>]).strip()   <span class="comment"># 去掉所有空格</span></span><br><span class="line">    <span class="keyword">if</span> len(content[<span class="number">0</span>])&gt;<span class="number">0</span>:</span><br><span class="line">        temp = content[<span class="number">0</span>].split(<span class="string">'='</span>,<span class="number">1</span>)</span><br><span class="line">        config_valid[temp[<span class="number">0</span>]]=temp[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    HOST = config_valid[<span class="string">"HOST"</span>]  <span class="comment"># ftp地址</span></span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    HOST = config_valid[<span class="string">"\ufeffHOST"</span>]  <span class="comment"># ftp地址</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># USER = config_valid["USER"]  # 用户名</span></span><br><span class="line"><span class="comment"># PASSWD = config_valid["PASSWD"]  # 用户密码</span></span><br><span class="line">USER = <span class="string">"admin"</span>  <span class="comment"># 用户名</span></span><br><span class="line">PASSWD = <span class="string">"12345"</span>  <span class="comment"># 用户密码</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LocalDir = config_valid[<span class="string">"LocalDir"</span>]  <span class="comment"># 本地存贮路径</span></span><br><span class="line">FTPDir = config_valid[<span class="string">"FTPDir"</span>]  <span class="comment"># 需要下载的ftp目录路径</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local_fname = <span class="string">'checkfile.txt'</span>  <span class="comment"># 用本地存放已下载过的文件名和文件信息</span></span><br><span class="line"></span><br><span class="line">local_files = []  <span class="comment"># 存放从checkfile.txt中读回的文件名</span></span><br><span class="line">appendFiles = []  <span class="comment"># 存放服务器上是否有新文件需要更新</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">FtpConnect</span><span class="params">(host, username, passwd)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    连接并登录ftp服务器</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    host:ftp地址</span></span><br><span class="line"><span class="string">    username:用户名</span></span><br><span class="line"><span class="string">    passwd:用户密码</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ftp = ftplib.FTP(host)</span><br><span class="line">        <span class="comment"># ftp.encoding = 'utf-8' #解决中文乱码问题</span></span><br><span class="line">        <span class="comment"># ftp.set_debuglevel(0)  #不开启调试模式</span></span><br><span class="line">    <span class="keyword">except</span> (socket.error, socket.gaierror):</span><br><span class="line">        print(<span class="string">'Error, cannot reach '</span> + host)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'Connect To Host Success...'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ftp.login(username, passwd)</span><br><span class="line">    <span class="keyword">except</span> ftplib.error_perm:</span><br><span class="line">        print(<span class="string">'Username or Passwd Error'</span>)</span><br><span class="line">        <span class="comment"># ftp.quit()</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'Login Success...'</span>)</span><br><span class="line">    <span class="keyword">return</span> ftp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filelist</span><span class="params">(ftp)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    获取ftp当前目录下的所有文件及目录信息</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    flist = []</span><br><span class="line">    ftp.dir(<span class="string">'.'</span>, flist.append)  <span class="comment"># 将目录中的内容存进flist列表</span></span><br><span class="line">    files = [f.split()[<span class="number">-1</span>] <span class="keyword">for</span> f <span class="keyword">in</span> flist <span class="keyword">if</span> f.startswith(<span class="string">'-'</span>)]  <span class="comment"># 读取flist列表中的信息，以-开头的是常规文件，将该信息以空字符分割成列表，取最后的元素即为文件名</span></span><br><span class="line">    fids = [f.split(<span class="literal">None</span>, <span class="number">4</span>)[<span class="number">-1</span>] <span class="keyword">for</span> f <span class="keyword">in</span> flist <span class="keyword">if</span> f.startswith(<span class="string">'-'</span>)]  <span class="comment"># 读取flist列表中的信息，以-开头的是常规文件，将该信息以前4个空字符分割成列表，</span></span><br><span class="line">    <span class="comment"># 最后的元素包括了文件的大小，修改日期时间，可作为文件的标识</span></span><br><span class="line">    dictf = dict(zip(files, fids))  <span class="comment"># 将文件名与对应的标识合成字典</span></span><br><span class="line">    dirs = [f.split()[<span class="number">-1</span>] <span class="keyword">for</span> f <span class="keyword">in</span> flist <span class="keyword">if</span> f.startswith(<span class="string">'d'</span>)]  <span class="comment"># 读取flist列表中的信息，以d开头的是目录，将该信息以空字符分割成列表，取最后的元素即为目录名</span></span><br><span class="line">    <span class="comment"># print(dirs)</span></span><br><span class="line">    <span class="keyword">return</span> (dictf, dirs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">FtpDownloadDir</span><span class="params">(ftp, ftp_dir, local_dir)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    递归下载ftp指定目录下的所有文件及目录</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    print(<span class="string">f'Walking to <span class="subst">&#123;ftp_dir&#125;</span>'</span>)</span><br><span class="line">    print(<span class="string">f'Walking to <span class="subst">&#123;local_dir&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">if</span> ftp_dir == <span class="string">"/"</span>:</span><br><span class="line">        dirname = <span class="string">"AllDir"</span>  <span class="comment"># 用于本地创建新目录，如果下载的是FTP根目录，则在目录名为AllDir</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        dirname = os.path.basename(ftp_dir)  <span class="comment"># 否则本地目录名与FTP目录名一样</span></span><br><span class="line"></span><br><span class="line">    ftp.cwd(ftp_dir)  <span class="comment"># 进入ftp对应目录</span></span><br><span class="line">    os.chdir(local_dir)  <span class="comment"># 进入本地下载目录</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(dirname):  <span class="comment"># 如果本地dirname目录已存在</span></span><br><span class="line">        os.chdir(dirname)  <span class="comment"># 则直接进入该目录</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            os.mkdir(dirname)  <span class="comment"># 否则在本地创建该目录</span></span><br><span class="line">        <span class="keyword">except</span> OSError:</span><br><span class="line">            print(<span class="string">'OSError!'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            os.chdir(dirname)  <span class="comment"># 创建完后进入该目录</span></span><br><span class="line"></span><br><span class="line">    ftp_curr_dir = ftp.pwd()  <span class="comment"># 获取FTP当前目录路径</span></span><br><span class="line">    local_curr_dir = os.getcwd()  <span class="comment"># 获取本地当前目录路径</span></span><br><span class="line">    <span class="comment"># print(f'Changing to &#123;ftp_curr_dir&#125;')</span></span><br><span class="line">    <span class="comment"># print(f'Changing to &#123;local_curr_dir&#125;')</span></span><br><span class="line"></span><br><span class="line">    dictf, dirs = filelist(ftp)  <span class="comment"># 调用filelist函数，递归ftp当前目录下的所有文件及目录</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> f, k <span class="keyword">in</span> dictf.items():  <span class="comment"># 获取到的文件信息的键值对</span></span><br><span class="line">        <span class="comment"># print(k.split(' ')[-1])</span></span><br><span class="line">        <span class="keyword">if</span> k <span class="keyword">not</span> <span class="keyword">in</span> local_files:  <span class="comment"># 文件标识与本地存储的已下载过的文件标识做对比</span></span><br><span class="line"></span><br><span class="line">            FtpDownloadFile(ftp, f, f)  <span class="comment"># k不在local_files中说明该文件未下载过，则下载该文件</span></span><br><span class="line"></span><br><span class="line">            appendFiles.append(k)  <span class="comment"># 同时将该文件的标识存储到appenFiles列表中，用于下载完成后更新本地的checkfile.txt文件</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> dirs:  <span class="comment"># 对子目录进行处理</span></span><br><span class="line">        FtpDownloadDir(ftp, d, local_curr_dir)  <span class="comment"># 调用自身，递归下载子目录中的文件</span></span><br><span class="line">        ftp.cwd(<span class="string">'..'</span>)</span><br><span class="line">        os.chdir(<span class="string">'..'</span>)  <span class="comment"># 每次递归完成后，ftp及本地都返回上一层目录，继续其他子目录的处理</span></span><br><span class="line">    os.chdir(local_dir)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">FtpDownloadFile</span><span class="params">(ftp, remotefile, localfile)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    下载ftp当前目录的文件到本地的当前目录中</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    buffer_size = <span class="number">10240</span>  <span class="comment"># 默认是8192</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        f = open(localfile, <span class="string">'wb'</span>)</span><br><span class="line">        ftp.retrbinary(<span class="string">f'RETR <span class="subst">&#123;remotefile&#125;</span>'</span>, f.write, buffer_size)</span><br><span class="line">    <span class="keyword">except</span> ftplib.error_perm:</span><br><span class="line">        print(<span class="string">f'File:<span class="subst">&#123;f&#125;</span> Download Error'</span>)</span><br><span class="line">        <span class="comment"># os.unlink(localpath)</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">f'File:<span class="subst">&#123;f&#125;</span> Download Success...'</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        f.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">operfile</span><span class="params">(ftp,fileTxt, op)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    操作下载目录中的文件</span></span><br><span class="line"><span class="string">    op为'r'时读取该文件，如文件不存在则忽略</span></span><br><span class="line"><span class="string">    op为'w'时追加写入文件</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    fp = os.path.join(LocalDir, fileTxt)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> op == <span class="string">'r'</span>:</span><br><span class="line">        print(<span class="string">f'从 <span class="subst">&#123;fp&#125;</span> 中读取本地文件列表'</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> open(fp, <span class="string">'r'</span>)<span class="keyword">as</span> ft:</span><br><span class="line">                <span class="keyword">for</span> line <span class="keyword">in</span> ft:</span><br><span class="line">                    line = line.strip()</span><br><span class="line">                    local_files.append(line)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(e)</span><br><span class="line">    <span class="keyword">elif</span> op == <span class="string">'w'</span>:</span><br><span class="line">        print(<span class="string">f'更新 <span class="subst">&#123;fileTxt&#125;</span> 中文件列表'</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            file = open(fp, <span class="string">'w'</span>).close()  <span class="comment"># 先清除掉checkfile文本里的内容</span></span><br><span class="line">            get_all_file(ftp, FTPDir, fp)</span><br><span class="line">            <span class="comment"># for f, k in dictf.items():  # 获取到的文件信息的键值对</span></span><br><span class="line">            <span class="comment">#     with open(fp, 'a') as ft:</span></span><br><span class="line">            <span class="comment">#         ft.writelines([f'&#123;k&#125;\n'])</span></span><br><span class="line">            <span class="comment"># for d in dirs:  # 对子目录进行处理</span></span><br><span class="line">            <span class="comment">#     ftp.cwd(d)  # 进入ftp对应目录</span></span><br><span class="line">            <span class="comment">#     dictf, dirs = filelist(ftp)  # 调用filelist函数，递归ftp当前目录下的所有文件及目录</span></span><br><span class="line">            <span class="comment">#     for f, k in dictf.items():  # 获取到的文件信息的键值对</span></span><br><span class="line">            <span class="comment">#         with open(fp, 'a') as ft:</span></span><br><span class="line">            <span class="comment">#             ft.writelines([f'&#123;k&#125;\n'])</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(e)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_all_file</span><span class="params">(ftp, ftp_dir, fp)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">       获取当前目录下所有的文件和子目录下所有文件的信息并存入checkfile</span></span><br><span class="line"><span class="string">     '''</span></span><br><span class="line">    ftp.cwd(ftp_dir)  <span class="comment"># 进入ftp对应目录</span></span><br><span class="line">    dictf, dirs = filelist(ftp)  <span class="comment"># 调用filelist函数，递归ftp当前目录下的所有文件及目录</span></span><br><span class="line">    <span class="keyword">for</span> f, k <span class="keyword">in</span> dictf.items():  <span class="comment"># 获取到的文件信息的键值对</span></span><br><span class="line">        <span class="keyword">with</span> open(fp, <span class="string">'a'</span>) <span class="keyword">as</span> ft:</span><br><span class="line">            ft.writelines([<span class="string">f'<span class="subst">&#123;k&#125;</span>\n'</span>])</span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> dirs:  <span class="comment"># 对子目录进行处理</span></span><br><span class="line">        get_all_file(ftp, d, fp)</span><br><span class="line">        ftp.cwd(<span class="string">'..'</span>)  <span class="comment"># ftp返回上一级</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ftpmain</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> appendFiles</span><br><span class="line">    ftp = FtpConnect(HOST, USER, PASSWD)  <span class="comment"># 连接并登录ftp服务器</span></span><br><span class="line">    <span class="keyword">if</span> ftp:  <span class="comment"># 如果登录成功</span></span><br><span class="line">        operfile(ftp,local_fname, <span class="string">'r'</span>)  <span class="comment"># 从checkfile.txt中获取已下载过的文件</span></span><br><span class="line">        FtpDownloadDir(ftp, FTPDir, LocalDir)  <span class="comment"># 将ftp指定目录下的文件更新到本地目录中</span></span><br><span class="line">        <span class="comment"># if config_valid["flag"] == "1":     # 判断是否启动更新重启功能</span></span><br><span class="line">        <span class="comment">#     for i in range(len(appendFiles)):</span></span><br><span class="line">        <span class="comment">#         if appendFiles[i].split(' ')[-1] == config_valid["dir"].split("\\")[-1]:  # config_valid["dir"].split("\\")[-1] 表示文件名,如果这个文件更新了就重新运行</span></span><br><span class="line">        <span class="comment">#             os.system("start explorer " + config_valid["dir"])</span></span><br><span class="line">        <span class="keyword">if</span> appendFiles:  <span class="comment"># 如果有新文件更新到本地</span></span><br><span class="line">            operfile(ftp, local_fname, <span class="string">'w'</span>)  <span class="comment"># 则将其追加到checkfile.txt中</span></span><br><span class="line">            <span class="keyword">if</span> config_valid[<span class="string">"flag"</span>]:  <span class="comment"># 判断是否启动更新重启功能</span></span><br><span class="line"></span><br><span class="line">                os.startfile(config_valid[<span class="string">"dir"</span>])  <span class="comment"># 以管理员身份运行程序</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            appendFiles = []  <span class="comment"># 清空列表</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">f'无需更新<span class="subst">&#123;local_fname&#125;</span>'</span>)</span><br><span class="line">        ftp.quit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">timer</span><span class="params">()</span>:</span></span><br><span class="line">    scheduler = BlockingScheduler()</span><br><span class="line">    scheduler.add_job(ftpmain, <span class="string">'cron'</span>, hour=<span class="string">'*/1'</span>, misfire_grace_time=<span class="number">300</span>)</span><br><span class="line">    scheduler.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># timer()   #定时执行，如每小时执行一次</span></span><br><span class="line"></span><br><span class="line">     ftpmain()   <span class="comment">#手动执行，只执行一次</span></span><br></pre></td></tr></table></figure>

<h4 id="2-使用介绍"><a href="#2-使用介绍" class="headerlink" title="2 使用介绍"></a>2 使用介绍</h4><ol>
<li><p>先配置configurantion.txt文件</p>
<ol>
<li><strong>注意配置文件必须和程序放在同目录下，否则读不到配置文件里的信息</strong></li>
<li>用户名和密码也可以放到配置文件里，笔者自己的需求是把用户名和密码封装到程序里了，读者可自行调整</li>
</ol>
</li>
<li><p>在ftpclient.py里第47行把下面代码注释掉然后打开上面2行，然后在配置文件里面添加对应数据就好了，</p>
<ol>
<li>flag为自启动功能，不用可以设置false（或者0和1），dir配置自启动的文件或者程序，可以是打开记事本来测试一下</li>
</ol>
</li>
<li><p>主程序有2个，ftpmain函数和timer函数，ftpmain函数是只运行一次，timer函数是定时任务的意思，间隔可以自己调</p>
</li>
<li><p>administrator.py，这是一个获取管理员权限然后去执行代码，我们只需要去里面加上我们想要执行的代码即可</p>
</li>
</ol>
<h4 id="3-填坑"><a href="#3-填坑" class="headerlink" title="3 填坑"></a>3 填坑</h4><ol>
<li>配置文件txt里的每行数据处理，需要处理文本里的注释和空格</li>
<li><strong>程序里读取配置文件的路径一定要写相对路径，不要写绝对路径</strong>，绝对路径在打包后注册位服务运行的时候是读不到文本的，请读者使用一下函数去读取exe所在的路径，然后把配置文件和exe放到同目录下即可</li>
<li>读文本的时候是utf-8格式，但是有些win7的电脑是utf-8 bom 格式，导致读取配置文件里的数据不对，utf-8 bom格式读出来起始数据会多一个\ufeff，笔者在这里写了异常来处理此问题</li>
<li>自启动的程序如果是需要权限的，比如c盘的文件或者注册服务脚本程序什么的，就需要把代码块放到administrator.py里，然后在去调用</li>
</ol>
<h3 id="2、python实现的ftp自动上传下载程序（支持目录递归操作）"><a href="#2、python实现的ftp自动上传下载程序（支持目录递归操作）" class="headerlink" title="2、python实现的ftp自动上传下载程序（支持目录递归操作）"></a>2、python实现的ftp自动上传下载程序（支持目录递归操作）</h3><p><a href="http://www.cppblog.com/fwxjj/archive/2011/12/14/162085.html" target="_blank" rel="noopener">python实现的ftp自动上传下载程序（支持目录递归操作）—-转</a></p>
<p>因为python脚本可以直接用文本工具打开修改，所以没有设置参数。使用的时候直接修改掉main中的连接下载参数即可。<br>修改一下，可以用来备份网站上的图片，数据库什么的。 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python  </span></span><br><span class="line"><span class="comment">#coding=gbk  </span></span><br><span class="line"><span class="string">''''' </span></span><br><span class="line"><span class="string">    ftp自动下载、自动上传脚本，可以递归目录操作 </span></span><br><span class="line"><span class="string">'''</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">from</span> ftplib <span class="keyword">import</span> FTP  </span><br><span class="line"><span class="keyword">import</span> os,sys,string,datetime,time  </span><br><span class="line"><span class="keyword">import</span> socket  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MYFTP</span>:</span>  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, hostaddr, username, password, remotedir, port=<span class="number">21</span>)</span>:</span>  </span><br><span class="line">        self.hostaddr = hostaddr  </span><br><span class="line">        self.username = username  </span><br><span class="line">        self.password = password  </span><br><span class="line">        self.remotedir  = remotedir  </span><br><span class="line">        self.port     = port  </span><br><span class="line">        self.ftp      = FTP()  </span><br><span class="line">        self.file_list = []  </span><br><span class="line">        <span class="comment"># self.ftp.set_debuglevel(2)  </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__del__</span><span class="params">(self)</span>:</span>  </span><br><span class="line">        self.ftp.close()  </span><br><span class="line">        <span class="comment"># self.ftp.set_debuglevel(0)  </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(self)</span>:</span>  </span><br><span class="line">        ftp = self.ftp  </span><br><span class="line">        <span class="keyword">try</span>:   </span><br><span class="line">            timeout = <span class="number">60</span>  </span><br><span class="line">            socket.setdefaulttimeout(timeout)  </span><br><span class="line">            ftp.set_pasv(<span class="literal">True</span>)  </span><br><span class="line">            <span class="keyword">print</span> <span class="string">'开始连接到 %s'</span> %(self.hostaddr)  </span><br><span class="line">            ftp.connect(self.hostaddr, self.port)  </span><br><span class="line">            <span class="keyword">print</span> <span class="string">'成功连接到 %s'</span> %(self.hostaddr)  </span><br><span class="line">            <span class="keyword">print</span> <span class="string">'开始登录到 %s'</span> %(self.hostaddr)  </span><br><span class="line">            ftp.login(self.username, self.password)  </span><br><span class="line">            <span class="keyword">print</span> <span class="string">'成功登录到 %s'</span> %(self.hostaddr)  </span><br><span class="line">            debug_print(ftp.getwelcome())  </span><br><span class="line">        <span class="keyword">except</span> Exception:  </span><br><span class="line">            deal_error(<span class="string">"连接或登录失败"</span>)  </span><br><span class="line">        <span class="keyword">try</span>:  </span><br><span class="line">            ftp.cwd(self.remotedir)  </span><br><span class="line">        <span class="keyword">except</span>(Exception):  </span><br><span class="line">            deal_error(<span class="string">'切换目录失败'</span>)  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_same_size</span><span class="params">(self, localfile, remotefile)</span>:</span>  </span><br><span class="line">        <span class="keyword">try</span>:  </span><br><span class="line">            remotefile_size = self.ftp.size(remotefile)  </span><br><span class="line">        <span class="keyword">except</span>:  </span><br><span class="line">            remotefile_size = <span class="number">-1</span>  </span><br><span class="line">        <span class="keyword">try</span>:  </span><br><span class="line">            localfile_size = os.path.getsize(localfile)  </span><br><span class="line">        <span class="keyword">except</span>:  </span><br><span class="line">            localfile_size = <span class="number">-1</span>  </span><br><span class="line">        debug_print(<span class="string">'lo:%d  re:%d'</span> %(localfile_size, remotefile_size),)  </span><br><span class="line">        <span class="keyword">if</span> remotefile_size == localfile_size:  </span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>  </span><br><span class="line">        <span class="keyword">else</span>:  </span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">download_file</span><span class="params">(self, localfile, remotefile)</span>:</span>  </span><br><span class="line">        <span class="keyword">if</span> self.is_same_size(localfile, remotefile):  </span><br><span class="line">            debug_print(<span class="string">'%s 文件大小相同，无需下载'</span> %localfile)  </span><br><span class="line">            <span class="keyword">return</span>  </span><br><span class="line">        <span class="keyword">else</span>:  </span><br><span class="line">            debug_print(<span class="string">'&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;下载文件 %s ... ...'</span> %localfile)  </span><br><span class="line">        <span class="comment">#return  </span></span><br><span class="line">        file_handler = open(localfile, <span class="string">'wb'</span>)  </span><br><span class="line">        self.ftp.retrbinary(<span class="string">'RETR %s'</span>%(remotefile), file_handler.write)  </span><br><span class="line">        file_handler.close()  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">download_files</span><span class="params">(self, localdir=<span class="string">'./'</span>, remotedir=<span class="string">'./'</span>)</span>:</span>  </span><br><span class="line">        <span class="keyword">try</span>:  </span><br><span class="line">            self.ftp.cwd(remotedir)  </span><br><span class="line">        <span class="keyword">except</span>:  </span><br><span class="line">            debug_print(<span class="string">'目录%s不存在，继续...'</span> %remotedir)  </span><br><span class="line">            <span class="keyword">return</span>  </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(localdir):  </span><br><span class="line">            os.makedirs(localdir)  </span><br><span class="line">        debug_print(<span class="string">'切换至目录 %s'</span> %self.ftp.pwd())  </span><br><span class="line">        self.file_list = []  </span><br><span class="line">        self.ftp.dir(self.get_file_list)  </span><br><span class="line">        remotenames = self.file_list  </span><br><span class="line">        <span class="comment">#print(remotenames)  </span></span><br><span class="line">        <span class="comment">#return  </span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> remotenames:  </span><br><span class="line">            filetype = item[<span class="number">0</span>]  </span><br><span class="line">            filename = item[<span class="number">1</span>]  </span><br><span class="line">            local = os.path.join(localdir, filename)  </span><br><span class="line">            <span class="keyword">if</span> filetype == <span class="string">'d'</span>:  </span><br><span class="line">                self.download_files(local, filename)  </span><br><span class="line">            <span class="keyword">elif</span> filetype == <span class="string">'-'</span>:  </span><br><span class="line">                self.download_file(local, filename)  </span><br><span class="line">        self.ftp.cwd(<span class="string">'..'</span>)  </span><br><span class="line">        debug_print(<span class="string">'返回上层目录 %s'</span> %self.ftp.pwd())  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">(self, localfile, remotefile)</span>:</span>  </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(localfile):  </span><br><span class="line">            <span class="keyword">return</span>  </span><br><span class="line">        <span class="keyword">if</span> self.is_same_size(localfile, remotefile):  </span><br><span class="line">            debug_print(<span class="string">'跳过[相等]: %s'</span> %localfile)  </span><br><span class="line">            <span class="keyword">return</span>  </span><br><span class="line">        file_handler = open(localfile, <span class="string">'rb'</span>)  </span><br><span class="line">        self.ftp.storbinary(<span class="string">'STOR %s'</span> %remotefile, file_handler)  </span><br><span class="line">        file_handler.close()  </span><br><span class="line">        debug_print(<span class="string">'已传送: %s'</span> %localfile)  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">upload_files</span><span class="params">(self, localdir=<span class="string">'./'</span>, remotedir = <span class="string">'./'</span>)</span>:</span>  </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(localdir):  </span><br><span class="line">            <span class="keyword">return</span>  </span><br><span class="line">        localnames = os.listdir(localdir)  </span><br><span class="line">        self.ftp.cwd(remotedir)  </span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> localnames:  </span><br><span class="line">            src = os.path.join(localdir, item)  </span><br><span class="line">            <span class="keyword">if</span> os.path.isdir(src):  </span><br><span class="line">                <span class="keyword">try</span>:  </span><br><span class="line">                    self.ftp.mkd(item)  </span><br><span class="line">                <span class="keyword">except</span>:  </span><br><span class="line">                    debug_print(<span class="string">'目录已存在 %s'</span> %item)  </span><br><span class="line">                self.upload_files(src, item)  </span><br><span class="line">            <span class="keyword">else</span>:  </span><br><span class="line">                self.upload_file(src, item)  </span><br><span class="line">        self.ftp.cwd(<span class="string">'..'</span>)  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_file_list</span><span class="params">(self, line)</span>:</span>  </span><br><span class="line">        ret_arr = []  </span><br><span class="line">        file_arr = self.get_filename(line)  </span><br><span class="line">        <span class="keyword">if</span> file_arr[<span class="number">1</span>] <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">'.'</span>, <span class="string">'..'</span>]:  </span><br><span class="line">            self.file_list.append(file_arr)  </span><br><span class="line">              </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_filename</span><span class="params">(self, line)</span>:</span>  </span><br><span class="line">        pos = line.rfind(<span class="string">':'</span>)  </span><br><span class="line">        <span class="keyword">while</span>(line[pos] != <span class="string">' '</span>):  </span><br><span class="line">            pos += <span class="number">1</span>  </span><br><span class="line">        <span class="keyword">while</span>(line[pos] == <span class="string">' '</span>):  </span><br><span class="line">            pos += <span class="number">1</span>  </span><br><span class="line">        file_arr = [line[<span class="number">0</span>], line[pos:]]  </span><br><span class="line">        <span class="keyword">return</span> file_arr  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug_print</span><span class="params">(s)</span>:</span>  </span><br><span class="line">    <span class="keyword">print</span> (s)  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deal_error</span><span class="params">(e)</span>:</span>  </span><br><span class="line">    timenow  = time.localtime()  </span><br><span class="line">    datenow  = time.strftime(<span class="string">'%Y-%m-%d'</span>, timenow)  </span><br><span class="line">    logstr = <span class="string">'%s 发生错误: %s'</span> %(datenow, e)  </span><br><span class="line">    debug_print(logstr)  </span><br><span class="line">    file.write(logstr)  </span><br><span class="line">    sys.exit()  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:  </span><br><span class="line">    file = open(<span class="string">"log.txt"</span>, <span class="string">"a"</span>)  </span><br><span class="line">    timenow  = time.localtime()  </span><br><span class="line">    datenow  = time.strftime(<span class="string">'%Y-%m-%d'</span>, timenow)  </span><br><span class="line">    logstr = datenow  </span><br><span class="line">    <span class="comment"># 配置如下变量  </span></span><br><span class="line">    hostaddr = <span class="string">'localhost'</span> <span class="comment"># ftp地址  </span></span><br><span class="line">    username = <span class="string">'test'</span> <span class="comment"># 用户名  </span></span><br><span class="line">    password = <span class="string">'test'</span> <span class="comment"># 密码  </span></span><br><span class="line">    port  =  <span class="number">21</span>   <span class="comment"># 端口号   </span></span><br><span class="line">    rootdir_local  = <span class="string">'.'</span> + os.sep + <span class="string">'bak/'</span> <span class="comment"># 本地目录  </span></span><br><span class="line">    rootdir_remote = <span class="string">'./'</span>          <span class="comment"># 远程目录  </span></span><br><span class="line">      </span><br><span class="line">    f = MYFTP(hostaddr, username, password, rootdir_remote, port)  </span><br><span class="line">    f.login()  </span><br><span class="line">    f.download_files(rootdir_local, rootdir_remote)  </span><br><span class="line">      </span><br><span class="line">    timenow  = time.localtime()  </span><br><span class="line">    datenow  = time.strftime(<span class="string">'%Y-%m-%d'</span>, timenow)  </span><br><span class="line">    logstr += <span class="string">" - %s 成功执行了备份\n"</span> %datenow  </span><br><span class="line">    debug_print(logstr)  </span><br><span class="line">      </span><br><span class="line">    file.write(logstr)  </span><br><span class="line">    file.close()</span><br></pre></td></tr></table></figure>

<h3 id="3、每天从FTP服务器上下载文件"><a href="#3、每天从FTP服务器上下载文件" class="headerlink" title="3、每天从FTP服务器上下载文件"></a>3、每天从FTP服务器上下载文件</h3><h4 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">FTP常用操作</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">from</span> ftplib <span class="keyword">import</span> FTP</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FTP_OP</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host, username, password, port)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        初始化ftp</span></span><br><span class="line"><span class="string">        :param host: ftp主机ip</span></span><br><span class="line"><span class="string">        :param username: ftp用户名</span></span><br><span class="line"><span class="string">        :param password: ftp密码</span></span><br><span class="line"><span class="string">        :param port:  ftp端口 （默认21）</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.host = host</span><br><span class="line">        self.username = username</span><br><span class="line">        self.password = password</span><br><span class="line">        self.port = port</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ftp_connect</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        连接ftp</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        ftp = FTP()</span><br><span class="line">        ftp.set_debuglevel(<span class="number">0</span>)  <span class="comment"># 不开启调试模式</span></span><br><span class="line">        ftp.connect(host=self.host, port=self.port)  <span class="comment"># 连接ftp</span></span><br><span class="line">        ftp.login(self.username, self.password)  <span class="comment"># 登录ftp</span></span><br><span class="line">        <span class="keyword">return</span> ftp</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">download_file</span><span class="params">(self, ftp_file_path, dst_file_path, temp_ftp_file_name)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        从ftp下载文件到本地</span></span><br><span class="line"><span class="string">        :param ftp_file_path: ftp下载文件路径</span></span><br><span class="line"><span class="string">        :param dst_file_path: 本地存放路径</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span>        </span><br><span class="line">        buffer_size = <span class="number">10240</span>  <span class="comment">#默认是8192</span></span><br><span class="line">        ftp = self.ftp_connect()</span><br><span class="line">        <span class="comment">#print ftp.getwelcome()  #显示登录ftp信息</span></span><br><span class="line">        file_list = ftp.nlst(ftp_file_path)</span><br><span class="line">        <span class="keyword">for</span> file_name <span class="keyword">in</span> file_list:</span><br><span class="line">                ftp_file = os.path.join(ftp_file_path, file_name)</span><br><span class="line">                file_name=os.path.basename(file_name)</span><br><span class="line">                write_file = os.path.join(dst_file_path+file_name)</span><br><span class="line">                <span class="comment">#print write_file</span></span><br><span class="line">                <span class="keyword">if</span> file_name.find(temp_ftp_file_name)&gt;<span class="number">-1</span> <span class="keyword">and</span> <span class="keyword">not</span> os.path.exists(write_file):</span><br><span class="line">                        <span class="keyword">print</span> <span class="string">"file_name:"</span>+write_file</span><br><span class="line">                        <span class="comment">#ftp_file = os.path.join(ftp_file_path, file_name)</span></span><br><span class="line">                        <span class="comment">#write_file = os.path.join(dst_file_path, file_name)</span></span><br><span class="line">                        <span class="keyword">with</span> open(write_file, <span class="string">"wb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">                                ftp.retrbinary(<span class="string">'RETR &#123;0&#125;'</span>.format(ftp_file), f.write, buffer_size)</span><br><span class="line">                        f.close()</span><br><span class="line">        ftp.quit()</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">  		<span class="comment">#FTP服务器IP</span></span><br><span class="line">        host = <span class="string">"***"</span></span><br><span class="line">         <span class="comment">#账号</span></span><br><span class="line">        username = <span class="string">"***"</span>  </span><br><span class="line">         <span class="comment"># 密码</span></span><br><span class="line">        password = <span class="string">"***"</span> </span><br><span class="line">         <span class="comment"># 端口</span></span><br><span class="line">        port = <span class="string">"21"</span> </span><br><span class="line">        <span class="comment">#从FTP服务器下载的目录</span></span><br><span class="line">        ftp_file_path = <span class="string">"/rawdata8_2/rbdata_pt/"</span>  </span><br><span class="line">         <span class="comment">#下载到本地的目录</span></span><br><span class="line">        dst_file_path = <span class="string">u"G:/资源/资源数据同步/"</span> </span><br><span class="line">        <span class="comment">#需要下载文件的前缀</span></span><br><span class="line">        list = [<span class="string">"ltexn"</span>,<span class="string">"yhsqk"</span>]</span><br><span class="line">        <span class="comment">#获取当天的前一天日期</span></span><br><span class="line">        now_date=(datetime.date.today() + datetime.timedelta(days = <span class="number">-1</span>)).strftime(<span class="string">'%Y%m%d'</span>)        </span><br><span class="line">        <span class="comment">#print now_date</span></span><br><span class="line">        ftp = FTP_OP(host=host, username=username, password=password, port=port)</span><br><span class="line">        <span class="keyword">for</span> pre <span class="keyword">in</span> list:</span><br><span class="line">                <span class="comment">#print pre</span></span><br><span class="line">                temp_ftp_file_name=pre+<span class="string">"_"</span>+now_date+<span class="string">".csv"</span></span><br><span class="line">                <span class="comment">#print temp_ftp_file_name</span></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                        ftp.download_file(ftp_file_path=ftp_file_path, dst_file_path=dst_file_path,temp_ftp_file_name=temp_ftp_file_name)</span><br><span class="line">                <span class="keyword">except</span> :</span><br><span class="line">                        <span class="keyword">print</span> <span class="string">'异常'</span></span><br></pre></td></tr></table></figure>

<h4 id="计划"><a href="#计划" class="headerlink" title="计划"></a>计划</h4><ol>
<li>点击电脑–管理–系统工具–任务计划程序，右键选择创建基本任务</li>
<li>设置好运行周期和运行时间已经脚本路径</li>
<li>好了</li>
<li>如果需要每天执行多次，或者这个定时任务可以执行多个脚本。可以如下：<ol>
<li>找到你新建的定时任务，右键–属性</li>
<li>在触发器可以添加多次执行，在操作可以添加执行多个脚本</li>
</ol>
</li>
</ol>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Gkon</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://gxkon.top/posts/636b49f9/">http://gxkon.top/posts/636b49f9/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://gxkon.top" target="_blank">Gxkon's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Python/">Python</a></div><div class="post_share"><div class="social-share" data-image="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/10/7/68coffee-5567269_1280.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/posts/c4eece1e/"><img class="prev_cover" data-src="/Pic/post.jpg" onerror="onerror=null;src='/Pic/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Git基础教程</div></div></a></div><div class="next-post pull_right"><a href="/posts/ea7246b/"><img class="next_cover" data-src="/Pic/post.jpg" onerror="onerror=null;src='/Pic/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">WordPress淘客商城</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/posts/ffb5fdc7/" title="Python GUI编程(Tkinter)"><img class="relatedPosts_cover" data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/09/night-4011992_1280.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-09-24</div><div class="relatedPosts_title">Python GUI编程(Tkinter)</div></div></a></div><div class="relatedPosts_item"><a href="/posts/1ed47f5b/" title="Python基础之列表"><img class="relatedPosts_cover" data-src="https://tvax3.sinaimg.cn/large/4a9e9735gy1gdait9noiwj24802diqp3.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-28</div><div class="relatedPosts_title">Python基础之列表</div></div></a></div><div class="relatedPosts_item"><a href="/posts/f1154067/" title="Python基础之库、Pip、Pypi"><img class="relatedPosts_cover" data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/09/norway-4970081_1280.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-28</div><div class="relatedPosts_title">Python基础之库、Pip、Pypi</div></div></a></div><div class="relatedPosts_item"><a href="/posts/49a688a0/" title="Python基础之字符串"><img class="relatedPosts_cover" data-src="https://tvax3.sinaimg.cn/large/4a9e9735gy1gdaiuzfg25j24002o0b29.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-28</div><div class="relatedPosts_title">Python基础之字符串</div></div></a></div><div class="relatedPosts_item"><a href="/posts/bbbc4a2f/" title="Python基础之安装与部署"><img class="relatedPosts_cover" data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/09/geyser-4766105_1280.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-27</div><div class="relatedPosts_title">Python基础之安装与部署</div></div></a></div><div class="relatedPosts_item"><a href="/posts/dcbec147/" title="Python中级之Pyinstaller打包成exe"><img class="relatedPosts_cover" data-src="/Pic/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-11-07</div><div class="relatedPosts_title">Python中级之Pyinstaller打包成exe</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '1ce3148e3133bf004c96',
  clientSecret: '2a1e5c0f4d38387460b916843bfe5cac67ef2d07',
  repo: 'blankwz.github.io',
  owner: 'blankwz',
  admin: ['blankwz'],
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  perPage: 10,
  distractionFreeMode: false,
  pagerDirection: 'last',
  createIssueManually: false,
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  try {
    document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
  } catch (e) {
    return false
  }
}</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Gkon</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">簡</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script src="/js/third-party/ClickShowText.js"></script></body></html>
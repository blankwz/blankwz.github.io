<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Flask教程之通俗易懂案例 | Gxkon's Blog</title><meta name="description" content="Flask教程之通俗易懂案例 官方中文教程：这里  一、简单入门使用案例一 Flask 是一个轻量级的基于 Python 的 Web 框架，支持 Python 2 和 Python 3，简单易用，适合快速开发。封装功能不及Django完善，性能不及Tornado，但是Flask的第三方开源组件比较丰富 其 WSGI工具箱采用 Werkzeug ，模板引擎则使用 Jinja2 。 Flask也被称为"><meta name="keywords" content="Python"><meta name="author" content="Gkon"><meta name="copyright" content="Gkon"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Flask教程之通俗易懂案例"><meta name="twitter:description" content="Flask教程之通俗易懂案例 官方中文教程：这里  一、简单入门使用案例一 Flask 是一个轻量级的基于 Python 的 Web 框架，支持 Python 2 和 Python 3，简单易用，适合快速开发。封装功能不及Django完善，性能不及Tornado，但是Flask的第三方开源组件比较丰富 其 WSGI工具箱采用 Werkzeug ，模板引擎则使用 Jinja2 。 Flask也被称为"><meta name="twitter:image" content="http://gxkon.top/Pic/post.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Flask教程之通俗易懂案例"><meta property="og:url" content="http://gxkon.top/posts/40ebec26/"><meta property="og:site_name" content="Gxkon's Blog"><meta property="og:description" content="Flask教程之通俗易懂案例 官方中文教程：这里  一、简单入门使用案例一 Flask 是一个轻量级的基于 Python 的 Web 框架，支持 Python 2 和 Python 3，简单易用，适合快速开发。封装功能不及Django完善，性能不及Tornado，但是Flask的第三方开源组件比较丰富 其 WSGI工具箱采用 Werkzeug ，模板引擎则使用 Jinja2 。 Flask也被称为"><meta property="og:image" content="http://gxkon.top/Pic/post.jpg"><meta property="article:published_time" content="2020-10-06T08:57:07.000Z"><meta property="article:modified_time" content="2021-01-23T12:12:21.559Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://gxkon.top/posts/40ebec26/"><link rel="prev" title="Python文本处理之读取yaml配置文件" href="http://gxkon.top/posts/263918de/"><link rel="next" title="Flask接口单元测试+测试报告+测试覆盖率" href="http://gxkon.top/posts/8aade918/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: {"text":"本人,超帅,打钱","fontSize":"15px"},
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/Pic/avatar.png" onerror="onerror=null;src='/Pic/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">156</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">83</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">54</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 娱乐</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask教程之通俗易懂案例"><span class="toc-text">Flask教程之通俗易懂案例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、简单入门使用案例一"><span class="toc-text">一、简单入门使用案例一</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-安装"><span class="toc-text">1. 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-创建简单项目"><span class="toc-text">2. 创建简单项目</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#app-run-调试模式"><span class="toc-text">app.run()调试模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#app-run-绑定IP和端口"><span class="toc-text">app.run()绑定IP和端口</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Get-获取Url参数"><span class="toc-text">3. Get - 获取Url参数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#获取所有的url参数"><span class="toc-text">获取所有的url参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取某个指定的参数"><span class="toc-text">获取某个指定的参数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#两种方法避免None错误结果"><span class="toc-text">两种方法避免None错误结果</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#处理多值"><span class="toc-text">处理多值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-POST-数据处理"><span class="toc-text">4.POST - 数据处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#查看Post数据内容"><span class="toc-text">查看Post数据内容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#解析POST数据"><span class="toc-text">解析POST数据</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-Post-Json数据处理"><span class="toc-text">5. Post - Json数据处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#响应JSON-json-dumps-方法"><span class="toc-text">响应JSON json.dumps()方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#响应JSON-使用-jsonify-工具函数"><span class="toc-text">响应JSON - 使用 jsonify 工具函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-上传文件"><span class="toc-text">6. 上传文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-Restful-URL-获取URL变量"><span class="toc-text">7. Restful URL - 获取URL变量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#简单"><span class="toc-text">简单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#route中指定类型转换"><span class="toc-text">route中指定类型转换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#自定义类型转换器"><span class="toc-text">自定义类型转换器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-使用url-for生成链接"><span class="toc-text">8. 使用url_for生成链接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-重定向-redirect"><span class="toc-text">9. 重定向  redirect</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-使用Jinja2模板引擎"><span class="toc-text">10. 使用Jinja2模板引擎</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-自定义HTTP错误的响应-例如404"><span class="toc-text">11. 自定义HTTP错误的响应 - 例如404</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#自定义错误页面-app-errorhandler"><span class="toc-text">自定义错误页面 - app.errorhandler</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-用户会话-session"><span class="toc-text">12. 用户会话 - session</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#设置session的有效时间"><span class="toc-text">设置session的有效时间</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-使用Cookie"><span class="toc-text">13.使用Cookie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-闪存系统-flashing-system"><span class="toc-text">14. 闪存系统 flashing system</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#对flash的内容进行分类"><span class="toc-text">对flash的内容进行分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#在模板文件中获取flash的内容"><span class="toc-text">在模板文件中获取flash的内容</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、简单入门使用案例二"><span class="toc-text">二、简单入门使用案例二</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-简单例子"><span class="toc-text">1. 简单例子</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#路由-app-route"><span class="toc-text">路由@app.route()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-HTTP的get和post方法"><span class="toc-text">2. HTTP的get和post方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-静态文件"><span class="toc-text">3. 静态文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-模板（HTML）文件及模板渲染-render-template"><span class="toc-text">4. 模板（HTML）文件及模板渲染 render_template</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-重定向-redirect"><span class="toc-text">5. 重定向 redirect</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-Error"><span class="toc-text">6. Error</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-flash和get-flashed-messages"><span class="toc-text">7.flash和get_flashed_messages</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-logger"><span class="toc-text">8. logger</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、Flask搭建API案例"><span class="toc-text">三、Flask搭建API案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Flask搭建API案例一"><span class="toc-text">1. Flask搭建API案例一</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#从url中解析出文字信息"><span class="toc-text">从url中解析出文字信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#传参并回参"><span class="toc-text">传参并回参</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#clent端访问server端"><span class="toc-text">clent端访问server端</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Flask搭建API方法案例二"><span class="toc-text">2. Flask搭建API方法案例二</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Flask搭建API方法案例三-参数的判断"><span class="toc-text">3. Flask搭建API方法案例三 - 参数的判断</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#只接受get方法访问"><span class="toc-text">只接受get方法访问</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#只接受post方法访问"><span class="toc-text">只接受post方法访问</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、Flask的logger案例"><span class="toc-text">四、Flask的logger案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#简单使用"><span class="toc-text">简单使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#直接设置Logger"><span class="toc-text">直接设置Logger</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#logger载入配置字典"><span class="toc-text">logger载入配置字典</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#工厂模式下Logger"><span class="toc-text">工厂模式下Logger</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、Flask接口标准化"><span class="toc-text">五、Flask接口标准化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#接口统一返回形式"><span class="toc-text">接口统一返回形式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#初级"><span class="toc-text">初级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#升级"><span class="toc-text">升级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#加载Yaml"><span class="toc-text">加载Yaml</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#编写msg-yaml"><span class="toc-text">编写msg.yaml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#修改-response-py"><span class="toc-text">修改 response.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#修改app-py内容"><span class="toc-text">修改app.py内容</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六、接口响应封装及自定义json返回类型"><span class="toc-text">六、接口响应封装及自定义json返回类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#问题重现"><span class="toc-text">问题重现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改装饰器"><span class="toc-text">修改装饰器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#编写route装饰器（util-py）"><span class="toc-text">编写route装饰器（util.py）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用route装饰器-test-py"><span class="toc-text">使用route装饰器(test.py)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决json类型错误"><span class="toc-text">解决json类型错误</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Flask-json转换类如下"><span class="toc-text">Flask json转换类如下</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#自定义Flask-json解析类-core-py"><span class="toc-text">自定义Flask json解析类(core.py)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用自定义Flask-json解析类-app-py"><span class="toc-text">使用自定义Flask json解析类(app.py)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试-test-py"><span class="toc-text">测试(test.py)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#七、数据库插件-SQLAlchemy"><span class="toc-text">七、数据库插件 SQLAlchemy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#简单使用-1"><span class="toc-text">简单使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#实例化SQLAlchemy-core-py"><span class="toc-text">实例化SQLAlchemy(core.py)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#注册到flask-App中-app-py"><span class="toc-text">注册到flask App中(app.py)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#定义model及创建数据库表"><span class="toc-text">定义model及创建数据库表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#增"><span class="toc-text">增</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查"><span class="toc-text">查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#改"><span class="toc-text">改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删"><span class="toc-text">删</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#事务"><span class="toc-text">事务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#八、使用redis数据库"><span class="toc-text">八、使用redis数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#redis"><span class="toc-text">redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Python使用redis"><span class="toc-text">Python使用redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flask使用redis"><span class="toc-text">Flask使用redis</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#封装redis方法-util-py"><span class="toc-text">封装redis方法(util.py)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试使用-test-py"><span class="toc-text">测试使用(test.py)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Flask-App-app-py"><span class="toc-text">Flask App(app.py)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动Flask-app"><span class="toc-text">启动Flask app</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#九、使用APScheduler定时任务"><span class="toc-text">九、使用APScheduler定时任务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#将apscheduler注册到Flask-App"><span class="toc-text">将apscheduler注册到Flask App</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编写定时任务task-py"><span class="toc-text">编写定时任务task.py</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建app-py"><span class="toc-text">创建app.py</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试"><span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#踩坑点"><span class="toc-text">踩坑点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Q-多进程部署，定时任务重复启动解决方法"><span class="toc-text">Q:多进程部署，定时任务重复启动解决方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q-Gunicorn使用gevent模式无效解决方法"><span class="toc-text">Q:Gunicorn使用gevent模式无效解决方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Q-使用Flask数据库解决方法"><span class="toc-text">Q:使用Flask数据库解决方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十、蓝图"><span class="toc-text">十、蓝图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#问题"><span class="toc-text">问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是蓝图"><span class="toc-text">什么是蓝图</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#蓝图的运行机制"><span class="toc-text">蓝图的运行机制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#例子演示"><span class="toc-text">例子演示</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#把每个模块的路由封装到各自的蓝图对象中"><span class="toc-text">把每个模块的路由封装到各自的蓝图对象中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#把单个蓝图对象注册到flask的实例对象app中"><span class="toc-text">把单个蓝图对象注册到flask的实例对象app中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动文件"><span class="toc-text">启动文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十一、操作Excel"><span class="toc-text">十一、操作Excel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Flask-Excel的使用"><span class="toc-text">Flask_Excel的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flask结合xlsxwriter使用"><span class="toc-text">Flask结合xlsxwriter使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十二、操作Word"><span class="toc-text">十二、操作Word</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Python处理Word的包"><span class="toc-text">Python处理Word的包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docxtpl的简单使用"><span class="toc-text">docxtpl的简单使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flask结合docxtpl使用"><span class="toc-text">Flask结合docxtpl使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十三、输出PDF报表"><span class="toc-text">十三、输出PDF报表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Python处理PDF的包"><span class="toc-text">Python处理PDF的包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReportLab简单使用"><span class="toc-text">ReportLab简单使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flask结合reportlab使用"><span class="toc-text">Flask结合reportlab使用</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/Pic/post.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Gxkon's Blog</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 娱乐</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Flask教程之通俗易懂案例</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-10-06 16:57:07"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-10-06</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2021-01-23 20:12:21"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2021-01-23</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Python/">Python</a><i class="fa fa-angle-right post-meta__separator" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Python/Flask/">Flask</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/posts/40ebec26/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="Flask教程之通俗易懂案例"><a href="#Flask教程之通俗易懂案例" class="headerlink" title="Flask教程之通俗易懂案例"></a>Flask教程之通俗易懂案例</h1><blockquote>
<p>官方中文教程：<a href="https://dormousehole.readthedocs.io/en/latest/" target="_blank" rel="noopener">这里</a></p>
</blockquote>
<h2 id="一、简单入门使用案例一"><a href="#一、简单入门使用案例一" class="headerlink" title="一、简单入门使用案例一"></a>一、简单入门使用案例一</h2><blockquote>
<p>Flask 是一个轻量级的基于 Python 的 Web 框架，支持 Python 2 和 Python 3，简单易用，适合快速开发。封装功能不及Django完善，性能不及Tornado，但是Flask的<a href="http://flask.pocoo.org/extensions/" target="_blank" rel="noopener">第三方开源组件</a>比较丰富</p>
<p>其 WSGI工具箱采用 Werkzeug ，模板引擎则使用 Jinja2 。</p>
<p>Flask也被称为 “microframework” ，因为它使用简单的核心，用 extension 增加其他功能。</p>
<p>Flask没有默认使用的数据库、窗体验证工具。</p>
<p>参考：<a href="https://www.cnblogs.com/cleven/p/10858016.html" target="_blank" rel="noopener">Python Flask Web 框架入门</a> ，特别感谢<a href="https://www.cnblogs.com/cleven/" target="_blank" rel="noopener">执着的怪味豆</a>！！教程非常通俗易懂！</p>
</blockquote>
<p><strong>其他web框架</strong></p>
<ul>
<li><p>Django：比较“重”的框架，同时也是最出名的Python框架。包含了web开发中常用的功能、组件的框架（ORM、Session、Form、Admin、分页、中间件、信号、缓存、ContenType….），Django是走大而全的方向，最出名的是其全自动化的管理后台：只需要使用起ORM，做简单的对象定义，它就能自动生成数据库结构、以及全功能的管理后台。</p>
</li>
<li><p>Tornado：大特性就是异步非阻塞、原生支持WebSocket协议；</p>
</li>
<li><p>Bottle：是一个简单高效的遵循WSGI的微型python Web框架。说微型，是因为它只有一个文件，除Python标准库外，它不依赖于任何第三方模块。</p>
</li>
</ul>
<h3 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h3><p><code>pip3 install Flask</code></p>
<h3 id="2-创建简单项目"><a href="#2-创建简单项目" class="headerlink" title="2. 创建简单项目"></a>2. 创建简单项目</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello World!'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<ol>
<li><p>python内置变量<code>__name__</code>的值是字符串<code>__main__</code> 。</p>
<ul>
<li>Flask类将这个参数作为程序名称。</li>
<li>当然这个是可以自定义的，比如<code>app = Flask(&quot;my-app&quot;)</code></li>
</ul>
</li>
<li><p>设置 静态资源、模板</p>
<ul>
<li><code>app = Flask(&quot;my-app&quot;, static_folder=&quot;path1&quot;, template_folder=&quot;path2&quot;)</code></li>
</ul>
</li>
</ol>
<h4 id="app-run-调试模式"><a href="#app-run-调试模式" class="headerlink" title="app.run()调试模式"></a>app.run()调试模式</h4><ol>
<li>以<code>app.run()</code>方式下运行，如果服务器端出现错误是不会在客户端显示的</li>
<li>但是在开发环境中，显示错误信息是很有必要的，</li>
<li>要显示错误信息，需要开启调试模式  <code>app.run(debug=True)</code></li>
<li><strong>debug=True 的另一个好处是，程序启动后，会自动检测源码是否发生变化，若有变化则自动重启程序。这可以帮我们省下很多时间</strong></li>
</ol>
<h4 id="app-run-绑定IP和端口"><a href="#app-run-绑定IP和端口" class="headerlink" title="app.run()绑定IP和端口"></a>app.run()绑定IP和端口</h4><p>默认情况下，Flask绑定IP为<code>127.0.0.1</code>，端口为<code>5000</code></p>
<p>也可以<code>自定义</code>： <code>app.run(host=&#39;0.0.0.0&#39;, port=80, debug=True)</code></p>
<ul>
<li><code>0.0.0.0</code>代表电脑所有的IP。<code>80</code>是HTTP网站服务的默认端口</li>
</ul>
<h3 id="3-Get-获取Url参数"><a href="#3-Get-获取Url参数" class="headerlink" title="3. Get - 获取Url参数"></a>3. Get - 获取Url参数</h3><h4 id="获取所有的url参数"><a href="#获取所有的url参数" class="headerlink" title="获取所有的url参数"></a>获取所有的url参数</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    print(request.path)</span><br><span class="line">    print(request.full_path)</span><br><span class="line">    <span class="keyword">return</span> request.args.__str__()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 在浏览器中访问http://127.0.0.1:5000/?user=Flask&amp;time&amp;p=7&amp;p=8，</span></span><br><span class="line"><span class="comment">#浏览器中将显示：</span></span><br><span class="line">ImmutableMultiDict([(<span class="string">'user'</span>, <span class="string">'Flask'</span>), (<span class="string">'time'</span>, <span class="string">''</span>), (<span class="string">'p'</span>, <span class="string">'7'</span>), (<span class="string">'p'</span>, <span class="string">'8'</span>)])</span><br><span class="line"><span class="comment"># 控制台（终端）将显示</span></span><br><span class="line">/</span><br><span class="line">/?user=Flask&amp;time&amp;p=7&amp;p=8</span><br></pre></td></tr></table></figure>

<h4 id="获取某个指定的参数"><a href="#获取某个指定的参数" class="headerlink" title="获取某个指定的参数"></a>获取某个指定的参数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> request.args.get(<span class="string">'info'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 在浏览器中访问http://127.0.0.1:5000/?info=hello，浏览器将显示</span></span><br><span class="line">hello</span><br></pre></td></tr></table></figure>

<p><strong>但是当我们访问<code>http://127.0.0.1:5000/</code>时候却出现了500错误</strong></p>
<p>因为<code>request.args.get(&#39;info&#39;)</code>返回Python内置的None，而<strong>Flask不允许返回None</strong></p>
<h5 id="两种方法避免None错误结果"><a href="#两种方法避免None错误结果" class="headerlink" title="两种方法避免None错误结果"></a>两种方法避免None错误结果</h5><ol>
<li>判断下它是不是None</li>
<li>设置默认值</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 判断下它是不是None</span></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    r = request.args.get(<span class="string">'info'</span>)</span><br><span class="line">    <span class="keyword">if</span> r==<span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># do something</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者设置默认值</span></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    r = request.args.get(<span class="string">'info'</span>, <span class="string">'hi'</span>)</span><br><span class="line">    <span class="keyword">return</span> r</span><br></pre></td></tr></table></figure>

<h4 id="处理多值"><a href="#处理多值" class="headerlink" title="处理多值"></a>处理多值</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    r = request.args.getlist(<span class="string">'p'</span>)  <span class="comment"># 返回一个list</span></span><br><span class="line">    <span class="keyword">return</span> str(r)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 浏览器输入 http://127.0.0.1:5000/?user=Flask&amp;time&amp;p=7&amp;p=8，</span></span><br><span class="line">我们会看到[<span class="string">'7'</span>, <span class="string">'8'</span>]</span><br></pre></td></tr></table></figure>

<h3 id="4-POST-数据处理"><a href="#4-POST-数据处理" class="headerlink" title="4.POST - 数据处理"></a>4.POST - 数据处理</h3><blockquote>
<p>post测试方法：</p>
<ol>
<li><p>使用Postman软件 （建议使用此方法）</p>
</li>
<li><p>requests 编写client端</p>
</li>
</ol>
</blockquote>
<h4 id="查看Post数据内容"><a href="#查看Post数据内容" class="headerlink" title="查看Post数据内容"></a>查看Post数据内容</h4><p><strong>服务端</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello world'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/register', methods=['POST'])  # 只接受post数据</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">()</span>:</span></span><br><span class="line">    print(request.headers)  <span class="comment"># 打印请求头</span></span><br><span class="line">    print(request.stream.read()) <span class="comment">#输出 接收到的数据  b'name=letian&amp;password=123'</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'welcome'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><strong>编写client端</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">user_info = &#123;<span class="string">'name'</span>: <span class="string">'letian'</span>, <span class="string">'password'</span>: <span class="string">'123'</span>&#125;</span><br><span class="line">r = requests.post(<span class="string">"http://127.0.0.1:5000/register"</span>, data=user_info)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>

<p><strong>测试</strong></p>
<ol>
<li>先运行服务端</li>
<li>再运行客户端</li>
</ol>
<h4 id="解析POST数据"><a href="#解析POST数据" class="headerlink" title="解析POST数据"></a>解析POST数据</h4><p>使用Flask内置的解析器<code>request.form</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello world'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/register', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">()</span>:</span></span><br><span class="line">    print(request.headers)</span><br><span class="line">    <span class="comment"># print(request.stream.read()) # 不要用，否则下面的form取不到数据</span></span><br><span class="line">    print(request.form) </span><br><span class="line">    print(request.form[<span class="string">'name'</span>])</span><br><span class="line">    print(request.form.get(<span class="string">'name'</span>))</span><br><span class="line">    print(request.form.getlist(<span class="string">'name'</span>))</span><br><span class="line">    print(request.form.get(<span class="string">'nickname'</span>, default=<span class="string">'little apple'</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'welcome'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><strong>client客户端</strong><a href="#查看Post数据内容">同上</a></p>
<p><strong>结果</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Host: 127.0.0.1:5000</span><br><span class="line">User-Agent: python-requests/2.19.1</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: 24</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ImmutableMultiDict([(<span class="string">'name'</span>, <span class="string">'letian'</span>), (<span class="string">'password'</span>, <span class="string">'123'</span>)])</span><br><span class="line">letian</span><br><span class="line">letian</span><br><span class="line">[<span class="string">'letian'</span>]</span><br><span class="line">little apple</span><br></pre></td></tr></table></figure>

<h3 id="5-Post-Json数据处理"><a href="#5-Post-Json数据处理" class="headerlink" title="5. Post - Json数据处理"></a>5. Post - Json数据处理</h3><blockquote>
<p>如果POST的数据是JSON格式，<strong><code>request.json</code></strong>会自动将json数据转换成Python类型（字典或者列表）</p>
</blockquote>
<p><strong>服务端</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line">app = Flask(<span class="string">"my-app"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello World!'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/add', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">()</span>:</span></span><br><span class="line">    print(request.headers)</span><br><span class="line">    print(type(request.json))</span><br><span class="line">    print(request.json)</span><br><span class="line">    result = request.json[<span class="string">'a'</span>] + request.json[<span class="string">'b'</span>]</span><br><span class="line">    <span class="keyword">return</span> str(result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'127.0.0.1'</span>, port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><strong>Postman请求：</strong></p>
<ol>
<li>请求：Post <code>http://127.0.0.1:5000/add</code></li>
<li>Body：<code>{&#39;a&#39;: 1, &#39;b&#39;: 2}</code></li>
</ol>
<p><strong>结果</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Host: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span></span><br><span class="line">User-Agent: python-requests/<span class="number">2.19</span><span class="number">.1</span></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: <span class="number">16</span></span><br><span class="line">Content-Type: application/json   <span class="comment"># 这里是Json</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">dict</span>'&gt;</span></span><br><span class="line">&#123;'a': 1, 'b': 2&#125;</span><br></pre></td></tr></table></figure>



<h4 id="响应JSON-json-dumps-方法"><a href="#响应JSON-json-dumps-方法" class="headerlink" title="响应JSON json.dumps()方法"></a>响应JSON json.dumps()方法</h4><p>响应JSON时，除了要把响应体改成JSON格式，响应头的<code>Content-Type</code>也要设置为<code>application/json</code></p>
<p><strong>客户端</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, Response</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">app = Flask(<span class="string">"my-app"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello World!'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/add', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">()</span>:</span></span><br><span class="line">    result = &#123;<span class="string">'sum'</span>: request.json[<span class="string">'a'</span>] + request.json[<span class="string">'b'</span>]&#125;</span><br><span class="line">    resp = Response(json.dumps(result),  mimetype=<span class="string">'application/json'</span>)</span><br><span class="line">    resp.headers.add(<span class="string">'Server'</span>, <span class="string">'python flask'</span>)  <span class="comment"># 定制http响应头</span></span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'127.0.0.1'</span>, port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><strong>Postman请求：</strong></p>
<ol>
<li>请求：Post <code>http://127.0.0.1:5000/add</code></li>
<li>Body：<code>{&#39;a&#39;: 1, &#39;b&#39;: 2}</code></li>
</ol>
<p><strong>客户端结果</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>, <span class="string">'Content-Length'</span>: <span class="string">'10'</span>, <span class="string">'Server'</span>: <span class="string">'python flask'</span>, <span class="string">'Date'</span>: <span class="string">'Sat, 07 Jul 2018 05:26:40 GMT'</span>&#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">"sum"</span>: <span class="number">3</span>&#125;</span><br></pre></td></tr></table></figure>

<h4 id="响应JSON-使用-jsonify-工具函数"><a href="#响应JSON-使用-jsonify-工具函数" class="headerlink" title="响应JSON - 使用 jsonify 工具函数"></a><strong>响应JSON - 使用 jsonify 工具函数</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify</span><br><span class="line"></span><br><span class="line">app = Flask(<span class="string">"my-app"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello World!'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/add', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">()</span>:</span></span><br><span class="line">    result = &#123;<span class="string">'sum'</span>: request.json[<span class="string">'a'</span>] + request.json[<span class="string">'b'</span>]&#125;</span><br><span class="line">    <span class="keyword">return</span> jsonify(result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'127.0.0.1'</span>, port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h3 id="6-上传文件"><a href="#6-上传文件" class="headerlink" title="6. 上传文件"></a>6. 上传文件</h3><p><strong>要求</strong></p>
<ol>
<li>将上传的图片只允许’png’、’jpg’、’jpeg’、’gif’这四种格式，</li>
<li>通过url<code>/upload</code>使用POST上传，</li>
<li>上传的图片存放在服务器端的<code>static/uploads</code>目录下 （需要在服务端的项目目录下创建<code>static/uploads</code>文件夹）</li>
<li>使用werkzeug库，判断文件名是否安全，例如防止文件名是<code>../../../a.png</code><ul>
<li><code>pip3 install werkzeug</code></li>
</ul>
</li>
</ol>
<p><strong>服务端</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> werkzeug.utils <span class="keyword">import</span> secure_filename</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件上传目录</span></span><br><span class="line">app.config[<span class="string">'UPLOAD_FOLDER'</span>] = <span class="string">'static/uploads/'</span></span><br><span class="line"><span class="comment"># 支持的文件格式</span></span><br><span class="line">app.config[<span class="string">'ALLOWED_EXTENSIONS'</span>] = &#123;<span class="string">'png'</span>, <span class="string">'jpg'</span>, <span class="string">'jpeg'</span>, <span class="string">'gif'</span>&#125;  <span class="comment"># 集合类型</span></span><br><span class="line"><span class="comment"># 控制上产文件的大小，可以设置请求实体的大小，例如：(不过，在处理上传文件时候，需要使用try:...except:...)</span></span><br><span class="line">app.config[<span class="string">'MAX_CONTENT_LENGTH'</span>] = <span class="number">16</span> * <span class="number">1024</span> * <span class="number">1024</span> <span class="comment">#16MB</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断文件名是否是我们支持的格式</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">allowed_file</span><span class="params">(filename)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'.'</span> <span class="keyword">in</span> filename <span class="keyword">and</span> \</span><br><span class="line">           filename.rsplit(<span class="string">'.'</span>, <span class="number">1</span>)[<span class="number">1</span>] <span class="keyword">in</span> app.config[<span class="string">'ALLOWED_EXTENSIONS'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello world'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/upload', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">()</span>:</span></span><br><span class="line">    upload_file = request.files[<span class="string">'image'</span>]</span><br><span class="line">    <span class="keyword">if</span> upload_file <span class="keyword">and</span> allowed_file(upload_file.filename):</span><br><span class="line">        filename = secure_filename(upload_file.filename)</span><br><span class="line">        <span class="comment"># 将文件保存到 static/uploads 目录，文件名同上传时使用的文件名</span></span><br><span class="line">        upload_file.save(os.path.join(app.root_path, app.config[<span class="string">'UPLOAD_FOLDER'</span>], filename))</span><br><span class="line">        <span class="comment"># 获取上传文件的内容可以</span></span><br><span class="line">        file_content = request.files[<span class="string">'image'</span>].stream.read()</span><br><span class="line">        print(file_content)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'info is '</span>+request.form.get(<span class="string">'info'</span>, <span class="string">''</span>)+<span class="string">'. success'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'failed'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 解释:</span></span><br><span class="line"><span class="number">1.</span> app.config中的config是字典的子类，可以用来设置自有的配置信息，也可以设置自己的配置信息。</span><br><span class="line"><span class="number">2.</span>  函数allowed_file(filename)用来判断filename是否有后缀以及后缀是否在app.config[<span class="string">'ALLOWED_EXTENSIONS'</span>]中</span><br><span class="line"><span class="number">3.</span>  客户端上传的图片必须以image标识</span><br><span class="line"><span class="number">4.</span>  upload_file是上传文件对应的对象</span><br><span class="line"><span class="number">5.</span> app.root_path获取server.py所在目录在文件系统中的绝对路径。</span><br><span class="line"><span class="number">6.</span> upload_file.save(path)用来将upload_file保存在服务器的文件系统中，参数最好是绝对路径，否则会报错（网上很多代码都是使用相对路径，但是笔者在使用相对路径时总是报错，说找不到路径）</span><br><span class="line"><span class="number">7.</span> 函数os.path.join()用来将使用合适的路径分隔符将路径组合起来</span><br></pre></td></tr></table></figure>

<p><strong>客户端</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">file_data = &#123;<span class="string">'image'</span>: open(<span class="string">'Lenna.jpg'</span>, <span class="string">'rb'</span>)&#125;</span><br><span class="line"></span><br><span class="line">user_info = &#123;<span class="string">'info'</span>: <span class="string">'Lenna'</span>&#125;</span><br><span class="line"></span><br><span class="line">r = requests.post(<span class="string">"http://127.0.0.1:5000/upload"</span>, data=user_info, files=file_data)</span><br><span class="line"></span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>



<h3 id="7-Restful-URL-获取URL变量"><a href="#7-Restful-URL-获取URL变量" class="headerlink" title="7. Restful URL - 获取URL变量"></a>7. Restful URL - 获取URL变量</h3><p>简单来说，Restful URL可以看做是对 URL 参数的替代</p>
<p>推荐阅读：<a href="http://www.ruanyifeng.com/blog/2011/09/restful.html" target="_blank" rel="noopener">阮一峰 理解RESTful架构</a></p>
<h4 id="简单"><a href="#简单" class="headerlink" title="简单"></a>简单</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello world'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/user/&lt;username&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user</span><span class="params">(username)</span>:</span></span><br><span class="line">    print(username)</span><br><span class="line">    print(type(username))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello '</span> + username</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/user/&lt;username&gt;/friends')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_friends</span><span class="params">(username)</span>:</span></span><br><span class="line">    print(username)</span><br><span class="line">    print(type(username))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello '</span> + username + <span class="string">'They are your friends.'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 使用浏览器访问http://127.0.0.1:5000/user/letian</span></span><br><span class="line"><span class="comment"># 浏览器显示   </span></span><br><span class="line">hello letian</span><br><span class="line"><span class="comment"># 终端显示</span></span><br><span class="line">letian</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">str</span>'&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"># 访问<span class="title">http</span>:</span>//<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span>/user/letian/，响应为<span class="number">404</span> Not Found</span><br><span class="line"></span><br><span class="line"><span class="comment"># 浏览器访问http://127.0.0.1:5000/user/letian/friends</span></span><br><span class="line"><span class="comment"># 浏览器显示</span></span><br><span class="line">Hello letian. They are your friends</span><br><span class="line"><span class="comment"># 终端显示</span></span><br><span class="line">letian</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">str</span>'&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="route中指定类型转换"><a href="#route中指定类型转换" class="headerlink" title="route中指定类型转换"></a>route中指定类型转换</h4><ul>
<li>使用 Restful URL 得到的变量默认为str对象</li>
<li>可以通过route中指定类型转换</li>
<li>若是输入的类型与route中指定类型不一样，则会404错误</li>
<li>有3个默认的转换器<ul>
<li><code>int     accepts integers</code></li>
<li><code>float     like int but for floating point values</code></li>
<li><code>path     like the default but also accepts slashes</code></li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello world'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/page/&lt;int:num&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page</span><span class="params">(num)</span>:</span></span><br><span class="line">    print(num)</span><br><span class="line">    print(type(num))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello world'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/page2/&lt;int:num1&gt;-&lt;int:num2&gt;') # 特殊方式</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page</span><span class="params">(num1, num2)</span>:</span></span><br><span class="line">    print(num1)</span><br><span class="line">    print(num2)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello world'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 在浏览器中访问http://127.0.0.1:5000/page/1</span></span><br><span class="line"><span class="comment"># 终端显示 </span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">int</span>'&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"># 如果访问的是<span class="title">http</span>:</span>//<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span>/page/asd，我们会得到<span class="number">404</span>响应</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在浏览器中访问http://127.0.0.1:5000/page/11-22</span></span><br><span class="line"><span class="comment"># 终端显示 </span></span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">22</span></span><br></pre></td></tr></table></figure>

<h4 id="自定义类型转换器"><a href="#自定义类型转换器" class="headerlink" title="自定义类型转换器"></a>自定义类型转换器</h4><p>自定义的转换器是一个继承<code>werkzeug.routing.BaseConverter</code>的类，</p>
<ul>
<li>修改<code>to_python</code>和<code>to_url</code>方法即可。</li>
<li><code>to_python</code>方法用于将url中的变量转换后供被<code>@app.route</code>包装的函数使用，</li>
<li><code>to_url</code>方法用于<code>flask.url_for</code>中的参数转换。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, url_for</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> werkzeug.routing <span class="keyword">import</span> BaseConverter</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyIntConverter</span><span class="params">(BaseConverter)</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, url_map)</span>:</span></span><br><span class="line">        super(MyIntConverter, self).__init__(url_map)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_python</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> int(value)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_url</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> value * <span class="number">2</span></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.url_map.converters[<span class="string">'my_int'</span>] = MyIntConverter</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello world'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/page/&lt;my_int:num&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page</span><span class="params">(num)</span>:</span></span><br><span class="line">    print(num)</span><br><span class="line">    print(url_for(<span class="string">'page'</span>, num=<span class="number">123</span>))   <span class="comment"># page 对应的是 page函数 ，num 对应对应`/page/&lt;my_int:num&gt;`中的num，必须是str</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello world'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 浏览器访问http://127.0.0.1:5000/page/123后，HelloWorld/server.py的输出信息是</span></span><br><span class="line"><span class="number">123</span></span><br><span class="line">/page/<span class="number">123123</span></span><br></pre></td></tr></table></figure>

<h3 id="8-使用url-for生成链接"><a href="#8-使用url-for生成链接" class="headerlink" title="8. 使用url_for生成链接"></a>8. 使用url_for生成链接</h3><p>工具函数<code>url_for</code>可以让你以软编码的形式生成url，提供开发效率</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, url_for</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/user/&lt;name&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/page/&lt;int:num&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page</span><span class="params">(num)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/test')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    print(url_for(<span class="string">'hello_world'</span>))</span><br><span class="line">    print(url_for(<span class="string">'user'</span>, name=<span class="string">'letian'</span>))</span><br><span class="line">    print(url_for(<span class="string">'page'</span>, num=<span class="number">1</span>, q=<span class="string">'hadoop mapreduce 10%3'</span>))</span><br><span class="line">    print(url_for(<span class="string">'static'</span>, filename=<span class="string">'uploads/01.jpg'</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 在浏览器中访问http://127.0.0.1:5000/test，HelloWorld/server.py将输出以下信息</span></span><br><span class="line">/</span><br><span class="line">/user/letian</span><br><span class="line">/page/1?q=hadoop+mapreduce+10%253</span><br><span class="line">/static/uploads/<span class="number">01.j</span>pg</span><br></pre></td></tr></table></figure>



<h3 id="9-重定向-redirect"><a href="#9-重定向-redirect" class="headerlink" title="9. 重定向  redirect"></a>9. <strong>重定向</strong>  <strong>redirect</strong></h3><p><code>redirect</code>函数用于重定向，实现机制很简单，就是向客户端（浏览器）发送一个重定向的HTTP报文，浏览器会去访问报文中指定的url</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, url_for, redirect</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello world'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/test1')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test1</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'this is test1'</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">'test2'</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/test2')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test2</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'this is test2'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'this is test2'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 在浏览器中访问http://127.0.0.1:5000/test1，</span></span><br><span class="line">浏览器的url会变成http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span>/test2，并显示 this <span class="keyword">is</span> test2</span><br></pre></td></tr></table></figure>

<h3 id="10-使用Jinja2模板引擎"><a href="#10-使用Jinja2模板引擎" class="headerlink" title="10. 使用Jinja2模板引擎"></a>10. 使用Jinja2模板引擎</h3><p>模板引擎负责MVC中的V（view，视图）这一部分。Flask默认使用Jinja2模板引擎。</p>
<p>Flask与模板相关的函数有：</p>
<ul>
<li><code>flask.render_template(template_name_or_list, **context)</code><br>Renders a template from the template folder with the given context.</li>
<li><code>flask.render_template_string(source, **context)</code><br>Renders a template from the given template source string with the given context.</li>
<li><code>flask.get_template_attribute(template_name, attribute)</code><br>Loads a macro (or variable) a template exports. This can be used to invoke a macro from within Python code.</li>
</ul>
<p><strong>模板文件</strong>  -  <strong>创建并编辑 HelloWorld/templates/default.html</strong> 与 <code>user_info.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># HelloWorld/templates/user_info.html</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span></span><br><span class="line">        &#123;% if page_title %&#125;</span><br><span class="line">            &#123;&#123; page_title &#125;&#125;</span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    &#123;% block body %&#125;&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">可以看到，在``标签中使用了if判断，如果给模板传递了`page_title`变量，显示之，否则，不显示。</span><br><span class="line">``标签中定义了一个名为`body`的block，用来被其他模板文件继承。</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"># HelloWorld/templates/user_info.html</span><br><span class="line"></span><br><span class="line">&#123;% extends "default.html" %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block body %&#125;</span><br><span class="line">    &#123;% for key in user_info %&#125;</span><br><span class="line"></span><br><span class="line">        &#123;&#123; key &#125;&#125;: &#123;&#123; user_info[key] &#125;&#125;   # 加个<span class="tag">&lt;<span class="name">br</span>&gt;</span>试试看  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p><strong>服务端</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello world'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/user')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user</span><span class="params">()</span>:</span></span><br><span class="line">    user_info = &#123;</span><br><span class="line">        <span class="string">'name'</span>: <span class="string">'letian'</span>,</span><br><span class="line">        <span class="string">'email'</span>: <span class="string">'123@aa.com'</span>,</span><br><span class="line">        <span class="string">'age'</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="string">'github'</span>: <span class="string">'https://github.com/letiantian'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'user_info.html'</span>, page_title=<span class="string">'letian\'s info'</span>, user_info=user_info)</span><br><span class="line"><span class="comment"># 　render_template()函数的第一个参数指定模板文件，后面的参数是要传递的数据。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在浏览器中访问http://127.0.0.1:5000/user</span></span><br></pre></td></tr></table></figure>



<h3 id="11-自定义HTTP错误的响应-例如404"><a href="#11-自定义HTTP错误的响应-例如404" class="headerlink" title="11. 自定义HTTP错误的响应 - 例如404"></a>11. 自定义HTTP错误的响应 - 例如404</h3><p>处理HTTP错误，可以使用<code>flask.abort</code>函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template_string, abort</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello world'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/user')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user</span><span class="params">()</span>:</span></span><br><span class="line">    abort(<span class="number">401</span>)  <span class="comment"># Unauthorized 未授权</span></span><br><span class="line">    print(<span class="string">'Unauthorized, 请先登录'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 浏览器访问http://127.0.0.1:5000/user</span></span><br><span class="line">HelloWorld/server.py中abort(<span class="number">401</span>)后的<span class="keyword">print</span>并没有执行</span><br></pre></td></tr></table></figure>

<h4 id="自定义错误页面-app-errorhandler"><a href="#自定义错误页面-app-errorhandler" class="headerlink" title="自定义错误页面 - app.errorhandler"></a>自定义错误页面 - app.errorhandler</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template_string, abort</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello world'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/user')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user</span><span class="params">()</span>:</span></span><br><span class="line">    abort(<span class="number">401</span>)  <span class="comment"># Unauthorized</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.errorhandler(401)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page_unauthorized</span><span class="params">(error)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(<span class="string">'&lt;h1&gt; Unauthorized &lt;/h1&gt;&lt;h2&gt;&#123;&#123; error_info &#125;&#125;&lt;/h2&gt;'</span>, error_info=error), <span class="number">401</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><code>page_unauthorized</code>函数返回的是一个元组，</p>
<ul>
<li><p>401 代表HTTP 响应状态码。</p>
</li>
<li><p>如果省略401，则响应状态码会变成默认的 200。</p>
</li>
</ul>
<h3 id="12-用户会话-session"><a href="#12-用户会话-session" class="headerlink" title="12. 用户会话 - session"></a>12. 用户会话 - session</h3><p><code>session</code>用来记录用户的登录状态，一般基于cookie实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template_string, \</span><br><span class="line">    session, request, redirect, url_for</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.secret_key = <span class="string">'F12Zr47j\3yX R~X@H!jLwf/T'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello world'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/login')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    page = <span class="string">'''</span></span><br><span class="line"><span class="string">    &lt;form action="&#123;&#123; url_for('do_login') &#125;&#125;" method="post"&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;name: &lt;input type="text" name="user_name" /&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;input type="submit" value="Submit" /&gt;</span></span><br><span class="line"><span class="string">    &lt;/form&gt;</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(page)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/do_login', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_login</span><span class="params">()</span>:</span></span><br><span class="line">    name = request.form.get(<span class="string">'user_name'</span>)</span><br><span class="line">    session[<span class="string">'user_name'</span>] = name</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'success'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/show')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> session[<span class="string">'user_name'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/logout')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">()</span>:</span></span><br><span class="line">    session.pop(<span class="string">'user_name'</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">'login'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">代码含义与解析：</span><br><span class="line">（<span class="number">1</span>）app.secret_key用于给session加密。</span><br><span class="line">（<span class="number">2</span>）在/login中将向用户展示一个表单，要求输入一个名字，submit后将数据以post的方式传递给/do_login，/do_login将名字存放在session中。</span><br><span class="line">（<span class="number">3</span>）如果用户成功登录，访问/show时会显示用户的名字。此时，打开firebug等调试工具，选择session面板，会看到有一个cookie的名称为session。</span><br><span class="line">（<span class="number">4</span>）/logout用于登出，通过将session中的user_name字段pop即可。Flask中的session基于字典类型实现，调用pop方法时会返回pop的键对应的值；如果要pop的键并不存在，那么返回值是pop()的第二个参数。</span><br><span class="line">（<span class="number">5</span>）使用redirect()重定向时，一定要在前面加上<span class="keyword">return</span>。</span><br></pre></td></tr></table></figure>

<p><strong>测试</strong></p>
<ol>
<li>进入<code>http://127.0.0.1:5000/login</code>，输入name，点击submit</li>
<li>进入<code>http://127.0.0.1:5000/show</code>查看session中存储的name</li>
<li>进入`<a href="http://127.0.0.1:5000/logout" target="_blank" rel="noopener">http://127.0.0.1:5000/logout</a> 登出</li>
</ol>
<h4 id="设置session的有效时间"><a href="#设置session的有效时间" class="headerlink" title="设置session的有效时间"></a>设置session的有效时间</h4><p><strong>将session的有效时间设置为5分钟</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> session, app</span><br><span class="line"></span><br><span class="line">session.permanent = <span class="literal">True</span></span><br><span class="line">app.permanent_session_lifetime = timedelta(minutes=<span class="number">5</span>)</span><br></pre></td></tr></table></figure>



<h3 id="13-使用Cookie"><a href="#13-使用Cookie" class="headerlink" title="13.使用Cookie"></a>13.使用Cookie</h3><p>Cookie是存储在客户端的记录访问者状态的数据。 常用的用于记录用户登录状态的session大多是基于cookie实现的。</p>
<ul>
<li>cookie可以借助<strong><code>flask.Response</code></strong>来实现</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, Response, make_response</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello world'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/add')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    res = Response(<span class="string">'add cookies'</span>)</span><br><span class="line">    res.set_cookie(key=<span class="string">'name'</span>, value=<span class="string">'letian'</span>, expires=time.time()+<span class="number">6</span>*<span class="number">60</span>) <span class="comment"># 添加cookie</span></span><br><span class="line">    <span class="comment"># 表示cookie在从现在开始的6分钟内都是有效的</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/show')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> request.cookies.__str__()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/del')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">del_cookie</span><span class="params">()</span>:</span></span><br><span class="line">    res = Response(<span class="string">'delete cookies'</span>)</span><br><span class="line">    res.set_cookie(<span class="string">'name'</span>, <span class="string">''</span>, expires=<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 浏览器打开http://127.0.0.1:5000/add</span></span><br><span class="line">add cookies</span><br><span class="line"><span class="comment"># 在cookie有效期间，使用浏览器访问http://127.0.0.1:5000/show</span></span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'letian'</span>&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>使用<code>Response.set_cookie</code>添加和删除cookie</p>
<ul>
<li><code>expires</code>参数用来设置cookie有效时间，它的值可以是<code>datetime</code>对象或者unix时间戳，这里使用的是unix时间戳</li>
<li>要删除cookie，将expire参数的值设为0即可<ul>
<li><code>res.set_cookie(&#39;name&#39;, &#39;&#39;, expires=0)</code></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>set_cookie原型</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">set_cookie(key, value=’’, max_age=None, expires=None, path=’/‘, domain=None, secure=None, httponly=False)</span><br><span class="line"></span><br><span class="line">Sets a cookie. The parameters are the same as <span class="keyword">in</span> the cookie Morsel object <span class="keyword">in</span> the Python standard library but it accepts unicode data, too.</span><br><span class="line">Parameters:</span><br><span class="line"></span><br><span class="line">     key – the key (name) of the cookie to be <span class="built_in">set</span>.</span><br><span class="line">     value – the value of the cookie.</span><br><span class="line">     max_age – should be a number of seconds, or None (default) <span class="keyword">if</span> the cookie should last only as long as the client’s browser session.</span><br><span class="line"></span><br><span class="line">     expires – should be a datetime object or UNIX timestamp.</span><br><span class="line"></span><br><span class="line">     domain – <span class="keyword">if</span> you want to <span class="built_in">set</span> a cross-domain cookie. For example, domain=”.example.com” will <span class="built_in">set</span> a cookie that is readable by the domain 　　　　　　　　 www.example.com, foo.example.com etc. Otherwise, a cookie will only be readable by the domain that <span class="built_in">set</span> it.</span><br><span class="line"></span><br><span class="line">     path – limits the cookie to a given path, per default it will span the whole domain.</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="14-闪存系统-flashing-system"><a href="#14-闪存系统-flashing-system" class="headerlink" title="14. 闪存系统 flashing system"></a>14. <strong>闪存系统 flashing system</strong></h3><p> Flask的闪存系统（flashing system）用于向用户提供反馈信息，</p>
<ul>
<li><p>这些反馈信息一般是对用户上一次操作的反馈。</p>
</li>
<li><p>反馈信息是存储在服务器端的，</p>
</li>
<li><p>当服务器向客户端返回反馈信息后，这些反馈信息会被服务器端删除。</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, flash, get_flashed_messages</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">'some_secret'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hi'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/gen')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen</span><span class="params">()</span>:</span></span><br><span class="line">    info = <span class="string">'access at '</span>+ time.time().__str__()</span><br><span class="line">    flash(info)</span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/show1')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show1</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> get_flashed_messages().__str__()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/show2')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show2</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> get_flashed_messages().__str__()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 打开浏览器，访问http://127.0.0.1:5000/gen，浏览器界面显示（注意，时间戳是动态生成的，每次都会不一样，除非并行访问）：</span></span><br><span class="line">access at <span class="number">1404020982.83</span></span><br><span class="line"><span class="comment"># 查看浏览器的cookie，可以看到session，其对应的内容是：</span></span><br><span class="line">.eJyrVopPy0kszkgtVrKKrlZSKIFQSUpWSknhYVXJRm55UYG2tkq1OlDRyHC_rKgIvypPdzcDTxdXA1-XwHLfLEdTfxfPUn8XX6DKWCAEAJKBGq8.BpE6dg.F1VURZa7VqU9bvbC4XIBO9<span class="number">-3</span>Y4Y</span><br><span class="line"><span class="comment"># 再一次访问http://127.0.0.1:5000/gen，浏览器界面显示：</span></span><br><span class="line">access at <span class="number">1404021130.32</span></span><br><span class="line"><span class="comment"># cookie中session发生了变化，新的内容是：</span></span><br><span class="line">.eJyrVopPy0kszkgtVrKKrlZSKIFQSUpWSknhYVXJRm55UYG2tkq1OlDRyHC_rKgIvypPdzcDTxdXA1-XwHLfLEdTfxfPUn8XX6DKWLBaMg1yrfCtciz1rfIEGxRbCwAhGjC5.BpE7Cg.Cb_B_k2otqczhknGnpNjQ5u4dqw</span><br><span class="line"><span class="comment"># 然后使用浏览器访问http://127.0.0.1:5000/show1，浏览器界面显示：</span></span><br><span class="line">[<span class="string">'access at 1404020982.83'</span>, <span class="string">'access at 1404021130.32'</span>]</span><br><span class="line"></span><br><span class="line">这个列表中的内容也就是上面的两次访问http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span>/gen得到的内容。此时，cookie中已经没有session了。</span><br><span class="line">如果使用浏览器访问http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span>/show1或者http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span>/show2，只会得到：[ ]</span><br></pre></td></tr></table></figure>

<h4 id="对flash的内容进行分类"><a href="#对flash的内容进行分类" class="headerlink" title="对flash的内容进行分类"></a>对flash的内容进行分类</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, flash, get_flashed_messages</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"> </span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">'some_secret'</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hi'</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route('/gen')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen</span><span class="params">()</span>:</span></span><br><span class="line">    info = <span class="string">'access at '</span>+ time.time().__str__()</span><br><span class="line">    flash(<span class="string">'show1 '</span>+info, category=<span class="string">'show1'</span>)</span><br><span class="line">    flash(<span class="string">'show2 '</span>+info, category=<span class="string">'show2'</span>)</span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route('/show1')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show1</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> get_flashed_messages(category_filter=<span class="string">'show1'</span>).__str__()</span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route('/show2')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show2</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> get_flashed_messages(category_filter=<span class="string">'show2'</span>).__str__()</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 某一时刻，浏览器访问http://127.0.0.1:5000/gen，浏览器界面显示： </span></span><br><span class="line">access at <span class="number">1404022326.39</span></span><br><span class="line"><span class="comment">#不过，由上面的代码可以知道，此时生成了两个flash信息，但分类(category)不同。</span></span><br><span class="line"><span class="comment">#使用浏览器访问http://127.0.0.1:5000/show1，得到如下内容：</span></span><br><span class="line">[<span class="string">'1 access at 1404022326.39'</span>]</span><br><span class="line"><span class="comment">#而继续访问http://127.0.0.1:5000/show2，</span></span><br><span class="line">得到的内容为空：[ ]</span><br></pre></td></tr></table></figure>

<h4 id="在模板文件中获取flash的内容"><a href="#在模板文件中获取flash的内容" class="headerlink" title="在模板文件中获取flash的内容"></a><strong>在模板文件中获取flash的内容</strong></h4><p>在Flask中，<code>get_flashed_messages()</code>默认已经集成到<code>Jinja2</code>模板引擎中，易用性很强。</p>
<p>具体查看官方示例</p>
<h2 id="二、简单入门使用案例二"><a href="#二、简单入门使用案例二" class="headerlink" title="二、简单入门使用案例二"></a>二、简单入门使用案例二</h2><blockquote>
<p>参考：<a href="https://blog.csdn.net/qq_38664371/article/details/80484009" target="_blank" rel="noopener">Aiko酱ing</a></p>
</blockquote>
<h3 id="1-简单例子"><a href="#1-简单例子" class="headerlink" title="1. 简单例子"></a>1. 简单例子</h3><ol>
<li>保存这段代码为 xx.py</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- encoding = UTF-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello World!'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/user/&lt;username&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_user_profile</span><span class="params">(username)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'User %s'</span> % username</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/post/&lt;int:post_id&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_post</span><span class="params">(post_id)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Post %d'</span> % post_id</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>然后运行它</li>
<li>地址栏分别输入：（看看效果）<ul>
<li><code>http://127.0.0.1:5000/</code></li>
<li><code>http://127.0.0.1:5000/user/xxxx</code> (xxx可以用其他任何字符代替)</li>
<li><code>http://127.0.0.1:5000/post/123</code> (123可以用其他任何数字代替)</li>
</ul>
</li>
</ol>
<h4 id="路由-app-route"><a href="#路由-app-route" class="headerlink" title="路由@app.route()"></a>路由@app.route()</h4><p>flask通过装饰器来识别用户需要访问的网址路径，并在对应的网址路径里做对应的应用</p>
<p><strong>注意路由中路径的 ‘<code>/</code>‘</strong></p>
<ul>
<li>用户在访问网址的时候如果没有加上’<code>/</code>‘，系统会自动添加并访问<ul>
<li>路由定义为 <code>@app.route(&#39;/projects/&#39;)</code>时，访问 <code>http://127.0.0.1:5000/projects/</code>，无错误</li>
</ul>
</li>
<li>但是如果没有定义’<code>/</code>‘，用户访问带’<code>/</code>‘的便会出现错误<ul>
<li>路由定义为 <code>@app.route(&#39;/projects&#39;)</code>时，访问 <code>http://127.0.0.1:5000/projects/</code>，<code>出错</code>！！！</li>
</ul>
</li>
</ul>
<h3 id="2-HTTP的get和post方法"><a href="#2-HTTP的get和post方法" class="headerlink" title="2. HTTP的get和post方法"></a>2. HTTP的get和post方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- encoding = UTF-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"> </span><br><span class="line">app = Flask(__name__)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route('/login/', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'post'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'get'</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>运行，并浏览器访问：<code>http://127.0.0.1:5000/login</code> 查看效果</p>
<h3 id="3-静态文件"><a href="#3-静态文件" class="headerlink" title="3. 静态文件"></a>3. 静态文件</h3><p>静态文件（css和JavaScript文件），默认放在项目目录下的static文件目录下</p>
<h3 id="4-模板（HTML）文件及模板渲染-render-template"><a href="#4-模板（HTML）文件及模板渲染-render-template" class="headerlink" title="4. 模板（HTML）文件及模板渲染 render_template"></a>4. 模板（HTML）文件及模板渲染 render_template</h3><ul>
<li>模板文件一般放在temlaptes文件夹中</li>
<li>对于html文件有专门的语言工具，及Jinjia2</li>
<li>对于处理好的html文件，我们可以使用render_template()来进行渲染</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/test/&lt;int:uid&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(uid)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'test.html'</span>, uid=uid)</span><br></pre></td></tr></table></figure>

<h3 id="5-重定向-redirect"><a href="#5-重定向-redirect" class="headerlink" title="5. 重定向 redirect"></a>5. 重定向 redirect</h3><p>重定向，即页面跳转，主要是将一个页面跳转到正确的页面上</p>
<p>这里一共介绍两种重定向，</p>
<ul>
<li>一个为301：永久转移；</li>
<li>一个为302：临时转移</li>
</ul>
<p><strong>这里使用flask框架里的<code>redirect</code></strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- encoding = UTF - 8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,redirect</span><br><span class="line"> </span><br><span class="line">app = Flask(__name__)</span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello'</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route('/newpath')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">newpath</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'newpath'</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route('/re/&lt;int:code&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">redirect_demo</span><span class="params">(code)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">'/newpath'</span>,code=code)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>运行，并浏览器输入<code>http://127.0.0.1:5000/re/302</code> </p>
<p>可以看到，从<code>127.0.0.1:5000/re/302</code>跳转到<code>127.0.0.1:5000/newpath</code></p>
<h3 id="6-Error"><a href="#6-Error" class="headerlink" title="6. Error"></a>6. Error</h3><p>error是为了解决用户进入到错误的或者不存在的页面跳转到一个专门的页面显示错误信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- encoding=UTF-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,render_template</span><br><span class="line"> </span><br><span class="line">app = Flask(__name__)</span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello'</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.errorhandler(404)   # 这个作用是将所有的404的错误都进行下面的函数的处理</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page_not_found</span><span class="params">(error)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> error</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'not_found.html'</span>) ,<span class="number">404</span></span><br><span class="line"><span class="comment"># not_found.html 为一个404页面模板</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br></pre></td></tr></table></figure>

<p>运行，并输入一个不存在的网址，结果显示了not_found.html 的静态页面的内容</p>
<h3 id="7-flash和get-flashed-messages"><a href="#7-flash和get-flashed-messages" class="headerlink" title="7.flash和get_flashed_messages"></a>7.flash和get_flashed_messages</h3><p><code>flash</code>的作用是将一个消息<code>压入（数据）</code>到一个buf中</p>
<ul>
<li>比如登陆成功显示的“登陆成功”，我们可以在别的页面读取这个值并显示出来</li>
</ul>
<p><code>get_flashed_messages</code>是用来<code>读取数据</code>的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- encoding=UTF-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,flash,get_flashed_messages,redirect</span><br><span class="line"> </span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key=<span class="string">'aiko'</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    res = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> msg,categore <span class="keyword">in</span> get_flashed_messages(with_categories=<span class="literal">True</span>):</span><br><span class="line">        res =res + categore + msg +<span class="string">'&lt;br&gt;'</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route('/login')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">     flash(<span class="string">'登陆成功'</span>,category=<span class="string">'aiko'</span>)</span><br><span class="line">     <span class="keyword">return</span> redirect(<span class="string">'/'</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>当用户进入后提示登陆成功，然后页面跳转到首页，首页里将之前压入的数据取出并显示</li>
<li>这里注意的是需要在一开始设置app.secret，因此这个是标识用户的一种方式，<ul>
<li>浏览器需要知道是哪个用户在使用登陆</li>
</ul>
</li>
</ul>
<ol>
<li>当我们输入<code>127.0.0.1:5000/login</code>的时候，页面发生了跳转，并且显示了 <strong>登陆成功aiko</strong>的字样</li>
<li>flash的参数category，这个适用于数据的过滤的作用，也可以理解为标签</li>
<li>flash那儿加入了一个category=’aiko’的参数，然后我们又在get_flashed_messages那个将category设置为true，并且将值显示在res中</li>
</ol>
<h3 id="8-logger"><a href="#8-logger" class="headerlink" title="8. logger"></a>8. logger</h3><ul>
<li><p>log的作用是为了方便调试项目的各个过程，同时也有监督的作用</p>
</li>
<li><p>log的等级一共有三个分别为info、warn和error</p>
<ul>
<li>这三个的等级是依次递增的，当后面的发生记录项的时候，前面的也会将这些信息记录下来，</li>
<li>也就是说如果error发生了记录项，记录的内容同时会出现在info和warn中</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入模块 </span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> logging.handlers <span class="keyword">import</span> RotatingFileHandler   </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_logger</span><span class="params">()</span>:</span></span><br><span class="line">    info_file_handler = RotatingFileHandler(<span class="string">'D:\\logs\\info.txt'</span>)</span><br><span class="line">    info_file_handler.setLevel (logging.INFO)</span><br><span class="line">    app.logger.addHandler(info_file_handler)</span><br><span class="line"> </span><br><span class="line">    warn_file_handler = RotatingFileHandler(<span class="string">'D:\\logs\\warn.txt'</span>)</span><br><span class="line">    warn_file_handler.setLevel(logging.WARN)</span><br><span class="line">    app.logger.addHandler(warn_file_handler)</span><br><span class="line"> </span><br><span class="line">    error_file_handler = RotatingFileHandler(<span class="string">'D:\\logs\\error.txt'</span>)</span><br><span class="line">    error_file_handler.setLevel(logging.ERROR)</span><br><span class="line">    app.logger.addHandler(error_file_handler)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 运行端加上</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    set_logger()</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>测试哪个函数，需要单独在那个函数的里面的相应位置加上logger的函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/login')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">     app.logger.info(<span class="string">'login begin'</span>)</span><br><span class="line">     flash(<span class="string">'登陆成功'</span>,category=<span class="string">'aiko'</span>)</span><br><span class="line">     app.logger.info(<span class="string">'login successed'</span>)</span><br><span class="line">     <span class="keyword">return</span> redirect(<span class="string">'/'</span>)</span><br></pre></td></tr></table></figure>











<h2 id="三、Flask搭建API案例"><a href="#三、Flask搭建API案例" class="headerlink" title="三、Flask搭建API案例"></a>三、Flask搭建API案例</h2><h3 id="1-Flask搭建API案例一"><a href="#1-Flask搭建API案例一" class="headerlink" title="1. Flask搭建API案例一"></a>1. Flask搭建API案例一</h3><blockquote>
<p>参考：<a href="https://www.jianshu.com/p/663ec211f52f" target="_blank" rel="noopener">flask框架搭建api</a></p>
</blockquote>
<h4 id="从url中解析出文字信息"><a href="#从url中解析出文字信息" class="headerlink" title="从url中解析出文字信息"></a>从url中解析出文字信息</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># antuor:dxiaod</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/',methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_text_input</span><span class="params">()</span>:</span></span><br><span class="line">    text = request.args.get(<span class="string">'inputstr'</span>)</span><br><span class="line">    print(text)</span><br><span class="line">    <span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>运行，并访问<code>http://0.0.0.0:5000/?inputstr=%E4%BD%A0%E5%A5%BD%E5%95%8A</code></p>
<h4 id="传参并回参"><a href="#传参并回参" class="headerlink" title="传参并回参"></a>传参并回参</h4><ul>
<li>传参功能用bind_request_parmams</li>
<li>回参用Response</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># antuor:dxiaod</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, Response</span><br><span class="line"><span class="keyword">from</span> flask_request_params <span class="keyword">import</span> bind_request_params</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.before_request(bind_request_params)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/projectname/name',methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_text_input</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># text = request.args.get('inputstr')</span></span><br><span class="line">    text = request.params[<span class="string">"askjson"</span>]</span><br><span class="line">    action = request.params[<span class="string">"action"</span>]</span><br><span class="line">    jieguo = &#123;<span class="string">"text"</span>:text&#125;</span><br><span class="line">    print(text)</span><br><span class="line">    <span class="keyword">return</span> Response(json.dumps(jieguo))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>运行，并访问 <code>http://0.0.0.0:5000/projectname/name?action=query&amp;askjson=nihaio</code></p>
<h4 id="clent端访问server端"><a href="#clent端访问server端" class="headerlink" title="clent端访问server端"></a>clent端访问server端</h4><p><strong>功能说明</strong>：<br>clent端访问server端，传这边的数据<br>需要用post进行传参<br>post传参需要用request.form获取内容</p>
<p><strong>server端</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*- conding:utf-8 -*-</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">验证post参数请求</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello world'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/register', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">()</span>:</span></span><br><span class="line">    print(request.method)</span><br><span class="line">    print(request.form)</span><br><span class="line">    print(request.form[<span class="string">'name'</span>])</span><br><span class="line">    print(request.form.get(<span class="string">'name'</span>))</span><br><span class="line">    print(request.form.getlist(<span class="string">'name'</span>))</span><br><span class="line">    print(request.form.get(<span class="string">'nickname'</span>, default=<span class="string">'little apple'</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'welcome'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">        app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><strong>client端</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*- conding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">user_info = &#123;<span class="string">'name'</span>: <span class="string">'letian'</span>, <span class="string">'password'</span>: <span class="string">'123'</span>&#125;</span><br><span class="line">r = requests.post(<span class="string">"http://127.0.0.1:5000/register"</span>, data=user_info)</span><br><span class="line"></span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>



<h3 id="2-Flask搭建API方法案例二"><a href="#2-Flask搭建API方法案例二" class="headerlink" title="2. Flask搭建API方法案例二"></a>2. Flask搭建API方法案例二</h3><blockquote>
<p>参考：<a href="https://www.jianshu.com/p/bee9e61aca14" target="_blank" rel="noopener">使用flask构建REST服务</a></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, jsonify, abort, request</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">books = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">'id'</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">'title'</span>: <span class="string">u'论语'</span>,</span><br><span class="line">        <span class="string">'auther'</span>: <span class="string">u'孔子'</span>,</span><br><span class="line">        <span class="string">'price'</span>: <span class="number">18</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">'id'</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="string">'title'</span>: <span class="string">u'道德经'</span>,</span><br><span class="line">        <span class="string">'auther'</span>: <span class="string">u'老子'</span>,</span><br><span class="line">        <span class="string">'price'</span>: <span class="number">15</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/bookstore/api/v1/books', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_tasks</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">'books'</span>: books&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/bookstore/api/v1/books/&lt;int:id&gt;', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_task</span><span class="params">(id)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> book <span class="keyword">in</span> books:</span><br><span class="line">        <span class="keyword">if</span> book[<span class="string">'id'</span>]==id:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">'book'</span>: book&#125;)</span><br><span class="line">    abort(<span class="number">404</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/bookstore/api/v1/books/', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_task</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> request.form <span class="keyword">or</span> <span class="keyword">not</span> <span class="string">'title'</span> <span class="keyword">in</span> request.form:</span><br><span class="line">        abort(<span class="number">400</span>)</span><br><span class="line">    book = &#123;</span><br><span class="line">        <span class="string">'id'</span>: books[<span class="number">-1</span>][<span class="string">'id'</span>] + <span class="number">1</span>,</span><br><span class="line">        <span class="string">'title'</span>: request.form[<span class="string">'title'</span>],</span><br><span class="line">        <span class="string">'auther'</span>: request.form[<span class="string">'auther'</span>],</span><br><span class="line">        <span class="string">'price'</span>: request.form[<span class="string">'price'</span>],</span><br><span class="line">    &#125;</span><br><span class="line">    books.append(book)</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">'book'</span>: book&#125;), <span class="number">201</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/bookstore/api/v1/books/&lt;int:id&gt;', methods=['PUT'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_book</span><span class="params">(id)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> book <span class="keyword">in</span> books:</span><br><span class="line">        <span class="keyword">if</span> book[<span class="string">'id'</span>]==id:</span><br><span class="line">            book[<span class="string">"title"</span>] = request.form[<span class="string">'title'</span>]</span><br><span class="line">            book[<span class="string">"auther"</span>] = request.form[<span class="string">'auther'</span>]</span><br><span class="line">            book[<span class="string">"price"</span>] = request.form[<span class="string">'price'</span>]</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">'books'</span>: books&#125;)</span><br><span class="line">    abort(<span class="number">400</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/bookstore/api/v1/books/&lt;int:id&gt;', methods=['DELETE'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_task</span><span class="params">(id)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> book <span class="keyword">in</span> books:</span><br><span class="line">        <span class="keyword">if</span> book[<span class="string">'id'</span>]==id:</span><br><span class="line">            books.remove(book)</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">'result'</span>: <span class="literal">True</span>&#125;)</span><br><span class="line">    abort(<span class="number">404</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">'result'</span>: <span class="literal">True</span>&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>运行，并用Postman分别进行测试</p>
<ol>
<li><p>获取所有的书列表</p>
<ul>
<li>get  <code>http://127.0.0.1:5000/bookstore/api/v1/books</code></li>
</ul>
</li>
<li><p>获取指定书的信息</p>
<ul>
<li>get <code>http://127.0.0.1:5000/bookstore/api/v1/books/1</code></li>
</ul>
</li>
<li><p>新增一本书</p>
<ul>
<li>Post <code>http://127.0.0.1:5000/bookstore/api/v1/books/</code></li>
</ul>
</li>
<li><p>更新信息</p>
<ul>
<li>put <code>http://127.0.0.1:5000/bookstore/api/v1/books/3</code></li>
</ul>
</li>
<li><p>删除书籍</p>
<ul>
<li>delete <code>http://127.0.0.1:5000/bookstore/api/v1/books/3</code></li>
</ul>
</li>
</ol>
<h3 id="3-Flask搭建API方法案例三-参数的判断"><a href="#3-Flask搭建API方法案例三-参数的判断" class="headerlink" title="3. Flask搭建API方法案例三 - 参数的判断"></a>3. Flask搭建API方法案例三 - 参数的判断</h3><h4 id="只接受get方法访问"><a href="#只接受get方法访问" class="headerlink" title="只接受get方法访问"></a>只接受get方法访问</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"> </span><br><span class="line">app=Flask(__name__)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 只接受get方法访问</span></span><br><span class="line"><span class="meta">@app.route("/test",methods=["GET"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 默认返回内容</span></span><br><span class="line">    return_dict= &#123;<span class="string">'return_code'</span>: <span class="string">'200'</span>, <span class="string">'return_info'</span>: <span class="string">'处理成功'</span>, <span class="string">'result'</span>: <span class="literal">False</span>&#125;</span><br><span class="line">    <span class="comment"># 判断入参是否为空</span></span><br><span class="line">    <span class="keyword">if</span> request.args <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        return_dict[<span class="string">'return_code'</span>] = <span class="string">'5004'</span></span><br><span class="line">        return_dict[<span class="string">'return_info'</span>] = <span class="string">'请求参数为空'</span></span><br><span class="line">        <span class="keyword">return</span> json.dumps(return_dict, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># 获取传入的params参数</span></span><br><span class="line">    get_data=request.args.to_dict()</span><br><span class="line">    name=get_data.get(<span class="string">'name'</span>)</span><br><span class="line">    age=get_data.get(<span class="string">'age'</span>)</span><br><span class="line">    <span class="comment"># 对参数进行操作</span></span><br><span class="line">    return_dict[<span class="string">'result'</span>]=tt(name,age)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> json.dumps(return_dict, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 功能函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tt</span><span class="params">(name,age)</span>:</span></span><br><span class="line">    result_str=<span class="string">"%s今年%s岁"</span> %(name,age)</span><br><span class="line">    <span class="keyword">return</span> result_str</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h4 id="只接受post方法访问"><a href="#只接受post方法访问" class="headerlink" title="只接受post方法访问"></a><strong>只接受post方法访问</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"> </span><br><span class="line">app=Flask(__name__)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 只接受POST方法访问</span></span><br><span class="line"><span class="meta">@app.route("/test",methods=["POST"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 默认返回内容</span></span><br><span class="line">    return_dict= &#123;<span class="string">'return_code'</span>: <span class="string">'200'</span>, <span class="string">'return_info'</span>: <span class="string">'处理成功'</span>, <span class="string">'result'</span>: <span class="literal">False</span>&#125;</span><br><span class="line">    <span class="comment"># 判断传入的json数据是否为空</span></span><br><span class="line">    <span class="keyword">if</span> request.get_data() <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        return_dict[<span class="string">'return_code'</span>] = <span class="string">'5004'</span></span><br><span class="line">        return_dict[<span class="string">'return_info'</span>] = <span class="string">'请求参数为空'</span></span><br><span class="line">        <span class="keyword">return</span> json.dumps(return_dict, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># 获取传入的参数</span></span><br><span class="line">    get_Data=request.get_data()</span><br><span class="line">    <span class="comment"># 传入的参数为bytes类型，需要转化成json</span></span><br><span class="line">    get_Data=json.loads(get_Data)</span><br><span class="line">    name=get_Data.get(<span class="string">'name'</span>)</span><br><span class="line">    age=get_Data.get(<span class="string">'age'</span>)</span><br><span class="line">    <span class="comment"># 对参数进行操作</span></span><br><span class="line">    return_dict[<span class="string">'result'</span>]=tt(name,age)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> json.dumps(return_dict, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 功能函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tt</span><span class="params">(name,age)</span>:</span></span><br><span class="line">    result_str=<span class="string">"%s今年%s岁"</span> %(name,age)</span><br><span class="line">    <span class="keyword">return</span> result_str</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>运行，Postman测试</p>
<ul>
<li>Post <a href="http://127.0.0.1:5000/test" target="_blank" rel="noopener">http://127.0.0.1:5000/test</a></li>
<li>（带参数） body  <code>{&quot;name&quot;:&quot;小朱&quot;,&quot;age&quot;:19}</code></li>
</ul>
<h2 id="四、Flask的logger案例"><a href="#四、Flask的logger案例" class="headerlink" title="四、Flask的logger案例"></a>四、Flask的logger案例</h2><h3 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.logger.debug(<span class="string">'A value for debugging'</span>)</span><br><span class="line">app.logger.warning(<span class="string">'A warning occurred (%d apples)'</span>, <span class="number">42</span>)</span><br><span class="line">app.logger.error(<span class="string">'An error occurred'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<h3 id="直接设置Logger"><a href="#直接设置Logger" class="headerlink" title="直接设置Logger"></a>直接设置Logger</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">handler = logging.FileHandler(filename=<span class="string">"test.log"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">handler.setLevel(<span class="string">"DEBUG"</span>)</span><br><span class="line">format_ =<span class="string">"%(asctime)s[%(name)s][%(levelname)s] :%(levelno)s: %(message)s"</span></span><br><span class="line">formatter = logging.Formatter(format_)</span><br><span class="line">handler.setFormatter(formatter)</span><br><span class="line">app.logger.addHandler(handler)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">	app.run()</span><br></pre></td></tr></table></figure>

<h3 id="logger载入配置字典"><a href="#logger载入配置字典" class="headerlink" title="logger载入配置字典"></a>logger载入配置字典</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> logging.config</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">logger_conf =&#123;</span><br><span class="line">    <span class="string">'version'</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">'formatters'</span>: &#123;<span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'format'</span>: <span class="string">'[%(asctime)s] %(levelname)s in %(module)s: %(message)s'</span>,</span><br><span class="line">    &#125;&#125;,</span><br><span class="line">    <span class="string">'handlers'</span>: &#123;<span class="string">'wsgi'</span>: &#123;</span><br><span class="line">        <span class="string">'class'</span>: <span class="string">'logging.StreamHandler'</span>,</span><br><span class="line">        <span class="string">'stream'</span>: <span class="string">'ext://flask.logging.wsgi_errors_stream'</span>,</span><br><span class="line">        <span class="string">'formatter'</span>: <span class="string">'default'</span></span><br><span class="line">    &#125;&#125;,</span><br><span class="line">    <span class="string">'root'</span>: &#123;</span><br><span class="line">        <span class="string">'level'</span>: <span class="string">'INFO'</span>,</span><br><span class="line">        <span class="string">'handlers'</span>: [<span class="string">'wsgi'</span>]</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">logging.config.dictConfig(logger_conf)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">	app.run()</span><br></pre></td></tr></table></figure>

<h3 id="工厂模式下Logger"><a href="#工厂模式下Logger" class="headerlink" title="工厂模式下Logger"></a>工厂模式下Logger</h3><p>工厂模式下不同地方使用logger，请使用<strong>current_app.logger</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> logging.config</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> current_app, Flask</span><br><span class="line"></span><br><span class="line">logger_conf =&#123;</span><br><span class="line">    <span class="string">'version'</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">'formatters'</span>: &#123;<span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'format'</span>: <span class="string">'[%(asctime)s] %(levelname)s in %(module)s: %(message)s'</span>,</span><br><span class="line">    &#125;&#125;,</span><br><span class="line">    <span class="string">'handlers'</span>: &#123;<span class="string">'wsgi'</span>: &#123;</span><br><span class="line">        <span class="string">'class'</span>: <span class="string">'logging.StreamHandler'</span>,</span><br><span class="line">        <span class="string">'stream'</span>: <span class="string">'ext://flask.logging.wsgi_errors_stream'</span>,</span><br><span class="line">        <span class="string">'formatter'</span>: <span class="string">'default'</span></span><br><span class="line">    &#125;&#125;,</span><br><span class="line">    <span class="string">'root'</span>: &#123;</span><br><span class="line">        <span class="string">'level'</span>: <span class="string">'INFO'</span>,</span><br><span class="line">        <span class="string">'handlers'</span>: [<span class="string">'wsgi'</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span><span class="params">()</span>:</span></span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    <span class="comment"># 方法一日志设置</span></span><br><span class="line">    handler = logging.FileHandler(filename=<span class="string">"test.log"</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">    handler.setLevel(<span class="string">"DEBUG"</span>)</span><br><span class="line">    format_ =<span class="string">"%(asctime)s[%(name)s][%(levelname)s] :%(levelno)s: %(message)s"</span></span><br><span class="line">    formatter = logging.Formatter(format_)</span><br><span class="line">    handler.setFormatter(formatter)</span><br><span class="line">    app.logger.addHandler(handler)</span><br><span class="line">    <span class="comment"># 方法二日志设置</span></span><br><span class="line">    <span class="comment"># logging.config.dictConfig(logger_conf)</span></span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line">    </span><br><span class="line">app = create_app()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/", methods=["GET"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    current_app.logger.info(<span class="string">"this is info"</span>)</span><br><span class="line">    current_app.logger.debug(<span class="string">"this is debug"</span>)</span><br><span class="line">    current_app.logger.warning(<span class="string">"this is warning"</span>)</span><br><span class="line">    current_app.logger.error(<span class="string">"this is error"</span>)</span><br><span class="line">    current_app.logger.critical(<span class="string">"this is critical"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"ok"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<h2 id="五、Flask接口标准化"><a href="#五、Flask接口标准化" class="headerlink" title="五、Flask接口标准化"></a>五、Flask接口标准化</h2><blockquote>
<p>参考：<a href="https://blog.csdn.net/qq_22034353/article/details/88701947" target="_blank" rel="noopener">Flask后端实践 连载三 接口标准化及全球化</a></p>
</blockquote>
<h3 id="接口统一返回形式"><a href="#接口统一返回形式" class="headerlink" title="接口统一返回形式"></a>接口统一返回形式</h3><p><code>成功类</code>，包含0以及200开头的数字</p>
<table>
<thead>
<tr>
<th>编码</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>成功</td>
</tr>
<tr>
<td>20001</td>
<td>登录成功</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<p><code>错误类</code>，400开头的数字</p>
<table>
<thead>
<tr>
<th>编码</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>-1</td>
<td>失败</td>
</tr>
<tr>
<td>40000</td>
<td>自定义错误(“{model} not have {key} “)</td>
</tr>
<tr>
<td>40001</td>
<td>账户或密码错误</td>
</tr>
<tr>
<td>40002</td>
<td>参数无效</td>
</tr>
<tr>
<td>40003</td>
<td>未找到相关资源</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<p><code>服务器错误类</code>，500开头的数值</p>
<table>
<thead>
<tr>
<th>编码</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>50001</td>
<td>服务器错误，请联系管理员</td>
</tr>
<tr>
<td>50002</td>
<td>计算出错</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<h3 id="初级"><a href="#初级" class="headerlink" title="初级"></a>初级</h3><p>编写响应码类和响应消息类 <code>code.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResponseCode</span><span class="params">(object)</span>:</span></span><br><span class="line">    SUCCESS = <span class="number">0</span>  <span class="comment"># 成功</span></span><br><span class="line">    FAIL = <span class="number">-1</span>  <span class="comment"># 失败</span></span><br><span class="line">    NO_RESOURCE_FOUND = <span class="number">40001</span>  <span class="comment"># 未找到资源</span></span><br><span class="line">    INVALID_PARAMETER = <span class="number">40002</span>  <span class="comment"># 参数无效</span></span><br><span class="line">    ACCOUNT_OR_PASS_WORD_ERR = <span class="number">40003</span>  <span class="comment"># 账户或密码错误</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResponseMessage</span><span class="params">(object)</span>:</span></span><br><span class="line">    SUCCESS = <span class="string">"成功"</span></span><br><span class="line">    FAIL =  <span class="string">"失败"</span></span><br><span class="line">    NO_RESOURCE_FOUND =  <span class="string">"未找到资源"</span></span><br><span class="line">    INVALID_PARAMETER =  <span class="string">"参数无效"</span></span><br><span class="line">    ACCOUNT_OR_PASS_WORD_ERR =  <span class="string">"账户或密码错误"</span></span><br></pre></td></tr></table></figure>

<p>Flask 接口返回实例 <code>app.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,jsonify</span><br><span class="line"><span class="keyword">from</span> code <span class="keyword">import</span> ResponseCode,ResponseMessage</span><br><span class="line"></span><br><span class="line">app =Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/",methods=["GET"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">	test_dict = dict(name=<span class="string">"zhang"</span>,age=<span class="number">18</span>)</span><br><span class="line">	data=dict(code=ResponseCode.SUCCESS,</span><br><span class="line">			  msg=ResponseMessage.SUCCESS,</span><br><span class="line">			  data=test_dict)</span><br><span class="line">	<span class="keyword">return</span> jsonify(data)</span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">	app.run()</span><br></pre></td></tr></table></figure>

<p>运行app，访问 <a href="http://127.0.0.1:5000/" target="_blank" rel="noopener">http://127.0.0.1:5000/</a> 返回如下:<br><code>{&quot;code&quot;:0,&quot;data&quot;:{&quot;age&quot;:18,&quot;name&quot;:&quot;zhang&quot;},&quot;msg&quot;:&quot;成功&quot;}</code></p>
<h3 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h3><p>进一步封装响应文本<code>response.py</code>，减少重复代码的编写量及保持代码清洁</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResMsg</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    封装响应文本</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, data=None, code=ResponseCode.SUCCESS, </span></span></span><br><span class="line"><span class="function"><span class="params">    			 msg=ResponseMessage.SUCCESS)</span>:</span></span><br><span class="line">        self._data = data</span><br><span class="line">        self._msg = msg</span><br><span class="line">        self._code = code</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(self, code=None, data=None, msg=None)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        更新默认响应文本</span></span><br><span class="line"><span class="string">        :param code:响应状态码</span></span><br><span class="line"><span class="string">        :param data: 响应数据</span></span><br><span class="line"><span class="string">        :param msg: 响应消息</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> code <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self._code = code</span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self._data = data</span><br><span class="line">        <span class="keyword">if</span> msg <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self._msg = msg</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_field</span><span class="params">(self, name=None, value=None)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        在响应文本中加入新的字段，方便使用</span></span><br><span class="line"><span class="string">        :param name: 变量名</span></span><br><span class="line"><span class="string">        :param value: 变量值</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.__dict__[name] = value</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">data</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        输出响应文本内容</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        body = self.__dict__</span><br><span class="line">        body[<span class="string">"data"</span>] = body.pop(<span class="string">"_data"</span>)</span><br><span class="line">        body[<span class="string">"msg"</span>] = body.pop(<span class="string">"_msg"</span>)</span><br><span class="line">        body[<span class="string">"code"</span>] = body.pop(<span class="string">"_code"</span>)</span><br><span class="line">        <span class="keyword">return</span> body</span><br></pre></td></tr></table></figure>

<p><strong>app中使用响应文本封装</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, jsonify</span><br><span class="line"><span class="keyword">from</span> code <span class="keyword">import</span> ResponseCode, ResponseMessage</span><br><span class="line"><span class="keyword">from</span> response <span class="keyword">import</span> ResMsg</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/", methods=["GET"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    res = ResMsg()</span><br><span class="line">    test_dict = dict(name=<span class="string">"zhang"</span>, age=<span class="number">18</span>)</span><br><span class="line">    res.update(data=test_dict)</span><br><span class="line">    <span class="keyword">return</span> jsonify(res.data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<p>运行app，访问 <a href="http://127.0.0.1:5000/" target="_blank" rel="noopener">http://127.0.0.1:5000/</a> 返回如下:<br><code>{&quot;code&quot;:0,&quot;data&quot;:{&quot;age&quot;:18,&quot;name&quot;:&quot;zhang&quot;},&quot;msg&quot;:&quot;成功&quot;}</code></p>
<h3 id="加载Yaml"><a href="#加载Yaml" class="headerlink" title="加载Yaml"></a>加载Yaml</h3><p>实现全球化配置，实现思路是编写两份不一样的响应消息，</p>
<ul>
<li>前端通过选择语言，</li>
<li>后端返回对应语言的消息。</li>
<li>因此采用yaml编写响应消息，并加载到Flask应用中，通过语言选择返回不同的语言消息</li>
</ul>
<h4 id="编写msg-yaml"><a href="#编写msg-yaml" class="headerlink" title="编写msg.yaml"></a>编写msg.yaml</h4><p>中文响应消息(zh_CN)，英文响应消息（en）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zh_CN:</span> <span class="meta">&amp;zh</span></span><br><span class="line">  <span class="attr">0:</span> <span class="string">"成功"</span></span><br><span class="line">  <span class="number">-1</span><span class="string">:</span> <span class="string">"失败"</span></span><br><span class="line">  <span class="attr">40001:</span> <span class="string">"资源不存在"</span></span><br><span class="line">  <span class="attr">40002:</span> <span class="string">"参数无效"</span></span><br><span class="line">  <span class="attr">40003:</span> <span class="string">"账户或密码错误"</span></span><br><span class="line"><span class="attr">en:</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="meta">*zh</span></span><br><span class="line">  <span class="comment"># 英文编码</span></span><br><span class="line">  <span class="attr">0:</span> <span class="string">"success"</span></span><br><span class="line">  <span class="number">-1</span><span class="string">:</span> <span class="string">"fail"</span></span><br><span class="line">  <span class="attr">40001:</span> <span class="string">"No resources found"</span></span><br><span class="line">  <span class="attr">40002:</span> <span class="string">"Invalid argument"</span></span><br><span class="line">  <span class="attr">40003:</span> <span class="string">"Incorrect account or password"</span></span><br></pre></td></tr></table></figure>

<h4 id="修改-response-py"><a href="#修改-response-py" class="headerlink" title="修改 response.py"></a>修改 <code>response.py</code></h4><p>不使用ResponseMessage类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> code <span class="keyword">import</span> ResponseCode</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request, current_app</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResMsg</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    封装响应文本</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, data=None, code=ResponseCode.SUCCESS, rq=request)</span>:</span></span><br><span class="line">        <span class="comment"># 获取请求中语言选择,如果不存在，获取配置中的语言,如果配置中语言不存在,则默认为中文</span></span><br><span class="line">        self.lang = rq.headers.get(<span class="string">"lang"</span>, </span><br><span class="line">                                   current_app.config.get(<span class="string">"LANG"</span>, <span class="string">"zh_CN"</span>) </span><br><span class="line">                                   )</span><br><span class="line">        self._data = data</span><br><span class="line">        self._msg = current_app.config[self.lang].get(code, <span class="literal">None</span>)</span><br><span class="line">        self._code = code</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(self, code=None, data=None, msg=None)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        更新默认响应文本</span></span><br><span class="line"><span class="string">        :param code:响应编码</span></span><br><span class="line"><span class="string">        :param data: 响应数据</span></span><br><span class="line"><span class="string">        :param msg: 响应消息</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> code <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self._code = code</span><br><span class="line">            <span class="comment"># 获取配置中对应语言的响应消息,默认为None</span></span><br><span class="line">            self._msg = current_app.config[self.lang].get(code, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self._data = data</span><br><span class="line">        <span class="keyword">if</span> msg <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self._msg = msg</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_field</span><span class="params">(self, name=None, value=None)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        在响应文本中加入新的字段，方便使用</span></span><br><span class="line"><span class="string">        :param name: 变量名</span></span><br><span class="line"><span class="string">        :param value: 变量值</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.__dict__[name] = value</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">data</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        输出响应文本内容</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        body = self.__dict__</span><br><span class="line">        body[<span class="string">"data"</span>] = body.pop(<span class="string">"_data"</span>)</span><br><span class="line">        body[<span class="string">"msg"</span>] = body.pop(<span class="string">"_msg"</span>)</span><br><span class="line">        body[<span class="string">"code"</span>] = body.pop(<span class="string">"_code"</span>)</span><br><span class="line">        <span class="keyword">return</span> body</span><br></pre></td></tr></table></figure>

<h4 id="修改app-py内容"><a href="#修改app-py内容" class="headerlink" title="修改app.py内容"></a>修改<code>app.py</code>内容</h4><p>添加读取响应消息配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, jsonify</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">from</span> code <span class="keyword">import</span> ResponseCode</span><br><span class="line"><span class="keyword">from</span> response <span class="keyword">import</span> ResMsg</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"msg.yaml"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    msg_conf = yaml.safe_load(f)</span><br><span class="line">app.config.update(msg_conf)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/", methods=["GET"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    res = ResMsg()</span><br><span class="line">    test_dict = dict(name=<span class="string">"zhang"</span>, age=<span class="number">18</span>)</span><br><span class="line">    <span class="comment"># 此处只需要填入响应状态码,即可获取到对应的响应消息</span></span><br><span class="line">    res.update(code=ResponseCode.SUCCESS, data=test_dict)</span><br><span class="line">    <span class="keyword">return</span> jsonify(res.data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<p>运行app，访问 <a href="http://127.0.0.1:5000/" target="_blank" rel="noopener">http://127.0.0.1:5000/</a> ，利用postman设置不同的请求头，返回如下：<br>中文(headers中<strong>lang=zh_CN</strong>):<br><code>{ &quot;code&quot;: 0,&quot;data&quot;: {&quot;age&quot;: 18,&quot;name&quot;: &quot;zhang&quot;},&quot;lang&quot;: &quot;zh_CN&quot;,&quot;msg&quot;: &quot;成功&quot;}</code><br>英文(headers中<strong>lang=en</strong>):<br><code>{ &quot;code&quot;: 0,&quot;data&quot;: {&quot;age&quot;: 18,&quot;name&quot;: &quot;zhang&quot;},&quot;lang&quot;: &quot;en&quot;,&quot;msg&quot;: &quot;success&quot;}</code></p>
<blockquote>
<p> <strong>注意</strong>：</p>
<ol>
<li>headers中的lang参数值需要和msg.yaml中的语言设置一样</li>
<li>msg.yaml中的响应状态码应和ResponseCode编码一致</li>
</ol>
</blockquote>
<h2 id="六、接口响应封装及自定义json返回类型"><a href="#六、接口响应封装及自定义json返回类型" class="headerlink" title="六、接口响应封装及自定义json返回类型"></a>六、接口响应封装及自定义json返回类型</h2><blockquote>
<p>参考：<a href="https://blog.csdn.net/qq_22034353/article/details/88758395" target="_blank" rel="noopener">Flask后端实践 连载四 接口响应封装及自定义json返回类型</a></p>
</blockquote>
<p>主要解决统一响应文本封装及json响应文本类型错误问题</p>
<h3 id="问题重现"><a href="#问题重现" class="headerlink" title="问题重现"></a>问题重现</h3><ul>
<li><p>前文<a href="https://blog.csdn.net/qq_22034353/article/details/88701947" target="_blank" rel="noopener">《Flask后端实践 连载三 接口标准化》</a>实现了响应文本的封装，即：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> response <span class="keyword">import</span> ResMsg</span><br><span class="line"><span class="meta">@app.route("/", methods=["GET"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    res = ResMsg()</span><br><span class="line">    test_dict = dict(name=<span class="string">"zhang"</span>, age=<span class="number">18</span>)</span><br><span class="line">    <span class="comment"># 此处只需要填入响应状态码,即可获取到对应的响应消息</span></span><br><span class="line">    res.update(code=ResponseCode.SUCCESS, data=test_dict)</span><br><span class="line">    <span class="keyword">return</span> jsonify(res.data)</span><br><span class="line"><span class="number">12345678</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>其中的<code>jsonify</code>是必不可少的，但是我们希望一个函数直接返回响应文本，实现<code>jsonify</code>的自动封装，不必重复书写，类似<code>return res.data</code>这样的格式。</p>
</li>
<li><p>当响应数据中存在<code>datetime</code>、<code>Decimal</code>等类型的时候，使用<code>jsonify</code>转换时会出错，报<code>TypeError: Object of type {} is not JSON serializable</code>。<br>python与json数据类型对应转换表：</p>
<table>
<thead>
<tr>
<th>python</th>
<th>json</th>
</tr>
</thead>
<tbody><tr>
<td>dict</td>
<td>object</td>
</tr>
<tr>
<td>list,tuple</td>
<td>array</td>
</tr>
<tr>
<td>str</td>
<td>string</td>
</tr>
<tr>
<td>int,float</td>
<td>float</td>
</tr>
<tr>
<td>True</td>
<td>true</td>
</tr>
<tr>
<td>False</td>
<td>false</td>
</tr>
<tr>
<td>None</td>
<td>null</td>
</tr>
</tbody></table>
</li>
</ul>
<p><strong>简单来说就是</strong></p>
<ol>
<li><p>修改route装饰器</p>
</li>
<li><p>修改json转换类</p>
</li>
</ol>
<h3 id="修改装饰器"><a href="#修改装饰器" class="headerlink" title="修改装饰器"></a>修改装饰器</h3><blockquote>
<p>装饰器本质上是一个Python函数，它可以让其他函数在不需要做任何代码变动的前提下增加额外功能，装饰器的返回值也是一个函数对象。它经常用于有切面需求的场景，比如：插入日志、性能测试、事务处理、缓存、权限校验等场景。装饰器是解决这类问题的绝佳设计，有了装饰器，我们就可以抽离出大量与函数功能本身无关的雷同代码并继续重用。概括的讲，装饰器的作用就是为已经存在的对象添加额外的功能</p>
</blockquote>
<h4 id="编写route装饰器（util-py）"><a href="#编写route装饰器（util-py）" class="headerlink" title="编写route装饰器（util.py）"></a><strong>编写route装饰器（util.py）</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">route</span><span class="params">(bp, *args, **kwargs)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    路由设置,统一返回格式</span></span><br><span class="line"><span class="string">    :param bp: 蓝图</span></span><br><span class="line"><span class="string">    :param args:</span></span><br><span class="line"><span class="string">    :param kwargs:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    kwargs.setdefault(<span class="string">'strict_slashes'</span>, <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(f)</span>:</span></span><br><span class="line"><span class="meta">        @bp.route(*args, **kwargs)</span></span><br><span class="line"><span class="meta">        @wraps(f)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">            rv = f(*args, **kwargs)</span><br><span class="line">            <span class="comment"># 响应函数返回整数和浮点型</span></span><br><span class="line">            <span class="keyword">if</span> isinstance(rv, (int, float)):</span><br><span class="line">                res = ResMsg()</span><br><span class="line">                res.update(data=rv)</span><br><span class="line">                <span class="keyword">return</span> jsonify(res.data)</span><br><span class="line">            <span class="comment"># 响应函数返回元组</span></span><br><span class="line">            <span class="keyword">elif</span> isinstance(rv, tuple):</span><br><span class="line">                <span class="comment"># 判断是否为多个参数</span></span><br><span class="line">                <span class="keyword">if</span> len(rv) &gt;= <span class="number">3</span>:</span><br><span class="line">                    <span class="keyword">return</span> jsonify(rv[<span class="number">0</span>]), rv[<span class="number">1</span>], rv[<span class="number">2</span>]</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">return</span> jsonify(rv[<span class="number">0</span>]), rv[<span class="number">1</span>]</span><br><span class="line">            <span class="comment"># 响应函数返回字典</span></span><br><span class="line">            <span class="keyword">elif</span> isinstance(rv, dict):</span><br><span class="line">                <span class="keyword">return</span> jsonify(rv)</span><br><span class="line">            <span class="comment"># 响应函数返回字节</span></span><br><span class="line">            <span class="keyword">elif</span> isinstance(rv, bytes):</span><br><span class="line">                rv = rv.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">                <span class="keyword">return</span> jsonify(rv)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> jsonify(rv)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> decorator</span><br></pre></td></tr></table></figure>

<h4 id="使用route装饰器-test-py"><a href="#使用route装饰器-test-py" class="headerlink" title="使用route装饰器(test.py)"></a>使用route装饰器(test.py)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"><span class="keyword">from</span> util <span class="keyword">import</span> route</span><br><span class="line"><span class="keyword">from</span> response <span class="keyword">import</span> ResMsg</span><br><span class="line"><span class="keyword">from</span> code <span class="keyword">import</span> ResponseCode</span><br><span class="line"></span><br><span class="line">bp = Blueprint(service_name, __name__, url_prefix=<span class="string">"/"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@route(bp, '/packed_response', methods=["GET"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_packed_response</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    测试响应封装</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    res = ResMsg()</span><br><span class="line">    test_dict = dict(name=<span class="string">"zhang"</span>, age=<span class="number">18</span>)</span><br><span class="line">    <span class="comment"># 此处只需要填入响应状态码,即可获取到对应的响应消息</span></span><br><span class="line">    res.update(code=ResponseCode.SUCCESS, data=test_dict)</span><br><span class="line">    <span class="comment"># 此处不再需要用jsonify，如果需要定制返回头或者http响应如下所示</span></span><br><span class="line">    <span class="comment"># return res.data,200,&#123;"token":"111"&#125;</span></span><br><span class="line">    <span class="keyword">return</span> res.data</span><br></pre></td></tr></table></figure>

<h3 id="解决json类型错误"><a href="#解决json类型错误" class="headerlink" title="解决json类型错误"></a>解决json类型错误</h3><h4 id="Flask-json转换类如下"><a href="#Flask-json转换类如下" class="headerlink" title="Flask json转换类如下"></a>Flask json转换类如下</h4><p>只需要我们重新写default函数，定义转换规则，便能到达我们想要的效果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JSONEncoder</span><span class="params">(_json.JSONEncoder)</span>:</span></span><br><span class="line">    <span class="string">"""The default Flask JSON encoder.  This one extends the default simplejson</span></span><br><span class="line"><span class="string">    encoder by also supporting ``datetime`` objects, ``UUID`` as well as</span></span><br><span class="line"><span class="string">    ``Markup`` objects which are serialized as RFC 822 datetime strings (same</span></span><br><span class="line"><span class="string">    as the HTTP date format).  In order to support more data types override the</span></span><br><span class="line"><span class="string">    :meth:`default` method.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">default</span><span class="params">(self, o)</span>:</span></span><br><span class="line">        <span class="string">"""Implement this method in a subclass such that it returns a</span></span><br><span class="line"><span class="string">        serializable object for ``o``, or calls the base implementation (to</span></span><br><span class="line"><span class="string">        raise a :exc:`TypeError`).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        For example, to support arbitrary iterators, you could implement</span></span><br><span class="line"><span class="string">        default like this::</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            def default(self, o):</span></span><br><span class="line"><span class="string">                try:</span></span><br><span class="line"><span class="string">                    iterable = iter(o)</span></span><br><span class="line"><span class="string">                except TypeError:</span></span><br><span class="line"><span class="string">                    pass</span></span><br><span class="line"><span class="string">                else:</span></span><br><span class="line"><span class="string">                    return list(iterable)</span></span><br><span class="line"><span class="string">                return JSONEncoder.default(self, o)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(o, datetime):</span><br><span class="line">            <span class="keyword">return</span> http_date(o.utctimetuple())</span><br><span class="line">        <span class="keyword">if</span> isinstance(o, date):</span><br><span class="line">            <span class="keyword">return</span> http_date(o.timetuple())</span><br><span class="line">        <span class="keyword">if</span> isinstance(o, uuid.UUID):</span><br><span class="line">            <span class="keyword">return</span> str(o)</span><br><span class="line">        <span class="keyword">if</span> hasattr(o, <span class="string">'__html__'</span>):</span><br><span class="line">            <span class="keyword">return</span> text_type(o.__html__())</span><br><span class="line">        <span class="keyword">return</span> _json.JSONEncoder.default(self, o)</span><br></pre></td></tr></table></figure>

<h4 id="自定义Flask-json解析类-core-py"><a href="#自定义Flask-json解析类-core-py" class="headerlink" title="自定义Flask json解析类(core.py)"></a>自定义Flask json解析类(core.py)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> decimal</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask.json <span class="keyword">import</span> JSONEncoder <span class="keyword">as</span> BaseJSONEncoder</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JSONEncoder</span><span class="params">(BaseJSONEncoder)</span>:</span></span><br><span class="line">	<span class="string">"""</span></span><br><span class="line"><span class="string">    重新default方法，支持更多的转换方法</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">default</span><span class="params">(self, o)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        如有其他的需求可直接在下面添加</span></span><br><span class="line"><span class="string">        :param o: </span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(o, datetime.datetime):</span><br><span class="line">            <span class="comment"># 格式化时间</span></span><br><span class="line">            <span class="keyword">return</span> o.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>)</span><br><span class="line">        <span class="keyword">if</span> isinstance(o, datetime.date):</span><br><span class="line">            <span class="comment"># 格式化日期</span></span><br><span class="line">            <span class="keyword">return</span> o.strftime(<span class="string">'%Y-%m-%d'</span>)</span><br><span class="line">        <span class="keyword">if</span> isinstance(o, decimal.Decimal):</span><br><span class="line">            <span class="comment"># 格式化高精度数字</span></span><br><span class="line">            <span class="keyword">return</span> str(o)</span><br><span class="line">        <span class="keyword">if</span> isinstance(o, uuid.UUID):</span><br><span class="line">            <span class="comment"># 格式化uuid</span></span><br><span class="line">            <span class="keyword">return</span> str(o)</span><br><span class="line">        <span class="keyword">if</span> isinstance(o, bytes):</span><br><span class="line">            <span class="comment"># 格式化字节数据</span></span><br><span class="line">            <span class="keyword">return</span> o.decode(<span class="string">"utf-8"</span>)</span><br><span class="line">        <span class="keyword">return</span> super(JSONEncoder, self).default(o)</span><br></pre></td></tr></table></figure>

<h4 id="使用自定义Flask-json解析类-app-py"><a href="#使用自定义Flask-json解析类-app-py" class="headerlink" title="使用自定义Flask json解析类(app.py)"></a>使用自定义Flask json解析类(app.py)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> core <span class="keyword">import</span> JSONEncoder</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回json格式转换</span></span><br><span class="line">app.json_encoder = JSONEncoder</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<h4 id="测试-test-py"><a href="#测试-test-py" class="headerlink" title="测试(test.py)"></a>测试(test.py)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> decimal <span class="keyword">import</span> Decimal</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"><span class="keyword">from</span> util <span class="keyword">import</span> route</span><br><span class="line"><span class="keyword">from</span> response <span class="keyword">import</span> ResMsg</span><br><span class="line"><span class="keyword">from</span> code <span class="keyword">import</span> ResponseCode</span><br><span class="line"></span><br><span class="line">bp = Blueprint(service_name, __name__, url_prefix=<span class="string">"/"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@route(bp, '/type_response', methods=["GET"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_type_response</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    测试返回不同的类型</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    res = ResMsg()</span><br><span class="line">    now = datetime.now()</span><br><span class="line">    date = datetime.now().date()</span><br><span class="line">    num = Decimal(<span class="number">11.11</span>)</span><br><span class="line">    test_dict = dict(now=now, date=date, num=num)</span><br><span class="line">    <span class="comment"># 此处只需要填入响应状态码,即可获取到对应的响应消息</span></span><br><span class="line">    res.update(code=ResponseCode.SUCCESS, data=test_dict)</span><br><span class="line">    <span class="comment"># 此处不再需要用jsonify，如果需要定制返回头或者http响应如下所示</span></span><br><span class="line">    <span class="comment"># return res.data,200,&#123;"token":"111"&#125;</span></span><br><span class="line">    <span class="keyword">return</span> res.data</span><br></pre></td></tr></table></figure>

<h2 id="七、数据库插件-SQLAlchemy"><a href="#七、数据库插件-SQLAlchemy" class="headerlink" title="七、数据库插件 SQLAlchemy"></a>七、数据库插件 SQLAlchemy</h2><blockquote>
<p>参考：<a href="https://blog.csdn.net/qq_22034353/article/details/88840483" target="_blank" rel="noopener">Flask后端实践 连载五 Flask与SQLAlchemy的集成和简单使用</a></p>
<p>Flask与SQLAlchemy的单表接口 请看  <a href="https://blog.csdn.net/qq_22034353/article/details/89043562" target="_blank" rel="noopener">Flask后端实践 连载六 基于Flask与SQLAlchemy的单表接口</a></p>
</blockquote>
<p>选用SQLAlchemy作为orm工具，可以减少sql代码编写以及防止sql注入的风险的存在</p>
<h3 id="简单使用-1"><a href="#简单使用-1" class="headerlink" title="简单使用"></a>简单使用</h3><ol>
<li>安装flask-sqlalchemy <code>pip3 install flask-sqlalchemy</code></li>
<li>安装pymysql <code>pip3 install pymysql</code></li>
</ol>
<h4 id="实例化SQLAlchemy-core-py"><a href="#实例化SQLAlchemy-core-py" class="headerlink" title="实例化SQLAlchemy(core.py)"></a>实例化SQLAlchemy(core.py)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"></span><br><span class="line">db = SQLAlchemy()</span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>

<h4 id="注册到flask-App中-app-py"><a href="#注册到flask-App中-app-py" class="headerlink" title="注册到flask App中(app.py)"></a>注册到flask App中(app.py)</h4><p>并配置数据库连接</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> core <span class="keyword">import</span> db</span><br><span class="line">app=Flask(__name__)</span><br><span class="line"></span><br><span class="line">USERNAME = <span class="string">'root'</span> <span class="comment"># 用户名</span></span><br><span class="line">PASSWORD = <span class="string">'mad123'</span><span class="comment"># 密码</span></span><br><span class="line">HOST = <span class="string">'127.0.0.1'</span> <span class="comment"># 数据库地址</span></span><br><span class="line">PORT = <span class="string">'3306'</span> <span class="comment"># 端口</span></span><br><span class="line">DATABASE = <span class="string">'test'</span> <span class="comment"># 数据库名</span></span><br><span class="line">database_url =<span class="string">'mysql+pymysql://&#123;&#125;:&#123;&#125;@&#123;&#125;:&#123;&#125;/&#123;&#125;?charset=utf8'</span>.format(</span><br><span class="line">    USERNAME,PASSWORD,HOST,PORT,DATABASE)</span><br><span class="line"><span class="comment">#添加数据库配置文件到flask App中</span></span><br><span class="line">app.config[<span class="string">'SQLALCHEMY_DATABASE_URI'</span>] = database_url </span><br><span class="line">app.config[<span class="string">'SQLALCHEMY_COMMIT_ON_TEARDOWN'</span>] = <span class="literal">False</span></span><br><span class="line"><span class="comment"># 注册数据库连接</span></span><br><span class="line">db.app =app</span><br><span class="line">db.init_app(app)</span><br></pre></td></tr></table></figure>

<h3 id="定义model及创建数据库表"><a href="#定义model及创建数据库表" class="headerlink" title="定义model及创建数据库表"></a>定义model及创建数据库表</h3><ul>
<li><p>定义model(model.py)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> core <span class="keyword">import</span> db</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建用户</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(db.Model)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    用户表</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    __tablename__ = <span class="string">'user'</span></span><br><span class="line">    id = db.Column(db.Integer, autoincrement=<span class="literal">True</span>, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">20</span>), nullable=<span class="literal">False</span>)  <span class="comment"># 用户姓名</span></span><br><span class="line">    age = db.Column(db.Integer, nullable=<span class="literal">False</span>)  <span class="comment"># 用户年龄</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建文章model</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span><span class="params">(db.Model)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章表</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    __tablename__ = <span class="string">'article'</span></span><br><span class="line">    id = db.Column(db.Integer, autoincrement=<span class="literal">True</span>, primary_key=<span class="literal">True</span>)</span><br><span class="line">    title = db.Column(db.String(<span class="number">20</span>), nullable=<span class="literal">False</span>)  <span class="comment"># 文章标题</span></span><br><span class="line">    body = db.Column(db.String(<span class="number">255</span>), nullable=<span class="literal">False</span>)  <span class="comment"># 文章内容</span></span><br><span class="line">    last_change_time = db.Column(db.DateTime, nullable=<span class="literal">False</span>) <span class="comment"># 最后一次修改日期</span></span><br><span class="line">    author_id = db.Column(db.Integer, db.ForeignKey(<span class="string">'user.id'</span>))  <span class="comment"># 作者</span></span><br><span class="line">    author = db.relationship(<span class="string">'User'</span>, backref=db.backref(<span class="string">'articles'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建文章修改日志 </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChangeLogs</span><span class="params">(db.Model)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    修改日志</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    __tablename__ = <span class="string">'change_logs'</span></span><br><span class="line">    id = db.Column(db.Integer, autoincrement=<span class="literal">True</span>, primary_key=<span class="literal">True</span>)</span><br><span class="line">    author_id = db.Column(db.Integer, db.ForeignKey(<span class="string">'user.id'</span>))  <span class="comment"># 作者</span></span><br><span class="line">    article_id = db.Column(db.Integer, db.ForeignKey(<span class="string">'article.id'</span>))  <span class="comment"># 文章</span></span><br><span class="line">    modify_content = db.Column(db.String(<span class="number">255</span>), nullable=<span class="literal">False</span>)  <span class="comment"># 修改内容</span></span><br><span class="line">    create_time = db.Column(db.DateTime, nullable=<span class="literal">False</span>) <span class="comment"># 创建日期</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建数据库表 执行<code>db.create_all()</code>命令，需要在启动FlaskApp之后再命令行执行</p>
</li>
</ul>
<h3 id="增"><a href="#增" class="headerlink" title="增"></a>增</h3><ol>
<li><p>单个新建</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法一,声明实例后赋值</span></span><br><span class="line">new_user = User()</span><br><span class="line">new_user.name = <span class="string">'qin'</span></span><br><span class="line">new_user.age =<span class="number">23</span></span><br><span class="line">db.session.add(new_user)</span><br><span class="line">db.session.commit()</span><br><span class="line"><span class="comment"># 方法二,声明实例直接赋值</span></span><br><span class="line">new_user = User(name=<span class="string">'zhang'</span>,age=<span class="number">26</span>)</span><br><span class="line">db.session.add(new_user)</span><br><span class="line">db.session.commit()</span><br><span class="line"><span class="comment"># 方法三，利用字典赋值</span></span><br><span class="line">user_dict=dict(name=<span class="string">'xiong'</span>,age=<span class="number">24</span>)</span><br><span class="line">new_user = User(**user_dict)</span><br><span class="line">db.session.add(new_user)</span><br><span class="line">db.session.commit()</span><br></pre></td></tr></table></figure>
</li>
<li><p>批量新建</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法一:声明多个实例，逐条插入</span></span><br><span class="line">new_user_qin = User(name=<span class="string">'qin'</span>,age=<span class="number">26</span>)</span><br><span class="line">new_user_zhang = User(name=<span class="string">'zhang'</span>,age=<span class="number">26</span>)</span><br><span class="line">new_user_xiong = User(name=<span class="string">'xiong'</span>,age=<span class="number">24</span>)</span><br><span class="line"></span><br><span class="line">db.session.add_all([new_user_qin ,new_user_zhang,new_user_xiong ])</span><br><span class="line">db.session.commit()</span><br><span class="line"><span class="comment"># 方法二：一次性插入</span></span><br><span class="line">new_users = [</span><br><span class="line">dict(name=<span class="string">'qin'</span>,age=<span class="number">24</span>),</span><br><span class="line">dict(name=<span class="string">'zhang'</span>,age=<span class="number">24</span>),</span><br><span class="line">dict(name=<span class="string">'xiong'</span>,age=<span class="number">24</span>)]</span><br><span class="line"></span><br><span class="line">db.session.execute(User.__table__.insert(), new_users )</span><br><span class="line">db.session.commit()</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="查"><a href="#查" class="headerlink" title="查"></a>查</h3><ol>
<li><p>查询一个元素</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法一,first()  </span></span><br><span class="line">user = db.session.query(User).filter(User.id == <span class="number">1</span>).first() </span><br><span class="line">user = User.query.filter(User.id ==<span class="number">1</span>).first()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法二,get() 此方法用于主键查询</span></span><br><span class="line">user = db.session.query(User).get(<span class="number">1</span>)  </span><br><span class="line">user = User.query.get(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 查询一个值</span></span><br><span class="line">name = db.session.query(User.name).filter(User.id==<span class="number">1</span>).scalar()</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询所有元素</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">users = db.session.query(User).all()</span><br><span class="line">users = User.query.all()</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询条件过滤 filter</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 等于</span></span><br><span class="line">users = db.session.query(User).filter(User.id ==<span class="number">1</span>).all()</span><br><span class="line">users = User.query.filter(User.id==<span class="number">1</span>).all()</span><br><span class="line"><span class="comment"># 大于等于</span></span><br><span class="line">users = db.session.query(User).filter(User.id &gt;=<span class="number">1</span>).all()</span><br><span class="line">users = User.query.filter(User.id&gt;=<span class="number">1</span>).all()</span><br><span class="line"><span class="comment"># 小于等于</span></span><br><span class="line">users = db.session.query(User).filter(User.id &lt;=<span class="number">1</span>).all()</span><br><span class="line">users = User.query.filter(User.id&lt;=<span class="number">1</span>).all()</span><br><span class="line"><span class="comment"># 不等于</span></span><br><span class="line">users = db.session.query(User).filter(User.id !=<span class="number">1</span>).all()</span><br><span class="line">users = User.query.filter(User.id !=<span class="number">1</span>).all()</span><br><span class="line"><span class="comment"># 两者之间</span></span><br><span class="line">users = db.session.query(User).filter(User.id.between(<span class="number">1</span>,<span class="number">10</span>)).all()</span><br><span class="line">users = User.query.filter(User.id.between(<span class="number">1</span>,<span class="number">10</span>)).all()</span><br><span class="line"><span class="comment"># 模糊查询</span></span><br><span class="line">users = db.session.query(User).filter(User.name.like(<span class="string">'%qin%'</span>)).all()</span><br><span class="line">users = User.query.filter(User.name.like(<span class="string">'%qin%'</span>)).all()</span><br><span class="line"><span class="comment"># 多条件查询</span></span><br><span class="line">users = db.session.query(User).filter(User.id ==<span class="number">1</span>, User.age==<span class="number">10</span>).all()</span><br><span class="line">users = User.query.filter(User.id&gt;=<span class="number">1</span>, User.age==<span class="number">10</span>).all()</span><br></pre></td></tr></table></figure>
</li>
<li><p>多表关联查询</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 外键关联,由于只存在一个ForeignKey, SQLAlchemy知道如何选取合适的列进行JOIN。</span></span><br><span class="line"><span class="comment"># 如果没有定义ForeignKey,或者存在多个，此时你需要手动指明你参与JOIN的列</span></span><br><span class="line">article_user = User.query.join(Article).filter(Article.id == <span class="number">1</span>).first()</span><br><span class="line">article_user = db.session.query(User).\</span><br><span class="line">join(Article).filter(Article.id == <span class="number">1</span>).first()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定键关联，查询某篇文章作者</span></span><br><span class="line">article_user = User.query.join(Article,Article.author_id == User.id).\</span><br><span class="line">filter(Article.id == <span class="number">1</span>).first()</span><br><span class="line">article_user = db.session.query(User).\</span><br><span class="line">join(Article,Article.author_id == User.id).filter(Article.id == <span class="number">1</span>).first()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多键关联，查询某篇文章的修改内容</span></span><br><span class="line">change_logs = ChangeLogs.query.join(User, ChangeLogs.author_id == User.id). \</span><br><span class="line">    join(Article, Article.id == ChangeLogs.article_id). \</span><br><span class="line">    filter(Article.id == <span class="number">1</span>, User.id == <span class="number">1</span>).all()</span><br><span class="line">change_logs = db.session.query(ChangeLogs). \</span><br><span class="line">    join(User, ChangeLogs.author_id == User.id). \</span><br><span class="line">    join(Article, Article.id == ChangeLogs.article_id). \</span><br><span class="line">    filter(Article.id == <span class="number">1</span>, User.id == <span class="number">1</span>).all()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 筛选多个表的字段，查询某篇文章的所有修改内容</span></span><br><span class="line">change_logs = db.session.query(ChangeLogs.modify_content,</span><br><span class="line">                           ChangeLogs.create_time,</span><br><span class="line">                           User.name, Article.title). \</span><br><span class="line">join(User, ChangeLogs.author_id == User.id). \</span><br><span class="line">join(Article, Article.id == ChangeLogs.article_id). \</span><br><span class="line">filter(Article.id == <span class="number">1</span>, User.id == <span class="number">1</span>).all()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 子查询关联一，查询文章最新修改的内容</span></span><br><span class="line"><span class="comment"># 定义子查询</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> and_</span><br><span class="line"></span><br><span class="line">stmt =db.session.query(ChangeLogs.article_id, ChangeLogs.modify_content,</span><br><span class="line">					   ChangeLogs.create_time ). \</span><br><span class="line">    filter(ChangeLogs.article_id == Article.id,</span><br><span class="line">           ChangeLogs.create_time == Article.last_change_time</span><br><span class="line">           ).subquery()</span><br><span class="line"><span class="comment"># 连接子查询内容</span></span><br><span class="line">last_change_logs = db.session.query(Article.title,stmt.c.modify_content,</span><br><span class="line">								Article.last_change_time</span><br><span class="line">								).\</span><br><span class="line">	outerjoin(stmt, and_(stmt.c.article_id== Article.id,</span><br><span class="line">                         stmt.c.create_time == Article.last_change_time</span><br><span class="line">                         )).all()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 子查询关联二,查询所有作者的文章数</span></span><br><span class="line"><span class="comment"># 查询文章数</span></span><br><span class="line">article_count = db.session.query(db.func.count(Article.id)). \</span><br><span class="line">    filter(Article.user_id == User.id).correlate(User).as_scalar()</span><br><span class="line">user_article = db.session.query(User.name, article_count.label(<span class="string">"count"</span>)). \</span><br><span class="line">    all()</span><br></pre></td></tr></table></figure>
</li>
<li><p>排序</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># oder_by  asc正序 desc 倒叙</span></span><br><span class="line"><span class="comment"># 查询某个作者的所有文章并按照最后修改时间倒叙排列</span></span><br><span class="line">user_articles= db.session.query(Article).\</span><br><span class="line">join(User,Article.author_id == User.id).filter(User.id == <span class="number">1</span>).\</span><br><span class="line">order_by(Article.last_change_time.desc()).all()</span><br></pre></td></tr></table></figure>
</li>
<li><p>分组</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># group_by，统计不同年龄段的用户</span></span><br><span class="line">group_age = db.session.query(User.age, db.func.count(User.id)). \</span><br><span class="line">group_by(User.age).all()</span><br></pre></td></tr></table></figure>
</li>
<li><p>函数</p>
</li>
</ol>
<p>   相关文档</p>
   <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 简单的介绍几种函数，更多的可以看官方文档</span></span><br><span class="line"><span class="comment"># count 统计不同年龄段的用户</span></span><br><span class="line">group_age = db.session.query(User.age, db.func.count(User.id)). \</span><br><span class="line">group_by(User.age).all()</span><br><span class="line"><span class="comment"># sum 总年龄</span></span><br><span class="line">sum_age= db.session.query(db.func.sum(User.age)).first()</span><br><span class="line"><span class="comment"># max 最大年龄</span></span><br><span class="line">max_age = db.session.query(db.func.max(User.age)).first()</span><br><span class="line"><span class="comment"># min 最新年龄 </span></span><br><span class="line">min_age = db.session.query(db.func.min(User.age)).first()</span><br><span class="line"><span class="comment"># avg 平均年龄</span></span><br><span class="line">avg_age = db.session.query(db.func.avg (User.age)).first()</span><br></pre></td></tr></table></figure>

<h3 id="改"><a href="#改" class="headerlink" title="改"></a>改</h3><ol>
<li><p>单个修改(更新)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法一</span></span><br><span class="line">user =db.session.query(User).fitler(User.id == <span class="number">1</span>).first()</span><br><span class="line">user.age = <span class="number">25</span></span><br><span class="line">user.name =<span class="string">"qinzq"</span></span><br><span class="line">db.session.add(user) </span><br><span class="line">db.session.commit()</span><br><span class="line"><span class="comment"># 方法二</span></span><br><span class="line">db.session.query(User).filter(User.id == <span class="number">1</span>).\</span><br><span class="line">update(&#123;<span class="string">"age "</span>:<span class="number">25</span>,<span class="string">"name"</span>:<span class="string">"qinzq"</span>&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>批量修改(更新)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.session.query(User).filter(User.id.in_((<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>))).update(&#123;<span class="string">"age "</span>:<span class="number">25</span>&#125;)</span><br><span class="line">db.session.commit()</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="删"><a href="#删" class="headerlink" title="删"></a>删</h3><ol>
<li><p>单个删除</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user =db.session.query(User).fitler(User.id == <span class="number">1</span>).first()</span><br><span class="line">db.session.delete(user) </span><br><span class="line">db.session.commit()</span><br></pre></td></tr></table></figure>
</li>
<li><p>批量删除</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.session.query(User).filter(User.id.in_((<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>))).\</span><br><span class="line">delete(synchronize_session=<span class="literal">False</span>)</span><br><span class="line">db.session.commit()</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除整个表数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.session.query(User).delete(synchronize_session=<span class="literal">False</span>)</span><br><span class="line">db.session.commit()</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h3><ol>
<li><p>rollback回滚错误操作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">new_user = User()</span><br><span class="line">new_user.name = <span class="string">'qin'</span></span><br><span class="line">new_user.age =<span class="number">23</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	db.session.add(new_user)</span><br><span class="line">	db.session.commit()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">	db.session.rollback()</span><br></pre></td></tr></table></figure>
</li>
<li><p>flush预提交数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">new_user_qin = User(name = <span class="string">'qin'</span>,age =<span class="number">23</span>)</span><br><span class="line">db.session.add(new_user_qin)</span><br><span class="line">db.session.flush()</span><br><span class="line"></span><br><span class="line">new_user_zhang = User(name=<span class="string">'zhang'</span>,age=<span class="number">26</span>)</span><br><span class="line">db.session.add(new_user_zhang )</span><br><span class="line">db.session.flush()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 统一执行commit操作，如果发生错误回滚添加的两个用户</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	db.session.commit()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">	db.session.rollback()</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h2 id="八、使用redis数据库"><a href="#八、使用redis数据库" class="headerlink" title="八、使用redis数据库"></a>八、使用redis数据库</h2><blockquote>
<p>参考：<a href="https://blog.csdn.net/qq_22034353/article/details/89107062" target="_blank" rel="noopener">Flask后端实践 连载七 Flask使用redis数据库</a></p>
</blockquote>
<p>在实际项目中，不频繁变化且重复使用的数据、有一定时效的数据等。放入redis中，不仅可以提高查询效率，还能减少维护成本。实际应用比如手机验证码，token验证、任务调度等。</p>
<h3 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h3><ol>
<li>定义<br>REmote DIctionary Server(Redis) 是一个由Salvatore Sanfilippo写的key-value存储系统。Redis是一个开源的使用ANSI C语言编写、遵守BSD协议、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库，并提供多种语言的API。它通常被称为数据结构服务器，因为值（value）可以是 字符串(String), 哈希(Hash), 列表(list), 集合(sets) 和 有序集合(sorted sets)等类型。</li>
<li>安装<br>此处<a href="https://github.com/MicrosoftArchive/redis/releases" target="_blank" rel="noopener">下载</a>对应系统的安装包，运行安装包即可。具体过程可以在<a href="http://www.runoob.com/redis/redis-install.html" target="_blank" rel="noopener">菜鸟教程</a>查看。</li>
<li>使用方法<br><a href="http://www.runoob.com/redis/redis-commands.html" target="_blank" rel="noopener">菜鸟教程</a>查看</li>
</ol>
<h3 id="Python使用redis"><a href="#Python使用redis" class="headerlink" title="Python使用redis"></a>Python使用redis</h3><ol>
<li><p>安装Python redis包<code>pip install redis</code></p>
</li>
<li><p>简单使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取redis数据库连接</span></span><br><span class="line">r = redis.StrictRedis(host=<span class="string">"127.0.0.1"</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># redis存入键值对</span></span><br><span class="line">r.set(name=<span class="string">"key"</span>, value=<span class="string">"value"</span>)</span><br><span class="line"><span class="comment"># 读取键值对</span></span><br><span class="line">print(r.get(<span class="string">"key"</span>))</span><br><span class="line"><span class="comment"># 删除</span></span><br><span class="line">print(r.delete(<span class="string">"key"</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># redis存入Hash值</span></span><br><span class="line">r.hset(name=<span class="string">"name"</span>, key=<span class="string">"key1"</span>, value=<span class="string">"value1"</span>)</span><br><span class="line">r.hset(name=<span class="string">"name"</span>, key=<span class="string">"key2"</span>, value=<span class="string">"value2"</span>)</span><br><span class="line"><span class="comment"># 获取所有哈希表中的字段</span></span><br><span class="line">print(r.hgetall(<span class="string">"name"</span>))</span><br><span class="line"><span class="comment"># 获取所有给定字段的值</span></span><br><span class="line">print(r.hmget(<span class="string">"name"</span>, <span class="string">"key1"</span>, <span class="string">"key2"</span>))</span><br><span class="line"><span class="comment"># 获取存储在哈希表中指定字段的值。</span></span><br><span class="line">print(r.hmget(<span class="string">"name"</span>, <span class="string">"key1"</span>))</span><br><span class="line"><span class="comment"># 删除一个或多个哈希表字段</span></span><br><span class="line">print(r.hdel(<span class="string">"name"</span>, <span class="string">"key1"</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 过期时间</span></span><br><span class="line">r.expire(<span class="string">"name"</span>, <span class="number">60</span>)  <span class="comment"># 60秒后过期</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更多相关内容可以参考菜鸟教程</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="Flask使用redis"><a href="#Flask使用redis" class="headerlink" title="Flask使用redis"></a>Flask使用redis</h3><h4 id="封装redis方法-util-py"><a href="#封装redis方法-util-py" class="headerlink" title="封装redis方法(util.py)"></a>封装redis方法(util.py)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> current_app</span><br><span class="line"><span class="keyword">import</span> redis </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Redis</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    redis数据库操作</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_r</span><span class="params">()</span>:</span></span><br><span class="line">    	host = current_app.config[<span class="string">'REDIS_HOST'</span>]</span><br><span class="line">    	port=current_app.config[<span class="string">'REDIS_PORT'</span>]</span><br><span class="line">    	db=current_app.config[<span class="string">'REDIS_DB'</span>]</span><br><span class="line">        r = redis.StrictRedis(host, port,db)</span><br><span class="line">        <span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(cls, key, value, expire=None)</span>:</span></span><br><span class="line">    	<span class="string">"""</span></span><br><span class="line"><span class="string">    	写入键值对</span></span><br><span class="line"><span class="string">    	"""</span></span><br><span class="line">    	<span class="comment"># 判断是否有过期时间，没有就设置默认值</span></span><br><span class="line">    	<span class="keyword">if</span> expire:</span><br><span class="line">    		expire_in_seconds = expire</span><br><span class="line">    	<span class="keyword">else</span>:</span><br><span class="line">    		expire_in_seconds = current_app.config[<span class="string">'REDIS_EXPIRE'</span>]</span><br><span class="line">        r = cls._get_r()</span><br><span class="line">        r.set(key, value, ex=expire_in_seconds)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(cls, key)</span>:</span></span><br><span class="line">    	<span class="string">"""</span></span><br><span class="line"><span class="string">    	读取键值对内容</span></span><br><span class="line"><span class="string">    	"""</span></span><br><span class="line">        r = cls._get_r()</span><br><span class="line">        value = r.get(key)</span><br><span class="line">        <span class="keyword">return</span> value.decode(<span class="string">'utf-8'</span>) <span class="keyword">if</span> value <span class="keyword">else</span> value</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hset</span><span class="params">(cls, name, key, value)</span>:</span></span><br><span class="line">    	<span class="string">"""</span></span><br><span class="line"><span class="string">    	写入hash表</span></span><br><span class="line"><span class="string">    	"""</span></span><br><span class="line">        r = cls._get_r()</span><br><span class="line">        r.hset(name, key, value)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hmset</span><span class="params">(cls, key, *value)</span>:</span></span><br><span class="line">    	<span class="string">"""</span></span><br><span class="line"><span class="string">    	读取指定hash表的所有给定字段的值</span></span><br><span class="line"><span class="string">    	"""</span></span><br><span class="line">        r = cls._get_r()</span><br><span class="line">        value = r.hmset(key, *value)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hget</span><span class="params">(cls, name, key)</span>:</span></span><br><span class="line">    	<span class="string">"""</span></span><br><span class="line"><span class="string">    	读取指定hash表的键值</span></span><br><span class="line"><span class="string">    	"""</span></span><br><span class="line">        r = cls._get_r()</span><br><span class="line">        value = r.hget(name, key)</span><br><span class="line">        <span class="keyword">return</span> value.decode(<span class="string">'utf-8'</span>) <span class="keyword">if</span> value <span class="keyword">else</span> value</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hgetall</span><span class="params">(cls, name)</span>:</span></span><br><span class="line">    	<span class="string">"""</span></span><br><span class="line"><span class="string">    	获取指定hash表所有的值</span></span><br><span class="line"><span class="string">    	"""</span></span><br><span class="line">        r = cls._get_r()</span><br><span class="line">        <span class="keyword">return</span> r.hgetall(name)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(cls, *names)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        删除一个或者多个</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        r = cls._get_r()</span><br><span class="line">        r.delete(*names)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hdel</span><span class="params">(cls, name, key)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">		删除指定hash表的键值</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        r = cls._get_r()</span><br><span class="line">        r.hdel(name, key)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">expire</span><span class="params">(cls, name, expire=None)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        设置过期时间</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> expire:</span><br><span class="line">    		expire_in_seconds = expire</span><br><span class="line">    	<span class="keyword">else</span>:</span><br><span class="line">    		expire_in_seconds = current_app.config[<span class="string">'REDIS_EXPIRE'</span>]</span><br><span class="line">        r = cls._get_r()</span><br><span class="line">        r.expire(name, expire_in_seconds)</span><br></pre></td></tr></table></figure>

<h4 id="测试使用-test-py"><a href="#测试使用-test-py" class="headerlink" title="测试使用(test.py)"></a>测试使用(test.py)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> util <span class="keyword">import</span> Redis</span><br><span class="line">bp = Blueprint(service_name, __name__, url_prefix=<span class="string">"/"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.route('/testRedisWrite', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_redis_write</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="string">"""</span></span><br><span class="line"><span class="string">	测试redis</span></span><br><span class="line"><span class="string">	"""</span></span><br><span class="line">	Redis.write(<span class="string">"test_key"</span>,<span class="string">"test_value"</span>,<span class="number">60</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="string">"ok"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.route('/testRedisRead', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_redis_read</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="string">"""</span></span><br><span class="line"><span class="string">	测试redis</span></span><br><span class="line"><span class="string">	"""</span></span><br><span class="line">	data = Redis.read(<span class="string">"test_key"</span>)</span><br><span class="line">	<span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>

<h4 id="Flask-App-app-py"><a href="#Flask-App-app-py" class="headerlink" title="Flask App(app.py)"></a>Flask App(app.py)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> test <span class="keyword">import</span> bp</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'REDIS_HOST'</span>] = <span class="string">"127.0.0.1"</span> <span class="comment"># redis数据库地址</span></span><br><span class="line">app.config[<span class="string">'REDIS_PORT'</span>] = <span class="number">6379</span> <span class="comment"># redis 端口号</span></span><br><span class="line">app.config[<span class="string">'REDIS_DB'</span>] = <span class="number">0</span> <span class="comment"># 数据库名</span></span><br><span class="line">app.config[<span class="string">'REDIS_EXPIRE'</span>] = <span class="number">60</span> <span class="comment"># redis 过期时间60秒</span></span><br><span class="line"><span class="comment"># 注册接口</span></span><br><span class="line">app.register_blueprint(bp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">	app.run()</span><br><span class="line"><span class="number">123456789101112</span></span><br></pre></td></tr></table></figure>

<h4 id="启动Flask-app"><a href="#启动Flask-app" class="headerlink" title="启动Flask app"></a>启动Flask app</h4><ul>
<li>访问 <code>http://127.0.0.1:5000/testRedisWrite</code> 返回 <code>&quot;ok&quot;</code></li>
<li>访问 <code>http://127.0.0.1:5000/testRedisRead</code> 返回 <code>test_value</code></li>
</ul>
<h2 id="九、使用APScheduler定时任务"><a href="#九、使用APScheduler定时任务" class="headerlink" title="九、使用APScheduler定时任务"></a>九、使用APScheduler定时任务</h2><blockquote>
<p>参考：<a href="https://blog.csdn.net/qq_22034353/article/details/89362959" target="_blank" rel="noopener">APScheduler</a></p>
</blockquote>
<p>安装<code>pip3 install flask_apscheduler</code></p>
<h3 id="将apscheduler注册到Flask-App"><a href="#将apscheduler注册到Flask-App" class="headerlink" title="将apscheduler注册到Flask App"></a>将apscheduler注册到Flask App</h3><ul>
<li><p><code>编写core.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_apscheduler <span class="keyword">import</span> APScheduler</span><br><span class="line">scheduler = APScheduler()</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>编写factory.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> core <span class="keyword">import</span> scheduler</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span><span class="params">()</span>:</span></span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    <span class="comment"># 配置任务，不然无法启动任务</span></span><br><span class="line">    app.config.update(</span><br><span class="line">        &#123;<span class="string">"SCHEDULER_API_ENABLED"</span>: <span class="literal">True</span>,</span><br><span class="line">         <span class="string">"JOBS"</span>: [&#123;<span class="string">"id"</span>: <span class="string">"my_job"</span>, <span class="comment"># 任务ID</span></span><br><span class="line">                    <span class="string">"func"</span>: <span class="string">"task:my_job"</span>,<span class="comment">#任务位置</span></span><br><span class="line">                    <span class="string">"trigger"</span>: <span class="string">"interval"</span>, <span class="comment">#触发器</span></span><br><span class="line">                    <span class="string">"seconds"</span>: <span class="number">5</span> <span class="comment"># 时间间隔</span></span><br><span class="line">                    &#125; </span><br><span class="line">                ]&#125;</span><br><span class="line">        )</span><br><span class="line">    scheduler.init_app(app)</span><br><span class="line">    scheduler.start()</span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="编写定时任务task-py"><a href="#编写定时任务task-py" class="headerlink" title="编写定时任务task.py"></a>编写定时任务task.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_job</span><span class="params">()</span>:</span></span><br><span class="line">    print(datetime.now().strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>))</span><br></pre></td></tr></table></figure>

<h4 id="创建app-py"><a href="#创建app-py" class="headerlink" title="创建app.py"></a>创建app.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> factory <span class="keyword">import</span> create_app</span><br><span class="line"></span><br><span class="line">app = create_app()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>执行python app.py，控制台输出如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Running job "my_job (trigger: interval[0:00:05], next run at: 2019-04-27 17:26:31 CST)" (scheduled at 2019-04-27 17:26:31.477195+08:00)</span><br><span class="line">Job "my_job (trigger: interval[0:00:05], next run at: 2019-04-27 17:26:36 CST)" executed successfully</span><br><span class="line">2019-04-27 17:26:31</span><br><span class="line">Running job "my_job (trigger: interval[0:00:05], next run at: 2019-04-27 17:26:33 CST)" (scheduled at 2019-04-27 17:26:33.410837+08:00)</span><br><span class="line">Job "my_job (trigger: interval[0:00:05], next run at: 2019-04-27 17:26:38 CST)" executed successfully</span><br><span class="line">2019-04-27 17:26:33</span><br></pre></td></tr></table></figure>



<h3 id="踩坑点"><a href="#踩坑点" class="headerlink" title="踩坑点"></a>踩坑点</h3><h4 id="Q-多进程部署，定时任务重复启动解决方法"><a href="#Q-多进程部署，定时任务重复启动解决方法" class="headerlink" title="Q:多进程部署，定时任务重复启动解决方法"></a>Q:多进程部署，定时任务重复启动解决方法</h4><p>A解决思路：在启动任务时，设置文件锁，当能获取到文件锁时，不在启动任务</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#factory.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span><span class="params">()</span>:</span></span><br><span class="line">    app =Flask(__name__)</span><br><span class="line">    <span class="comment"># 启动定时任务</span></span><br><span class="line">    scheduler_init(app)</span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scheduler_init</span><span class="params">(app)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    保证系统只启动一次定时任务</span></span><br><span class="line"><span class="string">    :param app:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> platform.system() != <span class="string">'Windows'</span>:</span><br><span class="line">        fcntl = __import__(<span class="string">"fcntl"</span>)</span><br><span class="line">        f = open(<span class="string">'scheduler.lock'</span>, <span class="string">'wb'</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            fcntl.flock(f, fcntl.LOCK_EX | fcntl.LOCK_NB)</span><br><span class="line">            scheduler.init_app(app)</span><br><span class="line">            scheduler.start()</span><br><span class="line">            app.logger.debug(<span class="string">'Scheduler Started,---------------'</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">unlock</span><span class="params">()</span>:</span></span><br><span class="line">            fcntl.flock(f, fcntl.LOCK_UN)</span><br><span class="line">            f.close()</span><br><span class="line"></span><br><span class="line">        atexit.register(unlock)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        msvcrt = __import__(<span class="string">'msvcrt'</span>)</span><br><span class="line">        f = open(<span class="string">'scheduler.lock'</span>, <span class="string">'wb'</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            msvcrt.locking(f.fileno(), msvcrt.LK_NBLCK, <span class="number">1</span>)</span><br><span class="line">            scheduler.init_app(app)</span><br><span class="line">            scheduler.start()</span><br><span class="line">            app.logger.debug(<span class="string">'Scheduler Started,----------------'</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_unlock_file</span><span class="params">()</span>:</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                f.seek(<span class="number">0</span>)</span><br><span class="line">                msvcrt.locking(f.fileno(), msvcrt.LK_UNLCK, <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        atexit.register(_unlock_file)</span><br></pre></td></tr></table></figure>

<h4 id="Q-Gunicorn使用gevent模式无效解决方法"><a href="#Q-Gunicorn使用gevent模式无效解决方法" class="headerlink" title="Q:Gunicorn使用gevent模式无效解决方法"></a>Q:Gunicorn使用gevent模式无效解决方法</h4><ul>
<li>解决思路：将gunicorn启动模式换为<code>eventlet</code></li>
</ul>
<p>配置文件<code>gun.conf</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 并行工作进程数</span><br><span class="line">workers &#x3D; 4</span><br><span class="line"># 指定每个工作者的线程数</span><br><span class="line">threads &#x3D; 4</span><br><span class="line"># 监听内网端口80</span><br><span class="line">bind &#x3D; &#39;0.0.0.0:80&#39;</span><br><span class="line"># 工作模式协程</span><br><span class="line">worker_class &#x3D; &#39;eventlet&#39; </span><br><span class="line"># 设置最大并发量</span><br><span class="line">worker_connections &#x3D; 2000</span><br><span class="line"># 设置进程文件目录</span><br><span class="line">pidfile &#x3D; &#39;gunicorn.pid&#39;</span><br><span class="line"># 设置访问日志和错误信息日志路径</span><br><span class="line">accesslog &#x3D; &#39;.&#x2F;logs&#x2F;gunicorn_acess.log&#39;</span><br><span class="line">errorlog &#x3D; &#39;.&#x2F;logs&#x2F;gunicorn_error.log&#39;</span><br><span class="line"># 设置日志记录水平</span><br><span class="line">loglevel &#x3D; &#39;info&#39;</span><br><span class="line"># 代码发生变化是否自动重启</span><br><span class="line">reload&#x3D;True</span><br></pre></td></tr></table></figure>

<h4 id="Q-使用Flask数据库解决方法"><a href="#Q-使用Flask数据库解决方法" class="headerlink" title="Q:使用Flask数据库解决方法"></a>Q:使用Flask数据库解决方法</h4><ul>
<li>解决思路：数据注册时指定一下app，并在定时任务中使用数据库绑定的app栈</li>
</ul>
<p><code>factory.py</code>配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span><span class="params">()</span>:</span></span><br><span class="line">    app =Flask(__name__)</span><br><span class="line">    <span class="comment"># 数据库注册</span></span><br><span class="line">    db.app = app</span><br><span class="line">    db.init_app(app)</span><br><span class="line">    app.config.update(</span><br><span class="line">        &#123;<span class="string">"SCHEDULER_API_ENABLED"</span>: <span class="literal">True</span>,</span><br><span class="line">         <span class="string">"JOBS"</span>: [&#123;<span class="string">"id"</span>: <span class="string">"db_query"</span>, <span class="comment"># 任务ID</span></span><br><span class="line">                    <span class="string">"func"</span>: <span class="string">"task:db_query"</span>,<span class="comment">#任务位置</span></span><br><span class="line">                    <span class="string">"trigger"</span>: <span class="string">"interval"</span>, <span class="comment">#触发器</span></span><br><span class="line">                    <span class="string">"seconds"</span>: <span class="number">5</span> <span class="comment"># 时间间隔</span></span><br><span class="line">                    &#125; </span><br><span class="line">                ]&#125;</span><br><span class="line">        )</span><br><span class="line">    scheduler_init(app)</span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>

<p><code>task.py</code>中使用数据库</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> app.utils.core <span class="keyword">import</span> db</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db_query</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    定时任务使用数据库</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">with</span> db.app.app_context():</span><br><span class="line">        data =db.session.query(user).first()</span><br><span class="line">       	print(data)</span><br></pre></td></tr></table></figure>



<h2 id="十、蓝图"><a href="#十、蓝图" class="headerlink" title="十、蓝图"></a>十、蓝图</h2><blockquote>
<p>参考：<a href="https://blog.csdn.net/Enjolras_fuu/article/details/79933756" target="_blank" rel="noopener">对 Flask 蓝图的理解</a></p>
</blockquote>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>随着业务代码的增加，将所有代码都放在单个程序文件中，是非常不合适的。这不仅会让代码阅读变得困难，而且会给后期维护带来麻烦。<br>如下示例：我们在一个文件中写入多个路由，这会使代码维护变得困难。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask    </span><br><span class="line">app &#x3D; Flask(__name__)    </span><br><span class="line"></span><br><span class="line">@app.route(&#39;&#x2F;&#39;)</span><br><span class="line">def index():</span><br><span class="line">    return &#39;index&#39;</span><br><span class="line"></span><br><span class="line">@app.route(&#39;&#x2F;list&#39;)</span><br><span class="line">def list():</span><br><span class="line">    return &#39;list&#39;</span><br><span class="line">    </span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<p><strong>尝试用模块导入的方式解决</strong>，<strong>路由错误</strong> （详情看<a href="https://blog.csdn.net/Enjolras_fuu/article/details/79933756" target="_blank" rel="noopener">这里</a>）</p>
<h3 id="什么是蓝图"><a href="#什么是蓝图" class="headerlink" title="什么是蓝图"></a>什么是蓝图</h3><p>蓝图：用于实现单个应用的视图、模板、静态文件的集合。</p>
<p>蓝图就是模块化处理的类。</p>
<p>简单来说，蓝图就是一个<strong>存储操作路由映射方法的容器</strong>，主要用来实现客户端请求和URL相互关联的功能。 在Flask中，使用蓝图可以帮助我们实现模块化应用的功能。</p>
<h4 id="蓝图的运行机制"><a href="#蓝图的运行机制" class="headerlink" title="蓝图的运行机制"></a>蓝图的运行机制</h4><p>蓝图是保存了一组将来可以在应用对象上执行的操作。注册路由就是一种操作,<strong>当在程序实例上调用route装饰器注册路由时，这个操作将修改对象的url_map路由映射列表</strong>。当我们在蓝图对象上调用route装饰器注册路由时，它只是在内部的一个延迟操作记录列表<strong>defered_functions</strong>中添加了一个项。当执行应用对象的 <strong>register_blueprint()</strong> 方法时，应用对象从蓝图对象的 <strong>defered_functions</strong> 列表中取出每一项，即调用应用对象的 <strong>add_url_rule()</strong> 方法，这将会修改程序实例的路由映射列表。</p>
<h3 id="例子演示"><a href="#例子演示" class="headerlink" title="例子演示"></a>例子演示</h3><p><strong>模拟:订单，用户两个模块的代码</strong></p>
<h4 id="把每个模块的路由封装到各自的蓝图对象中"><a href="#把每个模块的路由封装到各自的蓝图对象中" class="headerlink" title="把每个模块的路由封装到各自的蓝图对象中"></a><strong>把每个模块的路由封装到各自的蓝图对象中</strong></h4><p>*<em>用户模块 *</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  /blog/views/account.py</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"> </span><br><span class="line">account = Blueprint(<span class="string">'account'</span>,__name__)</span><br><span class="line"> </span><br><span class="line"><span class="meta">@account.route('/account')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">account_view</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'account view'</span></span><br></pre></td></tr></table></figure>

<p> <strong>订单模块</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /blog/views/order.py</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"> </span><br><span class="line">order = Blueprint(<span class="string">'order'</span>,__name__)</span><br><span class="line"> </span><br><span class="line"><span class="meta">@order.route('/order')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order_view</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'order view'</span></span><br></pre></td></tr></table></figure>

<h4 id="把单个蓝图对象注册到flask的实例对象app中"><a href="#把单个蓝图对象注册到flask的实例对象app中" class="headerlink" title="把单个蓝图对象注册到flask的实例对象app中"></a>把单个蓝图对象注册到flask的实例对象app中</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /blog/__init.py</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"> </span><br><span class="line">app = Flask(__name__)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> .views <span class="keyword">import</span> account  <span class="comment"># 用户蓝图对象</span></span><br><span class="line"><span class="keyword">from</span> .views <span class="keyword">import</span> order   <span class="comment"># 订单蓝图对象</span></span><br><span class="line"> </span><br><span class="line">app.register_blueprint(account.account)</span><br><span class="line">app.register_blueprint(order.order)</span><br></pre></td></tr></table></figure>

<h4 id="启动文件"><a href="#启动文件" class="headerlink" title="启动文件"></a><strong>启动文件</strong></h4><p>(此文件执行，就会执行/blog/__init.py文件)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /app_mamage.py </span></span><br><span class="line"><span class="keyword">import</span> blog</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    blog.app.run(port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure>



<h2 id="十一、操作Excel"><a href="#十一、操作Excel" class="headerlink" title="十一、操作Excel"></a>十一、操作Excel</h2><h3 id="Flask-Excel的使用"><a href="#Flask-Excel的使用" class="headerlink" title="Flask_Excel的使用"></a>Flask_Excel的使用</h3><p><strong>安装</strong>: <code>pip3 install Flask_Excel</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify</span><br><span class="line"><span class="keyword">import</span> flask_excel <span class="keyword">as</span> excel</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/upload", methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">"result"</span>: request.get_array(field_name=<span class="string">'file'</span>)&#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'''</span></span><br><span class="line"><span class="string">    &lt;!doctype html&gt;</span></span><br><span class="line"><span class="string">    &lt;title&gt;Upload an excel file&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;h1&gt;Excel file upload (csv, tsv, csvz, tsvz only)&lt;/h1&gt;</span></span><br><span class="line"><span class="string">    &lt;form action="" method=post enctype=multipart/form-data&gt;&lt;p&gt;</span></span><br><span class="line"><span class="string">    &lt;input type=file name=file&gt;&lt;input type=submit value=Upload&gt;</span></span><br><span class="line"><span class="string">    &lt;/form&gt;</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/download", methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_file</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> excel.make_response_from_array([[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>]], <span class="string">"csv"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/export", methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">export_records</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> excel.make_response_from_array([[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>]], <span class="string">"csv"</span>,</span><br><span class="line">                                          file_name=<span class="string">"export_data"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/download_file_named_in_unicode", methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_file_named_in_unicode</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> excel.make_response_from_array([[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>]], <span class="string">"csv"</span>,</span><br><span class="line">                                          file_name=<span class="string">u"中文文件名"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># insert database related code here</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    excel.init_excel(app)</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<h3 id="Flask结合xlsxwriter使用"><a href="#Flask结合xlsxwriter使用" class="headerlink" title="Flask结合xlsxwriter使用"></a>Flask结合xlsxwriter使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> xlsxwriter</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">()</span>:</span></span><br><span class="line">    path = <span class="string">"test.xlsx"</span></span><br><span class="line">    <span class="comment"># 新建excel文本</span></span><br><span class="line">    workbook = xlsxwriter.Workbook(path)</span><br><span class="line">    <span class="comment"># 添加一个sheet</span></span><br><span class="line">    worksheet = workbook.add_worksheet(<span class="string">"test1"</span>)</span><br><span class="line">    <span class="comment"># 设置列宽</span></span><br><span class="line">    worksheet.set_column(<span class="string">'A:A'</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加字体加粗样式</span></span><br><span class="line">    bold = workbook.add_format(&#123;<span class="string">'bold'</span>: <span class="literal">True</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 写入数据</span></span><br><span class="line">    worksheet.write(<span class="string">'A1'</span>, <span class="string">'Hello'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 写入数据并使用样子</span></span><br><span class="line">    worksheet.write(<span class="string">'A2'</span>, <span class="string">'World'</span>, bold)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用数字标识单元格位置（行，列）</span></span><br><span class="line">    worksheet.write(<span class="number">2</span>, <span class="number">0</span>, <span class="number">123</span>)</span><br><span class="line">    worksheet.write(<span class="number">3</span>, <span class="number">0</span>, <span class="number">123.456</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 按行依次写入数据</span></span><br><span class="line">    worksheet.write_column(<span class="number">4</span>, <span class="number">0</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 按列依次写入数据</span></span><br><span class="line">    worksheet.write_row(<span class="number">1</span>, <span class="number">1</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加图表</span></span><br><span class="line">    chart = workbook.add_chart(&#123;<span class="string">'type'</span>: <span class="string">'column'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 图表数据来源</span></span><br><span class="line">    chart.add_series(&#123;<span class="string">'values'</span>: [<span class="string">"test1"</span>,  <span class="comment"># worksheet的名字。即sheet_name</span></span><br><span class="line">                                <span class="number">4</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>  <span class="comment"># 数据位置</span></span><br><span class="line">                                ]&#125;)</span><br><span class="line">    <span class="comment"># 插入的表格位置</span></span><br><span class="line">    worksheet.insert_chart(<span class="string">'B3'</span>, chart)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 关闭excel文本并输出到指定位置。如果不调用改方法，无法输出excel</span></span><br><span class="line">    workbook.close()</span><br><span class="line">    <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/testExcel', methods=["GET"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_excel</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    测试输出excel</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    path = write()</span><br><span class="line">    <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<p>启动app，访问<code>http://127.0.0.1:5000/testExcel</code> 返回生成路径<code>test.xlsx</code>。然后配合nginx转发即可下载文件</p>
<h2 id="十二、操作Word"><a href="#十二、操作Word" class="headerlink" title="十二、操作Word"></a>十二、操作Word</h2><h3 id="Python处理Word的包"><a href="#Python处理Word的包" class="headerlink" title="Python处理Word的包"></a>Python处理Word的包</h3><ol>
<li><p>python-docx</p>
<p>python-docx是一个用于创建和更新Microsoft Word（.docx）文件的Python库。<a href="https://python-docx.readthedocs.io/en/latest/" target="_blank" rel="noopener">文档地址</a></p>
</li>
<li><p>docxtpl</p>
<p>主要包含两个包，分别是python-docx用于读取，编写和创建子文档。jinja2用于管理插入模板docx的标签。通过预先设定的模板文件，生成需要的文件。<a href="https://docxtpl.readthedocs.io/en/latest/" target="_blank" rel="noopener">文档地址</a></p>
</li>
</ol>
<h3 id="docxtpl的简单使用"><a href="#docxtpl的简单使用" class="headerlink" title="docxtpl的简单使用"></a>docxtpl的简单使用</h3><p>项目上的Word报表定制化比较高。通常由用户提供模板，我们这边只需要在对应位置填写数据。因此项目上采用<code>docxtpl</code>来定制化Word报表</p>
<ol>
<li><p>安装<code>pip install docxtpl</code></p>
</li>
<li><p>简单使用，更多详细内容请看<a href="https://docxtpl.readthedocs.io/en/latest/" target="_blank" rel="noopener">官方文档</a>。</p>
<ul>
<li><p>新建测试模板<code>test.docx</code>，设置模板样子，并填入相关参数。</p>
</li>
<li><p>编写渲染测试代码<code>test.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> docxtpl <span class="keyword">import</span> DocxTemplate, InlineImage</span><br><span class="line"><span class="keyword">from</span> docx.shared <span class="keyword">import</span> Mm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取指定位置的模板文件</span></span><br><span class="line">doc = DocxTemplate(<span class="string">"test.docx"</span>)</span><br><span class="line"><span class="comment"># 渲染的内容</span></span><br><span class="line">context = &#123;</span><br><span class="line">    <span class="comment"># 标题</span></span><br><span class="line">    <span class="string">'title'</span>: <span class="string">"人员信息"</span>,</span><br><span class="line">    <span class="comment"># 表格</span></span><br><span class="line">    <span class="string">'table'</span>: [</span><br><span class="line">        &#123;<span class="string">"name"</span>: <span class="string">"小李"</span>, <span class="string">"age"</span>: <span class="number">11</span>&#125;,</span><br><span class="line">        &#123;<span class="string">"name"</span>: <span class="string">"小张"</span>, <span class="string">"age"</span>: <span class="number">21</span>&#125;,</span><br><span class="line">        &#123;<span class="string">"name"</span>: <span class="string">"小张"</span>, <span class="string">"age"</span>: <span class="number">20</span>&#125;,</span><br><span class="line">        &#123;<span class="string">"name"</span>: <span class="string">"小张1"</span>, <span class="string">"age"</span>: <span class="number">10</span>&#125;,</span><br><span class="line">        &#123;<span class="string">"name"</span>: <span class="string">"小张2"</span>, <span class="string">"age"</span>: <span class="number">30</span>&#125;,</span><br><span class="line">        &#123;<span class="string">"name"</span>: <span class="string">"小张3"</span>, <span class="string">"age"</span>: <span class="number">40</span>&#125;,</span><br><span class="line">    ],</span><br><span class="line">    <span class="comment"># 页眉</span></span><br><span class="line">    <span class="string">'header'</span>: <span class="string">'xxx公司人员信息管理'</span>,</span><br><span class="line">    <span class="comment"># 页脚</span></span><br><span class="line">    <span class="string">'footer'</span>: <span class="string">'1'</span>,</span><br><span class="line">    <span class="comment"># 图片</span></span><br><span class="line">    <span class="string">'image'</span>: InlineImage(doc, <span class="string">'test.jpg'</span>, height=Mm(<span class="number">10</span>)),</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 渲染模板</span></span><br><span class="line">doc.render(context)</span><br><span class="line"><span class="comment"># 保存渲染的文件</span></span><br><span class="line">doc.save(<span class="string">"generated_doc.docx"</span>)</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ol>
<h3 id="Flask结合docxtpl使用"><a href="#Flask结合docxtpl使用" class="headerlink" title="Flask结合docxtpl使用"></a>Flask结合docxtpl使用</h3><ul>
<li><p>测试代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> docxtpl <span class="keyword">import</span> DocxTemplate, InlineImage</span><br><span class="line"><span class="keyword">from</span> docx.shared <span class="keyword">import</span> Mm</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">()</span>:</span></span><br><span class="line">    path = <span class="string">"generated_doc.docx"</span></span><br><span class="line">    <span class="comment"># 读取指定位置的模板文件</span></span><br><span class="line">    doc = DocxTemplate(<span class="string">"test.docx"</span>)</span><br><span class="line">    <span class="comment"># 渲染的内容</span></span><br><span class="line">    context = &#123;</span><br><span class="line">        <span class="comment"># 标题</span></span><br><span class="line">        <span class="string">'title'</span>: <span class="string">"人员信息"</span>,</span><br><span class="line">        <span class="comment"># 表格</span></span><br><span class="line">        <span class="string">'table'</span>: [</span><br><span class="line">            &#123;<span class="string">"name"</span>: <span class="string">"小李"</span>, <span class="string">"age"</span>: <span class="number">11</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"name"</span>: <span class="string">"小张"</span>, <span class="string">"age"</span>: <span class="number">21</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"name"</span>: <span class="string">"小张"</span>, <span class="string">"age"</span>: <span class="number">20</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"name"</span>: <span class="string">"小张1"</span>, <span class="string">"age"</span>: <span class="number">10</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"name"</span>: <span class="string">"小张2"</span>, <span class="string">"age"</span>: <span class="number">30</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"name"</span>: <span class="string">"小张3"</span>, <span class="string">"age"</span>: <span class="number">40</span>&#125;,</span><br><span class="line">        ],</span><br><span class="line">        <span class="comment"># 页眉</span></span><br><span class="line">        <span class="string">'header'</span>: <span class="string">'xxx公司人员信息管理'</span>,</span><br><span class="line">        <span class="comment"># 页脚</span></span><br><span class="line">        <span class="string">'footer'</span>: <span class="string">'1'</span>,</span><br><span class="line">        <span class="comment"># 图片</span></span><br><span class="line">        <span class="string">'image'</span>: InlineImage(doc, <span class="string">'test.jpg'</span>, height=Mm(<span class="number">10</span>)),</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 渲染模板</span></span><br><span class="line">    doc.render(context)</span><br><span class="line">    <span class="comment"># 保存渲染的文件</span></span><br><span class="line">    doc.save(path)</span><br><span class="line">    <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/testWord', methods=["GET"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_word</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    测试输出word</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    path = write()</span><br><span class="line">    <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>启动app，访问<code>http://127.0.0.1:5000/testWord</code> 返回生成路径<code>generated_doc.docx</code>。然后配合nginx转发即可下载文件</p>
<h2 id="十三、输出PDF报表"><a href="#十三、输出PDF报表" class="headerlink" title="十三、输出PDF报表"></a>十三、输出PDF报表</h2><h3 id="Python处理PDF的包"><a href="#Python处理PDF的包" class="headerlink" title="Python处理PDF的包"></a>Python处理PDF的包</h3><ol>
<li><p>reportlab</p>
<p>ReportLab标记语言（RML）是最强大的代码到PDF工具包，非常简单，是自动化专业发布的最佳选择。 清晰的，类似HTML的语法允许开发人员像网页一样布局数据驱动的文档。<a href="https://www.reportlab.com/documentation/" target="_blank" rel="noopener">文档地址</a>，<a href="https://www.reportlab.com/docs/reportlab-userguide.pdf" target="_blank" rel="noopener">用户手册</a>。</p>
</li>
<li><p>xhtml2pdf</p>
<p>xhtml2pdf是一个使用ReportLab Toolkit，HTML5lib和pyPdf的html2pdf转换器。它支持HTML 5和CSS 2.1（以及一些CSS 3）。它完全用纯Python编写，因此它与平台无关。具有Web技能（如HTML和CSS）的用户能够非常快速地生成PDF模板而无需学习新技术。<a href="https://xhtml2pdf.readthedocs.io/en/latest/" target="_blank" rel="noopener">文档地址</a></p>
</li>
<li><p>PyPDF2</p>
<p>PyPDF2可以提取文档信息（标题，作者，…）、按页拆分文档、逐页合并文档、裁剪页面、合并多个页面到一个页、对pdf文档进行加密解密等等。<a href="http://mstamy2.github.io/PyPDF2/" target="_blank" rel="noopener">文档地址</a></p>
</li>
</ol>
<h3 id="ReportLab简单使用"><a href="#ReportLab简单使用" class="headerlink" title="ReportLab简单使用"></a>ReportLab简单使用</h3><p>由于项目上需要绘制PDF，经过比较选择reportlab作为开发。reportlab可以利用模板来生成PDF，也可以手动生成PDF。</p>
<ol>
<li><p>安装<code>pip install reportlab</code></p>
</li>
<li><p>简单使用，更多详细内容请看</p>
<p>用户手册</p>
<p>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> reportlab.lib.colors <span class="keyword">import</span> HexColor</span><br><span class="line"><span class="keyword">from</span> reportlab.lib.styles <span class="keyword">import</span> getSampleStyleSheet, ParagraphStyle</span><br><span class="line"><span class="keyword">from</span> reportlab.platypus <span class="keyword">import</span> SimpleDocTemplate, Table, Image, PageBreak, Paragraph</span><br><span class="line"><span class="keyword">from</span> reportlab.lib.units <span class="keyword">import</span> inch</span><br><span class="line"><span class="keyword">from</span> reportlab.lib <span class="keyword">import</span> colors</span><br><span class="line"><span class="keyword">from</span> reportlab.pdfbase <span class="keyword">import</span> pdfmetrics</span><br><span class="line"><span class="keyword">from</span> reportlab.pdfbase.ttfonts <span class="keyword">import</span> TTFont</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加的字体，支持中文显示,需要自行下载支持中文的字体</span></span><br><span class="line">pdfmetrics.registerFont(TTFont(<span class="string">'SimSun'</span>, <span class="string">'SimSun.ttf'</span>))</span><br><span class="line">styles = getSampleStyleSheet()</span><br><span class="line">styles.add(ParagraphStyle(fontName=<span class="string">'SimSun'</span>, name=<span class="string">'SimSun'</span>, leading=<span class="number">20</span>, fontSize=<span class="number">12</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">table_model</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    添加表格</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    new_img = Image(<span class="string">'test.jpg'</span>, width=<span class="number">300</span>, height=<span class="number">300</span>)</span><br><span class="line">    base = [</span><br><span class="line">        [new_img, <span class="string">""</span>],</span><br><span class="line">        [<span class="string">"大类"</span>, <span class="string">"小类"</span>],</span><br><span class="line">        [<span class="string">"WebFramework"</span>, <span class="string">"django"</span>],</span><br><span class="line">        [<span class="string">""</span>, <span class="string">"flask"</span>],</span><br><span class="line">        [<span class="string">""</span>, <span class="string">"web.py"</span>],</span><br><span class="line">        [<span class="string">""</span>, <span class="string">"tornado"</span>],</span><br><span class="line">        [<span class="string">"Office"</span>, <span class="string">"xlsxwriter"</span>],</span><br><span class="line">        [<span class="string">""</span>, <span class="string">"openpyxl"</span>],</span><br><span class="line">        [<span class="string">""</span>, <span class="string">"xlrd"</span>],</span><br><span class="line">        [<span class="string">""</span>, <span class="string">"xlwt"</span>],</span><br><span class="line">        [<span class="string">""</span>, <span class="string">"python-docx"</span>],</span><br><span class="line">        [<span class="string">""</span>, <span class="string">"docxtpl"</span>],</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    style = [</span><br><span class="line">        <span class="comment"># 设置字体</span></span><br><span class="line">        (<span class="string">'FONTNAME'</span>, (<span class="number">0</span>, <span class="number">0</span>), (<span class="number">-1</span>, <span class="number">-1</span>), <span class="string">'SimSun'</span>),</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 合并单元格 (列,行)</span></span><br><span class="line">        (<span class="string">'SPAN'</span>, (<span class="number">0</span>, <span class="number">0</span>), (<span class="number">1</span>, <span class="number">0</span>)),</span><br><span class="line">        (<span class="string">'SPAN'</span>, (<span class="number">0</span>, <span class="number">2</span>), (<span class="number">0</span>, <span class="number">5</span>)),</span><br><span class="line">        (<span class="string">'SPAN'</span>, (<span class="number">0</span>, <span class="number">6</span>), (<span class="number">0</span>, <span class="number">11</span>)),</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 单元格背景</span></span><br><span class="line">        (<span class="string">'BACKGROUND'</span>, (<span class="number">0</span>, <span class="number">1</span>), (<span class="number">1</span>, <span class="number">1</span>), HexColor(<span class="string">'#548DD4'</span>)),  </span><br><span class="line"></span><br><span class="line">        <span class="comment"># 字体颜色</span></span><br><span class="line">        (<span class="string">'TEXTCOLOR'</span>, (<span class="number">0</span>, <span class="number">1</span>), (<span class="number">1</span>, <span class="number">1</span>), colors.white),  </span><br><span class="line">        <span class="comment"># 对齐设置</span></span><br><span class="line">        (<span class="string">'VALIGN'</span>, (<span class="number">0</span>, <span class="number">0</span>), (<span class="number">-1</span>, <span class="number">-1</span>), <span class="string">'MIDDLE'</span>),  </span><br><span class="line">        (<span class="string">'ALIGN'</span>, (<span class="number">0</span>, <span class="number">0</span>), (<span class="number">-1</span>, <span class="number">-1</span>), <span class="string">'CENTER'</span>),  </span><br><span class="line"></span><br><span class="line">        <span class="comment"># 单元格框线</span></span><br><span class="line">        (<span class="string">'GRID'</span>, (<span class="number">0</span>, <span class="number">0</span>), (<span class="number">-1</span>, <span class="number">-1</span>), <span class="number">0.5</span>, colors.grey),</span><br><span class="line">        (<span class="string">'BOX'</span>, (<span class="number">0</span>, <span class="number">0</span>), (<span class="number">-1</span>, <span class="number">-1</span>), <span class="number">0.5</span>, colors.black),</span><br><span class="line"></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    component_table = Table(base, style=style)</span><br><span class="line">    <span class="keyword">return</span> component_table</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">paragraph_model</span><span class="params">(msg)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    添加一段文字</span></span><br><span class="line"><span class="string">    :param msg:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 设置文字样式</span></span><br><span class="line">    style = ParagraphStyle(</span><br><span class="line">        name=<span class="string">'Normal'</span>,</span><br><span class="line">        fontName=<span class="string">'SimSun'</span>,</span><br><span class="line">        fontSize=<span class="number">50</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Paragraph(msg, style=style)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">image_model</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    添加图片</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    new_img = Image(<span class="string">'test.jpg'</span>, width=<span class="number">300</span>, height=<span class="number">300</span>)</span><br><span class="line">    <span class="keyword">return</span> new_img</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更多样式参考用户手册 https://www.reportlab.com/docs/reportlab-userguide.pdf</span></span><br><span class="line">data = list()</span><br><span class="line"><span class="comment"># 添加一段文字</span></span><br><span class="line">paragraph = paragraph_model(<span class="string">"测试添加一段文字"</span>)</span><br><span class="line">data.append(paragraph)</span><br><span class="line">data.append(PageBreak())  <span class="comment"># 分页标识</span></span><br><span class="line"><span class="comment"># 添加table和图片</span></span><br><span class="line">table = table_model()</span><br><span class="line">data.append(table)</span><br><span class="line">data.append(PageBreak())  <span class="comment"># 分页标识</span></span><br><span class="line">img = image_model()</span><br><span class="line">data.append(img)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置生成pdf的名字和编剧</span></span><br><span class="line">pdf = SimpleDocTemplate(<span class="string">"test.pdf"</span>, rightMargin=<span class="number">0</span>, leftMargin=<span class="number">0</span>, topMargin=<span class="number">40</span>, bottomMargin=<span class="number">0</span>, )</span><br><span class="line"><span class="comment"># 设置pdf每页的大小</span></span><br><span class="line">pdf.pagesize = (<span class="number">9</span> * inch, <span class="number">10</span> * inch)</span><br><span class="line"></span><br><span class="line">pdf.multiBuild(data)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="Flask结合reportlab使用"><a href="#Flask结合reportlab使用" class="headerlink" title="Flask结合reportlab使用"></a>Flask结合reportlab使用</h3><ul>
<li><p>测试代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> reportlab.lib.colors <span class="keyword">import</span> HexColor</span><br><span class="line"><span class="keyword">from</span> reportlab.lib.styles <span class="keyword">import</span> getSampleStyleSheet, ParagraphStyle</span><br><span class="line"><span class="keyword">from</span> reportlab.platypus <span class="keyword">import</span> SimpleDocTemplate, Table, Image, PageBreak, Paragraph</span><br><span class="line"><span class="keyword">from</span> reportlab.lib.units <span class="keyword">import</span> inch</span><br><span class="line"><span class="keyword">from</span> reportlab.lib <span class="keyword">import</span> colors</span><br><span class="line"><span class="keyword">from</span> reportlab.pdfbase <span class="keyword">import</span> pdfmetrics</span><br><span class="line"><span class="keyword">from</span> reportlab.pdfbase.ttfonts <span class="keyword">import</span> TTFont</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加的字体，支持中文显示,需要自行下载支持中文的字体</span></span><br><span class="line">pdfmetrics.registerFont(TTFont(<span class="string">'SimSun'</span>, <span class="string">'SimSun.ttf'</span>))</span><br><span class="line">styles = getSampleStyleSheet()</span><br><span class="line">styles.add(ParagraphStyle(fontName=<span class="string">'SimSun'</span>, name=<span class="string">'SimSun'</span>, leading=<span class="number">20</span>, fontSize=<span class="number">12</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">table_model</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    添加表格</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    new_img = Image(<span class="string">'test.jpg'</span>, width=<span class="number">300</span>, height=<span class="number">300</span>)</span><br><span class="line">    base = [</span><br><span class="line">        [new_img, <span class="string">""</span>],</span><br><span class="line">        [<span class="string">"大类"</span>, <span class="string">"小类"</span>],</span><br><span class="line">        [<span class="string">"WebFramework"</span>, <span class="string">"django"</span>],</span><br><span class="line">        [<span class="string">""</span>, <span class="string">"flask"</span>],</span><br><span class="line">        [<span class="string">""</span>, <span class="string">"web.py"</span>],</span><br><span class="line">        [<span class="string">""</span>, <span class="string">"tornado"</span>],</span><br><span class="line">        [<span class="string">"Office"</span>, <span class="string">"xlsxwriter"</span>],</span><br><span class="line">        [<span class="string">""</span>, <span class="string">"openpyxl"</span>],</span><br><span class="line">        [<span class="string">""</span>, <span class="string">"xlrd"</span>],</span><br><span class="line">        [<span class="string">""</span>, <span class="string">"xlwt"</span>],</span><br><span class="line">        [<span class="string">""</span>, <span class="string">"python-docx"</span>],</span><br><span class="line">        [<span class="string">""</span>, <span class="string">"docxtpl"</span>],</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    style = [</span><br><span class="line">        <span class="comment"># 设置字体</span></span><br><span class="line">        (<span class="string">'FONTNAME'</span>, (<span class="number">0</span>, <span class="number">0</span>), (<span class="number">-1</span>, <span class="number">-1</span>), <span class="string">'SimSun'</span>),</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 合并单元格 (列,行)</span></span><br><span class="line">        (<span class="string">'SPAN'</span>, (<span class="number">0</span>, <span class="number">0</span>), (<span class="number">1</span>, <span class="number">0</span>)),</span><br><span class="line">        (<span class="string">'SPAN'</span>, (<span class="number">0</span>, <span class="number">2</span>), (<span class="number">0</span>, <span class="number">5</span>)),</span><br><span class="line">        (<span class="string">'SPAN'</span>, (<span class="number">0</span>, <span class="number">6</span>), (<span class="number">0</span>, <span class="number">11</span>)),</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 单元格背景</span></span><br><span class="line">        (<span class="string">'BACKGROUND'</span>, (<span class="number">0</span>, <span class="number">1</span>), (<span class="number">1</span>, <span class="number">1</span>), HexColor(<span class="string">'#548DD4'</span>)),</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 字体颜色</span></span><br><span class="line">        (<span class="string">'TEXTCOLOR'</span>, (<span class="number">0</span>, <span class="number">1</span>), (<span class="number">1</span>, <span class="number">1</span>), colors.white),</span><br><span class="line">        <span class="comment"># 对齐设置</span></span><br><span class="line">        (<span class="string">'VALIGN'</span>, (<span class="number">0</span>, <span class="number">0</span>), (<span class="number">-1</span>, <span class="number">-1</span>), <span class="string">'MIDDLE'</span>),</span><br><span class="line">        (<span class="string">'ALIGN'</span>, (<span class="number">0</span>, <span class="number">0</span>), (<span class="number">-1</span>, <span class="number">-1</span>), <span class="string">'CENTER'</span>),</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 单元格框线</span></span><br><span class="line">        (<span class="string">'GRID'</span>, (<span class="number">0</span>, <span class="number">0</span>), (<span class="number">-1</span>, <span class="number">-1</span>), <span class="number">0.5</span>, colors.grey),</span><br><span class="line">        (<span class="string">'BOX'</span>, (<span class="number">0</span>, <span class="number">0</span>), (<span class="number">-1</span>, <span class="number">-1</span>), <span class="number">0.5</span>, colors.black),</span><br><span class="line"></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    component_table = Table(base, style=style)</span><br><span class="line">    <span class="keyword">return</span> component_table</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">paragraph_model</span><span class="params">(msg)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    添加一段文字</span></span><br><span class="line"><span class="string">    :param msg:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 设置文字样式</span></span><br><span class="line">    style = ParagraphStyle(</span><br><span class="line">        name=<span class="string">'Normal'</span>,</span><br><span class="line">        fontName=<span class="string">'SimSun'</span>,</span><br><span class="line">        fontSize=<span class="number">50</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Paragraph(msg, style=style)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">image_model</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    添加图片</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    new_img = Image(<span class="string">'test.jpg'</span>, width=<span class="number">300</span>, height=<span class="number">300</span>)</span><br><span class="line">    <span class="keyword">return</span> new_img</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_pdf</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    生成pdf</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    path = <span class="string">"test.pdf"</span></span><br><span class="line">    data = list()</span><br><span class="line">    <span class="comment"># 添加一段文字</span></span><br><span class="line">    paragraph = paragraph_model(<span class="string">"测试添加一段文字"</span>)</span><br><span class="line">    data.append(paragraph)</span><br><span class="line">    data.append(PageBreak())  <span class="comment"># 分页标识</span></span><br><span class="line">    <span class="comment"># 添加table和图片</span></span><br><span class="line">    table = table_model()</span><br><span class="line">    data.append(table)</span><br><span class="line">    data.append(PageBreak())  <span class="comment"># 分页标识</span></span><br><span class="line">    img = image_model()</span><br><span class="line">    data.append(img)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置生成pdf的名字和编剧</span></span><br><span class="line">    pdf = SimpleDocTemplate(path, rightMargin=<span class="number">0</span>, leftMargin=<span class="number">0</span>, topMargin=<span class="number">40</span>, bottomMargin=<span class="number">0</span>, )</span><br><span class="line">    <span class="comment"># 设置pdf每页的大小</span></span><br><span class="line">    pdf.pagesize = (<span class="number">9</span> * inch, <span class="number">10</span> * inch)</span><br><span class="line"></span><br><span class="line">    pdf.multiBuild(data)</span><br><span class="line">    <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/testPDF', methods=["GET"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_pdf</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    测试输出pdf</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    path = generate_pdf()</span><br><span class="line">    <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>启动app，访问<code>http://127.0.0.1:5000/testPDF</code> 返回生成路径<code>test.pdf</code>。然后配合nginx转发即可下载文件</p>
<blockquote>
<p>参考：<a href="qzq1111/**flask-restful-example**">qzq1111/<strong>flask-restful-example</strong></a></p>
</blockquote>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Gkon</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://gxkon.top/posts/40ebec26/">http://gxkon.top/posts/40ebec26/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://gxkon.top" target="_blank">Gxkon's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Python/">Python</a></div><div class="post_share"><div class="social-share" data-image="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/10/7/68coffee-5567269_1280.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/posts/263918de/"><img class="prev_cover" data-src="/Pic/post.jpg" onerror="onerror=null;src='/Pic/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Python文本处理之读取yaml配置文件</div></div></a></div><div class="next-post pull_right"><a href="/posts/8aade918/"><img class="next_cover" data-src="/Pic/post.jpg" onerror="onerror=null;src='/Pic/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Flask接口单元测试+测试报告+测试覆盖率</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/posts/ffb5fdc7/" title="Python GUI编程(Tkinter)"><img class="relatedPosts_cover" data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/09/night-4011992_1280.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-09-24</div><div class="relatedPosts_title">Python GUI编程(Tkinter)</div></div></a></div><div class="relatedPosts_item"><a href="/posts/1ed47f5b/" title="Python基础之列表"><img class="relatedPosts_cover" data-src="https://tvax3.sinaimg.cn/large/4a9e9735gy1gdait9noiwj24802diqp3.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-28</div><div class="relatedPosts_title">Python基础之列表</div></div></a></div><div class="relatedPosts_item"><a href="/posts/f1154067/" title="Python基础之库、Pip、Pypi"><img class="relatedPosts_cover" data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/09/norway-4970081_1280.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-28</div><div class="relatedPosts_title">Python基础之库、Pip、Pypi</div></div></a></div><div class="relatedPosts_item"><a href="/posts/49a688a0/" title="Python基础之字符串"><img class="relatedPosts_cover" data-src="https://tvax3.sinaimg.cn/large/4a9e9735gy1gdaiuzfg25j24002o0b29.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-03-28</div><div class="relatedPosts_title">Python基础之字符串</div></div></a></div><div class="relatedPosts_item"><a href="/posts/bbbc4a2f/" title="Python基础之安装与部署"><img class="relatedPosts_cover" data-src="https://pic-1256641195.cos.ap-nanjing.myqcloud.com/2020/09/geyser-4766105_1280.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-27</div><div class="relatedPosts_title">Python基础之安装与部署</div></div></a></div><div class="relatedPosts_item"><a href="/posts/dcbec147/" title="Python中级之Pyinstaller打包成exe"><img class="relatedPosts_cover" data-src="/Pic/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-11-07</div><div class="relatedPosts_title">Python中级之Pyinstaller打包成exe</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '1ce3148e3133bf004c96',
  clientSecret: '2a1e5c0f4d38387460b916843bfe5cac67ef2d07',
  repo: 'blankwz.github.io',
  owner: 'blankwz',
  admin: ['blankwz'],
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  perPage: 10,
  distractionFreeMode: false,
  pagerDirection: 'last',
  createIssueManually: false,
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  try {
    document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
  } catch (e) {
    return false
  }
}</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Gkon</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">簡</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script src="/js/third-party/ClickShowText.js"></script></body></html>